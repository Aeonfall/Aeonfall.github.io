<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aeonfall - Player's Handbook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Roboto+Slab:wght@300;400;700&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto Slab', serif; background-color: #1a1a1a; color: #e2e8f0; overflow-x: hidden; }
        .dashboard-bg { background-image: url('https://www.transparenttextures.com/patterns/dark-wood.png'); background-color: #0c0c0c; }
        
        /* HEADER STYLING */
        .brand-title { font-family: 'Cinzel', serif; font-weight: 900; color: #f59e0b; font-size: 3.5rem; line-height: 1; margin-bottom: 0.2rem; }
        .brand-sub { font-family: 'Cinzel', serif; font-size: 11px; font-weight: 700; color: #64748b; letter-spacing: 0.15em; text-transform: uppercase; }
        
        .user-pill { background: rgba(30, 41, 59, 0.8); border: 1px solid #334155; padding: 8px 16px; border-radius: 99px; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); position: relative; z-index: 100; pointer-events: auto; }
        .status-dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 10px #22c55e; }
        .status-dot.offline { background: #64748b; box-shadow: none; }
        .user-name-text { font-family: 'Cinzel', serif; font-size: 11px; font-weight: 900; color: #e2e8f0; text-transform: uppercase; }
        
        .auth-btn { font-family: 'Cinzel', serif; font-size: 10px; font-weight: 900; border-left: 1px solid #475569; padding: 4px 4px 4px 12px; margin-left: 4px; cursor: pointer; transition: all 0.2s; text-transform: uppercase; }
        .logout-btn { color: #ef4444; }
        .logout-btn:hover { color: #f87171; }
        .login-btn { color: #22c55e; }
        .login-btn:hover { color: #4ade80; }
        
        .role-selector { background: #0f172a; border-radius: 12px; padding: 4px; display: flex; gap: 4px; border: 1px solid #1e293b; }
        .role-btn { padding: 8px 24px; font-family: 'Cinzel', serif; font-size: 11px; font-weight: 900; border-radius: 8px; transition: all 0.3s; color: #475569; text-transform: uppercase; }
        .role-btn.active { background: #d97706; color: white; box-shadow: 0 4px 12px rgba(217, 119, 6, 0.4); }

        .nav-link { font-family: 'Cinzel', serif; color: #94a3b8; font-weight: 900; font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em; transition: color 0.2s; padding-bottom: 6px; border-bottom: 2px solid transparent; }
        .nav-link:hover { color: #f59e0b; }
        .nav-link.active { color: #f59e0b; border-bottom-color: #f59e0b; }
        .nav-link.graveyard { color: #7f1d1d; }

        /* SCRIPT CARD */
        .script-card {
            background-color: #fdfaf3; border: 2px solid #bba683; border-radius: 12px;
            padding: 24px; color: #2c1810; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative; height: 100%; display: flex; flex-direction: column;
        }
        .script-card-header { border-bottom: 2px solid #7a1d1d; margin-bottom: 8px; padding-bottom: 4px; }
        .script-card-title { font-family: 'Cinzel', serif; font-weight: 900; font-size: 24px; color: #7a1d1d; text-transform: uppercase; }
        .script-body { font-size: 14px; line-height: 1.6; white-space: pre-wrap; flex-grow: 1; }

        /* Tooltip */
        .term-hover { position: relative; border-bottom: 1px dotted #7a1d1d; cursor: help; display: inline; }
        .tooltip-content {
            visibility: hidden; width: 220px; background-color: #fdfaf3; color: #2c1810;
            text-align: left; border: 2px solid #7a1d1d; border-radius: 6px; padding: 10px;
            position: absolute; z-index: 100; bottom: 125%; left: 50%; margin-left: -110px;
            opacity: 0; transition: opacity 0.3s; font-size: 11px; font-family: 'Roboto Slab', serif;
        }
        .term-hover:hover .tooltip-content { visibility: visible; opacity: 1; }

        /* Hub Buttons */
        .archive-button {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155; border-radius: 16px; padding: 24px;
            display: flex; align-items: center; gap: 20px; transition: all 0.3s;
            cursor: pointer; width: 100%;
        }
        .archive-button:hover { transform: translateY(-4px); border-color: #f59e0b; }
        .button-label { font-family: 'Cinzel', serif; font-weight: 900; font-size: 18px; color: #f59e0b; text-transform: uppercase; }

        .hidden-view { display: none !important; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1e293b; color: #fff; padding: 12px 24px; border-radius: 30px; z-index: 2000; opacity: 0; transition: opacity 0.3s; pointer-events: none; border: 1px solid #3b82f6; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        .class-tab { padding: 8px 16px; font-size: 10px; font-weight: 900; text-transform: uppercase; cursor: pointer; border: 1px solid #333; border-radius: 4px; color: #94a3b8; }
        .class-tab.active { background: #f59e0b; color: #000; border-color: #f59e0b; }
        .level-bubble { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 11px; cursor: pointer; border: 2px solid #bba683; background: #fdfaf3; }
        .level-bubble.active { background: #7a1d1d; color: #fff; border-color: #7a1d1d; }

        .dm-editable { transition: background 0.2s; border-radius: 4px; }
        .dm-active-edit .dm-editable { background: rgba(122, 29, 29, 0.05); outline: 1px dashed #7a1d1d; padding: 2px; }
        
        .modal-overlay { background: rgba(0,0,0,0.95); backdrop-filter: blur(8px); }
    </style>
</head>
<body class="min-h-screen dashboard-bg">

    <div id="toast" class="toast">Message</div>

    <!-- MAIN HUB -->
    <div id="hub-view" class="p-4 md:p-8">
        <div class="max-w-7xl mx-auto">
            
            <header class="flex flex-col md:flex-row justify-between items-end mb-12 border-b border-gray-800/50 pb-8 gap-6">
                <div class="flex flex-col items-start">
                    <h1 class="brand-title">Aeonfall</h1>
                    <div class="flex items-center gap-6">
                        <p class="brand-sub">Campaign Management Suite</p>
                        <div class="user-pill">
                            <span id="auth-status-dot" class="status-dot"></span>
                            <span id="user-display-name" class="user-name-text">Guest</span>
                            <div id="auth-button-container">
                                <!-- Login/Logout Buttons -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col items-end gap-6 w-full md:w-auto">
                    <div class="role-selector">
                        <button id="role-player-btn" onclick="window.setRole('player')" class="role-btn">Player</button>
                        <button id="role-dm-btn" onclick="window.setRole('dm')" class="role-btn">DM</button>
                    </div>
                    <nav class="flex gap-8 items-center">
                        <a href="index.html" class="nav-link">Party</a>
                        <a href="npcs.html" class="nav-link">NPCs</a>
                        <a href="beasts.html" class="nav-link">Bestiary</a>
                        <a href="backpack.html" class="nav-link">Backpack</a>
                        <a href="#" class="nav-link active">Handbook</a>
                        <a href="index.html" class="nav-link graveyard uppercase">Graveyard</a>
                    </nav>
                </div>
            </header>

            <div class="flex flex-col gap-5 max-w-2xl mx-auto mt-16">
                <a href="https://homebrewery.naturalcrit.com/share/he6P3R1e5dgq" target="_blank" class="archive-button no-underline">
                    <span class="text-4xl">üìñ</span>
                    <div class="flex flex-col">
                        <span class="button-label">Players Handbook</span>
                        <span class="button-desc text-[#64748b] text-[10px] font-bold uppercase">Aeonfall Rules & Mechanics</span>
                    </div>
                    <span class="ml-auto text-amber-900 font-black">‚Üí</span>
                </a>

                <div onclick="window.switchView('scripts')" class="archive-button">
                    <span class="text-4xl">üìú</span>
                    <div class="flex flex-col">
                        <span class="button-label">Script Codex</span>
                        <span class="button-desc text-[#64748b] text-[10px] font-bold uppercase">Class Abilities & Tech Schools</span>
                    </div>
                    <span class="ml-auto text-amber-900 font-black">‚Üí</span>
                </div>

                <div onclick="window.switchView('sessions')" class="archive-button">
                    <span class="text-4xl">üñãÔ∏è</span>
                    <div class="flex flex-col">
                        <span class="button-label">Session Logs</span>
                        <span class="button-desc text-[#64748b] text-[10px] font-bold uppercase">Chronicles of the Party Deeds</span>
                    </div>
                    <span class="ml-auto text-amber-900 font-black">‚Üí</span>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS VIEW -->
    <div id="scripts-view" class="hidden-view p-4 md:p-8">
        <div class="max-w-6xl mx-auto">
            <button onclick="window.switchView('hub')" class="text-amber-500 font-black text-xs uppercase mb-8 hover:text-amber-400">‚Üê Back to Archives</button>
            <div class="flex flex-wrap gap-2 mb-8" id="class-tabs"></div>
            
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <div class="text-center md:text-left">
                    <h2 class="font-serif font-black text-3xl uppercase text-amber-500" id="current-class-title">Scripts</h2>
                    <div class="flex items-center gap-3 mt-4" id="level-nav"></div>
                </div>
                <button id="add-script-btn" onclick="window.addScriptEntry()" class="hidden bg-amber-600 text-white px-8 py-3 rounded-full font-black text-xs uppercase shadow-xl hover:bg-amber-500">+ Inscribe New Script</button>
            </div>
            <div id="scripts-list" class="grid grid-cols-1 md:grid-cols-2 gap-8"></div>
        </div>
    </div>

    <!-- SESSIONS VIEW -->
    <div id="sessions-view" class="hidden-view p-4 md:p-8">
        <div class="max-w-6xl mx-auto">
            <button onclick="window.switchView('hub')" class="text-amber-500 font-black text-xs uppercase mb-8 hover:text-amber-400">‚Üê Back to Archives</button>
            <div class="bg-[#fdfaf3] border-8 border-[#bba683] p-10 text-gray-900 min-h-[600px] shadow-2xl relative">
                <div class="absolute inset-0 border-2 border-[#2c1810] pointer-events-none" style="margin: 4px;"></div>
                <div class="flex justify-between items-end mb-8 border-b-2 border-gray-900 pb-4">
                    <h2 class="font-serif font-black text-3xl uppercase tracking-widest text-[#7a1d1d]">Campaign Chronicles</h2>
                    <button id="add-session-btn" onclick="window.addSessionEntry()" class="hidden bg-amber-800 text-white px-6 py-2 rounded-full font-black text-[10px] uppercase shadow-lg">+ New Session</button>
                </div>
                <div id="sessions-list" class="space-y-20"></div>
            </div>
        </div>
    </div>

    <!-- AUTHENTICATION MODAL -->
    <div id="login-modal" class="fixed inset-0 z-[700] flex items-center justify-center p-4 hidden">
        <div class="modal-overlay absolute inset-0" onclick="document.getElementById('login-modal').classList.add('hidden')"></div>
        <div class="bg-gray-800 p-8 rounded-2xl w-full max-w-sm border-2 border-amber-600 text-white text-center shadow-2xl relative z-10">
            <h3 class="text-xl font-serif text-amber-500 font-bold mb-2 uppercase">Identify Yourself</h3>
            <p class="text-[10px] text-gray-400 mb-6 uppercase tracking-widest">Archive Identity Initialization</p>
            <input type="text" id="login-username-input" placeholder="Enter Player Name" class="w-full bg-gray-900 text-center text-xl rounded-lg p-3 mb-6 border border-gray-700 text-white focus:border-amber-500 focus:outline-none">
            <button onclick="window.confirmLogin()" class="w-full bg-amber-600 hover:bg-amber-500 text-white py-4 rounded-xl font-bold uppercase text-xs transition-all shadow-lg">Access Archives</button>
            <button onclick="document.getElementById('login-modal').classList.add('hidden')" class="w-full text-gray-500 mt-4 text-[10px] uppercase font-bold">Cancel</button>
        </div>
    </div>

    <!-- CLAIM SCRIPT MODAL -->
    <div id="claim-modal" class="fixed inset-0 z-[600] flex items-center justify-center p-4 hidden">
        <div class="modal-overlay absolute inset-0" onclick="document.getElementById('claim-modal').classList.add('hidden')"></div>
        <div class="bg-[#fdfaf3] p-8 rounded-2xl w-full max-w-sm border-8 border-[#bba683] text-center text-gray-900 relative z-10 shadow-2xl">
            <div class="absolute inset-0 border-2 border-[#2c1810] pointer-events-none" style="margin: 4px;"></div>
            <h3 class="text-2xl font-serif font-black text-[#7a1d1d] uppercase mb-4">Initialize Script</h3>
            <div class="text-left mb-6">
                <label class="text-[9px] font-black uppercase text-gray-400 ml-1">Choose Character</label>
                <select id="claim-pc-select" class="w-full bg-white/50 border-2 border-[#bba683] rounded-lg p-3 font-serif text-sm font-bold mt-1 text-[#2c1810] focus:outline-none"></select>
            </div>
            <div class="flex flex-col gap-3">
                <button onclick="window.confirmAddScript()" class="w-full bg-[#7a1d1d] hover:bg-[#902020] text-white py-4 rounded-xl font-black text-xs uppercase shadow-lg transition-all active:scale-95">Link Script Memory</button>
                <button onclick="document.getElementById('claim-modal').classList.add('hidden')" class="w-full text-gray-500 py-2 font-black text-[10px] uppercase">Abort Link</button>
            </div>
        </div>
    </div>

    <!-- DM PASSWORD MODAL -->
    <div id="password-modal" class="fixed inset-0 bg-black/95 flex items-center justify-center z-[500] hidden">
        <div class="bg-gray-800 p-8 rounded-2xl w-full max-w-sm border-2 border-amber-600 text-white text-center shadow-2xl relative z-10">
            <h3 class="text-xl font-serif text-amber-500 font-bold mb-2 uppercase">Dungeon Master Access</h3>
            <input type="password" id="dm-password" class="w-full bg-gray-900 text-center text-2xl rounded-lg p-3 mb-6 border border-gray-700 text-white">
            <button onclick="window.verifyDmPassword()" class="w-full bg-amber-600 text-white py-3 rounded-xl font-bold uppercase text-xs">Unlock Archives</button>
            <button onclick="document.getElementById('password-modal').classList.add('hidden')" class="w-full text-gray-500 mt-4 text-[10px] uppercase font-bold">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, updateDoc, onSnapshot, addDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBLN0KhcnZFKZEYyR0O-Q2mZhKr-iyh7BI", authDomain: "aeonfall-523c1.firebaseapp.com", projectId: "aeonfall-523c1", storageBucket: "aeonfall-523c1.firebasestorage.app", messagingSenderId: "716207733913", appId: "1:716207733913:web:7aac43906a70e2b5f50c08" };
        const appId = 'aeonfall-manager-v2';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const CLASSES = ["Heartbound", "Nomad", "Wilderness Warden", "Chronicler", "Orator", "Scriptweaver", "War-Touched", "Archivist", "Fabricator"];
        const TOOLTIPS = { "Activation Time": "Time to initialize.", "Range/Area": "Maximum distance.", "Components": "Triggers: V, S, M.", "Duration": "How long distortion persists." };

        let currentClass = "Heartbound";
        let currentLevel = 1; 
        let activeRole = 'player';
        let scripts = [], sessions = [], allCharacters = [];
        let autoSaveTimer = null;
        let scriptToClaim = null;

        // --- AUTH & LOGIN (Synced with Index) ---

        window.updateAuthUI = () => {
            const savedUser = localStorage.getItem('aeonfall_user');
            const savedRole = localStorage.getItem('aeonfall_role');
            const userDisplay = document.getElementById('user-display-name');
            const statusDot = document.getElementById('auth-status-dot');
            const authContainer = document.getElementById('auth-button-container');

            if (savedRole === 'dm') activeRole = 'dm';

            if (savedUser) {
                const user = JSON.parse(savedUser);
                userDisplay.textContent = user.username;
                statusDot.classList.remove('offline');
                authContainer.innerHTML = `<button onclick="window.logout()" class="auth-btn logout-btn">Logout</button>`;
            } else {
                userDisplay.textContent = "Guest";
                statusDot.classList.add('offline');
                authContainer.innerHTML = `<button onclick="window.openLogin()" class="auth-btn login-btn">Login</button>`;
            }
            window.updateRoleUI();
        };

        window.openLogin = () => {
            document.getElementById('login-modal').classList.remove('hidden');
            document.getElementById('login-username-input').focus();
        };

        window.confirmLogin = () => {
            const name = document.getElementById('login-username-input').value;
            if (name && name.trim()) {
                const user = { username: name.trim() };
                localStorage.setItem('aeonfall_user', JSON.stringify(user));
                document.getElementById('login-modal').classList.add('hidden');
                window.updateAuthUI();
                window.showToast("Archive Identity Verified");
            }
        };

        window.logout = () => {
            localStorage.removeItem('aeonfall_user');
            localStorage.removeItem('aeonfall_role');
            activeRole = 'player';
            window.updateAuthUI();
            window.showToast("Identity Terminated");
        };

        window.setRole = (role) => {
            if (role === 'dm') {
                if (localStorage.getItem('aeonfall_role') === 'dm') return;
                document.getElementById('password-modal').classList.remove('hidden');
            } else {
                activeRole = 'player';
                localStorage.setItem('aeonfall_role', 'player');
                window.updateRoleUI();
            }
        };

        window.verifyDmPassword = () => {
            if (document.getElementById('dm-password').value === 'Rew4994') {
                activeRole = 'dm';
                localStorage.setItem('aeonfall_role', 'dm');
                document.getElementById('password-modal').classList.add('hidden');
                window.updateRoleUI();
                window.showToast("DM Access Granted");
            } else {
                window.showToast("Unauthorized Command");
            }
        };

        window.updateRoleUI = () => {
            const isDM = activeRole === 'dm';
            document.getElementById('role-player-btn').classList.toggle('active', !isDM);
            document.getElementById('role-dm-btn').classList.toggle('active', isDM);
            document.getElementById('add-script-btn').classList.toggle('hidden', !isDM);
            document.getElementById('add-session-btn').classList.toggle('hidden', !isDM);
            renderLists();
            renderNavs();
        };

        // --- CORE UI ---

        window.showToast = (m) => { const t = document.getElementById('toast'); t.textContent=m; t.style.opacity=1; setTimeout(()=>t.style.opacity=0, 3000); };
        window.switchView = (v) => {
            ['hub', 'scripts', 'sessions'].forEach(id => document.getElementById(`${id}-view`).classList.add('hidden-view'));
            document.getElementById(`${v}-view`).classList.remove('hidden-view');
            window.scrollTo(0,0);
        };
        window.selectClass = (c) => { 
            currentClass = c; 
            if (["Heartbound", "Nomad", "Fabricator"].includes(c)) { if (currentLevel < 1) currentLevel = 1; if (currentLevel > 5) currentLevel = 5; }
            renderNavs(); renderLists(); 
        };
        window.selectLevel = (l) => { currentLevel = l; renderNavs(); renderLists(); };

        function parseAeonfallContent(text, isDM) {
            if (!text) return '';
            if (isDM) return text; 
            let html = text.replace(/&&([^&]+)&&/g, (match, content) => {
                const parts = content.split('|');
                const term = parts[0].trim();
                const definition = parts.length > 1 ? parts[1].trim() : (TOOLTIPS[term] || "Restricted.");
                return `<span class="term-hover def-term">${term}<span class="tooltip-content">${definition}</span></span>`;
            });
            html = html.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\*(.*?)\*/g, '<i>$1</i>').replace(/__(.*?)__/g, '<u>$1</u>');
            return html;
        }

        const renderNavs = () => {
            const tabs = document.getElementById('class-tabs');
            if (tabs) tabs.innerHTML = CLASSES.map(c => `<div class="class-tab ${currentClass === c ? 'active' : ''}" onclick="window.selectClass('${c}')">${c}</div>`).join('');
            const lNav = document.getElementById('level-nav');
            if (lNav) {
                let levels = ["Heartbound", "Nomad", "Fabricator"].includes(currentClass) ? [1, 2, 3, 4, 5] : [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
                lNav.innerHTML = levels.map(l => `<div class="level-bubble ${currentLevel === l ? 'active' : ''}" onclick="window.selectLevel(${l})">${l === 0 ? 'T' : l}</div>`).join('');
            }
            const title = document.getElementById('current-class-title');
            if (title) title.textContent = `${currentClass} ${currentLevel === 0 ? 'Tricks' : 'Lv. ' + currentLevel}`;
        };

        const renderLists = () => {
            const isDM = activeRole === 'dm';
            const sList = document.getElementById('scripts-list');
            if (sList) {
                sList.innerHTML = '';
                scripts.filter(s => parseInt(s.level) === currentLevel && (s.scriptLists || '').toLowerCase().includes(currentClass.toLowerCase())).forEach(s => {
                    const card = document.createElement('div');
                    card.className = "script-card";
                    card.innerHTML = `
                        <div class="script-card-header"><div class="script-card-title dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdate('${s.id}', 'title', this.innerText)">${s.title}</div></div>
                        <span class="script-card-level">${s.level === 0 ? 'Trick' : s.level + '-level'} ‚Äî <span class="dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdate('${s.id}', 'school', this.innerText)">${s.school || 'Dominion'}</span></span>
                        <div class="script-body py-4 ${isDM ? 'dm-editable' : ''}" contenteditable="${isDM}" oninput="window.debounceUpdate('${s.id}', 'content', this.innerText)">${parseAeonfallContent(s.content, isDM)}</div>
                        <button onclick="window.openClaimModal('${s.id}')" class="mt-auto w-full bg-[#2c1810]/5 border border-[#7a1d1d33] py-2 rounded-lg text-[#7a1d1d] font-black text-[10px] uppercase transition-all">+ Claim Script</button>
                    `;
                    sList.appendChild(card);
                });
            }
            // Sessions Log logic
            const sessList = document.getElementById('sessions-list');
            if (sessList) {
                sessList.innerHTML = '';
                sessions.forEach(s => {
                    const div = document.createElement('div');
                    div.className = "relative p-4 border-b border-gray-100";
                    div.innerHTML = `<h4 class="font-bold">${s.title}</h4><p class="text-sm italic">${s.date}</p>`;
                    sessList.appendChild(div);
                });
            }
        };

        window.openClaimModal = (scriptId) => {
            scriptToClaim = scripts.find(s => s.id === scriptId);
            const select = document.getElementById('claim-pc-select');
            select.innerHTML = '';
            const saved = localStorage.getItem('aeonfall_user');
            if (!saved) return window.showToast("Identify yourself to initialize script.");
            const userObj = JSON.parse(saved);
            const myChars = allCharacters.filter(c => c.owner === userObj.username && c.type === 'PC' && !c.isDeleted);
            if (myChars.length === 0) select.innerHTML = '<option value="">No characters discovered.</option>';
            else myChars.forEach(c => { const opt = document.createElement('option'); opt.value = c.id; opt.textContent = c.name; select.appendChild(opt); });
            document.getElementById('claim-modal').classList.remove('hidden');
        };

        window.confirmAddScript = async () => {
            const charId = document.getElementById('claim-pc-select').value;
            if (!charId || !scriptToClaim) return;
            const char = allCharacters.find(c => c.id === charId);
            
            // Format for the "Scriptcasting" boxes in index.html
            const level = scriptToClaim.level === 0 ? "0" : String(scriptToClaim.level);
            const cleanContent = scriptToClaim.content.replace(/&&([^|&]+)(?:\|[^&]+)?&&/g, '$1').replace(/\*\*|\*|__/g, '');
            
            // Entry format specifically for the grid boxes shown in your screenshot
            const scriptEntry = `[${scriptToClaim.title.toUpperCase()}]\n${cleanContent}\n\n`;
            
            // Handle structured scriptcasting (Object/Map based on level)
            let scData = char.scriptcasting || {};
            
            // If current scriptcasting is a string (old format), convert to object
            if (typeof scData === 'string') {
                scData = { "0": scData };
            }
            
            // Append to the specific level bucket
            const existingLevelData = scData[level] || "";
            scData[level] = existingLevelData + scriptEntry;
            
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'characters', charId), { 
                scriptcasting: scData 
            });
            
            window.showToast(`Claimed: ${scriptToClaim.title} (Level ${level})`);
            document.getElementById('claim-modal').classList.add('hidden');
        };

        window.debounceUpdate = (id, field, val) => {
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => { updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookScripts', id), { [field]: val }); }, 1000);
        };

        // Initialize
        (async () => {
            await signInAnonymously(auth);
            window.updateAuthUI();
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'handbookScripts'), (snap) => { scripts = snap.docs.map(d => ({id: d.id, ...d.data()})); renderLists(); });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'handbookSessions'), (snap) => { sessions = snap.docs.map(d => ({id: d.id, ...d.data()})); renderLists(); });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'characters'), (snap) => { allCharacters = snap.docs.map(d => ({id: d.id, ...d.data()})); });
        })();

    </script>
</body>
</html>
