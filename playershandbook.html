<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aeonfall - Player's Handbook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Roboto+Slab:wght@300;400;700&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto Slab', serif; background-color: #1a1a1a; color: #e2e8f0; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .dashboard-bg { background-image: url('https://www.transparenttextures.com/patterns/dark-wood.png'); background-color: #0c0c0c; }
        
        /* HEADER STYLING - MATCHING BRANDING */
        .brand-title { font-family: 'Cinzel', serif; font-weight: 900; color: #f59e0b; line-height: 1; margin-bottom: 0.2rem; }
        .brand-sub { font-family: 'Cinzel', serif; font-size: 10px; font-weight: 700; color: #64748b; letter-spacing: 0.15em; text-transform: uppercase; }
        
        .user-pill { background: rgba(30, 41, 59, 0.6); border: 1px solid #334155; padding: 6px 14px; border-radius: 99px; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .status-dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 10px #22c55e; }
        .user-name-text { font-family: 'Cinzel', serif; font-size: 10px; font-weight: 900; color: #e2e8f0; text-transform: uppercase; }
        .logout-btn { font-family: 'Cinzel', serif; font-size: 10px; font-weight: 700; color: #ef4444; border-left: 1px solid #475569; padding-left: 8px; margin-left: 4px; cursor: pointer; }
        
        .role-selector { background: #0f172a; border-radius: 12px; padding: 4px; display: flex; gap: 4px; border: 1px solid #1e293b; width: fit-content; }
        .role-btn { padding: 6px 16px; font-family: 'Cinzel', serif; font-size: 10px; font-weight: 900; border-radius: 8px; transition: all 0.3s; color: #475569; text-transform: uppercase; }
        .role-btn.active { background: #d97706; color: white; box-shadow: 0 4px 12px rgba(217, 119, 6, 0.4); }

        .nav-link { font-family: 'Cinzel', serif; color: #94a3b8; font-weight: 900; font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; transition: color 0.2s; padding-bottom: 4px; border-bottom: 2px solid transparent; white-space: nowrap; }
        .nav-link:hover { color: #f59e0b; }
        .nav-link.active { color: #f59e0b; border-bottom-color: #f59e0b; }
        .nav-link.graveyard { color: #7f1d1d; }

        /* SCRIPT/ITEM CARD Aesthetic */
        .script-card {
            background-color: #fdfaf3; border: 2px solid #bba683; border-radius: 12px;
            padding: 20px; color: #2c1810; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative; height: 100%; display: flex; flex-direction: column;
            transition: all 0.3s;
        }
        .script-card-header { border-bottom: 2px solid #7a1d1d; margin-bottom: 8px; padding-bottom: 4px; }
        .script-card-title { font-family: 'Cinzel', serif; font-weight: 900; font-size: 20px; color: #7a1d1d; text-transform: uppercase; }
        .script-card-level { font-style: italic; font-size: 13px; margin-bottom: 12px; display: block; }
        .script-prop-list { list-style: disc; margin-left: 18px; font-size: 13px; margin-bottom: 16px; }
        .script-prop-list li { margin-bottom: 2px; }
        .script-prop-list b { font-weight: 900; }
        .script-body { font-size: 13px; line-height: 1.6; white-space: pre-wrap; flex-grow: 1; }
        .script-higher-levels { font-size: 12px; margin-top: 12px; padding-top: 12px; border-top: 1px dotted #7a1d1d33; }
        .script-higher-levels b { font-weight: 900; }
        .script-footer { font-style: italic; font-size: 11px; margin-top: 12px; border-top: 1px solid #7a1d1d33; padding-top: 8px; }
        .script-footer b { font-weight: 900; font-style: normal; }

        /* Item Lore/Description Distinction */
        .item-flavor-text { color: #6b4423; font-style: italic; border-left: 2px solid #bba68344; padding-left: 10px; margin-bottom: 16px; font-size: 12px; line-height: 1.5; }
        .item-description-label { font-family: 'Cinzel', serif; font-size: 9px; font-weight: 900; text-transform: uppercase; color: #7a1d1d; letter-spacing: 0.1em; display: block; margin-bottom: 4px; border-bottom: 1px solid #7a1d1d11; }

        /* Landmark Specifics */
        .personal-tie-badge { background: #7a1d1d; color: white; padding: 3px 10px; border-radius: 4px; font-size: 9px; font-weight: 900; text-transform: uppercase; margin-top: 8px; display: inline-flex; align-items: center; gap: 6px; letter-spacing: 0.1em; }
        .tie-button { font-size: 9px; text-transform: uppercase; font-weight: 900; color: #d97706; border: 1px solid #d9770633; padding: 2px 6px; border-radius: 4px; cursor: pointer; transition: all 0.2s; }
        .tie-button:hover { background: #d9770611; }
        .intel-block { background: rgba(122, 29, 29, 0.05); border: 1px solid rgba(122, 29, 29, 0.1); border-left: 4px solid #7a1d1d; padding: 12px; margin: 12px 0; border-radius: 4px; font-size: 11px; color: #2c1810; }

        /* Search Input Styling */
        .neural-search { background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; border-radius: 12px; padding: 12px 20px; color: #fff; width: 100%; outline: none; transition: all 0.3s; font-family: 'Cinzel', serif; font-size: 14px; letter-spacing: 0.05em; }
        .neural-search:focus { border-color: #f59e0b; box-shadow: 0 0 15px rgba(245, 158, 11, 0.2); }
        .neural-search::placeholder { color: #475569; text-transform: uppercase; font-size: 10px; font-weight: 900; }

        /* Progression Table Styling */
        .progression-table-container { 
            background-color: #fdfaf3; border: 4px double #bba683; border-radius: 12px; 
            padding: 16px; color: #2c1810; margin-bottom: 24px; overflow-x: auto;
            position: relative;
        }
        .progression-table { width: 100%; min-width: 500px; border-collapse: collapse; font-size: 12px; }
        .progression-table th { 
            font-family: 'Cinzel', serif; font-weight: 900; text-transform: uppercase; 
            color: #7a1d1d; border-bottom: 2px solid #7a1d1d; padding: 10px 6px; text-align: left;
            background: rgba(122, 29, 29, 0.02);
        }
        .progression-table td { padding: 8px 6px; border-bottom: 1px solid rgba(122, 29, 29, 0.1); }

        /* Archetype Heading Styling */
        .archetype-divider { 
            grid-column: 1 / -1; margin: 32px 0 16px 0; 
            border-left: 6px solid #f59e0b; background: rgba(245, 158, 11, 0.05);
            padding: 12px 16px; border-radius: 4px 12px 12px 4px;
            display: flex; align-items: center; justify-content: space-between;
            flex-wrap: wrap; gap: 12px;
        }
        .archetype-name { font-family: 'Cinzel', serif; font-weight: 900; font-size: 20px; color: #f59e0b; text-transform: uppercase; letter-spacing: 0.1em; }
        .archetype-controls { display: flex; gap: 6px; flex-wrap: wrap; }
        .arch-btn { font-size: 9px; font-weight: 900; text-transform: uppercase; padding: 4px 10px; border-radius: 4px; cursor: pointer; }

        /* Scrollable Navs for Mobile */
        .horizontal-scroll {
            display: flex; overflow-x: auto; gap: 8px; padding-bottom: 4px;
            scrollbar-width: none; -ms-overflow-style: none;
        }
        .horizontal-scroll::-webkit-scrollbar { display: none; }

        /* Tooltip behavior on mobile */
        .term-hover { border-bottom: 1px dotted #7a1d1d; cursor: help; position: relative; }
        .tooltip-content {
            visibility: hidden; width: 200px; background-color: #fdfaf3; color: #2c1810;
            text-align: left; border: 2px solid #7a1d1d; border-radius: 6px; padding: 8px;
            position: absolute; z-index: 100; bottom: 125%; left: 50%; transform: translateX(-50%);
            opacity: 0; transition: opacity 0.3s; font-size: 11px; line-height: 1.4;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); pointer-events: none;
        }
        .term-hover:hover .tooltip-content { visibility: visible; opacity: 1; }

        /* Hub Buttons Responsive */
        .archive-button {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155; border-radius: 16px; padding: 16px 20px;
            display: flex; align-items: center; gap: 16px; transition: all 0.3s;
            cursor: pointer; width: 100%;
        }
        .archive-button:hover { border-color: #f59e0b; }
        .button-label { font-family: 'Cinzel', serif; font-weight: 900; font-size: 16px; color: #f59e0b; text-transform: uppercase; }
        .button-desc { font-size: 9px; color: #64748b; text-transform: uppercase; font-weight: 700; margin-top: 1px; }

        .hidden-view { display: none !important; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1e293b; color: #fff; padding: 10px 20px; border-radius: 30px; z-index: 2000; opacity: 0; transition: opacity 0.3s; border: 1px solid #3b82f6; }
        
        .class-tab { padding: 6px 12px; font-size: 9px; font-weight: 900; text-transform: uppercase; cursor: pointer; border: 1px solid #333; border-radius: 4px; color: #94a3b8; white-space: nowrap; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .class-tab.active { background: #f59e0b; color: #000; border-color: #f59e0b; }
        .class-tab.locked { opacity: 0.3; grayscale: 100%; cursor: not-allowed; }
        .dm-tab-lock-icon { cursor: pointer; font-size: 10px; opacity: 0.6; }
        .dm-tab-lock-icon:hover { opacity: 1; color: #f59e0b; }

        .level-bubble { min-width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 10px; cursor: pointer; border: 2px solid #bba683; background: #fdfaf3; color: #2c1810; flex-shrink: 0; }
        .level-bubble.active { background: #7a1d1d; color: #fff; border-color: #7a1d1d; }

        .section-label { font-size: 9px; text-transform: uppercase; font-weight: 900; color: #f59e0b; opacity: 0.5; margin-bottom: 6px; letter-spacing: 0.2em; display: block; border-bottom: 1px solid rgba(245, 158, 11, 0.1); padding-bottom: 3px; }

        /* Sub-tab styling */
        .sub-nav-container { margin-top: 8px; border-top: 1px solid rgba(245, 158, 11, 0.1); padding-top: 8px; }
        .sub-tab { border-style: dashed; }

        /* DM Specific UI */
        .dm-active-edit { position: relative; }
        .dm-editable { outline: none; transition: background 0.2s; border-radius: 4px; }
        .dm-editable:hover, .dm-editable:focus { background: rgba(0,0,0,0.05); }
        .drag-handle { cursor: grab; opacity: 0.3; transition: opacity 0.2s; }
        .drag-handle:hover { opacity: 1; }
        .classification-pill { font-size: 10px; font-weight: 900; color: #7a1d1d; cursor: pointer; text-decoration: underline dotted; }

        /* Item Preview Img */
        .item-preview-img { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; border: 2px solid #bba683; margin-bottom: 16px; cursor: pointer; }
        .item-url-input { font-size: 8px; font-family: monospace; color: #94a3b8; margin-bottom: 8px; display: block; overflow: hidden; text-overflow: ellipsis; }

        @media (max-width: 768px) {
            .brand-title { font-size: 2.5rem; }
            .script-card-title { font-size: 18px; }
            .archive-button { padding: 12px 16px; }
            .button-label { font-size: 14px; }
            .button-desc { font-size: 8px; }
        }
    </style>
</head>
<body class="min-h-screen dashboard-bg">

    <div id="toast" class="toast">Message</div>

    <!-- MAIN HUB -->
    <div id="hub-view" class="p-4 md:p-8">
        <div class="max-w-7xl mx-auto">
            
            <header class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 md:mb-12 border-b border-gray-800/50 pb-6 md:pb-8 gap-6">
                <div class="flex flex-col items-start w-full md:w-auto">
                    <h1 class="brand-title text-4xl md:text-6xl">Aeonfall</h1>
                    <div class="flex flex-wrap items-center gap-4 mt-1">
                        <p class="brand-sub">Campaign Suite</p>
                        <div class="user-pill">
                            <span class="status-dot"></span>
                            <span id="user-display-name" class="user-name-text">Guest</span>
                            <button onclick="window.logout()" class="logout-btn uppercase">Logout</button>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col items-start md:items-end gap-5 w-full md:w-auto overflow-hidden">
                    <div class="role-selector">
                        <button id="role-player-btn" onclick="window.setRole('player')" class="role-btn">Player</button>
                        <button id="role-dm-btn" onclick="window.setRole('dm')" class="role-btn">DM</button>
                    </div>
                    <nav class="horizontal-scroll w-full md:w-auto gap-5 md:gap-8 border-b border-transparent">
                        <a href="index.html" class="nav-link">Party</a>
                        <a href="npcs.html" class="nav-link">NPCs</a>
                        <a href="beasts.html" class="nav-link">Bestiary</a>
                        <a href="partybag.html" class="nav-link">Backpack</a>
                        <a href="#" class="nav-link active">Handbook</a>
                        <a href="#" onclick="window.setView('graveyard'); return false;" id="nav-graveyard" class="nav-link !text-red-900">Graveyard</a>
                    </nav>
                </div>
            </header>

            <div class="flex flex-col gap-4 max-w-xl mx-auto mt-8 md:mt-12 pb-16">
                <a href="howtoplay.html" class="archive-button no-underline">
                    <span class="text-3xl md:text-4xl">üé≤</span>
                    <div class="flex flex-col text-left">
                        <span class="button-label">How to Play</span>
                        <span class="button-desc">Rules & Operations</span>
                    </div>
                    <span class="ml-auto text-amber-900 font-black">‚Üí</span>
                </a>

                <a href="lineages.html" class="archive-button no-underline">
                    <span class="text-3xl md:text-4xl">üß¨</span>
                    <div class="flex flex-col text-left">
                        <span class="button-label">Lineages</span>
                        <span class="button-desc">Biological Heritage</span>
                    </div>
                    <span class="ml-auto text-amber-900 font-black">‚Üí</span>
                </a>

                <a href="classes.html" class="archive-button no-underline">
                    <span class="text-3xl md:text-4xl">üõ°Ô∏è</span>
                    <div class="flex flex-col text-left">
                        <span class="button-label">Vocations</span>
                        <span class="button-desc">Class Identities</span>
                    </div>
                    <span class="ml-auto text-amber-900 font-black">‚Üí</span>
                </a>

                <div onclick="window.switchView('landmarks')" class="archive-button">
                    <span class="text-3xl md:text-4xl">üìç</span>
                    <div class="flex flex-col">
                        <span class="button-label">Landmarks</span>
                        <span class="button-desc">Locations & Discoveries</span>
                    </div>
                    <span class="ml-auto text-amber-900 font-black">‚Üí</span>
                </div>

                <div onclick="window.switchView('scripts')" class="archive-button">
                    <span class="text-3xl md:text-4xl">üìú</span>
                    <div class="flex flex-col">
                        <span class="button-label">Script Codex</span>
                        <span class="button-desc">Code Abilities</span>
                    </div>
                    <span class="ml-auto text-amber-900 font-black">‚Üí</span>
                </div>

                <div onclick="window.switchView('sessions')" class="archive-button">
                    <span class="text-3xl md:text-4xl">üñãÔ∏è</span>
                    <div class="flex flex-col">
                        <span class="button-label">Session Logs</span>
                        <span class="button-desc">Party Chronicles</span>
                    </div>
                    <span class="ml-auto text-amber-900 font-black">‚Üí</span>
                </div>

                <div onclick="window.switchView('items')" class="archive-button">
                    <span class="text-3xl md:text-4xl">‚öîÔ∏è</span>
                    <div class="flex flex-col">
                        <span class="button-label">Gear & Artifacts</span>
                        <span class="button-desc">Loot & Hardware</span>
                    </div>
                    <span class="ml-auto text-amber-900 font-black">‚Üí</span>
                </div>

                <a href="lore.html" class="archive-button no-underline">
                    <span class="text-3xl md:text-4xl">üåç</span>
                    <div class="flex flex-col text-left">
                        <span class="button-label">World Lore</span>
                        <span class="button-desc">History & Culture</span>
                    </div>
                    <span class="ml-auto text-amber-900 font-black">‚Üí</span>
                </a>
            </div>
        </div>
    </div>

    <!-- FEATURES VIEW -->
    <div id="features-view" class="hidden-view p-4 md:p-8">
        <div class="max-w-6xl mx-auto">
            <button onclick="window.switchView('hub')" class="text-amber-500 font-black text-[10px] uppercase mb-6 hover:text-amber-400">‚Üê Back</button>
            
            <div class="mb-8">
                <span class="section-label">Martial Classes</span>
                <div class="horizontal-scroll mb-6" id="feature-martial-tabs"></div>
                
                <span class="section-label">Script Users</span>
                <div class="horizontal-scroll" id="feature-script-tabs"></div>
            </div>
            
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div class="text-left">
                    <h2 class="font-serif font-black text-2xl md:text-3xl uppercase text-amber-500" id="current-feature-title">Feature Moves</h2>
                    <p class="text-[9px] text-amber-900/60 font-black uppercase tracking-widest mt-1" id="current-feature-class-label">Vanguard Features</p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button id="add-table-btn" onclick="window.addTableEntry()" class="hidden bg-amber-900/80 text-white px-4 py-2 rounded-full font-black text-[9px] uppercase">Add Table</button>
                    <button id="add-archetype-btn" onclick="window.addArchetypeEntry()" class="hidden bg-amber-800 text-white px-4 py-2 rounded-full font-black text-[9px] uppercase">Add Archetype</button>
                    <button id="add-feature-btn" onclick="window.addFeatureEntry()" class="hidden bg-amber-600 text-white px-5 py-2 rounded-full font-black text-[9px] uppercase">+ Document Move</button>
                </div>
            </div>

            <div id="features-list" class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8"></div>
        </div>
    </div>

    <!-- SCRIPTS VIEW -->
    <div id="scripts-view" class="hidden-view p-4 md:p-8">
        <div class="max-w-6xl mx-auto">
            <button onclick="window.switchView('hub')" class="text-amber-500 font-black text-[10px] uppercase mb-6 hover:text-amber-400">‚Üê Back</button>
            <div class="horizontal-scroll mb-8" id="class-tabs"></div>
            
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-6">
                <div class="text-left w-full">
                    <h2 class="font-serif font-black text-2xl md:text-3xl uppercase text-amber-500" id="current-class-title">Scripts</h2>
                    <div class="horizontal-scroll mt-4" id="level-nav"></div>
                </div>
                <button id="add-script-btn" onclick="window.addScriptEntry()" class="hidden bg-amber-600 text-white px-6 py-2 rounded-full font-black text-[9px] uppercase">+ New Script</button>
            </div>
            <div id="scripts-list" class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8"></div>
        </div>
    </div>

    <!-- LANDMARKS VIEW -->
    <div id="landmarks-view" class="hidden-view p-4 md:p-8">
        <div class="max-w-6xl mx-auto">
            <button onclick="window.switchView('hub')" class="text-amber-500 font-black text-[10px] uppercase mb-6 hover:text-amber-400">‚Üê Back</button>
            
            <div class="landmark-nav-wrapper">
                <div class="horizontal-scroll mb-2" id="landmark-region-tabs"></div>
                <div class="sub-nav-container hidden" id="fractured-planes-subnav">
                    <span class="section-label">Planes of the Fracture</span>
                    <div class="horizontal-scroll mb-8" id="fractured-planes-tabs"></div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div class="text-left">
                    <h2 class="font-serif font-black text-2xl md:text-3xl uppercase text-amber-500">Landmarks</h2>
                    <p class="text-[9px] text-amber-900/60 font-black uppercase tracking-widest mt-1" id="current-landmark-region-title">All Discoveries</p>
                </div>
                <button id="add-landmark-btn" onclick="window.addLandmarkEntry()" class="hidden bg-amber-600 text-white px-6 py-2 rounded-full font-black text-[9px] uppercase">+ New Landmark</button>
            </div>
            <div id="landmarks-list" class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8"></div>
        </div>
    </div>

    <!-- SESSIONS VIEW -->
    <div id="sessions-view" class="hidden-view p-4 md:p-8">
        <div class="max-w-6xl mx-auto">
            <button onclick="window.switchView('hub')" class="text-amber-500 font-black text-[10px] uppercase mb-6 hover:text-amber-400">‚Üê Back</button>
            <div class="bg-[#fdfaf3] border-4 md:border-8 border-[#bba683] p-4 md:p-10 text-gray-900 min-h-[400px] shadow-2xl relative">
                <div class="absolute inset-0 border-2 border-[#2c1810] pointer-events-none" style="margin: 2px;"></div>
                <div class="flex flex-wrap justify-between items-end mb-8 border-b-2 border-gray-900 pb-4 gap-4">
                    <h2 class="font-serif font-black text-xl md:text-3xl uppercase tracking-widest text-[#7a1d1d]">Campaign Chronicles</h2>
                    <button id="add-session-btn" onclick="window.addSessionEntry()" class="hidden bg-amber-800 text-white px-4 py-2 rounded-full font-black text-[9px] uppercase">+ New Session</button>
                </div>
                <div id="sessions-list" class="space-y-12 md:space-y-20"></div>
            </div>
        </div>
    </div>

    <!-- ITEMS VIEW -->
    <div id="items-view" class="hidden-view p-4 md:p-8">
        <div class="max-w-6xl mx-auto">
            <button onclick="window.switchView('hub')" class="text-amber-500 font-black text-[10px] uppercase mb-6 hover:text-amber-400">‚Üê Back</button>
            
            <div class="mb-6">
                <input type="text" id="item-search-input" placeholder="Neural Search: Enter weapon, armor, or artifact name..." class="neural-search" oninput="window.handleItemSearch(this.value)">
            </div>

            <div class="horizontal-scroll mb-8" id="item-category-tabs"></div>
            
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div class="text-left">
                    <h2 class="font-serif font-black text-2xl md:text-3xl uppercase text-amber-500">Gear & Artifacts</h2>
                    <p class="text-[9px] text-amber-900/60 font-black uppercase tracking-widest mt-1" id="current-item-category-title">All Equipment</p>
                </div>
                <button id="add-item-btn" onclick="window.addItemEntry()" class="hidden bg-amber-600 text-white px-6 py-2 rounded-full font-black text-[9px] uppercase">+ New Item</button>
            </div>
            <div id="items-list" class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8"></div>
        </div>
    </div>

    <!-- LIGHTBOX MODAL -->
    <div id="lightbox-modal" class="fixed inset-0 z-[1000] flex items-center justify-center p-4 hidden">
        <div class="modal-overlay absolute inset-0 bg-black/80" onclick="document.getElementById('lightbox-modal').classList.add('hidden')"></div>
        <div class="relative z-10 flex flex-col items-center gap-4 w-full">
            <img id="lightbox-img" src="" alt="Zoomed Asset" class="max-w-full max-h-[80vh] border-4 border-[#bba683] rounded-xl shadow-2xl">
            <button onclick="document.getElementById('lightbox-modal').classList.add('hidden')" class="bg-amber-600 text-white px-6 py-2 rounded-full font-black text-[9px] uppercase tracking-widest">Close Optical Feed</button>
        </div>
    </div>

    <!-- DELETE CONFIRMATION MODAL -->
    <div id="delete-modal" class="fixed inset-0 z-[600] flex items-center justify-center p-4 hidden">
        <div class="modal-overlay absolute inset-0 bg-black/50" onclick="document.getElementById('delete-modal').classList.add('hidden')"></div>
        <div class="bg-white p-6 rounded-2xl w-full max-w-xs border-4 border-red-600 text-center text-gray-900 relative z-10 shadow-2xl">
            <h3 class="text-xl font-serif font-black text-red-700 uppercase mb-2">Disposal</h3>
            <p class="text-xs text-gray-500 mb-6 italic leading-relaxed">This record will be permanently erased.</p>
            <div class="flex flex-col gap-2">
                <button id="confirm-delete-btn" class="w-full bg-red-700 text-white py-3 rounded-xl font-black text-[10px] uppercase">Erase Permanently</button>
                <button onclick="document.getElementById('delete-modal').classList.add('hidden')" class="w-full bg-gray-100 text-gray-500 py-2 rounded-xl font-black text-[9px] uppercase">Cancel</button>
            </div>
        </div>
    </div>

    <!-- PERSONAL TIE MODAL -->
    <div id="tie-modal" class="fixed inset-0 z-[600] flex items-center justify-center p-4 hidden">
        <div class="modal-overlay absolute inset-0 bg-black/50" onclick="document.getElementById('tie-modal').classList.add('hidden')"></div>
        <div class="bg-gray-800 p-6 rounded-2xl w-full max-w-xs border-2 border-amber-600 text-white text-center relative z-10 shadow-2xl">
            <h3 class="text-lg font-serif text-amber-500 font-bold mb-2 uppercase">Establish Personal Tie</h3>
            <p class="text-[9px] text-gray-400 mb-4 italic">Assign a username. Only this user (and the DM) will be able to see the confidential data bound to this landmark.</p>
            <input type="text" id="tie-username-input" placeholder="Enter Username" class="w-full bg-gray-900 text-center rounded-lg p-3 mb-4 border border-gray-700 outline-none text-sm">
            <div class="flex flex-col gap-2">
                <button onclick="window.saveLandmarkTie()" class="w-full bg-amber-600 text-white py-3 rounded-xl font-bold uppercase text-[10px]">Bind Identity</button>
                <button id="sever-tie-btn" onclick="window.clearLandmarkTie()" class="w-full bg-red-900/40 text-red-400 py-2 rounded-xl font-bold uppercase text-[10px] hidden">Sever Connection</button>
                <button onclick="document.getElementById('tie-modal').classList.add('hidden')" class="w-full text-gray-500 mt-2 text-[9px] uppercase font-bold">Cancel</button>
            </div>
        </div>
    </div>

    <!-- DM PASSWORD MODAL -->
    <div id="password-modal" class="fixed inset-0 bg-black/95 flex items-center justify-center z-[500] hidden">
        <div class="bg-gray-800 p-6 rounded-2xl w-full max-w-xs border-2 border-amber-600 text-white text-center shadow-2xl mx-4">
            <h3 class="text-lg font-serif text-amber-500 font-bold mb-2 uppercase">DM Access</h3>
            <input type="password" id="dm-password" class="w-full bg-gray-900 text-center text-xl rounded-lg p-3 mb-4 border border-gray-700 outline-none">
            <button onclick="window.verifyDmPassword()" class="w-full bg-amber-600 text-white py-3 rounded-xl font-bold uppercase text-[10px]">Unlock Archives</button>
            <button onclick="document.getElementById('password-modal').classList.add('hidden')" class="w-full text-gray-500 mt-4 text-[9px] uppercase font-bold">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, updateDoc, setDoc, onSnapshot, addDoc, deleteDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBLN0KhcnZFKZEYyR0O-Q2mZhKr-iyh7BI", authDomain: "aeonfall-523c1.firebaseapp.com", projectId: "aeonfall-523c1", storageBucket: "aeonfall-523c1.firebasestorage.app", messagingSenderId: "716207733913", appId: "1:716207733913:web:7aac43906a70e2b5f50c08" };
        const appId = 'aeonfall-manager-v2';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const CLASSES = ["Heartbound", "Nomad", "Wilderness Warden", "Chronicler", "Orator", "Scriptweaver", "War-Touched", "Archivist", "Fabricator"];
        const FEATURE_MARTIAL_CLASSES = ["Vanguard", "Warrior", "Peacekeeper", "Scavenger"];
        const ITEM_CATEGORIES = ["All", "Weapons", "Armor", "Material Component", "Adventuring Gear", "Transportation", "Artifacts", "Recipes & Consumables"];
        const LANDMARK_REGIONS = ["All", "Havendor", "Tormarath", "Vorastra", "Eryndor", "Fractured Planes"];
        const DEFAULT_PLANES = ["Umbraclast Veil", "Thornsong Wilds", "Luminara Drift", "Hollow Expanse", "Ember Expanse"];

        const TOOLTIPS = {
            "Activation Time": "The amount of time required to initialize this script and push it to reality.",
            "Range/Area": "The maximum distance the script can reach, or the spatial dimensions of its effect.",
            "Components": "Triggers: Verbal (Commands), Somatic (Gestures), or Material (Items).",
            "Duration": "How long the reality-distortion persists before the script expires.",
            "At Higher Levels": "Scaling effects when using higher level script slots.",
            "Concord": "Ritual Protocol: This script can be initialized through ritualistic focus, conserving internal energy reserves.",
            "Mechanum": "Technomagic Protocol: This script utilizes specialized hardware and digital distortion to warp reality through code.",
            "Attack Roll": "A d20 roll + modifiers used to determine if an offensive script strike lands.",
            "Saving Throw": "A roll made by the target to resist or mitigate the incoming script's effects.",
            "Concentration": "Requires continuous focus. Ends if incapacitated or if you fail a check when taking damage.",
            "Damage": "Physical, energy, or digital integrity loss caused by the script output.",
            "V": "Verbal: Requires spoken command strings.",
            "S": "Somatic: Requires precise hand gestures.",
            "M": "Material: Requires a specific component consumed by the distortion.",
            "Script Lists": "Authorized user-groups for this specific code block.",
            "d4": "A four-sided die commonly used for minor adjustments or predictive boosts.",
            "d6": "A six-sided die, the standard unit for energy-output measurement.",
            "d8": "An eight-sided die, typically used for significant physical or kinetic impact.",
            "d10": "A ten-sided die for heavy-duty calculations and high-output scripts.",
            "d12": "A twelve-sided die for massive atmospheric or biological shifts.",
            "d20": "A twenty-sided die used to determine the success of an action.",
            "Aegis": "Aegis governs protection, prevention, and resistance, creating wards that block, absorb, or negate harm.",
            "Calling": "Calling governs summoning and creation, drawing creatures, objects, or forces into existence or from elsewhere.",
            "Sight": "Sight governs information and foresight, revealing truths, patterns, and possibilities beyond normal perception.",
            "Dominion": "Dominion governs will and influence, shaping thoughts, emotions, and behavior through directed intent.",
            "Ruin": "Ruin governs raw energy and destruction, unleashing elemental and forceful power to damage or overwhelm.",
            "Veil": "Veil governs sensory manipulation, altering what creatures see, hear, or believe to create deception.",
            "Mortis": "Mortis governs biological failure and recovery, managing decay, stabilization, and vitality at the edge of life.",
            "Forge": "Forge governs transformation, reshaping matter, bodies, and materials into new forms."
        };

        let currentClass = "Heartbound";
        let currentFeatureClass = "Vanguard";
        let currentLevel = 1; 
        let currentItemCategory = "All";
        let itemSearchQuery = "";
        let currentLandmarkRegion = "All";
        let regionVisibility = { Tormarath: false, Vorastra: false, Eryndor: false, "Fractured Planes": false, Havendor: true };
        let planeNames = [...DEFAULT_PLANES];
        let activeRole = 'player';
        let scripts = [], sessions = [], items = [], features = [], archetypes = [], tables = [], landmarks = [];
        let itemSeeds = {}; // For stable randomization
        let autoSaveTimer = null;
        let itemToDeleteId = null;
        let activeLandmarkId = null;
        let deleteType = ''; 

        window.showToast = (m) => { const t = document.getElementById('toast'); t.textContent=m; t.style.opacity=1; setTimeout(()=>t.style.opacity=0, 4000); };

        window.setRole = (r) => { 
            if (r === 'dm') {
                if (localStorage.getItem('aeonfall_role') === 'dm') return;
                document.getElementById('password-modal').classList.remove('hidden'); 
            } else { 
                activeRole = 'player'; localStorage.setItem('aeonfall_role', 'player'); window.updateRoleUI(); 
            } 
        };
        
        window.verifyDmPassword = () => { 
            if (document.getElementById('dm-password').value === 'Rew4994') { 
                activeRole = 'dm'; localStorage.setItem('aeonfall_role', 'dm'); document.getElementById('password-modal').classList.add('hidden'); window.updateRoleUI(); 
            } else { window.showToast("Access Denied"); } 
        };

        window.logout = () => { localStorage.removeItem('aeonfall_user'); localStorage.removeItem('aeonfall_role'); window.location.reload(); };

        window.updateRoleUI = () => {
            const isDM = activeRole === 'dm';
            document.getElementById('role-player-btn').classList.toggle('active', !isDM);
            document.getElementById('role-dm-btn').classList.toggle('active', isDM);
            document.getElementById('add-script-btn').classList.toggle('hidden', !isDM);
            document.getElementById('add-session-btn').classList.toggle('hidden', !isDM);
            document.getElementById('add-item-btn').classList.toggle('hidden', !isDM);
            document.getElementById('add-feature-btn').classList.toggle('hidden', !isDM);
            document.getElementById('add-archetype-btn').classList.toggle('hidden', !isDM);
            document.getElementById('add-table-btn').classList.toggle('hidden', !isDM);
            document.getElementById('add-landmark-btn').classList.toggle('hidden', !isDM);
            renderLists();
            renderNavs();
        };

        window.switchView = (v) => {
            ['hub', 'scripts', 'sessions', 'items', 'features', 'landmarks'].forEach(id => {
                const el = document.getElementById(`${id}-view`);
                if(el) el.classList.add('hidden-view');
            });
            document.getElementById(`${v}-view`).classList.remove('hidden-view');
            window.scrollTo(0,0);
        };

        window.selectClass = (c) => { 
            currentClass = c; 
            const shortClasses = ["Heartbound", "Nomad", "Fabricator"];
            if (shortClasses.includes(c)) { if (currentLevel < 1) currentLevel = 1; if (currentLevel > 5) currentLevel = 5; }
            renderNavs(); renderLists(); 
        };

        window.selectFeatureClass = (c) => {
            currentFeatureClass = c;
            renderNavs(); renderLists();
        };
        
        window.selectLevel = (l) => { currentLevel = l; renderNavs(); renderLists(); };

        window.selectItemCategory = (cat) => {
            currentItemCategory = cat;
            renderNavs();
            renderLists();
        };

        window.handleItemSearch = (q) => {
            itemSearchQuery = q.toLowerCase();
            renderLists();
        };

        window.selectLandmarkRegion = (reg) => {
            if (activeRole !== 'dm' && reg !== 'All' && reg !== 'Havendor' && !regionVisibility[reg]) {
                window.showToast(`The region of ${reg} has not yet been surveyed.`);
                return;
            }
            currentLandmarkRegion = reg;
            renderNavs();
            renderLists();
        };

        window.toggleRegionVisibility = async (reg, e) => {
            e.stopPropagation();
            if (activeRole !== 'dm') return;
            const newVal = !regionVisibility[reg];
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'regionVisibility'), {
                ...regionVisibility,
                [reg]: newVal
            });
            window.showToast(`${reg} is now ${newVal ? 'Publicly Known' : 'Hidden from Files'}`);
        };

        window.addFracturedPlane = async () => {
            if (activeRole !== 'dm') return;
            const name = prompt("Enter the name of the new Fractured Plane:");
            if (!name) return;
            const updatedPlanes = [...planeNames, name.trim()];
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'landmarkConfig'), {
                planeNames: updatedPlanes
            });
            window.showToast(`${name} has been added to the Fracture Archive.`);
        };

        window.setLandmarkPersonalTie = (id) => {
            if (activeRole !== 'dm') return;
            activeLandmarkId = id;
            const currentTie = landmarks.find(l => l.id === id)?.personalTie || "";
            document.getElementById('tie-username-input').value = currentTie;
            document.getElementById('sever-tie-btn').classList.toggle('hidden', !currentTie);
            document.getElementById('tie-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('tie-username-input').focus(), 100);
        };

        window.saveLandmarkTie = async () => {
            const userVal = document.getElementById('tie-username-input').value.trim();
            if (!activeLandmarkId) return;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLandmarks', activeLandmarkId), { 
                personalTie: userVal 
            });
            document.getElementById('tie-modal').classList.add('hidden');
            window.showToast(userVal ? `Ties Bound to ${userVal}` : "Personal Ties Severed");
            activeLandmarkId = null;
        };

        window.clearLandmarkTie = async () => {
            if (!activeLandmarkId) return;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLandmarks', activeLandmarkId), { 
                personalTie: "" 
            });
            document.getElementById('tie-modal').classList.add('hidden');
            window.showToast("Personal Ties Severed");
            activeLandmarkId = null;
        };

        // DRAG AND DROP LOGIC (DM ONLY)
        window.handleDragStart = (e, id, type) => {
            if (activeRole !== 'dm') return;
            e.dataTransfer.setData('application/json', JSON.stringify({ id, type }));
            document.body.classList.add('is-dragging-mode');
            e.currentTarget.classList.add('dragging');
        };

        window.handleDragEnd = (e) => {
            document.body.classList.remove('is-dragging-mode');
            e.currentTarget.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        };

        window.handleDragOver = (e) => {
            if (activeRole !== 'dm') return;
            e.preventDefault();
            const target = e.currentTarget;
            if (!target.classList.contains('dragging')) {
                target.classList.add('drag-over');
            }
        };

        window.handleDragLeave = (e) => {
            e.currentTarget.classList.remove('drag-over');
        };

        window.handleDrop = async (e, targetId, targetType) => {
            if (activeRole !== 'dm') return;
            e.preventDefault();
            document.body.classList.remove('is-dragging-mode');
            e.currentTarget.classList.remove('drag-over');
            
            const data = JSON.parse(e.dataTransfer.getData('application/json'));
            if (data.id === targetId || data.type !== targetType) return;

            let list = [];
            let collectionName = '';
            if (data.type === 'script') { collectionName = 'handbookScripts'; list = scripts; }
            else if (data.type === 'feature') { collectionName = 'handbookFeatures'; list = features; }
            else if (data.type === 'table') { collectionName = 'handbookTables'; list = tables; }
            else if (data.type === 'archetype') { collectionName = 'handbookArchetypes'; list = archetypes; }

            const sourceItem = list.find(i => i.id === data.id);
            const targetItem = list.find(i => i.id === targetId);
            if (!sourceItem || !targetItem) return;

            const sourceOrder = sourceItem.order ?? sourceItem.createdAt;
            const targetOrder = targetItem.order ?? targetItem.createdAt;

            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, sourceItem.id), { order: targetOrder });
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, targetItem.id), { order: sourceOrder });
            window.showToast("Record Snapped into Place");
        };

        function parseAeonfallContent(text, isDM) {
            if (!text) return '';
            if (isDM) return text; 
            let html = text.replace(/&&([^&]+)&&/g, (match, content) => {
                const parts = content.split('|');
                const term = parts[0].trim();
                const definition = parts.length > 1 ? parts[1].trim() : (TOOLTIPS[term] || "No technical record found in archives.");
                return `<span class="term-hover def-term">${term}<span class="tooltip-content">${definition}</span></span>`;
            });
            html = html.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            html = html.replace(/\*(.*?)\*/g, '<i>$1</i>');
            html = html.replace(/__(.*?)__/g, '<u>$1</u>');
            return html;
        }

        function wrapWithTooltip(label, termKey) {
            const key = termKey || label;
            if (TOOLTIPS[key]) return `<span class="term-hover">${label}<span class="tooltip-content">${TOOLTIPS[key]}</span></span>`;
            return label;
        }

        function linkifyClasses(text) {
            if (!text) return '';
            let linkedText = text;
            CLASSES.concat(FEATURE_MARTIAL_CLASSES).forEach(cls => {
                const regex = new RegExp(`\\b${cls}\\b`, 'g');
                linkedText = linkedText.replace(regex, `<span class="class-link" onclick="event.stopPropagation(); window.selectClass('${cls}')">${cls}</span>`);
            });
            return linkedText;
        }

        function linkifyComponents(text, isDM) {
            if (!text) return '';
            if (isDM) return text;
            let linked = text.replace(/\bV\b/g, wrapWithTooltip('V', 'V'))
                             .replace(/\bS\b/g, wrapWithTooltip('S', 'S'))
                             .replace(/\bM\b/g, wrapWithTooltip('M', 'M'));
            linked = linked.replace(/\(([^)]+)\)/g, (match, itemName) => {
                return `(<span class="item-reference-link" onclick="window.jumpToItem('${itemName.replace(/'/g, "\\'")}')">${itemName}</span>)`;
            });
            return linked;
        }

        window.jumpToItem = (itemName) => {
            const matchItem = items.find(i => i.title.toLowerCase() === itemName.toLowerCase());
            if (matchItem) {
                currentItemCategory = matchItem.category || "All";
                window.switchView('items');
                renderNavs();
                setTimeout(() => {
                    const itemEntryTitles = Array.from(document.querySelectorAll('#items-list .script-card-title'));
                    const targetEl = itemEntryTitles.find(el => el.innerText.toLowerCase() === itemName.toLowerCase());
                    if (targetEl) {
                        const card = targetEl.closest('.script-card');
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        card.classList.add('highlight-glow');
                        setTimeout(() => card.classList.remove('highlight-glow'), 4000);
                    }
                }, 200);
            } else {
                window.showToast(`Resource "${itemName}" is not registered.`);
            }
        };

        function renderNavs() {
            const isDM = activeRole === 'dm';

            const tabs = document.getElementById('class-tabs');
            if (tabs) tabs.innerHTML = CLASSES.map(c => `<div class="class-tab ${currentClass === c ? 'active' : ''}" onclick="window.selectClass('${c}')">${c}</div>`).join('');

            const martialTabs = document.getElementById('feature-martial-tabs');
            if (martialTabs) martialTabs.innerHTML = FEATURE_MARTIAL_CLASSES.map(c => `<div class="class-tab ${currentFeatureClass === c ? 'active' : ''}" onclick="window.selectFeatureClass('${c}')">${c}</div>`).join('');

            const scriptTabs = document.getElementById('feature-script-tabs');
            if (scriptTabs) scriptTabs.innerHTML = CLASSES.map(c => `<div class="class-tab ${currentFeatureClass === c ? 'active' : ''}" onclick="window.selectFeatureClass('${c}')">${c}</div>`).join('');

            const lNav = document.getElementById('level-nav');
            if (lNav) {
                const shortClasses = ["Heartbound", "Nomad", "Fabricator"];
                let levels = shortClasses.includes(currentClass) ? [1, 2, 3, 4, 5] : [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
                lNav.innerHTML = levels.map(l => `<div class="level-bubble ${currentLevel === l ? 'active' : ''}" onclick="window.selectLevel(${l})">${l === 0 ? 'T' : l}</div>`).join('');
            }
            const title = document.getElementById('current-class-title');
            if (title) title.textContent = `${currentClass} ${currentLevel === 0 ? 'Tricks' : 'Lv. ' + currentLevel}`;

            const fLabel = document.getElementById('current-feature-class-label');
            if (fLabel) fLabel.textContent = `${currentFeatureClass} Features`;

            const iTabs = document.getElementById('item-category-tabs');
            if (iTabs) {
                iTabs.innerHTML = ITEM_CATEGORIES.map(cat => 
                    `<div class="class-tab ${currentItemCategory === cat ? 'active' : ''}" onclick="window.selectItemCategory('${cat}')">${cat}</div>`
                ).join('');
            }
            const iTitle = document.getElementById('current-item-category-title');
            if (iTitle) iTitle.textContent = currentItemCategory === "All" ? "All Equipment" : currentItemCategory;

            // LANDMARK REGIONS
            const lRegTabs = document.getElementById('landmark-region-tabs');
            if (lRegTabs) {
                lRegTabs.innerHTML = LANDMARK_REGIONS.map(reg => {
                    const isPublic = (reg === 'All' || reg === 'Havendor' || regionVisibility[reg]);
                    const classList = `class-tab ${currentLandmarkRegion === reg ? 'active' : ''} ${!isPublic && !isDM ? 'locked' : ''}`;
                    const lockIcon = isDM && reg !== 'All' && reg !== 'Havendor' ? `<span class="dm-tab-lock-icon" onclick="window.toggleRegionVisibility('${reg}', event)">${isPublic ? 'üîì' : 'üîí'}</span>` : '';
                    return `<div class="${classList}" onclick="window.selectLandmarkRegion('${reg}')">${reg} ${lockIcon}</div>`;
                }).join('');
            }

            // FRACTURED PLANES SUBNAV
            const subNav = document.getElementById('fractured-planes-subnav');
            const planeTabs = document.getElementById('fractured-planes-tabs');
            if (currentLandmarkRegion === 'Fractured Planes' || planeNames.includes(currentLandmarkRegion)) {
                subNav.classList.remove('hidden');
                let planesHtml = planeNames.map(plane => {
                    const isPublic = regionVisibility[plane] || false;
                    const isActive = currentLandmarkRegion === plane;
                    const classList = `class-tab sub-tab ${isActive ? 'active' : ''} ${!isPublic && !isDM ? 'locked' : ''}`;
                    const lockIcon = isDM ? `<span class="dm-tab-lock-icon" onclick="window.toggleRegionVisibility('${plane}', event)">${isPublic ? 'üîì' : 'üîí'}</span>` : '';
                    return `<div class="${classList}" onclick="window.selectLandmarkRegion('${plane}')">${plane} ${lockIcon}</div>`;
                }).join('');
                
                if (isDM) {
                    planesHtml += `<div class="class-tab sub-tab !border-amber-600 !text-amber-600" onclick="window.addFracturedPlane()">+ New Plane</div>`;
                }
                planeTabs.innerHTML = planesHtml;
            } else {
                subNav.classList.add('hidden');
            }

            const lTitle = document.getElementById('current-landmark-region-title');
            if (lTitle) lTitle.textContent = currentLandmarkRegion === "All" ? "All Discoveries" : `${currentLandmarkRegion} Records`;
        }

        window.zoomImage = (url) => {
            const modal = document.getElementById('lightbox-modal');
            const img = document.getElementById('lightbox-img');
            img.src = url;
            modal.classList.remove('hidden');
        };

        window.cycleClassification = async (id, currentVal) => {
            if (activeRole !== 'dm') return;
            const states = ['Mechanum', 'Concord', ''];
            let currentIndex = states.indexOf(currentVal || '');
            let nextIndex = (currentIndex + 1) % states.length;
            const newVal = states[nextIndex];
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookScripts', id), { classification: newVal });
            window.showToast(newVal ? `Script Type: ${newVal}` : "Classification Removed");
        };

        window.copyScript = (id) => {
            const s = scripts.find(script => script.id === id);
            if (!s) return;
            const cleanContent = (s.content || "").replace(/&&([^|&]+)(?:\|[^&]+)?&&/g, '$1').replace(/\*\*|\*|__/g, '');
            const text = `--- AEONFALL SCRIPT DATA ---\nNAME: ${s.title.toUpperCase()}\nLEVEL: ${s.level === 0 ? 'Trick' : s.level}\nSCHOOL: ${s.school || 'Dominion'}\nTYPE: ${s.classification || 'Standard'}\nACTIVATION: ${s.activationTime || '1 Action'}\nRANGE: ${s.range || '30 feet'}\nCOMPONENTS: ${s.components || 'V, S'}\nDURATION: ${s.duration || 'Instant'}\n\nEFFECT:\n${cleanContent}\n\nSCALING:\n${s.higherLevels || 'None'}\n\nAUTHORIZED USERS: ${s.scriptLists || s.className || 'General'}`;
            copyToClipboard(text);
        };

        window.copyFeature = (id) => {
            const f = features.find(feat => feat.id === id);
            if (!f) return;
            const cleanContent = (f.content || "").replace(/&&([^|&]+)(?:\|[^&]+)?&&/g, '$1').replace(/\*\*|\*|__/g, '');
            const text = `--- AEONFALL FEATURE DATA ---\nNAME: ${f.title.toUpperCase()}\nCLASS: ${f.className}\nTYPE: ${f.type || 'Feature'}\n\nEFFECT:\n${cleanContent}`;
            copyToClipboard(text);
        };

        window.copyItem = (id) => {
            const i = items.find(item => item.id === id);
            if (!i) return;
            const cleanContent = (i.content || "").replace(/&&([^|&]+)(?:\|[^&]+)?&&/g, '$1').replace(/\*\*|\*|__/g, '');
            const text = `--- AEONFALL ITEM DATA ---\nNAME: ${i.title.toUpperCase()}\nCATEGORY: ${i.category || 'General'}\nTYPE: ${i.type || 'Gear'}\nRARITY: ${i.rarity || 'Common'}\nWEIGHT: ${i.weight || '1 lb'}\nCOST: ${i.cost || '-'}\n\nDESCRIPTION:\n${cleanContent}\n\nPROPERTIES:\n${i.properties || 'None'}`;
            copyToClipboard(text);
        };

        function copyToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                window.showToast("Data Compiled & Copied");
            } catch (err) {
                window.showToast("Failed to access system clipboard");
            }
            document.body.removeChild(textArea);
        }

        const getRarityClass = (rarity) => {
            const r = (rarity || '').toLowerCase();
            if (r.includes('legendary')) return 'rarity-legendary';
            if (r.includes('very rare')) return 'rarity-very-rare';
            if (r.includes('rare')) return 'rarity-rare';
            if (r.includes('uncommon')) return 'rarity-uncommon';
            return 'rarity-common';
        };

        function createScriptCard(s, isDM) {
            const classif = s.classification || '';
            const classifHtml = isDM ? ` [<span class="classification-pill ${!classif ? 'classification-none' : ''}" onclick="window.cycleClassification('${s.id}', '${classif}')">${wrapWithTooltip(classif || ' + ', classif)}</span>]` : (classif ? ` [${wrapWithTooltip(classif)}]` : '');
            return `
                <div class="script-card ${isDM ? 'dm-active-edit' : ''}" 
                     draggable="${isDM}" 
                     ondragstart="window.handleDragStart(event, '${s.id}', 'script')" 
                     ondragend="window.handleDragEnd(event)"
                     ondragover="window.handleDragOver(event)" 
                     ondragleave="window.handleDragLeave(event)"
                     ondrop="window.handleDrop(event, '${s.id}', 'script')">
                    <div class="script-card-header flex justify-between items-center">
                        <div class="script-card-title dm-editable flex-grow" contenteditable="${isDM}" oninput="window.debounceUpdate('${s.id}', 'title', this.innerText)">${s.title}</div>
                        ${isDM ? `
                            <div class="flex items-center gap-2">
                                <div class="drag-handle" title="Move Item">‚†ø</div>
                                <button onclick="window.triggerDeleteScript('${s.id}')" class="text-red-700 opacity-30 hover:opacity-100">‚úï</button>
                            </div>
                        ` : ''}
                    </div>
                    <span class="script-card-level">
                        ${s.level === 0 ? 'Trick' : s.level + '-level'} ‚Äî 
                        <span class="${isDM ? 'dm-editable' : ''}" contenteditable="${isDM}" oninput="window.debounceUpdate('${s.id}', 'school', this.innerText)">${isDM ? (s.school || 'Dominion') : wrapWithTooltip(s.school || 'Dominion')}</span> 
                        ${classifHtml}
                    </span>
                    <ul class="script-prop-list">
                        <li><b>${wrapWithTooltip('Activation Time')}:</b> <span class="dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdate('${s.id}', 'activationTime', this.innerText)">${s.activationTime || '1 Action'}</span></li>
                        <li><b>${wrapWithTooltip('Range/Area')}:</b> <span class="dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdate('${s.id}', 'range', this.innerText)">${s.range || '30 feet'}</span></li>
                        <li><b>${wrapWithTooltip('Components')}:</b> <span class="${isDM ? 'dm-editable' : ''}" contenteditable="${isDM}" oninput="window.debounceUpdate('${s.id}', 'components', this.innerText)">${linkifyComponents(s.components || 'V, S', isDM)}</span></li>
                        <li><b>${wrapWithTooltip('Duration')}:</b> <span class="dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdate('${s.id}', 'duration', this.innerText)">${s.duration || 'Instantaneous'}</span></li>
                    </ul>
                    <div class="script-body ${isDM ? 'dm-editable' : ''}" contenteditable="${isDM}" oninput="window.debounceUpdate('${s.id}', 'content', this.innerText)">${parseAeonfallContent(s.content, isDM)}</div>
                    <div class="script-higher-levels"><b>${wrapWithTooltip('At Higher Levels')}.</b> <span class="dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdate('${s.id}', 'higherLevels', this.innerText)">${s.higherLevels || '...'}</span></div>
                    <div class="script-footer"><b>Lists:</b> <span class="${isDM ? 'dm-editable' : ''}" contenteditable="${isDM}" oninput="window.debounceUpdate('${s.id}', 'scriptLists', this.innerText)">${isDM ? (s.scriptLists || currentClass) : linkifyClasses(s.scriptLists || currentClass)}</span></div>
                    <button onclick="window.copyScript('${s.id}')" class="mt-4 w-full bg-[#2c1810]/5 hover:bg-[#7a1d1d]/10 border border-[#7a1d1d33] py-2 rounded-lg text-[#7a1d1d] font-black text-[9px] uppercase transition-all flex items-center justify-center gap-2"><span>üìã</span> Copy Script Data</button>
                </div>
            `;
        }

        function createFeatureCard(f, isDM) {
            return `
                <div class="script-card ${isDM ? 'dm-active-edit' : ''}" 
                     draggable="${isDM}" 
                     ondragstart="window.handleDragStart(event, '${f.id}', 'feature')" 
                     ondragend="window.handleDragEnd(event)"
                     ondragover="window.handleDragOver(event)" 
                     ondragleave="window.handleDragLeave(event)"
                     ondrop="window.handleDrop(event, '${f.id}', 'feature')">
                    <div class="script-card-header flex justify-between items-center">
                        <div class="script-card-title dm-editable flex-grow" contenteditable="${isDM}" oninput="window.debounceUpdateFeature('${f.id}', 'title', this.innerText)">${f.title}</div>
                        ${isDM ? `
                            <div class="flex items-center gap-2">
                                <div class="drag-handle" title="Move Item">‚†ø</div>
                                <button onclick="window.triggerDeleteFeature('${f.id}')" class="text-red-700 opacity-30 hover:opacity-100">‚úï</button>
                            </div>
                        ` : ''}
                    </div>
                    <span class="script-card-level">
                        <span class="dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdateFeature('${f.id}', 'type', this.innerText)">${f.type || 'Feature Move'}</span>
                    </span>
                    <div class="script-body mt-4 ${isDM ? 'dm-editable' : ''}" contenteditable="${isDM}" oninput="window.debounceUpdateFeature('${f.id}', 'content', this.innerText)">${parseAeonfallContent(f.content, isDM)}</div>
                    <button onclick="window.copyFeature('${f.id}')" class="mt-4 w-full bg-[#2c1810]/5 hover:bg-[#7a1d1d]/10 border border-[#7a1d1d33] py-2 rounded-lg text-[#7a1d1d] font-black text-[9px] uppercase transition-all flex items-center justify-center gap-2"><span>üìã</span> Copy Feature Data</button>
                </div>
            `;
        }

        function createTableHtml(t, isDM) {
            let headersHtml = t.headers.map((h, i) => `<th contenteditable="${isDM}" oninput="window.debounceUpdateTableCell('${t.id}', 'headers', ${i}, this.innerText)">${h}</th>`).join('');
            let rowsHtml = t.rows.map((row, rowIdx) => {
                let cellsHtml = row.map((cell, cellIdx) => `<td contenteditable="${isDM}" oninput="window.debounceUpdateTableCell('${t.id}', 'rows', ${rowIdx}, this.innerText, ${cellIdx})">${cell}</td>`).join('');
                return `<tr>${cellsHtml}</tr>`;
            }).join('');

            return `
                <div class="progression-table-container shadow-2xl mb-8 grid-column-span-full ${isDM ? 'dm-active-edit' : ''}" 
                     style="grid-column: 1 / -1;"
                     draggable="${isDM}" 
                     ondragstart="window.handleDragStart(event, '${t.id}', 'table')" 
                     ondragend="window.handleDragEnd(event)"
                     ondragover="window.handleDragOver(event)" 
                     ondragleave="window.handleDragLeave(event)"
                     ondrop="window.handleDrop(event, '${t.id}', 'table')">
                    <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <div class="flex items-center gap-3">
                            ${isDM ? '<div class="drag-handle" title="Move Table">‚†ø</div>' : ''}
                            <h3 class="font-serif font-black uppercase text-lg md:text-xl text-[#7a1d1d] dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdateTable('${t.id}', 'title', this.innerText)">${t.title}</h3>
                        </div>
                        ${isDM ? `
                            <div class="flex gap-2">
                                <button onclick="window.addRowToTable('${t.id}')" class="arch-btn arch-btn-add">+ Row</button>
                                <button onclick="window.addColumnToTable('${t.id}')" class="arch-btn arch-btn-util">+ Col</button>
                                <button onclick="window.triggerDeleteTable('${t.id}')" class="arch-btn arch-btn-delete">Dispose</button>
                            </div>
                        ` : ''}
                    </div>
                    <table class="progression-table">
                        <thead><tr>${headersHtml}</tr></thead>
                        <tbody>${rowsHtml}</tbody>
                    </table>
                </div>
            `;
        }

        const renderLists = () => {
            const isDM = activeRole === 'dm';
            const savedUser = JSON.parse(localStorage.getItem('aeonfall_user') || '{}');
            const currentUsername = savedUser.username || 'Guest';
            
            // Render Features
            const fList = document.getElementById('features-list');
            if (fList) {
                fList.innerHTML = '';
                const classTables = tables.filter(t => t.parentClass === currentFeatureClass && !t.archetypeId);
                const generalFeatures = features.filter(f => f.className === currentFeatureClass && !f.archetypeId);
                const classArchetypes = archetypes.filter(a => a.parentClass === currentFeatureClass);

                classTables.forEach(t => fList.innerHTML += createTableHtml(t, isDM));
                generalFeatures.forEach(f => fList.innerHTML += createFeatureCard(f, isDM));

                classArchetypes.forEach(arch => {
                    const archTables = tables.filter(t => t.archetypeId === arch.id);
                    const archFeatures = features.filter(f => f.archetypeId === arch.id);
                    const archScripts = scripts.filter(s => s.archetypeId === arch.id);

                    const divider = document.createElement('div');
                    divider.className = `archetype-divider shadow-md ${isDM ? 'dm-active-edit' : ''}`;
                    if (isDM) {
                        divider.draggable = true;
                        divider.ondragstart = (e) => window.handleDragStart(e, arch.id, 'archetype');
                        divider.ondragend = (e) => window.handleDragEnd(e);
                        divider.ondragover = (e) => window.handleDragOver(e);
                        divider.ondragleave = (e) => window.handleDragLeave(e);
                        divider.ondrop = (e) => window.handleDrop(e, arch.id, 'archetype');
                    }
                    divider.innerHTML = `
                        <div class="flex items-center gap-4">
                            ${isDM ? '<div class=\"drag-handle\" title=\"Move Archetype\">‚†ø</div>' : ''}
                            <div class="archetype-name dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdateArchetype('${arch.id}', 'name', this.innerText)">${arch.name}</div>
                        </div>
                        ${isDM ? `
                            <div class="archetype-controls">
                                <button onclick="window.addTableEntry('${arch.id}')" class="arch-btn arch-btn-add">+ Tbl</button>
                                <button onclick="window.addFeatureEntry('${arch.id}')" class="arch-btn arch-btn-add">+ Feat</button>
                                <button onclick="window.addScriptEntry(null, '${arch.id}')" class="arch-btn arch-btn-add">+ Scr</button>
                                <button onclick="window.triggerDeleteArchetype('${arch.id}')" class="arch-btn arch-btn-delete">Dispose</button>
                            </div>
                        ` : ''}
                    `;
                    fList.appendChild(divider);

                    archTables.forEach(t => fList.innerHTML += createTableHtml(t, isDM));
                    archFeatures.forEach(f => fList.innerHTML += createFeatureCard(f, isDM));
                    archScripts.forEach(s => fList.innerHTML += createScriptCard(s, isDM));

                    if (!archTables.length && !archFeatures.length && !archScripts.length) {
                        const empty = document.createElement('p');
                        empty.className = 'col-span-full text-center italic opacity-30 py-6 text-[10px] uppercase font-black';
                        empty.textContent = 'Archetype Buffer Empty';
                        fList.appendChild(empty);
                    }
                });
            }

            // Render Scripts
            const sList = document.getElementById('scripts-list');
            if (sList) {
                sList.innerHTML = '';
                const filteredScripts = scripts.filter(s => {
                    if (parseInt(s.level) !== currentLevel) return false;
                    const listText = (s.scriptLists || s.className || '').toLowerCase();
                    return listText.includes(currentClass.toLowerCase());
                });
                filteredScripts.forEach(s => sList.innerHTML += createScriptCard(s, isDM));
                if (!filteredScripts.length) sList.innerHTML = `<p class="col-span-full text-center italic opacity-40 py-20 uppercase font-black text-amber-900 tracking-widest text-xs">No Records Found</p>`;
            }

            // Render Landmarks
            const lList = document.getElementById('landmarks-list');
            if (lList) {
                lList.innerHTML = '';
                const filteredLandmarks = landmarks.filter(l => currentLandmarkRegion === "All" || (l.region || 'Havendor') === currentLandmarkRegion);
                filteredLandmarks.forEach(l => {
                    const card = document.createElement('div');
                    card.className = `script-card ${isDM ? 'dm-active-edit' : ''}`;
                    const imgUrl = (l.imageUrl || '').trim();
                    let imgHtml = imgUrl ? `<img src="${imgUrl}" class="item-preview-img" onclick="window.zoomImage('${imgUrl}')" onerror="this.src='https://placehold.co/600x400/000000/f59e0b?text=LOCATION+ASSET+LOST'">` : (isDM ? `<div class="w-full h-10 bg-black/5 border-dashed border-2 border-amber-900/20 rounded-lg flex items-center justify-center text-[8px] uppercase font-black opacity-40 mb-4 tracking-widest">Signal Lost: Input Link Below</div>` : '');
                    
                    const isTargetUser = currentUsername.toLowerCase() === (l.personalTie || '').toLowerCase();
                    let personalTieHtml = "";
                    if (isDM || isTargetUser) {
                        if (l.personalTie) {
                            personalTieHtml = `
                                <div class="personal-tie-badge">üîó Personal Tie ${isDM ? '('+l.personalTie+')' : ''}</div>
                                <div class="intel-block">
                                    <span class="block font-black uppercase text-[8px] text-[#7a1d1d] opacity-60 mb-2 tracking-widest">Encrypted Dossier</span>
                                    <div class="${isDM ? 'dm-editable' : ''} italic leading-relaxed" contenteditable="${isDM}" oninput="window.debounceUpdateLandmark('${l.id}', 'personalTieContent', this.innerText)">
                                        ${l.personalTieContent || (isDM ? "Explain the confidential link here..." : "Data stream corrupted or unavailable.")}
                                    </div>
                                </div>
                            `;
                        }
                    }

                    const tieButtonHtml = isDM ? `<button onclick="window.setLandmarkPersonalTie('${l.id}')" class="tie-button ml-2">${l.personalTie ? 'Bound User' : 'Bind Identity'}</button>` : "";

                    card.innerHTML = `
                        <div class="script-card-header">
                            <div class="script-card-title dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdateLandmark('${l.id}', 'title', this.innerText)">${l.title}</div>
                            ${isDM ? `<button onclick="window.triggerDeleteLandmark('${l.id}')" class="absolute top-4 right-4 text-red-700 opacity-30 hover:opacity-100">‚úï</button>` : ''}
                        </div>
                        <div class="flex justify-between items-center mb-4">
                            <span class="script-card-level">
                                <span class="dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdateLandmark('${l.id}', 'region', this.innerText)">${l.region || 'Havendor'}</span>
                            </span>
                            ${tieButtonHtml}
                        </div>
                        ${imgHtml}
                        ${personalTieHtml}
                        ${isDM ? `<span class="item-url-input mt-2">Asset: <span class="dm-editable inline-block min-w-[50px] border-b border-amber-900/20" contenteditable="true" oninput="window.debounceUpdateLandmark('${l.id}', 'imageUrl', this.innerText)">${imgUrl}</span></span>` : ''}
                        
                        <div class="item-flavor-text mt-4 ${isDM ? 'dm-editable' : ''}" contenteditable="${isDM}" oninput="window.debounceUpdateLandmark('${l.id}', 'flavorText', this.innerText)">${l.flavorText || (isDM ? "Lore/Flavor text goes here..." : "")}</div>
                        
                        <span class="item-description-label">Regional Data</span>
                        <div class="script-body ${isDM ? 'dm-editable' : ''}" contenteditable="${isDM}" oninput="window.debounceUpdateLandmark('${l.id}', 'content', this.innerText)">${parseAeonfallContent(l.content, isDM)}</div>
                        
                        <div class="script-footer mt-4"><b>Tags:</b> <span class="dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdateLandmark('${l.id}', 'tags', this.innerText)">${l.tags || 'Location'}</span></div>
                    `;
                    lList.appendChild(card);
                });
                if (!filteredLandmarks.length) lList.innerHTML = `<p class="col-span-full text-center italic opacity-40 py-20 uppercase font-black text-amber-900 tracking-widest text-xs">No Landmark Records Found</p>`;
            }

            // Render Items
            const iList = document.getElementById('items-list');
            if (iList) {
                iList.innerHTML = '';
                let filteredItems = items.filter(i => {
                    const matchesCategory = currentItemCategory === "All" || (i.category || 'General').toLowerCase() === currentItemCategory.toLowerCase();
                    const matchesSearch = !itemSearchQuery || (i.title || '').toLowerCase().includes(itemSearchQuery);
                    return matchesCategory && matchesSearch;
                });
                
                // RANDOMIZATION LOGIC FOR "ALL" CATEGORY
                if (currentItemCategory === "All" && !itemSearchQuery) {
                    filteredItems.sort((a, b) => a._seed - b._seed);
                } else if (!itemSearchQuery) {
                    filteredItems.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                }

                filteredItems.forEach(i => {
                    const card = document.createElement('div');
                    card.className = `script-card ${isDM ? 'dm-active-edit' : ''}`;
                    const imgUrl = (i.imageUrl || '').trim();
                    let imgHtml = imgUrl ? `<img src="${imgUrl}" class="item-preview-img" onclick="window.zoomImage('${imgUrl}')" onerror="this.src='https://placehold.co/400x400/000000/f59e0b?text=ASSET+LOST'">` : (isDM ? `<div class="w-full h-10 bg-black/5 border-dashed border-2 border-amber-900/20 rounded-lg flex items-center justify-center text-[8px] uppercase font-black opacity-40 mb-4 tracking-widest">Signal Lost: Input Link Below</div>` : '');
                    card.innerHTML = `
                        <div class="script-card-header">
                            <div class="script-card-title dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdateItem('${i.id}', 'title', this.innerText)">${i.title}</div>
                            ${isDM ? `<button onclick="window.triggerDeleteItem('${i.id}')" class="absolute top-4 right-4 text-red-700 opacity-30 hover:opacity-100">‚úï</button>` : ''}
                        </div>
                        <span class="script-card-level">
                            <span class="dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdateItem('${i.id}', 'category', this.innerText)">${i.category || 'General'}</span> ‚Äî 
                            <span class="dm-editable ${getRarityClass(i.rarity)}" contenteditable="${isDM}" oninput="window.debounceUpdateItem('${i.id}', 'rarity', this.innerText)">${i.rarity || 'Common'}</span>
                        </span>
                        ${imgHtml}
                        ${isDM ? `<span class="item-url-input">Asset: <span class="dm-editable inline-block min-w-[50px] border-b border-amber-900/20" contenteditable="true" oninput="window.debounceUpdateItem('${i.id}', 'imageUrl', this.innerText)">${imgUrl}</span></span>` : ''}
                        <ul class="script-prop-list">
                            <li><b>Weight:</b> <span class="dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdateItem('${i.id}', 'weight', this.innerText)">${i.weight || '1 lb'}</span></li>
                            <li><b>Value:</b> <span class="dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdateItem('${i.id}', 'cost', this.innerText)">${i.cost || '-'}</span></li>
                        </ul>
                        
                        <div class="item-flavor-text ${isDM ? 'dm-editable' : ''}" contenteditable="${isDM}" oninput="window.debounceUpdateItem('${i.id}', 'flavorText', this.innerText)">${i.flavorText || (isDM ? "Lore/Flavor text goes here..." : "")}</div>
                        
                        <span class="item-description-label">Description</span>
                        <div class="script-body ${isDM ? 'dm-editable' : ''}" contenteditable="${isDM}" oninput="window.debounceUpdateItem('${i.id}', 'content', this.innerText)">${parseAeonfallContent(i.content, isDM)}</div>
                        
                        <div class="script-higher-levels"><b>Properties.</b> <span class="dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdateItem('${i.id}', 'properties', this.innerText)">${i.properties || 'None.'}</span></div>
                        <button onclick="window.copyItem('${i.id}')" class="mt-4 w-full bg-[#2c1810]/5 hover:bg-[#7a1d1d]/10 border border-[#7a1d1d33] py-2 rounded-lg text-[#7a1d1d] font-black text-[9px] uppercase transition-all flex items-center justify-center gap-2"><span>üìã</span> Copy Data</button>
                    `;
                    iList.appendChild(card);
                });
                if (!filteredItems.length) iList.innerHTML = `<p class="col-span-full text-center italic opacity-40 py-20 uppercase font-black text-amber-900 tracking-widest text-xs">No Records Found</p>`;
            }

            // Render Sessions
            const sessList = document.getElementById('sessions-list');
            if (sessList) {
                sessList.innerHTML = '';
                sessions.forEach(s => {
                    const div = document.createElement('div');
                    div.className = `relative ${isDM ? 'dm-active-edit' : ''}`;
                    let html = `
                        <div class="flex flex-wrap justify-between items-start mb-6 border-b border-gray-900/10 pb-2 gap-4">
                            <div class="font-serif font-black text-2xl md:text-4xl uppercase text-[#7a1d1d] dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdateSession('${s.id}', 'title', this.innerText)">${s.title}</div>
                            ${isDM ? `<button onclick="window.triggerDeleteSession('${s.id}')" class="text-red-700 font-black text-[9px] uppercase border border-red-200 px-2 py-1 rounded">Delete</button>` : ''}
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-x-12">
                            <div>
                                <div class="session-field-group"><b>Date:</b> <span class="dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdateSession('${s.id}', 'date', this.innerText)">${s.date}</span></div>
                                <div class="session-field-group"><b>Location:</b> <span class="dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdateSession('${s.id}', 'startingPoint', this.innerText)">${s.startingPoint || '...'}</span></div>
                                <div class="session-field-group"><b>Summary:</b> <span class="dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdateSession('${s.id}', 'lastSessionSummary', this.innerText)">${s.lastSessionSummary || '...'}</span></div>
                            </div>
                        </div>
                        <div class="mt-8">
                            <h4 class="font-serif font-black text-lg uppercase text-[#7a1d1d] mb-4">Scenes & Beats</h4>
                            <div class="space-y-4">
                                <div class="session-field-group"><b>1. Opening:</b> <div class="dm-editable italic min-h-[20px]" contenteditable="${isDM}" oninput="window.debounceUpdateSession('${s.id}', 'scene1', this.innerText)">${s.scene1 || '...'}</div></div>
                                <div class="session-field-group"><b>2. Key Goals:</b> <div class="dm-editable italic min-h-[20px]" contenteditable="${isDM}" oninput="window.debounceUpdateSession('${s.id}', 'scene2', this.innerText)">${s.scene2 || '...'}</div></div>
                                <div class="session-field-group"><b>3. Challenges:</b> <div class="dm-editable italic min-h-[20px]" contenteditable="${isDM}" oninput="window.debounceUpdateSession('${s.id}', 'scene3', this.innerText)">${s.scene3 || '...'}</div></div>
                                <div class="session-field-group"><b>4. Secrets:</b> <div class="dm-editable italic min-h-[20px]" contenteditable="${isDM}" oninput="window.debounceUpdateSession('${s.id}', 'scene4', this.innerText)">${s.scene4 || '...'}</div></div>
                                <div class="session-field-group"><b>5. Closing:</b> <div class="dm-editable italic min-h-[20px]" contenteditable="${isDM}" oninput="window.debounceUpdateSession('${s.id}', 'scene5', this.innerText)">${s.scene5 || '...'}</div></div>
                            </div>
                        </div>
                    `;
                    if (isDM) html += `
                        <div class="dm-intel-box mt-10 p-4 bg-[#2c1810]/5 rounded-xl border border-[#2c1810]/10">
                            <span class="text-[9px] uppercase font-black text-[#7a1d1d] opacity-50 block mb-4">DM Intel Overlay</span>
                            <div class="mb-4"><div class="font-black text-[10px] uppercase text-[#7a1d1d] mb-1">Goals</div><div class="dm-editable min-h-[40px] bg-white/50 p-2 rounded" contenteditable="true" oninput="window.debounceUpdateSession('${s.id}', 'dmGoals', this.innerText)">${s.dmGoals || '...'}</div></div>
                            <div class="mb-4"><div class="font-black text-[10px] uppercase text-[#7a1d1d] mb-1">Notes</div><div class="dm-editable min-h-[60px] bg-white/50 p-2 rounded" contenteditable="true" oninput="window.debounceUpdateSession('${s.id}', 'dmRunningNotes', this.innerText)">${s.dmRunningNotes || '...'}</div></div>
                        </div>`;
                    div.innerHTML = html;
                    sessList.appendChild(div);
                });
            }
        };

        window.debounceUpdateTable = (id, field, val) => {
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => { updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookTables', id), { [field]: val }); }, 1000);
        };
        
        window.debounceUpdateTableCell = (id, field, idx, val, cellIdx = null) => {
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(async () => {
                const table = tables.find(t => t.id === id);
                if (!table) return;
                const tableRef = doc(db, 'artifacts', appId, 'public', 'data', 'handbookTables', id);
                if (field === 'headers') {
                    const newHeaders = [...table.headers]; newHeaders[idx] = val;
                    await updateDoc(tableRef, { headers: newHeaders });
                } else if (field === 'rows') {
                    const newRows = [...table.rows]; newRows[idx][cellIdx] = val;
                    await updateDoc(tableRef, { rows: JSON.stringify(newRows) });
                }
            }, 1000);
        };

        window.addRowToTable = async (id) => {
            const table = tables.find(t => t.id === id);
            if (!table) return;
            const updatedRows = [...table.rows, new Array(table.headers.length).fill("...")];
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookTables', id), { rows: JSON.stringify(updatedRows) });
        };

        window.addColumnToTable = async (id) => {
            const table = tables.find(t => t.id === id);
            if (!table) return;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookTables', id), { 
                headers: [...table.headers, "New"],
                rows: JSON.stringify(table.rows.map(row => [...row, "..."]))
            });
        };

        window.debounceUpdateArchetype = (id, field, val) => {
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => { updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookArchetypes', id), { [field]: val }); }, 1000);
        };
        window.debounceUpdateFeature = (id, field, val) => {
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => { updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookFeatures', id), { [field]: val }); }, 1000);
        };
        window.debounceUpdate = (id, field, val) => {
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => { updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookScripts', id), { [field]: val }); }, 1000);
        };
        window.debounceUpdateSession = (id, field, val) => {
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => { updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookSessions', id), { [field]: val }); }, 1000);
        };
        window.debounceUpdateItem = (id, field, val) => {
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => { updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookItems', id), { [field]: val }); }, 1000);
        };
        window.debounceUpdateLandmark = (id, field, val) => {
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => { updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLandmarks', id), { [field]: val }); }, 1000);
        };

        window.triggerDeleteTable = (id) => { itemToDeleteId = id; deleteType = 'table'; document.getElementById('delete-modal').classList.remove('hidden'); };
        window.triggerDeleteArchetype = (id) => { itemToDeleteId = id; deleteType = 'archetype'; document.getElementById('delete-modal').classList.remove('hidden'); };
        window.triggerDeleteFeature = (id) => { itemToDeleteId = id; deleteType = 'feature'; document.getElementById('delete-modal').classList.remove('hidden'); };
        window.triggerDeleteScript = (id) => { itemToDeleteId = id; deleteType = 'script'; document.getElementById('delete-modal').classList.remove('hidden'); };
        window.triggerDeleteSession = (id) => { itemToDeleteId = id; deleteType = 'session'; document.getElementById('delete-modal').classList.remove('hidden'); };
        window.triggerDeleteItem = (id) => { itemToDeleteId = id; deleteType = 'item'; document.getElementById('delete-modal').classList.remove('hidden'); };
        window.triggerDeleteLandmark = (id) => { itemToDeleteId = id; deleteType = 'landmark'; document.getElementById('delete-modal').classList.remove('hidden'); };

        document.getElementById('confirm-delete-btn').onclick = async () => {
            if (!itemToDeleteId) return;
            const collectionName = deleteType === 'script' ? 'handbookScripts' : deleteType === 'session' ? 'handbookSessions' : deleteType === 'feature' ? 'handbookFeatures' : deleteType === 'archetype' ? 'handbookArchetypes' : deleteType === 'table' ? 'handbookTables' : deleteType === 'landmark' ? 'handbookLandmarks' : 'handbookItems';
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, itemToDeleteId));
            document.getElementById('delete-modal').classList.add('hidden');
            window.showToast("Record Erased");
            itemToDeleteId = null;
        };

        window.addTableEntry = async (archId = null) => {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'handbookTables'), { 
                title: "NEW PROGRESSION", parentClass: currentFeatureClass, archetypeId: archId,
                headers: ["Level", "Prof.", "Features"], rows: JSON.stringify([["1st", "+2", "..."]]), 
                createdAt: Date.now(), order: Date.now()
            });
        };

        window.addArchetypeEntry = async () => {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'handbookArchetypes'), { name: "NEW ARCHETYPE", parentClass: currentFeatureClass, createdAt: Date.now(), order: Date.now() });
        };

        window.addFeatureEntry = async (archId = null) => {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'handbookFeatures'), { title: "NEW FEATURE", content: "...", type: "Feature Move", className: currentFeatureClass, archetypeId: archId, createdAt: Date.now(), order: Date.now() });
        };

        window.addScriptEntry = async (lvl = null, archId = null) => {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'handbookScripts'), { 
                title: "NEW SCRIPT", content: "...", school: "Dominion", classification: "", 
                activationTime: "1 Action", range: "30 feet", components: "V, S", duration: "Instant", 
                higherLevels: "...", scriptLists: currentFeatureClass, className: currentFeatureClass, 
                level: lvl || currentLevel, archetypeId: archId, createdAt: Date.now(), order: Date.now() 
            });
        };
        
        window.addSessionEntry = async () => {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'handbookSessions'), { title: "SESSION #", date: new Date().toLocaleDateString(), startingPoint: "...", lastSessionSummary: "...", scene1: "...", scene2: "...", scene3: "...", scene4: "...", scene5: "...", dmGoals: "...", createdAt: Date.now() });
        };

        window.addItemEntry = async () => {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'handbookItems'), { title: "NEW ITEM", content: "Description...", flavorText: "Flavor text...", category: currentItemCategory === "All" ? "Adventuring Gear" : currentItemCategory, type: "Gear", rarity: "Common", weight: "1 lb", cost: "-", properties: "None", imageUrl: "", createdAt: Date.now() });
        };

        window.addLandmarkEntry = async () => {
            let region = currentLandmarkRegion === "All" ? "Havendor" : currentLandmarkRegion;
            if (region === 'Fractured Planes') region = planeNames[0];
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'handbookLandmarks'), { title: "NEW LANDMARK", content: "Detailed description...", flavorText: "Flavor text...", region: region, tags: "Location", imageUrl: "", personalTie: "", personalTieContent: "", createdAt: Date.now() });
        };

        const sortFn = (a, b) => (a.order ?? a.createdAt) - (b.order ?? b.createdAt);

        const init = async () => {
            await signInAnonymously(auth);
            const saved = localStorage.getItem('aeonfall_user');
            if (saved) document.getElementById('user-display-name').textContent = JSON.parse(saved).username;
            const role = localStorage.getItem('aeonfall_role');
            if (role) activeRole = role;
            
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'handbookTables'), (snap) => {
                tables = snap.docs.map(d => { const data = d.data(); return { id: d.id, ...data, rows: typeof data.rows === 'string' ? JSON.parse(data.rows) : (data.rows || []) }; }).sort(sortFn);
                renderLists();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'handbookArchetypes'), (snap) => {
                archetypes = snap.docs.map(d => ({id: d.id, ...d.data()})).sort(sortFn);
                renderLists();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'handbookFeatures'), (snap) => {
                features = snap.docs.map(d => ({id: d.id, ...d.data()})).sort(sortFn);
                renderLists();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'handbookScripts'), (snap) => {
                scripts = snap.docs.map(d => ({id: d.id, ...d.data()})).sort(sortFn);
                renderLists();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'handbookSessions'), (snap) => {
                sessions = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.createdAt - a.createdAt);
                renderLists();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'handbookItems'), (snap) => {
                items = snap.docs.map(d => {
                    const data = d.data();
                    if (!itemSeeds[d.id]) itemSeeds[d.id] = Math.random();
                    return { id: d.id, ...data, _seed: itemSeeds[d.id] };
                });
                renderLists(); renderNavs();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'handbookLandmarks'), (snap) => {
                landmarks = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => a.createdAt - b.createdAt);
                renderLists();
            });

            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'regionVisibility'), (docSnap) => {
                if (docSnap.exists()) {
                    regionVisibility = docSnap.data();
                } else {
                    regionVisibility = { Tormarath: false, Vorastra: false, Eryndor: false, "Fractured Planes": false, Havendor: true };
                }
                renderNavs();
                renderLists();
            });

            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'landmarkConfig'), (docSnap) => {
                if (docSnap.exists()) {
                    planeNames = docSnap.data().planeNames || [...DEFAULT_PLANES];
                } else {
                    planeNames = [...DEFAULT_PLANES];
                }
                renderNavs();
                renderLists();
            });

            window.updateRoleUI();
        };
        init();
    </script>
</body>
</html>
