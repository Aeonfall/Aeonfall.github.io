<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aeonfall - Player's Handbook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Roboto+Slab:wght@300;400;700&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto Slab', serif; background-color: #1a1a1a; color: #e2e8f0; overflow-x: hidden; }
        .dashboard-bg { background-image: url('https://www.transparenttextures.com/patterns/dark-wood.png'); background-color: #0c0c0c; }
        
        /* HEADER STYLING */
        .brand-title { font-family: 'Cinzel', serif; font-weight: 900; color: #f59e0b; font-size: 3.5rem; line-height: 1; margin-bottom: 0.2rem; }
        .brand-sub { font-family: 'Cinzel', serif; font-size: 11px; font-weight: 700; color: #64748b; letter-spacing: 0.15em; text-transform: uppercase; }
        
        .user-pill { background: rgba(30, 41, 59, 0.6); border: 1px solid #334155; padding: 6px 16px; border-radius: 99px; display: flex; align-items: center; gap: 10px; }
        .status-dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 10px #22c55e; }
        .user-name-text { font-family: 'Cinzel', serif; font-size: 11px; font-weight: 900; color: #e2e8f0; text-transform: uppercase; }
        .logout-btn { font-family: 'Cinzel', serif; font-size: 10px; font-weight: 700; color: #ef4444; border-left: 1px solid #475569; padding-left: 10px; margin-left: 4px; cursor: pointer; border: none; background: transparent; }
        
        .role-selector { background: #0f172a; border-radius: 12px; padding: 4px; display: flex; gap: 4px; border: 1px solid #1e293b; }
        .role-btn { padding: 8px 24px; font-family: 'Cinzel', serif; font-size: 11px; font-weight: 900; border-radius: 8px; transition: all 0.3s; color: #475569; text-transform: uppercase; border: none; cursor: pointer; }
        .role-btn.active { background: #d97706; color: white; box-shadow: 0 4px 12px rgba(217, 119, 6, 0.4); }

        .nav-link { font-family: 'Cinzel', serif; color: #94a3b8; font-weight: 900; font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em; transition: color 0.2s; padding-bottom: 6px; border-bottom: 2px solid transparent; text-decoration: none; }
        .nav-link:hover { color: #f59e0b; }
        .nav-link.active { color: #f59e0b; border-bottom-color: #f59e0b; }

        /* CARD STYLING */
        .script-card {
            background-color: #fdfaf3; border: 2px solid #bba683; border-radius: 12px;
            padding: 24px; color: #2c1810; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative; height: 100%; min-height: fit-content; display: flex; flex-direction: column;
            transition: transform 0.2s ease, border-color 0.2s;
        }
        
        /* Drag and Drop Styling */
        .dm-active-edit .script-card, 
        .dm-active-edit .progression-table-container,
        .dm-active-edit .archetype-divider { cursor: grab; user-select: none; }
        .dm-active-edit .script-card:active { cursor: grabbing; }
        .dragging { opacity: 0.3; transform: scale(0.95); z-index: 1000; }
        
        /* Drop Target Visuals */
        .drop-before { border-top: 6px solid #f59e0b !important; }
        .drop-after { border-bottom: 6px solid #f59e0b !important; }
        .drop-left { border-left: 8px solid #f59e0b !important; }
        .drop-right { border-right: 8px solid #f59e0b !important; }

        .script-card-header { border-bottom: 2px solid #7a1d1d; margin-bottom: 8px; padding-bottom: 4px; display: flex; justify-content: space-between; align-items: flex-start; }
        .script-card-title { font-family: 'Cinzel', serif; font-weight: 900; font-size: 20px; color: #7a1d1d; text-transform: uppercase; flex-grow: 1; }
        .script-card-level { font-style: italic; font-size: 13px; margin-bottom: 12px; display: block; }
        .script-prop-list { list-style: disc; margin-left: 20px; font-size: 13px; margin-bottom: 16px; }
        .script-body { font-size: 14px; line-height: 1.6; white-space: pre-wrap; flex-grow: 1; min-height: 1em; }
        .script-footer { font-style: italic; font-size: 11px; margin-top: 12px; border-top: 1px solid #7a1d1d33; padding-top: 8px; }

        /* Progression Table */
        .progression-table-container { 
            background-color: #fdfaf3; border: 4px double #bba683; border-radius: 12px; 
            padding: 20px; color: #2c1810; margin-bottom: 32px; overflow-x: auto;
            position: relative; transition: border-color 0.2s; height: auto;
        }
        .progression-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .progression-table th { 
            font-family: 'Cinzel', serif; font-weight: 900; text-transform: uppercase; 
            color: #7a1d1d; border-bottom: 2px solid #7a1d1d; padding: 12px 8px; text-align: left;
            position: relative;
        }
        .progression-table td { padding: 10px 8px; border-bottom: 1px solid rgba(122, 29, 29, 0.1); }

        .header-delete-btn {
            position: absolute; top: -2px; right: -2px; background: #ef4444; color: white;
            width: 14px; height: 14px; border-radius: 50%; font-size: 8px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            border: 1px solid white; opacity: 0; transition: opacity 0.2s;
        }
        th:hover .header-delete-btn { opacity: 1; }

        /* Archetype Divider */
        .archetype-divider { 
            grid-column: 1 / -1; margin: 48px 0 24px 0; 
            border-left: 8px solid #f59e0b; background: rgba(245, 158, 11, 0.05);
            padding: 16px 24px; border-radius: 4px 16px 16px 4px;
            display: flex; align-items: center; justify-content: space-between;
            position: relative; transition: border-color 0.2s;
        }
        .archetype-name { font-family: 'Cinzel', serif; font-weight: 900; font-size: 24px; color: #f59e0b; text-transform: uppercase; }
        .archetype-controls { display: flex; gap: 8px; align-items: center; }
        .arch-btn { font-size: 10px; font-weight: 900; text-transform: uppercase; padding: 6px 12px; border-radius: 4px; cursor: pointer; border: none; transition: background 0.2s; }
        .arch-btn-add { background: #22c55e; color: white; }
        .arch-btn-util { background: #64748b; color: white; }
        .arch-btn-delete { background: #ef4444; color: white; opacity: 0.4; }
        .arch-btn-delete:hover { opacity: 1; }

        /* Link Pulsing */
        .item-reference-link { color: #7a1d1d; text-decoration: underline; text-decoration-style: dotted; cursor: pointer; font-weight: 700; }
        .item-reference-link:hover { color: #f59e0b; }
        @keyframes highlight-pulse {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); transform: scale(1); }
            50% { box-shadow: 0 0 30px 10px rgba(245, 158, 11, 0.4); transform: scale(1.02); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); transform: scale(1); }
        }
        .highlight-glow { animation: highlight-pulse 2s ease-in-out 2; z-index: 50; outline: 3px solid #f59e0b; border-radius: 12px; }

        .archive-button {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155; border-radius: 16px; padding: 24px;
            display: flex; align-items: center; gap: 24px; cursor: pointer; transition: transform 0.2s, border-color 0.2s;
            text-decoration: none;
        }
        .archive-button:hover { transform: translateY(-4px); border-color: #f59e0b; }
        .button-label { font-family: 'Cinzel', serif; font-weight: 900; font-size: 18px; color: #f59e0b; text-transform: uppercase; }
        .button-desc { font-size: 10px; color: #64748b; text-transform: uppercase; font-weight: 700; margin-top: 2px; letter-spacing: 0.05em; }

        .hidden-view { display: none !important; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1e293b; color: #fff; padding: 12px 24px; border-radius: 30px; z-index: 2000; opacity: 0; transition: opacity 0.3s; border: 1px solid #3b82f6; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        
        .class-tab { padding: 8px 16px; font-size: 10px; font-weight: 900; text-transform: uppercase; cursor: pointer; border: 1px solid #333; border-radius: 4px; color: #94a3b8; }
        .class-tab.active { background: #f59e0b; color: #000; border-color: #f59e0b; }
        .level-bubble { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 11px; cursor: pointer; border: 2px solid #bba683; background: #fdfaf3; color: #2c1810; }
        .level-bubble.active { background: #7a1d1d; color: #fff; border-color: #7a1d1d; }

        .section-label { font-size: 10px; text-transform: uppercase; font-weight: 900; color: #f59e0b; opacity: 0.5; margin-bottom: 8px; letter-spacing: 0.2em; display: block; border-bottom: 1px solid rgba(245, 158, 11, 0.1); padding-bottom: 4px; }
        
        input, textarea { background: transparent; border: none; width: 100%; color: inherit; outline: none; }
        .modal-overlay { background: rgba(0,0,0,0.95); backdrop-filter: blur(8px); }

        .term-hover { position: relative; border-bottom: 1px dotted #7a1d1d; cursor: help; }
        .tooltip-content {
            visibility: hidden; width: 220px; background-color: #fdfaf3; color: #2c1810;
            text-align: left; border: 2px solid #7a1d1d; border-radius: 6px; padding: 10px;
            position: absolute; z-index: 100; bottom: 125%; left: 50%; margin-left: -110px;
            opacity: 0; transition: opacity 0.3s; font-size: 11px;
            pointer-events: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .term-hover:hover .tooltip-content { visibility: visible; opacity: 1; }
    </style>
</head>
<body class="min-h-screen dashboard-bg">

    <div id="toast" class="toast">Message</div>

    <!-- MAIN HUB -->
    <div id="hub-view" class="p-4 md:p-8">
        <div class="max-w-7xl mx-auto">
            <header class="flex flex-col md:flex-row justify-between items-end mb-12 border-b border-gray-800/50 pb-8 gap-6">
                <div class="flex flex-col items-start">
                    <h1 class="brand-title">Aeonfall</h1>
                    <div class="flex items-center gap-6">
                        <p class="brand-sub">Campaign Management Suite</p>
                        <div class="user-pill">
                            <span class="status-dot"></span>
                            <span id="user-display-name" class="user-name-text">Guest</span>
                            <button onclick="window.logout()" class="logout-btn uppercase">Logout</button>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col items-end gap-6 w-full md:w-auto">
                    <div class="role-selector">
                        <button id="role-player-btn" onclick="window.setRole('player')" class="role-btn">Player</button>
                        <button id="role-dm-btn" onclick="window.setRole('dm')" class="role-btn">DM</button>
                    </div>
                    <nav class="flex gap-8 items-center">
                        <a href="index.html" class="nav-link">Party</a>
                        <a href="npcs.html" class="nav-link">NPCs</a>
                        <a href="beasts.html" class="nav-link">Bestiary</a>
                        <a href="partybag.html" class="nav-link">Backpack</a>
                        <a href="#" class="nav-link active">Handbook</a>
                    </nav>
                </div>
            </header>

            <div class="flex flex-col gap-5 max-w-2xl mx-auto mt-16">
                <a href="https://homebrewery.naturalcrit.com/share/he6P3R1e5dgq" target="_blank" class="archive-button">
                    <span class="text-4xl">üìñ</span>
                    <div class="flex flex-col">
                        <span class="button-label">Players Handbook</span>
                        <span class="button-desc">Official Aeonfall Rules & Mechanics</span>
                    </div>
                    <span class="ml-auto text-amber-900 font-black">‚Üí</span>
                </a>
                <div onclick="window.switchView('features')" class="archive-button">
                    <span class="text-4xl">üí•</span>
                    <div class="flex flex-col">
                        <span class="button-label">Feature Moves</span>
                        <span class="button-desc">Unique Class Skills & Combat Arts</span>
                    </div>
                    <span class="ml-auto text-amber-900 font-black">‚Üí</span>
                </div>
                <div onclick="window.switchView('scripts')" class="archive-button">
                    <span class="text-4xl">üìú</span>
                    <div class="flex flex-col">
                        <span class="button-label">Script Codex</span>
                        <span class="button-desc">Class Abilities & Tech Schools</span>
                    </div>
                    <span class="ml-auto text-amber-900 font-black">‚Üí</span>
                </div>
                <div onclick="window.switchView('sessions')" class="archive-button">
                    <span class="text-4xl">üñãÔ∏è</span>
                    <div class="flex flex-col">
                        <span class="button-label">Session Logs</span>
                        <span class="button-desc">Chronicles of the Party Deeds</span>
                    </div>
                    <span class="ml-auto text-amber-900 font-black">‚Üí</span>
                </div>
                <div onclick="window.switchView('items')" class="archive-button">
                    <span class="text-4xl">‚öîÔ∏è</span>
                    <div class="flex flex-col">
                        <span class="button-label">Gear & Artifacts</span>
                        <span class="button-desc">Equipment, Loot, and Scavenged Tech</span>
                    </div>
                    <span class="ml-auto text-amber-900 font-black">‚Üí</span>
                </div>
            </div>
        </div>
    </div>

    <!-- FEATURES VIEW -->
    <div id="features-view" class="hidden-view p-4 md:p-8">
        <div class="max-w-6xl mx-auto">
            <button onclick="window.switchView('hub')" class="text-amber-500 font-black text-xs uppercase mb-8 hover:text-amber-400">‚Üê Back to Archives</button>
            <div class="mb-8">
                <span class="section-label">Martial Classes</span>
                <div class="flex flex-wrap gap-2 mb-6" id="feature-martial-tabs"></div>
                <span class="section-label">Script Users</span>
                <div class="flex flex-wrap gap-2" id="feature-script-tabs"></div>
            </div>
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <div>
                    <h2 class="font-serif font-black text-3xl uppercase text-amber-500" id="current-feature-title">Feature Moves</h2>
                    <p class="text-xs text-amber-900/60 font-black uppercase tracking-widest mt-2" id="current-feature-class-label">Features</p>
                </div>
                <div class="flex gap-2 flex-wrap">
                    <button id="add-table-btn" onclick="window.addTableEntry()" class="hidden bg-amber-900/80 text-white px-6 py-3 rounded-full font-black text-xs uppercase shadow-xl">+ Table</button>
                    <button id="add-archetype-btn" onclick="window.addArchetypeEntry()" class="hidden bg-amber-800 text-white px-6 py-3 rounded-full font-black text-xs uppercase shadow-xl">Archetype</button>
                    <button id="add-feature-btn" onclick="window.addFeatureEntry()" class="hidden bg-amber-600 text-white px-8 py-3 rounded-full font-black text-xs uppercase shadow-xl">+ Move</button>
                </div>
            </div>
            <div id="features-list" class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start" ondragover="window.handleDragOver(event)" ondrop="window.handleDrop(event, 'features')"></div>
        </div>
    </div>

    <!-- SCRIPTS VIEW -->
    <div id="scripts-view" class="hidden-view p-4 md:p-8">
        <div class="max-w-6xl mx-auto">
            <button onclick="window.switchView('hub')" class="text-amber-500 font-black text-xs uppercase mb-8 hover:text-amber-400">‚Üê Back to Archives</button>
            <div class="flex flex-wrap gap-2 mb-8" id="class-tabs"></div>
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <div class="text-center md:text-left">
                    <h2 class="font-serif font-black text-3xl uppercase text-amber-500" id="current-class-title">Scripts</h2>
                    <div class="flex items-center gap-3 mt-4" id="level-nav"></div>
                </div>
                <button id="add-script-btn" onclick="window.addScriptEntry()" class="hidden bg-amber-600 text-white px-8 py-3 rounded-full font-black text-xs uppercase shadow-xl">+ Inscribe Script</button>
            </div>
            <div id="scripts-list" class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start" ondragover="window.handleDragOver(event)" ondrop="window.handleDrop(event, 'scripts')"></div>
        </div>
    </div>

    <!-- ITEMS VIEW -->
    <div id="items-view" class="hidden-view p-4 md:p-8">
        <div class="max-w-6xl mx-auto">
            <button onclick="window.switchView('hub')" class="text-amber-500 font-black text-xs uppercase mb-8 hover:text-amber-400">‚Üê Back to Archives</button>
            <div class="flex flex-wrap gap-2 mb-8" id="item-category-tabs"></div>
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <div>
                    <h2 class="font-serif font-black text-3xl uppercase text-amber-500">Gear & Artifacts</h2>
                    <p class="text-xs text-amber-900/60 font-black uppercase tracking-widest mt-2" id="current-item-category-title">All Equipment</p>
                </div>
                <button id="add-item-btn" onclick="window.addItemEntry()" class="hidden bg-amber-600 text-white px-8 py-3 rounded-full font-black text-xs uppercase shadow-xl">+ Log Item</button>
            </div>
            <div id="items-list" class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start" ondragover="window.handleDragOver(event)" ondrop="window.handleDrop(event, 'items')"></div>
        </div>
    </div>

    <!-- SESSIONS VIEW -->
    <div id="sessions-view" class="hidden-view p-4 md:p-8">
        <div class="max-w-6xl mx-auto">
            <button onclick="window.switchView('hub')" class="text-amber-500 font-black text-xs uppercase mb-8 hover:text-amber-400">‚Üê Back to Archives</button>
            <div class="bg-[#fdfaf3] border-8 border-[#bba683] p-10 text-gray-900 min-h-[600px] shadow-2xl relative">
                <div class="flex justify-between items-end mb-8 border-b-2 border-gray-900 pb-4">
                    <h2 class="font-serif font-black text-3xl uppercase tracking-widest text-[#7a1d1d]">Campaign Chronicles</h2>
                    <button id="add-session-btn" onclick="window.addSessionEntry()" class="hidden bg-amber-800 text-white px-6 py-2 rounded-full font-black text-[10px] uppercase shadow-lg">+ New Session</button>
                </div>
                <div id="sessions-list" class="space-y-20"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="lightbox-modal" class="fixed inset-0 z-[1000] flex items-center justify-center p-4 hidden">
        <div class="modal-overlay absolute inset-0" onclick="document.getElementById('lightbox-modal').classList.add('hidden')"></div>
        <img id="lightbox-img" src="" alt="Zoomed Asset" class="relative z-10 max-w-[90vw] max-h-[80vh] border-4 border-amber-600 rounded shadow-2xl">
    </div>

    <div id="delete-modal" class="fixed inset-0 z-[600] flex items-center justify-center p-4 hidden">
        <div class="modal-overlay absolute inset-0" onclick="document.getElementById('delete-modal').classList.add('hidden')"></div>
        <div class="bg-white p-8 rounded-2xl w-full max-sm border-4 border-red-600 text-center text-gray-900 relative z-10 shadow-2xl">
            <h3 class="text-2xl font-serif font-black text-red-700 uppercase mb-4">Erase Record?</h3>
            <div class="flex flex-col gap-3">
                <button id="confirm-delete-btn" class="w-full bg-red-700 text-white py-4 rounded-xl font-black text-xs uppercase">Yes, Erase</button>
                <button onclick="document.getElementById('delete-modal').classList.add('hidden')" class="w-full bg-gray-100 text-gray-500 py-3 rounded-xl font-black text-[10px] uppercase">Cancel</button>
            </div>
        </div>
    </div>

    <div id="password-modal" class="fixed inset-0 bg-black/80 backdrop-blur-md flex items-center justify-center z-[500] hidden">
        <div class="bg-gray-900/90 p-8 rounded-3xl w-full max-w-sm border border-amber-600/30 text-white text-center shadow-2xl">
            <h3 class="text-xl font-serif text-amber-500 font-bold mb-1 uppercase">DM Access</h3>
            <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-6">Credential Verification Required</p>
            <input type="password" id="dm-password" class="w-full bg-gray-950 text-center text-2xl rounded-2xl p-4 mb-6 border border-gray-800 focus:border-amber-500/50 outline-none">
            <button onclick="window.verifyDmPassword()" class="w-full bg-amber-600 hover:bg-amber-500 text-white py-4 rounded-2xl font-black uppercase text-xs">Unlock</button>
            <button onclick="document.getElementById('password-modal').classList.add('hidden')" class="w-full text-gray-500 mt-6 text-[10px] uppercase font-bold hover:text-white transition-colors">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, updateDoc, onSnapshot, addDoc, deleteDoc, writeBatch, initializeFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Environment variables
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'aeonfall-manager-v2';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        // Force long polling to fix connection failures in preview environments
        const db = initializeFirestore(app, { experimentalForceLongPolling: true });

        const CLASSES = ["Heartbound", "Nomad", "Wilderness Warden", "Chronicler", "Orator", "Scriptweaver", "War-Touched", "Archivist", "Fabricator"];
        const FEATURE_MARTIAL_CLASSES = ["Vanguard", "Warrior", "Peacekeeper", "Scavenger"];
        const ITEM_CATEGORIES = ["All", "Weapons", "Armor", "Material Component", "Adventuring Gear", "Artifacts", "Recipes & Consumables"];
        
        const TOOLTIPS = {
            "Activation Time": "The amount of time required to initialize this script.",
            "Range/Area": "The maximum distance the script can reach.",
            "Components": "Triggers: Verbal (V), Somatic (S), or Material (M).",
            "Duration": "How long the script persists.",
            "Concentration": "Requires continuous focus.",
            "V": "Verbal command strings.",
            "S": "Somatic hand gestures.",
            "M": "Material component requirement.",
            "Aegis": "Protection and resistance.",
            "Dominion": "Will and influence.",
            "Ruin": "Raw energy and destruction.",
            "Mortis": "Biological failure and recovery.",
            "Forge": "Transformation and reshaping matter."
        };

        // --- GLOBAL UTILITIES ---
        function parseAeonfallContent(text, isDM) {
            if (!text) return '';
            if (isDM) return text; 
            let html = text.replace(/&&([^&]+)&&/g, (match, content) => {
                const parts = content.split('|');
                const term = parts[0].trim();
                const definition = parts.length > 1 ? parts[1].trim() : (TOOLTIPS[term] || "Technical record restricted.");
                return `<span class="term-hover def-term">${term}<span class="tooltip-content">${definition}</span></span>`;
            });
            html = html.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\*(.*?)\*/g, '<i>$1</i>');
            return html;
        }

        function wrapWithTooltip(label, termKey) {
            const key = termKey || label;
            if (TOOLTIPS[key]) return `<span class="term-hover">${label}<span class="tooltip-content">${TOOLTIPS[key]}</span></span>`;
            return label;
        }

        function linkifyComponents(text, isDM) {
            if (!text || isDM) return text;
            return text.replace(/\b(V|S|M)\b/g, m => wrapWithTooltip(m));
        }

        let currentClass = "Heartbound";
        let currentFeatureClass = "Vanguard";
        let currentLevel = 1; 
        let currentItemCategory = "All";
        let activeRole = 'player';
        let scripts = [], sessions = [], items = [], features = [], archetypes = [], tables = [];
        let autoSaveTimer = null;
        let itemToDeleteId = null;
        let deleteType = ''; 
        let draggedId = null;
        let draggedType = null;

        window.showToast = (m) => { const t = document.getElementById('toast'); t.textContent=m; t.style.opacity=1; setTimeout(()=>t.style.opacity=0, 3000); };

        window.setRole = (r) => { 
            if (r === 'dm') {
                if (localStorage.getItem('aeonfall_role') === 'dm') { activeRole = 'dm'; window.updateRoleUI(); return; }
                document.getElementById('password-modal').classList.remove('hidden'); 
            } else { 
                activeRole = 'player'; 
                localStorage.setItem('aeonfall_role', 'player'); 
                window.updateRoleUI(); 
            } 
        };
        
        window.verifyDmPassword = () => { 
            if (document.getElementById('dm-password').value === 'Rew4994') { 
                activeRole = 'dm'; 
                localStorage.setItem('aeonfall_role', 'dm'); 
                document.getElementById('password-modal').classList.add('hidden'); 
                window.updateRoleUI(); 
            } else { window.showToast("Access Denied"); } 
        };

        window.logout = () => { 
            localStorage.removeItem('aeonfall_user'); 
            localStorage.removeItem('aeonfall_role'); 
            const url = new URL('index.html', window.location.href);
            window.location.assign(url.pathname);
        };

        window.updateRoleUI = () => {
            const isDM = activeRole === 'dm';
            const playerBtn = document.getElementById('role-player-btn');
            const dmBtn = document.getElementById('role-dm-btn');
            if(playerBtn) playerBtn.classList.toggle('active', !isDM);
            if(dmBtn) dmBtn.classList.toggle('active', isDM);
            document.body.classList.toggle('dm-active-edit', isDM);
            ['add-script-btn', 'add-session-btn', 'add-item-btn', 'add-feature-btn', 'add-archetype-btn', 'add-table-btn'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.toggle('hidden', !isDM);
            });
            renderLists();
            renderNavs();
        };

        window.switchView = (v) => {
            ['hub', 'scripts', 'sessions', 'items', 'features'].forEach(id => {
                const el = document.getElementById(`${id}-view`);
                if(el) el.classList.add('hidden-view');
            });
            const target = document.getElementById(`${v}-view`);
            if(target) target.classList.remove('hidden-view');
            window.scrollTo(0,0);
        };

        window.selectClass = (c) => { currentClass = c; renderNavs(); renderLists(); };
        window.selectFeatureClass = (c) => { currentFeatureClass = c; renderNavs(); renderLists(); };
        window.selectLevel = (l) => { currentLevel = l; renderLists(); renderNavs(); };
        window.selectItemCategory = (cat) => { currentItemCategory = cat; renderNavs(); renderLists(); };

        // --- SMART LINKING & JUMP LOGIC ---
        function linkifyCellContent(text, isDM) {
            if (!text || isDM) return text;
            const matchName = text.trim().replace(/[,.;]$/, "");
            const matchFeature = features.find(f => f.title.toLowerCase() === matchName.toLowerCase());
            const matchScript = scripts.find(s => s.title.toLowerCase() === matchName.toLowerCase());
            const matchArch = archetypes.find(a => a.name.toLowerCase() === matchName.toLowerCase());

            if (matchFeature || matchScript || matchArch) {
                return `<span class="item-reference-link" onclick="window.universalJump('${matchName.replace(/'/g, "\\'")}')">${text}</span>`;
            }
            return text;
        }

        window.universalJump = (name) => {
            const lowName = name.toLowerCase();
            const fMatch = features.find(f => f.title.toLowerCase() === lowName);
            const sMatch = scripts.find(s => s.title.toLowerCase() === lowName);
            const aMatch = archetypes.find(a => a.name.toLowerCase() === lowName);

            if (fMatch || aMatch) {
                window.switchView('features');
                currentFeatureClass = fMatch ? fMatch.className : aMatch.parentClass;
                renderNavs(); renderLists(); scrollAndHighlight(name);
            } else if (sMatch) {
                window.switchView('scripts');
                currentClass = sMatch.className || (sMatch.scriptLists ? sMatch.scriptLists.split(',')[0].trim() : 'Chronicler');
                currentLevel = parseInt(sMatch.level);
                renderNavs(); renderLists(); scrollAndHighlight(name);
            }
        };

        function scrollAndHighlight(name) {
            setTimeout(() => {
                const searchStr = name.toLowerCase();
                const targets = Array.from(document.querySelectorAll('.script-card-title, .archetype-name'));
                const el = targets.find(t => t.innerText.toLowerCase() === searchStr);
                if (el) {
                    const card = el.closest('.script-card, .archetype-divider');
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    card.classList.add('highlight-glow');
                    setTimeout(() => card.classList.remove('highlight-glow'), 3000);
                }
            }, 300);
        }

        // --- CLIPBOARD ---
        window.copyScript = (id) => {
            const s = scripts.find(script => script.id === id);
            if (!s) return;
            const cleanContent = (s.content || "").replace(/&&([^|&]+)(?:\|[^&]+)?&&/g, '$1').replace(/\*\*|\*|__/g, '');
            const text = `--- AEONFALL SCRIPT ---\nNAME: ${s.title.toUpperCase()}\nLVL: ${s.level}\n${cleanContent}`;
            const textArea = document.createElement("textarea");
            textArea.value = text; document.body.appendChild(textArea); textArea.select();
            try { document.execCommand('copy'); window.showToast("Data Compiled"); } catch (err) { window.showToast("Copy Failed"); }
            document.body.removeChild(textArea);
        };

        window.copyFeature = (id) => {
            const f = features.find(feat => feat.id === id);
            if (!f) return;
            const cleanContent = (f.content || "").replace(/&&([^|&]+)(?:\|[^&]+)?&&/g, '$1').replace(/\*\*|\*|__/g, '');
            const text = `--- AEONFALL FEATURE ---\nNAME: ${f.title.toUpperCase()}\n${cleanContent}`;
            const textArea = document.createElement("textarea");
            textArea.value = text; document.body.appendChild(textArea); textArea.select();
            try { document.execCommand('copy'); window.showToast("Data Compiled"); } catch (err) { window.showToast("Copy Failed"); }
            document.body.removeChild(textArea);
        };

        // --- SPATIAL DRAG AND DROP HANDLERS ---
        window.handleDragStart = (e, id, type) => {
            if (activeRole !== 'dm') return;
            draggedId = id; draggedType = type;
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        };

        window.handleDragEnd = (e) => {
            e.currentTarget.classList.remove('dragging');
            document.querySelectorAll('.drop-before, .drop-after, .drop-left, .drop-right').forEach(el => el.classList.remove('drop-before', 'drop-after', 'drop-left', 'drop-right'));
            draggedId = null;
        };

        window.handleDragOver = (e) => {
            if (activeRole !== 'dm') return;
            e.preventDefault();
            const target = e.target.closest('.script-card, .progression-table-container, .archetype-divider');
            if (!target || target.dataset.id === draggedId) return;

            const rect = target.getBoundingClientRect();
            const relX = e.clientX - rect.left;
            const relY = e.clientY - rect.top;

            document.querySelectorAll('.drop-before, .drop-after, .drop-left, .drop-right').forEach(el => el.classList.remove('drop-before', 'drop-after', 'drop-left', 'drop-right'));

            const isArchetype = target.classList.contains('archetype-divider');
            if (isArchetype) {
                if (relY < rect.height / 2) target.classList.add('drop-before');
                else target.classList.add('drop-after');
            } else {
                if (relY < rect.height * 0.25) target.classList.add('drop-before');
                else if (relY > rect.height * 0.75) target.classList.add('drop-after');
                else if (relX < rect.width / 2) target.classList.add('drop-left');
                else target.classList.add('drop-right');
            }
        };

        window.handleDrop = async (e, viewType) => {
            if (activeRole !== 'dm' || !draggedId) return;
            e.preventDefault();
            const dropZone = e.target.closest('.script-card, .progression-table-container, .archetype-divider');
            if (!dropZone) return;

            const targetId = dropZone.dataset.id;
            const targetArchId = dropZone.dataset.archetypeId || null;
            const isBefore = dropZone.classList.contains('drop-before') || dropZone.classList.contains('drop-left');

            let containerId = viewType === 'scripts' ? 'scripts-list' : (viewType === 'items' ? 'items-list' : 'features-list');
            const elements = Array.from(document.getElementById(containerId).children);
            const colMap = { 'script': 'handbookScripts', 'feature': 'handbookFeatures', 'table': 'handbookTables', 'archetype': 'handbookArchetypes', 'item': 'handbookItems' };

            let sequence = elements.map(el => ({ id: el.dataset.id, type: el.dataset.type }));
            const draggedIdx = sequence.findIndex(x => x.id === draggedId);
            const targetIdx = sequence.findIndex(x => x.id === targetId);
            if (draggedIdx === -1 || targetIdx === -1) return;

            const [draggedItem] = sequence.splice(draggedIdx, 1);
            const newTargetIdx = sequence.findIndex(x => x.id === targetId);
            sequence.splice(isBefore ? newTargetIdx : newTargetIdx + 1, 0, draggedItem);

            const batch = writeBatch(db);
            sequence.forEach((x, i) => {
                const collectionName = colMap[x.type];
                if (!collectionName) return;
                const ref = doc(db, 'artifacts', appId, 'public', 'data', collectionName, x.id);
                batch.update(ref, { order: i * 10 });
                if (x.id === draggedId && x.type !== 'archetype' && viewType === 'features') {
                    batch.update(ref, { archetypeId: targetArchId });
                }
            });
            await batch.commit();
            window.showToast("Order Synchronized");
        };

        // --- TABLE UTILITIES ---
        window.removeHeaderAtIndex = async (tableId, index) => {
            const table = tables.find(t => t.id === tableId);
            if (!table || table.headers.length <= 1) return;
            const newHeaders = [...table.headers]; newHeaders.splice(index, 1);
            const newRows = table.rows.map(row => { const r = [...row]; r.splice(index, 1); return r; });
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookTables', tableId), { headers: newHeaders, rows: JSON.stringify(newRows) });
        };
        window.addRowToTable = async (id) => { const t = tables.find(x => x.id === id); if (!t) return; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookTables', id), { rows: JSON.stringify([...t.rows, new Array(t.headers.length).fill("...")]) }); };
        window.removeRowFromTable = async (id) => { const t = tables.find(x => x.id === id); if (!t || t.rows.length <= 1) return; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookTables', id), { rows: JSON.stringify(t.rows.slice(0, -1)) }); };
        window.addColumnToTable = async (id) => { const t = tables.find(x => x.id === id); if (!t) return; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookTables', id), { headers: [...t.headers, "Header"], rows: JSON.stringify(t.rows.map(r => [...r, "..."])) }); };
        window.removeColumnFromTable = async (id) => { const t = tables.find(x => x.id === id); if (!t || t.headers.length <= 1) return; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookTables', id), { headers: t.headers.slice(0, -1), rows: JSON.stringify(t.rows.map(r => r.slice(0, -1))) }); };

        // --- COMPONENT BUILDERS ---
        function createScriptCard(s, isDM) {
            return `
                <div class="script-card" data-id="${s.id}" data-type="script" draggable="${isDM}" 
                     ondragstart="window.handleDragStart(event, '${s.id}', 'script')" ondragend="window.handleDragEnd(event)">
                    <div class="script-card-header">
                        <div class="script-card-title dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdate('${s.id}', 'title', this.innerText)">${s.title}</div>
                        ${isDM ? `<button onclick="window.triggerDeleteScript('${s.id}')" class="text-red-500 opacity-30">‚úï</button>` : ''}
                    </div>
                    <span class="script-card-level">${s.level === 0 ? 'Trick' : s.level + '-level'} ‚Äî <span class="${isDM ? 'dm-editable' : ''}" contenteditable="${isDM}" oninput="window.debounceUpdate('${s.id}', 'school', this.innerText)">${s.school || 'Dominion'}</span></span>
                    <ul class="script-prop-list">
                        <li><b>Activation:</b> <span class="dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdate('${s.id}', 'activationTime', this.innerText)">${s.activationTime || '1 Action'}</span></li>
                        <li><b>Range:</b> <span class="dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdate('${s.id}', 'range', this.innerText)">${s.range || '30 feet'}</span></li>
                        <li><b>Components:</b> <span class="${isDM ? 'dm-editable' : ''}" contenteditable="${isDM}" oninput="window.debounceUpdate('${s.id}', 'components', this.innerText)">${linkifyComponents(s.components || 'V, S', isDM)}</span></li>
                    </ul>
                    <div class="script-body ${isDM ? 'dm-editable' : ''}" contenteditable="${isDM}" oninput="window.debounceUpdate('${s.id}', 'content', this.innerText)">${parseAeonfallContent(s.content, isDM)}</div>
                    <button onclick="window.copyScript('${s.id}')" class="mt-6 w-full border border-amber-900/20 py-2 rounded text-amber-900 font-black text-[10px] uppercase">üìã Copy Data</button>
                </div>
            `;
        }

        function createFeatureCard(f, isDM) {
            return `
                <div class="script-card" data-id="${f.id}" data-type="feature" data-archetype-id="${f.archetypeId || ''}" draggable="${isDM}"
                     ondragstart="window.handleDragStart(event, '${f.id}', 'feature')" ondragend="window.handleDragEnd(event)">
                    <div class="script-card-header">
                        <div class="script-card-title dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdateFeature('${f.id}', 'title', this.innerText)">${f.title}</div>
                        ${isDM ? `<button onclick="window.triggerDeleteFeature('${f.id}')" class="text-red-500 opacity-30">‚úï</button>` : ''}
                    </div>
                    <span class="script-card-level dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdateFeature('${f.id}', 'type', this.innerText)">${f.type || 'Feature'}</span>
                    <div class="script-body mt-4 ${isDM ? 'dm-editable' : ''}" contenteditable="${isDM}" oninput="window.debounceUpdateFeature('${f.id}', 'content', this.innerText)">${parseAeonfallContent(f.content, isDM)}</div>
                    <button onclick="window.copyFeature('${f.id}')" class="mt-6 w-full border border-amber-900/20 py-2 rounded text-amber-900 font-black text-[10px] uppercase">üìã Copy Data</button>
                </div>
            `;
        }

        function createTableHtml(t, isDM) {
            let hHtml = (t.headers || []).map((h, i) => `<th class="group"><div contenteditable="${isDM}" oninput="window.debounceUpdateTableCell('${t.id}', 'headers', ${i}, this.innerText)">${h}</div>${isDM ? `<div class="header-delete-btn" onclick="window.removeHeaderAtIndex('${t.id}', ${i})">‚úï</div>` : ''}</th>`).join('');
            let rHtml = (t.rows || []).map((row, rowIdx) => {
                let cellsHtml = row.map((cell, cellIdx) => `<td contenteditable="${isDM}" oninput="window.debounceUpdateTableCell('${t.id}', 'rows', ${rowIdx}, this.innerText, ${cellIdx})">${isDM ? cell : linkifyCellContent(cell, isDM)}</td>`).join('');
                return `<tr>${cellsHtml}</tr>`;
            }).join('');
            return `
                <div class="progression-table-container shadow-2xl" style="grid-column: 1 / -1;" data-id="${t.id}" data-type="table" data-archetype-id="${t.archetypeId || ''}" draggable="${isDM}"
                     ondragstart="window.handleDragStart(event, '${t.id}', 'table')" ondragend="window.handleDragEnd(event)">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-serif font-black uppercase text-xl text-[#7a1d1d] dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdateTable('${t.id}', 'title', this.innerText)">${t.title}</h3>
                        ${isDM ? `<div class="flex gap-2">
                            <button onclick="window.addRowToTable('${t.id}')" class="arch-btn arch-btn-add">+ Row</button>
                            <button onclick="window.removeRowFromTable('${t.id}')" class="arch-btn arch-btn-delete">- Row</button>
                            <button onclick="window.addColumnToTable('${t.id}')" class="arch-btn arch-btn-util">+ Header</button>
                            <button onclick="window.removeColumnFromTable('${t.id}')" class="arch-btn arch-btn-util">- Header</button>
                            <button onclick="window.triggerDeleteTable('${t.id}')" class="arch-btn arch-btn-delete">‚úï</button>
                        </div>` : ''}
                    </div>
                    <table class="progression-table"><thead><tr>${hHtml}</tr></thead><tbody>${rHtml}</tbody></table>
                </div>
            `;
        }

        const renderLists = () => {
            const isDM = activeRole === 'dm';
            const sortByOrder = (a, b) => (a.order ?? 999999) - (b.order ?? 999999);
            
            const fList = document.getElementById('features-list');
            if (fList) {
                fList.innerHTML = '';
                tables.filter(t => t.parentClass === currentFeatureClass && !t.archetypeId).sort(sortByOrder).forEach(t => fList.innerHTML += createTableHtml(t, isDM));
                features.filter(f => f.className === currentFeatureClass && !f.archetypeId).sort(sortByOrder).forEach(f => fList.innerHTML += createFeatureCard(f, isDM));
                archetypes.filter(a => a.parentClass === currentFeatureClass).sort(sortByOrder).forEach(arch => {
                    const divider = document.createElement('div');
                    divider.className = 'archetype-divider shadow-md'; divider.dataset.id = arch.id; divider.dataset.type = 'archetype'; divider.draggable = isDM;
                    divider.ondragstart = (e) => window.handleDragStart(e, arch.id, 'archetype'); divider.ondragend = (e) => window.handleDragEnd(e);
                    divider.innerHTML = `<div class="archetype-name dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdateArchetype('${arch.id}', 'name', this.innerText)">${arch.name}</div>
                        ${isDM ? `<div class="archetype-controls">
                            <button onclick="window.addTableEntry('${arch.id}')" class="arch-btn arch-btn-add">+ Tbl</button>
                            <button onclick="window.addFeatureEntry('${arch.id}')" class="arch-btn arch-btn-add">+ Mov</button>
                            <button onclick="window.addScriptEntry(null, '${arch.id}')" class="arch-btn arch-btn-add">+ Scr</button>
                            <button onclick="window.triggerDeleteArchetype('${arch.id}')" class="arch-btn arch-btn-delete">‚úï</button>
                        </div>` : ''}`;
                    fList.appendChild(divider);
                    tables.filter(t => t.archetypeId === arch.id).sort(sortByOrder).forEach(t => fList.innerHTML += createTableHtml(t, isDM));
                    features.filter(f => f.archetypeId === arch.id).sort(sortByOrder).forEach(f => fList.innerHTML += createFeatureCard(f, isDM));
                    scripts.filter(s => s.archetypeId === arch.id).sort(sortByOrder).forEach(s => fList.innerHTML += createScriptCard(s, isDM));
                });
            }

            const sList = document.getElementById('scripts-list');
            if (sList) {
                sList.innerHTML = '';
                scripts.filter(s => parseInt(s.level) === currentLevel && (s.scriptLists || '').toLowerCase().includes(currentClass.toLowerCase())).sort(sortByOrder).forEach(s => sList.innerHTML += createScriptCard(s, isDM));
            }

            const iList = document.getElementById('items-list');
            if (iList) {
                iList.innerHTML = '';
                items.filter(i => currentItemCategory === "All" || (i.category || '').toLowerCase() === currentItemCategory.toLowerCase()).sort(sortByOrder).forEach(i => {
                    const card = document.createElement('div');
                    card.className = 'script-card'; card.dataset.id = i.id; card.dataset.type = 'item'; card.draggable = isDM;
                    card.ondragstart = (e) => window.handleDragStart(e, i.id, 'item'); card.ondragend = (e) => window.handleDragEnd(e);
                    const imgUrl = (i.imageUrl || '').trim();
                    card.innerHTML = `<div class="script-card-header"><div class="script-card-title dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdateItem('${i.id}', 'title', this.innerText)">${i.title}</div>
                        ${isDM ? `<button onclick="window.triggerDeleteItem('${i.id}')" class="text-red-500 opacity-30">‚úï</button>` : ''}</div>
                        <span class="script-card-level"><span class="dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdateItem('${i.id}', 'rarity', this.innerText)">${i.rarity || 'Common'}</span> Gear</span>
                        ${imgUrl ? `<img src="${imgUrl}" class="w-full h-40 object-cover rounded border border-amber-900/20 mb-4" onclick="window.zoomImage('${imgUrl}')">` : ''}
                        <div class="script-body ${isDM ? 'dm-editable' : ''}" contenteditable="${isDM}" oninput="window.debounceUpdateItem('${i.id}', 'content', this.innerText)">${parseAeonfallContent(i.content, isDM)}</div>`;
                    iList.appendChild(card);
                });
            }
        };

        // --- FIREBASE OPS ---
        window.debounceUpdate = (id, f, v) => { if (autoSaveTimer) clearTimeout(autoSaveTimer); autoSaveTimer = setTimeout(() => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookScripts', id), { [f]: v }), 1000); };
        window.debounceUpdateFeature = (id, f, v) => { if (autoSaveTimer) clearTimeout(autoSaveTimer); autoSaveTimer = setTimeout(() => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookFeatures', id), { [f]: v }), 1000); };
        window.debounceUpdateTable = (id, f, v) => { if (autoSaveTimer) clearTimeout(autoSaveTimer); autoSaveTimer = setTimeout(() => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookTables', id), { [f]: v }), 1000); };
        window.debounceUpdateArchetype = (id, f, v) => { if (autoSaveTimer) clearTimeout(autoSaveTimer); autoSaveTimer = setTimeout(() => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookArchetypes', id), { [f]: v }), 1000); };
        window.debounceUpdateItem = (id, f, v) => { if (autoSaveTimer) clearTimeout(autoSaveTimer); autoSaveTimer = setTimeout(() => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookItems', id), { [f]: v }), 1000); };
        window.debounceUpdateTableCell = (id, f, idx, val, cellIdx = null) => {
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(async () => {
                const table = tables.find(t => t.id === id); if (!table) return;
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'handbookTables', id);
                if (f === 'headers') { const h = [...table.headers]; h[idx] = val; await updateDoc(ref, { headers: h }); }
                else if (f === 'rows') { const r = [...table.rows]; r[idx][cellIdx] = val; await updateDoc(ref, { rows: JSON.stringify(r) }); }
            }, 1000);
        };

        window.triggerDeleteScript = (id) => { itemToDeleteId = id; deleteType = 'script'; document.getElementById('delete-modal').classList.remove('hidden'); };
        window.triggerDeleteFeature = (id) => { itemToDeleteId = id; deleteType = 'feature'; document.getElementById('delete-modal').classList.remove('hidden'); };
        window.triggerDeleteTable = (id) => { itemToDeleteId = id; deleteType = 'table'; document.getElementById('delete-modal').classList.remove('hidden'); };
        window.triggerDeleteArchetype = (id) => { itemToDeleteId = id; deleteType = 'archetype'; document.getElementById('delete-modal').classList.remove('hidden'); };
        window.triggerDeleteItem = (id) => { itemToDeleteId = id; deleteType = 'item'; document.getElementById('delete-modal').classList.remove('hidden'); };

        window.addTableEntry = async (archId = null) => { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'handbookTables'), { title: "NEW TABLE", parentClass: currentFeatureClass, archetypeId: archId, headers: ["Level", "Features"], rows: JSON.stringify([["1st", "..."]]), order: Date.now() }); };
        window.addArchetypeEntry = async () => { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'handbookArchetypes'), { name: "NEW ARCHETYPE", parentClass: currentFeatureClass, order: Date.now() }); };
        window.addFeatureEntry = async (archId = null) => { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'handbookFeatures'), { title: "NEW MOVE", content: "...", type: "Feature", className: currentFeatureClass, archetypeId: archId, order: Date.now() }); };
        window.addScriptEntry = async (lvl = null, archId = null) => { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'handbookScripts'), { title: "NEW SCRIPT", content: "...", school: "Aegis", level: lvl || currentLevel, scriptLists: currentFeatureClass, archetypeId: archId, order: Date.now() }); };
        window.addItemEntry = async () => { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'handbookItems'), { title: "NEW ITEM", content: "...", category: currentItemCategory, order: Date.now() }); };
        window.addSessionEntry = async () => { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'handbookSessions'), { title: "SESSION #", date: new Date().toLocaleDateString(), createdAt: Date.now() }); };

        function renderNavs() {
            const m = document.getElementById('feature-martial-tabs'); if (m) m.innerHTML = FEATURE_MARTIAL_CLASSES.map(c => `<div class="class-tab ${currentFeatureClass === c ? 'active' : ''}" onclick="window.selectFeatureClass('${c}')">${c}</div>`).join('');
            const s = document.getElementById('feature-script-tabs'); if (s) s.innerHTML = CLASSES.map(c => `<div class="class-tab ${currentFeatureClass === c ? 'active' : ''}" onclick="window.selectFeatureClass('${c}')">${c}</div>`).join('');
            const cl = document.getElementById('class-tabs'); if (cl) cl.innerHTML = CLASSES.map(c => `<div class="class-tab ${currentClass === c ? 'active' : ''}" onclick="window.selectClass('${c}')">${c}</div>`).join('');
            const l = document.getElementById('level-nav'); if (l) l.innerHTML = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9].map(i => `<div class="level-bubble ${currentLevel === i ? 'active' : ''}" onclick="window.selectLevel(${i})">${i === 0 ? 'T' : i}</div>`).join('');
            const it = document.getElementById('item-category-tabs'); if (it) it.innerHTML = ITEM_CATEGORIES.map(c => `<div class="class-tab ${currentItemCategory === c ? 'active' : ''}" onclick="window.selectItemCategory('${c}')">${c}</div>`).join('');
            const ft = document.getElementById('current-feature-class-label'); if (ft) ft.textContent = `${currentFeatureClass} Archives`;
        }

        // --- INITIALIZATION ---
        const init = async () => {
            // Restore confirm-delete-btn handler inside init to ensure DOM element exists
            const deleteBtn = document.getElementById('confirm-delete-btn');
            if(deleteBtn) {
                deleteBtn.onclick = async () => {
                    if (!itemToDeleteId) return;
                    const colMap = { 'script': 'handbookScripts', 'feature': 'handbookFeatures', 'archetype': 'handbookArchetypes', 'table': 'handbookTables', 'item': 'handbookItems' };
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', colMap[deleteType], itemToDeleteId));
                    document.getElementById('delete-modal').classList.add('hidden');
                };
            }

            const syncAuth = async () => {
                const userSaved = localStorage.getItem('aeonfall_user');
                if (userSaved) { 
                    const userData = JSON.parse(userSaved);
                    document.getElementById('user-display-name').textContent = userData.username || 'Guest';
                }
                const roleSaved = localStorage.getItem('aeonfall_role');
                if (roleSaved) activeRole = roleSaved;
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                window.updateRoleUI();
            };

            window.addEventListener('storage', (e) => { if (e.key === 'aeonfall_user' || e.key === 'aeonfall_role') syncAuth(); });
            await syncAuth();

            onAuthStateChanged(auth, (user) => {
                if (!user) return;
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'handbookTables'), s => { tables = s.docs.map(d => { const da = d.data(); return { id: d.id, ...da, rows: JSON.parse(da.rows || '[]') }; }); renderLists(); }, (err) => console.log("Tables offline"));
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'handbookArchetypes'), s => { archetypes = s.docs.map(d => ({ id: d.id, ...d.data() })); renderLists(); }, (err) => console.log("Archetypes offline"));
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'handbookFeatures'), s => { features = s.docs.map(d => ({ id: d.id, ...d.data() })); renderLists(); }, (err) => console.log("Features offline"));
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'handbookScripts'), s => { scripts = s.docs.map(d => ({ id: d.id, ...d.data() })); renderLists(); }, (err) => console.log("Scripts offline"));
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'handbookItems'), s => { items = s.docs.map(d => ({ id: d.id, ...d.data() })); renderLists(); }, (err) => console.log("Items offline"));
            });
        };
        init();
    </script>
</body>
</html>
