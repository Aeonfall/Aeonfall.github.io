<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aeonfall - Player's Handbook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Roboto+Slab:wght@300;400;700&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto Slab', serif; background-color: #1a1a1a; color: #e2e8f0; overflow-x: hidden; }
        .dashboard-bg { background-image: url('https://www.transparenttextures.com/patterns/dark-wood.png'); background-color: #0c0c0c; }
        
        /* HEADER STYLING */
        .brand-title { font-family: 'Cinzel', serif; font-weight: 900; color: #f59e0b; font-size: 3.5rem; line-height: 1; margin-bottom: 0.2rem; }
        .brand-sub { font-family: 'Cinzel', serif; font-size: 11px; font-weight: 700; color: #64748b; letter-spacing: 0.15em; text-transform: uppercase; }
        
        .user-pill { background: rgba(30, 41, 59, 0.6); border: 1px solid #334155; padding: 6px 16px; border-radius: 99px; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .status-dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 10px #22c55e; }
        .user-name-text { font-family: 'Cinzel', serif; font-size: 11px; font-weight: 900; color: #e2e8f0; text-transform: uppercase; }
        .logout-btn { font-family: 'Cinzel', serif; font-size: 10px; font-weight: 700; color: #ef4444; border-left: 1px solid #475569; padding-left: 10px; margin-left: 4px; cursor: pointer; }
        
        .role-selector { background: #0f172a; border-radius: 12px; padding: 4px; display: flex; gap: 4px; border: 1px solid #1e293b; }
        .role-btn { padding: 8px 24px; font-family: 'Cinzel', serif; font-size: 11px; font-weight: 900; border-radius: 8px; transition: all 0.3s; color: #475569; text-transform: uppercase; }
        .role-btn.active { background: #d97706; color: white; box-shadow: 0 4px 12px rgba(217, 119, 6, 0.4); }

        .nav-link { font-family: 'Cinzel', serif; color: #94a3b8; font-weight: 900; font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em; transition: color 0.2s; padding-bottom: 6px; border-bottom: 2px solid transparent; }
        .nav-link:hover { color: #f59e0b; }
        .nav-link.active { color: #f59e0b; border-bottom-color: #f59e0b; }
        .nav-link.graveyard { color: #7f1d1d; }

        /* SCRIPT/ITEM CARD Aesthetic */
        .script-card {
            background-color: #fdfaf3; border: 2px solid #bba683; border-radius: 12px;
            padding: 24px; color: #2c1810; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative; height: auto; display: flex; flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            max-width: 100%;
            flex: 1 1 400px; 
            min-width: 320px;
            align-self: stretch;
        }
        .script-card-header { border-bottom: 2px solid #7a1d1d; margin-bottom: 4px; padding-bottom: 4px; display: flex; align-items: flex-start; justify-content: space-between; }
        .script-card-title { font-family: 'Cinzel', serif; font-weight: 900; font-size: 24px; color: #7a1d1d; text-transform: uppercase; flex-grow: 1; }
        .script-card-level { font-style: italic; font-size: 14px; margin-bottom: 12px; display: block; }
        .script-body { font-size: 14px; line-height: 1.6; white-space: pre-wrap; flex-grow: 1; }

        /* Drag Handles */
        .drag-handle { cursor: grab; color: #bba683; padding: 4px; opacity: 0.4; transition: opacity 0.2s; }
        .drag-handle:hover { opacity: 1; }
        .sortable-ghost { opacity: 0.3; transform: scale(0.95); border: 2px dashed #f59e0b !important; }

        /* Progression Table Styling */
        .progression-table-container { 
            background-color: #fdfaf3; border: 4px double #bba683; border-radius: 12px; 
            padding: 20px; color: #2c1810; margin-bottom: 32px;
            position: relative;
            box-sizing: border-box;
            flex-grow: 0;
            flex-shrink: 0;
            max-width: 100%;
            align-self: stretch;
        }
        .dm-resizable { resize: both; overflow: auto; min-width: 250px; min-height: 150px; }
        .resize-handle-icon { position: absolute; bottom: 4px; right: 4px; width: 12px; height: 12px; border-right: 2px solid #bba683; border-bottom: 2px solid #bba683; pointer-events: none; opacity: 0.5; }

        .progression-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .progression-table th { font-family: 'Cinzel', serif; font-weight: 900; text-transform: uppercase; color: #7a1d1d; border-bottom: 2px solid #7a1d1d; padding: 12px 8px; text-align: left; }
        .progression-table td { padding: 10px 8px; border-bottom: 1px solid rgba(122, 29, 29, 0.1); }

        /* Archetype Heading Styling */
        .archetype-divider { 
            width: 100%; margin: 48px 0 24px 0; 
            border-left: 8px solid #f59e0b; background: rgba(245, 158, 11, 0.05);
            padding: 16px 24px; border-radius: 4px 16px 16px 4px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .archetype-name { font-family: 'Cinzel', serif; font-weight: 900; font-size: 24px; color: #f59e0b; text-transform: uppercase; letter-spacing: 0.1em; flex-grow: 1; }
        .archetype-controls { display: flex; gap: 8px; align-items: center; }
        .arch-btn { font-size: 10px; font-weight: 900; text-transform: uppercase; padding: 6px 12px; border-radius: 4px; transition: all 0.2s; cursor: pointer; }
        .arch-btn-add { background: #22c55e; color: white; }
        .arch-btn-delete { background: #ef4444; color: white; opacity: 0.4; }
        .arch-btn-delete:hover { opacity: 1; }

        .hidden-view { display: none !important; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(50%); background: #1e293b; color: #fff; padding: 12px 24px; border-radius: 30px; z-index: 2000; opacity: 0; transition: opacity 0.3s; pointer-events: none; border: 1px solid #3b82f6; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        .dm-active-edit .dm-editable { background: rgba(122, 29, 29, 0.05); outline: 1px dashed #7a1d1d; padding: 2px; }
        
        .class-tab { padding: 8px 16px; font-size: 10px; font-weight: 900; text-transform: uppercase; cursor: pointer; border: 1px solid #333; border-radius: 4px; color: #94a3b8; }
        .class-tab.active { background: #f59e0b; color: #000; border-color: #f59e0b; }
        .level-bubble { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 11px; cursor: pointer; border: 2px solid #bba683; background: #fdfaf3; }
        .level-bubble.active { background: #7a1d1d; color: #fff; border-color: #7a1d1d; }

        .section-label { font-size: 10px; text-transform: uppercase; font-weight: 900; color: #f59e0b; opacity: 0.5; margin-bottom: 8px; letter-spacing: 0.2em; display: block; border-bottom: 1px solid rgba(245, 158, 11, 0.1); padding-bottom: 4px; }
        .modal-overlay { background: rgba(0,0,0,0.95); backdrop-filter: blur(8px); }

        /* Hub Buttons */
        .archive-button { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border: 1px solid #334155; border-radius: 16px; padding: 24px; display: flex; align-items: center; gap: 20px; transition: all 0.3s; cursor: pointer; width: 100%; }
        .archive-button:hover { transform: translateY(-4px); border-color: #f59e0b; }
        .button-label { font-family: 'Cinzel', serif; font-weight: 900; font-size: 18px; color: #f59e0b; text-transform: uppercase; }
        .button-desc { font-size: 10px; color: #64748b; text-transform: uppercase; font-weight: 700; }
    </style>
</head>
<body class="min-h-screen dashboard-bg">

    <div id="toast" class="toast">Message</div>

    <!-- MAIN HUB -->
    <div id="hub-view" class="p-4 md:p-8">
        <div class="max-w-7xl mx-auto">
            <header class="flex flex-col md:flex-row justify-between items-end mb-12 border-b border-gray-800/50 pb-8 gap-6">
                <div class="flex flex-col items-start">
                    <h1 class="brand-title">Aeonfall</h1>
                    <div class="flex items-center gap-6">
                        <p class="brand-sub">Campaign Management Suite</p>
                        <div class="user-pill">
                            <span class="status-dot"></span>
                            <span id="user-display-name" class="user-name-text">Guest</span>
                            <button onclick="window.logout()" class="logout-btn uppercase">Logout</button>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col items-end gap-6 w-full md:w-auto">
                    <div class="role-selector">
                        <button id="role-player-btn" onclick="window.setRole('player')" class="role-btn">Player</button>
                        <button id="role-dm-btn" onclick="window.setRole('dm')" class="role-btn">DM</button>
                    </div>
                    <nav class="flex gap-8 items-center">
                        <a href="index.html" class="nav-link">Party</a>
                        <a href="npcs.html" class="nav-link">NPCs</a>
                        <a href="beasts.html" class="nav-link">Bestiary</a>
                        <a href="partybag.html" class="nav-link">Backpack</a>
                         <a href="#" class="nav-link active">Handbook</a>
                        <a href="#" onclick="window.setView('graveyard'); return false;" id="nav-graveyard" class="nav-link !text-red-900">Graveyard</a>
                    </nav>
                </div>
            </header>

            <div class="flex flex-col gap-5 max-w-2xl mx-auto mt-16">
                <a href="https://homebrewery.naturalcrit.com/share/he6P3R1e5dgq" target="_blank" class="archive-button no-underline">
                    <span class="text-4xl">üìñ</span>
                    <div class="flex flex-col">
                        <span class="button-label">Players Handbook</span>
                        <span class="button-desc">Official Aeonfall Rules & Mechanics</span>
                    </div>
                    <span class="ml-auto text-amber-900 font-black">‚Üí</span>
                </a>
                <div onclick="window.switchView('features')" class="archive-button">
                    <span class="text-4xl">üí•</span>
                    <div class="flex flex-col"><span class="button-label">Feature Moves & Archetypes</span><span class="button-desc">Unique Class Skills & Combat Arts</span></div>
                    <span class="ml-auto text-amber-900 font-black">‚Üí</span>
                </div>
                <div onclick="window.switchView('scripts')" class="archive-button">
                    <span class="text-4xl">üìú</span>
                    <div class="flex flex-col"><span class="button-label">Script Codex</span><span class="button-desc">Class Abilities & Tech Schools</span></div>
                    <span class="ml-auto text-amber-900 font-black">‚Üí</span>
                </div>
                <div onclick="window.switchView('sessions')" class="archive-button">
                    <span class="text-4xl">üñãÔ∏è</span>
                    <div class="flex flex-col"><span class="button-label">Session Logs</span><span class="button-desc">Chronicles of the Party Deeds</span></div>
                    <span class="ml-auto text-amber-900 font-black">‚Üí</span>
                </div>
                <div onclick="window.switchView('items')" class="archive-button">
                    <span class="text-4xl">‚öîÔ∏è</span>
                    <div class="flex flex-col"><span class="button-label">Gear & Artifacts</span><span class="button-desc">Equipment, Loot, and Scavenged Tech</span></div>
                    <span class="ml-auto text-amber-900 font-black">‚Üí</span>
                </div>
            </div>
        </div>
    </div>

    <!-- FEATURES VIEW -->
    <div id="features-view" class="hidden-view p-4 md:p-8">
        <div class="max-w-6xl mx-auto">
            <button onclick="window.switchView('hub')" class="text-amber-500 font-black text-xs uppercase mb-8 hover:text-amber-400">‚Üê Back to Archives</button>
            <div class="mb-8">
                <span class="section-label">Martial Classes</span>
                <div class="flex flex-wrap gap-2 mb-6" id="feature-martial-tabs"></div>
                <span class="section-label">Script Users</span>
                <div class="flex flex-wrap gap-2" id="feature-script-tabs"></div>
            </div>
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <div class="text-center md:text-left">
                    <h2 class="font-serif font-black text-3xl uppercase text-amber-500" id="current-feature-title">Feature Moves</h2>
                    <p class="text-xs text-amber-900/60 font-black uppercase tracking-widest mt-2" id="current-feature-class-label">Vanguard Features</p>
                </div>
                <div class="flex gap-2 flex-wrap">
                    <button id="add-table-btn" onclick="window.addTableEntry()" class="hidden bg-amber-900/80 text-white px-6 py-3 rounded-full font-black text-xs uppercase shadow-xl hover:bg-amber-800 transition-all">+ Table</button>
                    <button id="add-archetype-btn" onclick="window.addArchetypeEntry()" class="hidden bg-amber-800 text-white px-6 py-3 rounded-full font-black text-xs uppercase shadow-xl hover:bg-amber-700 transition-all">+ Archetype</button>
                    <button id="add-script-feature-btn" onclick="window.addScriptEntry()" class="hidden bg-amber-700 text-white px-6 py-3 rounded-full font-black text-xs uppercase shadow-xl hover:bg-amber-600 transition-all">+ Script</button>
                    <button id="add-feature-btn" onclick="window.addFeatureEntry()" class="hidden bg-amber-600 text-white px-8 py-3 rounded-full font-black text-xs uppercase shadow-xl hover:bg-amber-500 transition-all">+ Move</button>
                </div>
            </div>
            <div id="features-list" class="flex flex-col gap-8"></div>
        </div>
    </div>

    <!-- SCRIPTS VIEW -->
    <div id="scripts-view" class="hidden-view p-4 md:p-8">
        <div class="max-w-6xl mx-auto">
            <button onclick="window.switchView('hub')" class="text-amber-500 font-black text-xs uppercase mb-8 hover:text-amber-400">‚Üê Back to Archives</button>
            <div class="flex flex-wrap gap-2 mb-8" id="class-tabs"></div>
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <div class="text-center md:text-left">
                    <h2 class="font-serif font-black text-3xl uppercase text-amber-500" id="current-class-title">Scripts</h2>
                    <div class="flex items-center gap-3 mt-4" id="level-nav"></div>
                </div>
                <button id="add-script-btn" onclick="window.addScriptEntry()" class="hidden bg-amber-600 text-white px-8 py-3 rounded-full font-black text-xs uppercase shadow-xl hover:bg-amber-500 transition-all">+ Inscribe New Script</button>
            </div>
            <div id="scripts-list" class="flex flex-wrap gap-8 items-stretch justify-start"></div>
        </div>
    </div>

    <!-- PASSWORD MODAL -->
    <div id="password-modal" class="fixed inset-0 bg-black/95 flex items-center justify-center z-[500] hidden">
        <div class="bg-gray-800 p-8 rounded-2xl w-full max-w-sm border-2 border-amber-600 text-white text-center shadow-2xl">
            <h3 class="text-xl font-serif text-amber-500 font-bold mb-2 uppercase">DM Access Required</h3>
            <input type="password" id="dm-password" class="w-full bg-gray-900 text-center text-2xl rounded-lg p-3 mb-6 border border-gray-700">
            <button onclick="window.verifyDmPassword()" class="w-full bg-amber-600 text-white py-3 rounded-xl font-bold uppercase text-xs">Unlock Archives</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, updateDoc, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBLN0KhcnZFKZEYyR0O-Q2mZhKr-iyh7BI", authDomain: "aeonfall-523c1.firebaseapp.com", projectId: "aeonfall-523c1", storageBucket: "aeonfall-523c1.firebasestorage.app", messagingSenderId: "716207733913", appId: "1:716207733913:web:7aac43906a70e2b5f50c08" };
        const appId = 'aeonfall-manager-v2';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const CLASSES = ["Heartbound", "Nomad", "Wilderness Warden", "Chronicler", "Orator", "Scriptweaver", "War-Touched", "Archivist", "Fabricator"];
        const FEATURE_MARTIAL_CLASSES = ["Vanguard", "Warrior", "Peacekeeper", "Scavenger"];
        
        let currentClass = "Heartbound";
        let currentFeatureClass = "Vanguard";
        let currentLevel = 1; 
        let activeRole = 'player';
        let scripts = [], archetypes = [], tables = [], features = [];
        let autoSaveTimer = null;
        let isUserResizing = false;

        window.onmouseup = () => { isUserResizing = false; };

        const resizeObserver = new ResizeObserver(entries => {
            if (activeRole !== 'dm' || !isUserResizing) return;
            for (let entry of entries) {
                const id = entry.target.dataset.id;
                if (!id) continue;
                const table = tables.find(t => t.id === id);
                if (!table) continue;
                const rect = entry.target.getBoundingClientRect();
                const newWidth = `${Math.round(rect.width)}px`;
                const newHeight = `${Math.round(rect.height)}px`;
                if (table.width !== newWidth || table.height !== newHeight) {
                    if (autoSaveTimer) clearTimeout(autoSaveTimer);
                    autoSaveTimer = setTimeout(() => {
                        updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookTables', id), {
                            width: newWidth, height: newHeight
                        });
                    }, 1000);
                }
            }
        });

        window.showToast = (m) => { const t = document.getElementById('toast'); t.textContent=m; t.style.opacity=1; setTimeout(()=>t.style.opacity=0, 4000); };
        window.setRole = (r) => { if (r === 'dm') { if (localStorage.getItem('aeonfall_role') === 'dm') return; document.getElementById('password-modal').classList.remove('hidden'); } else { activeRole = 'player'; localStorage.setItem('aeonfall_role', 'player'); window.updateRoleUI(); } };
        window.verifyDmPassword = () => { if (document.getElementById('dm-password').value === 'Rew4994') { activeRole = 'dm'; localStorage.setItem('aeonfall_role', 'dm'); document.getElementById('password-modal').classList.add('hidden'); window.updateRoleUI(); } else { window.showToast("Access Denied"); } };
        
        window.logout = () => { 
            localStorage.removeItem('aeonfall_user'); 
            localStorage.removeItem('aeonfall_role'); 
            window.location.reload(); 
        };

        window.updateRoleUI = () => {
            const isDM = activeRole === 'dm';
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.toggle('active', (btn.id === 'role-dm-btn') === isDM));
            ['add-script-btn', 'add-feature-btn', 'add-archetype-btn', 'add-table-btn', 'add-script-feature-btn'].forEach(id => {
                const el = document.getElementById(id); if (el) el.classList.toggle('hidden', !isDM);
            });
            renderLists(); renderNavs();
        };

        window.switchView = (v) => { ['hub', 'scripts', 'features'].forEach(id => document.getElementById(`${id}-view`)?.classList.add('hidden-view')); document.getElementById(`${v}-view`).classList.remove('hidden-view'); window.scrollTo(0,0); };
        window.selectClass = (c) => { currentClass = c; renderNavs(); renderLists(); };
        window.selectFeatureClass = (c) => { currentFeatureClass = c; renderNavs(); renderLists(); };
        window.selectLevel = (l) => { currentLevel = l; renderNavs(); renderLists(); };

        function parseContent(text) { return text ? text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\*(.*?)\*/g, '<i>$1</i>') : ''; }

        function createScriptCard(s, isDM) {
            return `
                <div class="script-card ${isDM ? 'dm-active-edit' : ''}" data-id="${s.id}" data-type="script">
                    <div class="script-card-header">
                        <div class="flex items-center">
                            ${isDM ? `<div class="drag-handle mr-2">‚†ø</div>` : ''}
                            <div class="script-card-title dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdate('${s.id}', 'title', this.innerText)">${s.title}</div>
                        </div>
                        ${isDM ? `<button onclick="window.deleteItem('${s.id}', 'handbookScripts')" class="text-red-700 opacity-30 hover:opacity-100 ml-4">‚úï</button>` : ''}
                    </div>
                    <span class="script-card-level italic text-sm mb-2 opacity-70">${s.level === 0 ? 'Trick' : 'Lv. ' + s.level} ${s.school || 'Dominion'}</span>
                    <div class="script-body ${isDM ? 'dm-editable' : ''}" contenteditable="${isDM}" oninput="window.debounceUpdate('${s.id}', 'content', this.innerText)">${parseContent(s.content)}</div>
                </div>
            `;
        }

        function createFeatureCard(f, isDM) {
            return `
                <div class="script-card ${isDM ? 'dm-active-edit' : ''}" data-id="${f.id}" data-type="feature">
                    <div class="script-card-header">
                        <div class="flex flex-col grow">
                            <div class="flex items-center">
                                ${isDM ? `<div class="drag-handle mr-2">‚†ø</div>` : ''}
                                <div class="script-card-title dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdateFeature('${f.id}', 'title', this.innerText)">${f.title}</div>
                            </div>
                            <div class="text-[11px] font-black uppercase opacity-40 mt-1 tracking-widest dm-editable italic" contenteditable="${isDM}" oninput="window.debounceUpdateFeature('${f.id}', 'type', this.innerText)">${f.type || 'New Feature Move'}</div>
                        </div>
                        ${isDM ? `<button onclick="window.deleteItem('${f.id}', 'handbookFeatures')" class="text-red-700 opacity-30 hover:opacity-100 ml-4">‚úï</button>` : ''}
                    </div>
                    <div class="script-body mt-4 ${isDM ? 'dm-editable' : ''}" contenteditable="${isDM}" oninput="window.debounceUpdateFeature('${f.id}', 'content', this.innerText)">${parseContent(f.content)}</div>
                </div>
            `;
        }

        function createTableHtml(t, isDM) {
            const hCells = t.headers.map((h, i) => `<th contenteditable="${isDM}" oninput="window.updateTableCells('${t.id}', 'headers', ${i}, this.innerText)">${h}</th>`).join('');
            const rCells = t.rows.map((row, rIdx) => `<tr>${row.map((c, cIdx) => `<td contenteditable="${isDM}" oninput="window.updateTableCells('${t.id}', 'rows', ${rIdx}, this.innerText, ${cIdx})">${c}</td>`).join('')}</tr>`).join('');
            const style = `width: ${t.width || '100%'}; height: ${t.height || 'auto'};`;
            return `
                <div class="progression-table-container shadow-2xl ${isDM ? 'dm-resizable' : ''}" 
                     style="${style}" 
                     data-id="${t.id}" data-type="table"
                     onmousedown="if (event.offsetX > this.offsetWidth - 30 && event.offsetY > this.offsetHeight - 30) isUserResizing = true;">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center">
                            ${isDM ? `<div class="drag-handle mr-4">‚†ø</div>` : ''}
                            <h3 class="font-serif font-black uppercase text-xl text-[#7a1d1d] dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdateTable('${t.id}', 'title', this.innerText)">${t.title}</h3>
                        </div>
                        ${isDM ? `
                            <div class="flex gap-2">
                                <button onclick="window.modifyTable('${t.id}', 'addRow')" class="arch-btn arch-btn-add">+ Row</button>
                                <button onclick="window.modifyTable('${t.id}', 'remRow')" class="arch-btn bg-red-700 text-white">- Row</button>
                                <button onclick="window.modifyTable('${t.id}', 'addCol')" class="arch-btn arch-btn-add">+ Col</button>
                                <button onclick="window.modifyTable('${t.id}', 'remCol')" class="arch-btn bg-red-700 text-white">- Col</button>
                                <button onclick="window.deleteItem('${t.id}', 'handbookTables')" class="arch-btn bg-black text-white">‚úï</button>
                            </div>
                        ` : ''}
                    </div>
                    <table class="progression-table"><thead><tr>${hCells}</tr></thead><tbody>${rCells}</tbody></table>
                    ${isDM ? `<div class="resize-handle-icon"></div>` : ''}
                </div>
            `;
        }

        const renderLists = () => {
            const isDM = activeRole === 'dm';
            const fList = document.getElementById('features-list');
            if (fList) {
                fList.innerHTML = '';
                const topContainer = document.createElement('div');
                topContainer.className = 'w-full flex flex-wrap gap-8 items-stretch justify-start';
                fList.appendChild(topContainer);

                tables.filter(t => t.parentClass === currentFeatureClass && !t.archetypeId).forEach(t => topContainer.innerHTML += createTableHtml(t, isDM));
                features.filter(f => f.className === currentFeatureClass && !f.archetypeId).forEach(f => topContainer.innerHTML += createFeatureCard(f, isDM));
                scripts.filter(s => s.scriptLists?.includes(currentFeatureClass) && !s.archetypeId).forEach(s => topContainer.innerHTML += createScriptCard(s, isDM));

                archetypes.filter(a => a.parentClass === currentFeatureClass).forEach(arch => {
                    const archWrapper = document.createElement('div');
                    archWrapper.className = 'w-full flex flex-wrap gap-8 items-stretch justify-start';
                    archWrapper.dataset.id = arch.id;
                    archWrapper.dataset.type = 'archetype';

                    const divider = document.createElement('div');
                    divider.className = 'archetype-divider shadow-md';
                    divider.innerHTML = `
                        <div class="flex items-center flex-grow">
                             ${isDM ? `<div class="drag-handle mr-4 !color-amber-500">‚†ø</div>` : ''}
                             <div class="archetype-name dm-editable" contenteditable="${isDM}" oninput="window.debounceUpdateArchetype('${arch.id}', 'name', this.innerText)">${arch.name}</div>
                        </div>
                        ${isDM ? `<div class="archetype-controls">
                            <button onclick="window.addTableEntry('${arch.id}')" class="arch-btn arch-btn-add">+ Tbl</button>
                            <button onclick="window.addFeatureEntry('${arch.id}')" class="arch-btn arch-btn-add">+ Ftr</button>
                            <button onclick="window.addScriptEntry(null, '${arch.id}')" class="arch-btn arch-btn-add">+ Scp</button>
                            <button onclick="window.deleteItem('${arch.id}', 'handbookArchetypes')" class="arch-btn arch-btn-delete">‚úï</button>
                        </div>` : ''}
                    `;
                    archWrapper.appendChild(divider);

                    const contentContainer = document.createElement('div');
                    contentContainer.className = 'w-full flex flex-wrap gap-8 items-stretch justify-start';
                    tables.filter(t => t.archetypeId === arch.id).forEach(t => contentContainer.innerHTML += createTableHtml(t, isDM));
                    features.filter(f => f.archetypeId === arch.id).forEach(f => contentContainer.innerHTML += createFeatureCard(f, isDM));
                    scripts.filter(s => s.archetypeId === arch.id).forEach(s => contentContainer.innerHTML += createScriptCard(s, isDM));

                    archWrapper.appendChild(contentContainer);
                    fList.appendChild(archWrapper);
                    if (isDM) new Sortable(contentContainer, { handle: '.drag-handle', animation: 150, onEnd: (evt) => window.syncOrder(contentContainer) });
                });

                if (isDM) {
                    new Sortable(fList, { handle: '.drag-handle', animation: 150, onEnd: (evt) => window.syncOrder(fList, true) });
                    new Sortable(topContainer, { handle: '.drag-handle', animation: 150, onEnd: (evt) => window.syncOrder(topContainer) });
                    document.querySelectorAll('.dm-resizable').forEach(el => resizeObserver.observe(el));
                }
            }

            const sList = document.getElementById('scripts-list');
            if (sList) {
                sList.innerHTML = '';
                scripts.filter(s => parseInt(s.level) === currentLevel && (s.scriptLists || '').toLowerCase().includes(currentClass.toLowerCase()))
                       .forEach(s => sList.innerHTML += createScriptCard(s, isDM));
                if (isDM) new Sortable(sList, { handle: '.drag-handle', animation: 150, onEnd: (evt) => window.syncOrder(sList) });
            }
        };

        window.syncOrder = async (container, isArch = false) => {
            Array.from(container.children).forEach((el, index) => {
                if (!el.dataset.id) return;
                const col = isArch ? 'handbookArchetypes' : (el.dataset.type === 'script' ? 'handbookScripts' : el.dataset.type === 'feature' ? 'handbookFeatures' : 'handbookTables');
                updateDoc(doc(db, 'artifacts', appId, 'public', 'data', col, el.dataset.id), { order: index });
            });
        };

        window.updateTableCells = (id, field, idx, val, cellIdx = null) => {
            const t = tables.find(t => t.id === id); if (!t) return;
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                if (field === 'headers') { let h = [...t.headers]; h[idx] = val; updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookTables', id), { headers: h }); }
                else { let r = [...t.rows]; r[idx][cellIdx] = val; updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookTables', id), { rows: JSON.stringify(r) }); }
            }, 1000);
        };

        window.modifyTable = async (id, action) => {
            const t = tables.find(t => t.id === id); if (!t) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'handbookTables', id);
            if (action === 'addRow') { await updateDoc(docRef, { rows: JSON.stringify([...t.rows, new Array(t.headers.length).fill("...")]) }); }
            else if (action === 'remRow' && t.rows.length > 1) { await updateDoc(docRef, { rows: JSON.stringify(t.rows.slice(0, -1)) }); }
            else if (action === 'addCol') { const h = [...t.headers, "New Header"]; const r = t.rows.map(row => [...row, "..."]); await updateDoc(docRef, { headers: h, rows: JSON.stringify(r) }); }
            else if (action === 'remCol' && t.headers.length > 1) { const h = t.headers.slice(0, -1); const r = t.rows.map(row => row.slice(0, -1)); await updateDoc(docRef, { headers: h, rows: JSON.stringify(r) }); }
        };

        window.debounceUpdate = (id, f, v) => { if (autoSaveTimer) clearTimeout(autoSaveTimer); autoSaveTimer = setTimeout(() => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookScripts', id), { [f]: v }), 1000); };
        window.debounceUpdateFeature = (id, f, v) => { if (autoSaveTimer) clearTimeout(autoSaveTimer); autoSaveTimer = setTimeout(() => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookFeatures', id), { [f]: v }), 1000); };
        window.debounceUpdateTable = (id, f, v) => { if (autoSaveTimer) clearTimeout(autoSaveTimer); autoSaveTimer = setTimeout(() => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookTables', id), { [f]: v }), 1000); };
        window.debounceUpdateArchetype = (id, f, v) => { if (autoSaveTimer) clearTimeout(autoSaveTimer); autoSaveTimer = setTimeout(() => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookArchetypes', id), { [f]: v }), 1000); };

        window.deleteItem = async (id, col) => { if(confirm("Permanently erase record?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id)); };

        window.addTableEntry = async (archId = null) => { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'handbookTables'), { title: "NEW TABLE", parentClass: currentFeatureClass, archetypeId: archId, headers: ["Lv", "Bonus"], rows: JSON.stringify([["1", "+2"]]), order: 999, createdAt: Date.now() }); };
        window.addArchetypeEntry = async () => { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'handbookArchetypes'), { name: "NEW ARCHETYPE", parentClass: currentFeatureClass, order: 999, createdAt: Date.now() }); };
        window.addFeatureEntry = async (archId = null) => { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'handbookFeatures'), { title: "NEW MOVE", content: "...", type: "Feature Move", className: currentFeatureClass, archetypeId: archId, order: 999, createdAt: Date.now() }); };
        window.addScriptEntry = async (lvl = null, archId = null) => { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'handbookScripts'), { title: "NEW SCRIPT", content: "...", level: lvl || currentLevel, school: 'Dominion', scriptLists: [currentFeatureClass, currentClass], archetypeId: archId, order: 999, createdAt: Date.now() }); };

        const init = async () => {
            await signInAnonymously(auth);
            const savedRole = localStorage.getItem('aeonfall_role'); if (savedRole) activeRole = savedRole;
            const savedUser = localStorage.getItem('aeonfall_user');
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    document.getElementById('user-display-name').textContent = user.username || 'Guest';
                } catch(e) { console.error("User parse fail"); }
            }
            const sortFn = (a, b) => (a.order ?? 999) - (b.order ?? 999) || a.createdAt - b.createdAt;
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'handbookTables'), s => { tables = s.docs.map(d => ({ id: d.id, ...d.data(), rows: JSON.parse(d.data().rows || "[]") })).sort(sortFn); renderLists(); });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'handbookArchetypes'), s => { archetypes = s.docs.map(d => ({ id: d.id, ...d.data() })).sort(sortFn); renderLists(); });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'handbookFeatures'), s => { features = s.docs.map(d => ({ id: d.id, ...d.data() })).sort(sortFn); renderLists(); });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'handbookScripts'), s => { scripts = s.docs.map(d => ({ id: d.id, ...d.data() })).sort(sortFn); renderLists(); });
            window.updateRoleUI();
        };
        init();
        function renderNavs() {
            const tabs = document.getElementById('class-tabs');
            if (tabs) tabs.innerHTML = CLASSES.map(c => `<div class="class-tab ${currentClass === c ? 'active' : ''}" onclick="window.selectClass('${c}')">${c}</div>`).join('');
            const martialTabs = document.getElementById('feature-martial-tabs');
            if (martialTabs) martialTabs.innerHTML = FEATURE_MARTIAL_CLASSES.map(c => `<div class="class-tab ${currentFeatureClass === c ? 'active' : ''}" onclick="window.selectFeatureClass('${c}')">${c}</div>`).join('');
            const scriptTabs = document.getElementById('feature-script-tabs');
            if (scriptTabs) scriptTabs.innerHTML = CLASSES.map(c => `<div class="class-tab ${currentFeatureClass === c ? 'active' : ''}" onclick="window.selectFeatureClass('${c}')">${c}</div>`).join('');
            const lNav = document.getElementById('level-nav');
            if (lNav) lNav.innerHTML = [0,1,2,3,4,5,6,7,8,9].map(l => `<div class="level-bubble ${currentLevel === l ? 'active' : ''}" onclick="window.selectLevel(${l})">${l}</div>`).join('');
        }
    </script>
</body>
</html>
