<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aeonfall Campaign</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Roboto+Slab:wght@300;400;700&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto Slab', serif; background-color: #1a1a1a; color: #e2e8f0; overflow-x: hidden; }
        .dashboard-bg { background-image: url('https://www.transparenttextures.com/patterns/dark-wood.png'); background-color: #121212; }
        .card { transition: all 0.2s; cursor: pointer; border-left-width: 4px; position: relative; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.7); }
        
        #sheet-container { background-color: #e8e0cd; min-height: 100vh; padding-bottom: 120px; color: #333; transition: filter 0.3s ease; }
        #sheet-container.status-coma { background-color: #fef3c7 !important; }
        #sheet-container.status-dead { filter: grayscale(1); background-color: #d1d5db !important; }
        
        .sheet-card {
            background-color: #fff;
            border: 1px solid #dcd3c0;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 16px;
            margin-bottom: 16px;
            position: relative;
        }
        .sheet-card h3 {
            font-family: 'Cinzel', serif; font-weight: 700; text-align: center; font-size: 0.85rem; color: #222;
            border-bottom: 2px solid #e8e0cd; padding-bottom: 4px; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em;
        }
        
        .nav-link { color: #94a3b8; font-weight: 900; font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em; transition: color 0.2s; cursor: pointer; }
        .nav-link.active { color: #f59e0b; border-bottom: 2px solid #f59e0b; padding-bottom: 4px; }

        .vital-container { aspect-ratio: 1/1; display: flex; flex-direction: column; align-items: center; justify-content: center; background-size: 100% 100%; position: relative; transition: transform 0.2s; }
        .vital-shield { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M50 5 L10 20 L10 50 C10 75 50 95 50 95 C50 95 90 75 90 50 L90 20 Z' fill='%23e0f2fe' stroke='%230369a1' stroke-width='4'/%3E%3C/svg%3E"); }
        .vital-square-init { border: 3px solid #b45309; border-radius: 12px; background-color: #fef3c7; }
        .vital-square-speed { border: 3px solid #15803d; border-radius: 12px; background-color: #dcfce7; }
        .vital-label { font-size: 10px; font-weight: 900; text-transform: uppercase; position: absolute; top: 10%; color: #4b5563; }
        .vital-input { width: 80%; text-align: center; font-size: 24px; font-weight: 900; background: transparent; border: none !important; color: #1a1a1a; margin-top: 10px; }

        .floating-roller {
            position: fixed; bottom: 24px; right: 24px; z-index: 100;
            background: white; border-radius: 20px; border: 3px solid #1a1a1a;
            padding: 16px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3); width: 280px;
        }
        .dice-grid-btn { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border: 3px solid; border-radius: 10px; font-weight: 900; font-size: 12px; transition: all 0.1s; }
        .dice-orange { background: #fffbeb; border-color: #d97706; color: #b45309; }
        .dice-green { background: #f0fdf4; border-color: #16a34a; color: #166534; }
        .dice-blue { background: #eff6ff; border-color: #2563eb; color: #1e40af; }
        .dice-purple { background: #f5f3ff; border-color: #7c3aed; color: #5b21b6; }
        .dice-red { background: #fef2f2; border-color: #dc2626; color: #991b1b; }
        .dice-dark { background: #f9fafb; border-color: #374151; color: #111827; }

        .ds-dot { width: 14px; height: 14px; border-radius: 50%; border: 2px solid #ccc; cursor: pointer; transition: background 0.2s; }
        .ds-dot.checked-succ { background: #16a34a; border-color: #166534; }
        .ds-dot.checked-fail { background: #dc2626; border-color: #991b1b; }

        .hidden-view { display: none !important; }
        .rollable { cursor: pointer; transition: transform 0.1s; }
        .rollable:hover { transform: scale(1.05); color: #8b0000; }
        .tiny-label { font-size: 9px; text-transform: uppercase; color: #888; font-weight: 900; display: block; border-top: 1px solid #ddd; margin-top: 2px; }
        
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 12px 24px; border-radius: 30px; z-index: 1000; pointer-events: none; opacity: 0; transition: opacity 0.3s; }
        
        input, textarea, select { background: transparent; border: none; font-size: 13px; color: #333; width: 100%; }
        input:focus { outline: none; border-bottom: 1px solid #d97706; }

        #sync-indicator { position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.5); color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 10px; opacity: 0; pointer-events: none; z-index: 9999; }
        
        .score-line-val { font-family: 'Cinzel', serif; font-size: 24px; font-weight: 900; color: #312e81; position: relative; margin: 0 10px; }
        .score-line-val::after { content: ''; position: absolute; bottom: -10px; left: 0; width: 100%; height: 2px; background: #cbd5e1; }
        .assign-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .assign-row { display: flex; align-items: center; justify-content: space-between; background: #f8fafc; padding: 6px 10px; border-radius: 8px; border: 1px solid #e2e8f0; }

        .mode-btn { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 900; border: 2px solid #cbd5e1; color: #64748b; background: #f1f5f9; }
        .mode-btn.active { background: #374151; color: white; border-color: #374151; }

        .lvl-card { background: #fff; border: 1px solid #dcd3c0; border-radius: 8px; padding: 12px; display: flex; flex-direction: column; min-height: 100px; }
        .lvl-header { font-family: 'Cinzel', serif; font-size: 10px; font-weight: 900; border-bottom: 2px solid #e8e0cd; margin-bottom: 8px; padding-bottom: 4px; }

        .dm-panel { background: #2d2a2e; color: #fff; padding: 16px; border-radius: 12px; margin-bottom: 24px; border: 2px solid #f59e0b; }
        .dm-whisper-box { background: #fef2f2; border-left: 4px solid #ef4444; padding: 12px; border-radius: 4px; margin-bottom: 16px; }
        .whisper-tag { font-size: 9px; font-weight: 900; color: #991b1b; text-transform: uppercase; margin-bottom: 4px; display: block; }
        
        .equip-header { background: #f8f9fa; font-size: 10px; font-weight: 900; color: #6c757d; text-transform: uppercase; padding: 4px 8px; border-radius: 4px; display: grid; grid-template-columns: 1fr 50px 70px 24px; gap: 4px; margin-bottom: 4px; }
        .equip-row { display: grid; grid-template-columns: 1fr 50px 70px 24px; gap: 4px; align-items: center; padding: 4px 8px; border-bottom: 1px solid #f1f1f1; }
    </style>
</head>
<body class="min-h-screen">

    <div id="toast" class="toast">Message</div>
    <div id="sync-indicator">Cloud Synced</div>

    <!-- MAIN DASHBOARD -->
    <div id="dashboard-screen" class="min-h-screen dashboard-bg p-4 md:p-8">
        <div class="max-w-6xl mx-auto">
            <header class="flex flex-col md:flex-row justify-between items-center mb-10 border-b border-gray-800 pb-8 gap-6">
                <div>
                    <h1 class="text-4xl md:text-6xl text-amber-500 font-bold mb-2 font-serif tracking-tight">Aeonfall</h1>
                    <p class="text-gray-500 text-xs md:text-sm uppercase tracking-widest font-bold">Campaign Management Suite</p>
                </div>
                <div class="flex flex-col items-center gap-4">
                    <div class="flex items-center gap-2 bg-gray-900 p-1 rounded-xl shadow-2xl">
                        <button id="role-player-btn" onclick="window.setRole('player')" class="px-6 py-3 rounded-lg text-sm font-bold transition-all bg-amber-600 text-white shadow-lg">Player</button>
                        <button id="role-dm-btn" onclick="window.setRole('dm')" class="px-6 py-3 rounded-lg text-sm font-bold transition-all text-gray-500">DM</button>
                    </div>
                    <nav id="main-nav" class="flex gap-6">
                        <button onclick="window.setView('party')" id="nav-party" class="nav-link active">Party</button>
                        <!-- Updated Redirection Buttons -->
                        <button onclick="window.location.href='NPCs.html'" id="nav-npcs" class="nav-link">NPCs</button>
                        <button onclick="window.location.href='Beasts.html'" id="nav-beasts" class="nav-link">Bestiary</button>
                        <button onclick="window.setView('graveyard')" id="nav-graveyard" class="nav-link !text-red-900">Graveyard</button>
                    </nav>
                </div>
            </header>

            <div class="flex justify-between items-center mb-8">
                <h2 id="view-title" class="text-2xl font-serif text-gray-400 uppercase font-bold tracking-widest">The Party</h2>
                <div id="create-actions" class="flex gap-2">
                    <button onclick="window.openPartyModal()" class="bg-indigo-600 text-white px-4 py-2.5 rounded-lg text-sm font-bold shadow-lg">NEW PARTY</button>
                    <button id="btn-create-pc" onclick="window.createChar('PC')" class="bg-green-700 text-white px-6 py-2.5 rounded-lg text-sm font-bold shadow-lg">+ NEW PC</button>
                </div>
            </div>

            <div id="view-content" class="space-y-8">
                <div id="party-view-container" class="space-y-8"></div>
                <!-- NPCs and Beasts containers are still here as fallbacks, but nav redirects to standalone pages -->
                <div id="npcs-view-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden-view"></div>
                <div id="beasts-view-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden-view"></div>
                <div id="graveyard-view-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden-view"></div>
            </div>
        </div>
    </div>

    <!-- Modals for Party, Password, Deletion, etc. go here (consistent with previous versions) -->
    <!-- ... Rest of UI sections (sheet-screen, etc) same as last working version ... -->

    <!-- CHARACTER SHEET SCREEN -->
    <div id="sheet-screen" class="hidden-view">
        <div id="sheet-container">
            <nav class="sticky top-0 z-[60] bg-gray-900 p-2 shadow-2xl border-b border-gray-800">
                <div class="max-w-6xl mx-auto flex justify-between items-center text-white px-4">
                    <button onclick="window.closeSheet()" class="text-gray-400 hover:text-white font-bold flex items-center gap-2"><span>‚Üê</span> Exit</button>
                    <div class="flex items-center gap-4">
                        <span id="sheet-type-badge" class="bg-amber-600 px-3 py-1 rounded text-[10px] font-black uppercase tracking-widest">PC</span>
                        <div class="flex items-center gap-1">
                            <button onclick="window.saveCurrentCharacter(true)" class="bg-green-700 hover:bg-green-600 px-4 py-1 rounded text-[10px] font-black uppercase tracking-widest">SYNC</button>
                            <button id="delete-char-btn" onclick="window.triggerDeleteModal()" class="bg-red-900 px-3 py-1 rounded text-[10px] font-black uppercase hidden">Manage</button>
                        </div>
                    </div>
                </div>
            </nav>

            <div class="max-w-6xl mx-auto p-4 md:p-8">
                <!-- DM Oversight and Parchment Sheet Layout internals same as previous turn -->
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, deleteDoc, onSnapshot, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config and appId here (placeholders)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'aeonfall-manager';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let characters = [], parties = [], user = null, activeCharId = null, activeRole = 'player';
        // ... Variables and Core Logic same as working turn ...

        // Ensure listeners start AFTER Auth
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if (user) setupListeners();
                });
            } catch (err) { console.error("Auth Init Error:", err); }
        };

        const setupListeners = () => {
            if (!user) return;
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'characters'), (snap) => {
                characters = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderDashboard();
                if (activeCharId) syncSheetData();
            }, (err) => console.error("Permission error on characters:", err));

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'parties'), (snap) => {
                parties = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderDashboard();
                if (activeCharId) syncSheetData();
            }, (err) => console.error("Permission error on parties:", err));
        };

        // UI Handlers (setView, setRole, verifyDmPassword, etc) same as previous ...
        window.setView = (v) => {
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            const nBtn = document.getElementById(`nav-${v}`); if (nBtn) nBtn.classList.add('active');
            ['party','npcs','beasts','graveyard'].forEach(view => {
                const el = document.getElementById(`${view}-view-container`);
                if (el) el.classList.toggle('hidden-view', view !== v);
            });
            const vt = document.getElementById('view-title');
            if (vt) vt.textContent = v === 'party' ? 'The Party' : (v === 'graveyard' ? 'The Graveyard' : v.toUpperCase());
            renderDashboard();
        };

        // Dashboard Rendering Logic
        function renderDashboard() {
            const pcC = document.getElementById('party-view-container'), grC = document.getElementById('graveyard-view-container');
            if (!pcC || !grC) return; pcC.innerHTML = ''; grC.innerHTML = '';
            const activePCs = characters.filter(c => c.type === 'PC' && !c.isDeleted);
            parties.forEach(p => {
                const s = document.createElement('div'); s.className = "bg-gray-900/40 p-6 rounded-2xl border border-gray-800 shadow-xl mb-8";
                s.innerHTML = `<h3 class="text-indigo-400 font-serif font-bold uppercase text-sm mb-4">${p.name}</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="party-grid-${p.id}"></div>`;
                pcC.appendChild(s);
                const g = s.querySelector(`#party-grid-${p.id}`); activePCs.filter(c => c.partyId === p.id).forEach(c => g.appendChild(createCard(c)));
            });
            const unassigned = activePCs.filter(c => !c.partyId);
            if (unassigned.length > 0) {
                const s = document.createElement('div'); s.className = "space-y-4 mb-8";
                s.innerHTML = `<h3 class="text-gray-500 font-serif font-bold uppercase text-sm mb-4">Unassigned Adventurers</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="unassigned-grid"></div>`;
                pcC.appendChild(s);
                const g = s.querySelector('#unassigned-grid'); unassigned.forEach(c => g.appendChild(createCard(c)));
            }
            characters.filter(c => c.isDeleted).forEach(c => grC.appendChild(createCard(c)));
        }

        function createCard(c) {
            const d = document.createElement('div'); d.className = `bg-gray-800 p-5 rounded-xl card border-l-4 shadow-xl ${c.status === 'dead' ? 'opacity-50' : ''}`;
            d.style.borderColor = c.status === 'coma' ? '#f59e0b' : c.status === 'dead' ? '#4b5563' : '#10b981';
            d.onclick = () => window.openSheet(c.id);
            d.innerHTML = `<div class="flex items-center gap-4 mb-4"><div class="w-12 h-12 rounded-lg bg-gray-700 overflow-hidden">${c.imageSrc ? `<img src="${c.imageSrc}" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center text-xl">üë§</div>'}</div><div><h5 class="text-amber-500 font-serif font-bold">${c.name}</h5><p class="text-[10px] text-gray-400 uppercase font-black">${c.class || 'Class'} Lvl ${c.level || 1}</p></div></div>`;
            return d;
        }

        // ... Rest of character logic from previous turn ...
        initAuth();
    </script>
</body>
</html>
