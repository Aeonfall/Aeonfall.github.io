<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aeonfall Campaign</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Roboto+Slab:wght@300;400;700&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto Slab', serif; background-color: #1a1a1a; color: #e2e8f0; overflow-x: hidden; }
        .dashboard-bg { background-image: url('https://www.transparenttextures.com/patterns/dark-wood.png'); background-color: #121212; }
        .card { transition: all 0.2s; cursor: pointer; border-left-width: 4px; position: relative; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.7); }
        
        #sheet-container { background-color: #e8e0cd; min-height: 100vh; padding-bottom: 120px; color: #333; transition: filter 0.3s ease; }
        
        /* Status Themes */
        #sheet-container.status-coma { background-color: #fef3c7 !important; }
        #sheet-container.status-dead { filter: grayscale(1); background-color: #d1d5db !important; }
        
        .sheet-card {
            background-color: #fff;
            border: 1px solid #dcd3c0;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 16px;
            margin-bottom: 16px;
            position: relative;
        }
        .sheet-card h3 {
            font-family: 'Cinzel', serif;
            font-weight: 700;
            text-align: center;
            font-size: 0.85rem;
            color: #222;
            border-bottom: 2px solid #e8e0cd;
            padding-bottom: 4px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .nav-link { color: #94a3b8; font-weight: 900; font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em; transition: color 0.2s; cursor: pointer; }
        .nav-link.active { color: #f59e0b; border-bottom: 2px solid #f59e0b; padding-bottom: 4px; }

        .vital-container { aspect-ratio: 1/1; display: flex; flex-direction: column; align-items: center; justify-content: center; background-size: 100% 100%; position: relative; transition: transform 0.2s; }
        .vital-shield { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M50 5 L10 20 L10 50 C10 75 50 95 50 95 C50 95 90 75 90 50 L90 20 Z' fill='%23e0f2fe' stroke='%230369a1' stroke-width='4'/%3E%3C/svg%3E"); }
        .vital-square-init { border: 3px solid #b45309; border-radius: 12px; background-color: #fef3c7; }
        .vital-square-speed { border: 3px solid #15803d; border-radius: 12px; background-color: #dcfce7; }
        .vital-label { font-size: 10px; font-weight: 900; text-transform: uppercase; position: absolute; top: 10%; color: #4b5563; }
        .vital-input { width: 80%; text-align: center; font-size: 24px; font-weight: 900; background: transparent; border: none !important; color: #1a1a1a; margin-top: 10px; }

        .floating-roller {
            position: fixed; bottom: 24px; right: 24px; z-index: 100;
            background: white; border-radius: 20px; border: 3px solid #1a1a1a;
            padding: 16px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3);
            width: 280px;
        }
        .dice-grid-btn { 
            width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
            border: 3px solid; border-radius: 10px; font-weight: 900; font-size: 12px; transition: all 0.1s;
        }
        .dice-orange { background: #fffbeb; border-color: #d97706; color: #b45309; }
        .dice-green { background: #f0fdf4; border-color: #16a34a; color: #166534; }
        .dice-blue { background: #eff6ff; border-color: #2563eb; color: #1e40af; }
        .dice-purple { background: #f5f3ff; border-color: #7c3aed; color: #5b21b6; }
        .dice-red { background: #fef2f2; border-color: #dc2626; color: #991b1b; }
        .dice-dark { background: #f9fafb; border-color: #374151; color: #111827; }

        .mode-btn { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 900; border: 2px solid #cbd5e1; color: #64748b; background: #f1f5f9; }
        .mode-btn.active { background: #374151; color: white; border-color: #374151; }

        .ds-dot { width: 14px; height: 14px; border-radius: 50%; border: 2px solid #ccc; cursor: pointer; transition: background 0.2s; }
        .ds-dot.checked-succ { background: #16a34a; border-color: #166534; }
        .ds-dot.checked-fail { background: #dc2626; border-color: #991b1b; }

        .hidden-view { display: none !important; }
        .rollable { cursor: pointer; transition: transform 0.1s; }
        .rollable:hover { transform: scale(1.05); color: #8b0000; }
        .tiny-label { font-size: 9px; text-transform: uppercase; color: #888; font-weight: 900; display: block; border-top: 1px solid #ddd; margin-top: 2px; }
        
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 12px 24px; border-radius: 30px; z-index: 1000; pointer-events: none; opacity: 0; transition: opacity 0.3s; }
        
        input, textarea, select { background: transparent; border: none; font-size: 13px; color: #333; width: 100%; }
        input:focus { outline: none; border-bottom: 1px solid #d97706; }

        #sync-indicator { position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.5); color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 10px; opacity: 0; pointer-events: none; z-index: 9999; }
        
        .lvl-card { background: #fff; border: 1px solid #dcd3c0; border-radius: 8px; padding: 12px; display: flex; flex-direction: column; min-height: 100px; }
        .lvl-header { font-family: 'Cinzel', serif; font-size: 10px; font-weight: 900; border-bottom: 2px solid #e8e0cd; margin-bottom: 8px; padding-bottom: 4px; }
        
        .equip-header { background: #f8f9fa; font-size: 10px; font-weight: 900; color: #6c757d; text-transform: uppercase; padding: 4px 8px; border-radius: 4px; display: grid; grid-template-columns: 1fr 50px 70px 24px; gap: 4px; margin-bottom: 4px; }

        .score-line-display {
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-bottom: 2px solid #374151;
            padding: 8px 0;
            margin: 10px 0;
        }
        .score-line-val {
            font-family: 'Cinzel', serif;
            font-size: 24px;
            font-weight: 900;
            color: #312e81;
            position: relative;
        }
        .score-line-val::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            width: 100%;
            height: 2px;
            background: #cbd5e1;
        }

        .assign-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .assign-row { display: flex; align-items: center; justify-content: space-between; background: #f8fafc; padding: 6px 10px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .assign-label { font-weight: 900; font-size: 10px; text-transform: uppercase; color: #64748b; }
        .assign-select { width: 60px !important; text-align: center; font-weight: bold; border-bottom: 1px solid #cbd5e1 !important; color: #1e293b; }

        /* DM Specific UI */
        .dm-panel { background: #2d2a2e; color: #fff; padding: 16px; border-radius: 12px; margin-bottom: 24px; border: 2px solid #f59e0b; }
        .dm-whisper-box { background: #fef2f2; border-left: 4px solid #ef4444; padding: 12px; border-radius: 4px; margin-bottom: 16px; }
        .whisper-tag { font-size: 9px; font-weight: 900; color: #991b1b; text-transform: uppercase; margin-bottom: 4px; display: block; }
    </style>
</head>
<body class="min-h-screen">

    <div id="toast" class="toast">Message</div>
    <div id="sync-indicator">Cloud Synced</div>

    <!-- MAIN DASHBOARD -->
    <div id="dashboard-screen" class="min-h-screen dashboard-bg p-4 md:p-8">
        <div class="max-w-6xl mx-auto">
            <header class="flex flex-col md:flex-row justify-between items-center mb-10 border-b border-gray-800 pb-8 gap-6">
                <div>
                    <h1 class="text-4xl md:text-6xl text-amber-500 font-bold mb-2 font-serif tracking-tight">Aeonfall</h1>
                    <p class="text-gray-500 text-xs md:text-sm uppercase tracking-widest font-bold">Campaign Management Suite</p>
                </div>
                <div class="flex flex-col items-center gap-4">
                    <div class="flex items-center gap-2 bg-gray-900 p-1 rounded-xl shadow-2xl">
                        <button id="role-player-btn" onclick="window.setRole('player')" class="px-6 py-3 rounded-lg text-sm font-bold transition-all bg-amber-600 text-white shadow-lg">Player</button>
                        <button id="role-dm-btn" onclick="window.setRole('dm')" class="px-6 py-3 rounded-lg text-sm font-bold transition-all text-gray-500">DM</button>
                    </div>
                    <nav id="main-nav" class="flex gap-6">
                        <button onclick="window.setView('party')" id="nav-party" class="nav-link active">Party</button>
                        <button onclick="window.setView('npcs')" id="nav-npcs" class="nav-link">NPCs</button>
                        <button onclick="window.setView('beasts')" id="nav-beasts" class="nav-link">Bestiary</button>
                        <button onclick="window.setView('graveyard')" id="nav-graveyard" class="nav-link !text-red-900">Graveyard</button>
                    </nav>
                </div>
            </header>

            <div class="flex justify-between items-center mb-8">
                <h2 id="view-title" class="text-2xl font-serif text-gray-400 uppercase font-bold tracking-widest">The Party</h2>
                <div id="create-actions" class="flex gap-2">
                    <button onclick="window.openPartyModal()" class="bg-indigo-600 text-white px-4 py-2.5 rounded-lg text-sm font-bold shadow-lg">NEW PARTY</button>
                    <button onclick="window.createChar('PC')" class="bg-green-700 text-white px-6 py-2.5 rounded-lg text-sm font-bold shadow-lg">+ NEW PC</button>
                </div>
            </div>

            <div id="view-content" class="space-y-8">
                <div id="party-view-container" class="space-y-8"></div>
                <div id="npcs-view-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden-view"></div>
                <div id="beasts-view-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden-view"></div>
                <div id="graveyard-view-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden-view"></div>
            </div>
        </div>
    </div>

    <!-- PARTY MODAL -->
    <div id="party-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[110] hidden">
        <div class="bg-gray-800 p-8 rounded-2xl w-full max-w-sm border-2 border-indigo-600 shadow-2xl text-center">
            <h3 class="text-xl font-serif text-indigo-400 font-bold mb-4 uppercase">Create New Party</h3>
            <input type="text" id="party-name-input" class="w-full bg-gray-900 text-white rounded-lg p-3 mb-6 border border-gray-700 font-serif" placeholder="Party Name...">
            <div class="flex gap-2">
                <button onclick="window.createParty()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold uppercase text-xs">Confirm</button>
                <button onclick="document.getElementById('party-modal').classList.add('hidden')" class="flex-1 bg-gray-700 text-gray-300 py-3 rounded-xl font-bold uppercase text-xs">Cancel</button>
            </div>
        </div>
    </div>

    <!-- PASSWORD MODAL -->
    <div id="password-modal" class="fixed inset-0 bg-black/95 backdrop-blur-md flex items-center justify-center z-[200] hidden">
        <div class="bg-gray-800 p-8 rounded-2xl w-full max-w-sm border-2 border-amber-600 shadow-2xl text-center">
            <h3 class="text-xl font-serif text-amber-500 font-bold mb-2">DM AUTHORIZATION</h3>
            <input type="password" id="dm-password" class="w-full bg-gray-900 text-white text-center text-2xl tracking-widest rounded-lg p-3 mb-6 border border-gray-700 font-serif" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <div class="flex gap-2">
                <button onclick="window.verifyDmPassword()" class="flex-1 bg-amber-600 text-white py-3 rounded-xl font-bold uppercase text-xs">Enter</button>
                <button onclick="document.getElementById('password-modal')?.classList.add('hidden')" class="flex-1 bg-gray-700 text-gray-300 py-3 rounded-xl font-bold uppercase text-xs">Back</button>
            </div>
        </div>
    </div>

    <!-- DELETE CHARACTER MODAL (FIXED) -->
    <div id="delete-modal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-[160] hidden">
        <div class="bg-white p-8 rounded-2xl w-full max-w-sm border-4 border-red-600 shadow-2xl text-center">
            <div id="delete-stage-1">
                <h3 class="text-2xl font-serif text-red-700 font-bold mb-4 uppercase">Manage Record</h3>
                <p id="delete-modal-desc" class="text-gray-500 text-sm mb-8 leading-relaxed">Choose an action for this character record.</p>
                <div class="flex flex-col gap-3">
                    <button id="archive-btn" onclick="window.archiveCharacter()" class="bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-xl font-bold uppercase text-xs shadow-md transition-colors">
                        Archive to Graveyard
                    </button>
                    <button id="restore-btn" onclick="window.restoreCharacter()" class="bg-green-600 hover:bg-green-500 text-white py-3 rounded-xl font-bold uppercase text-xs shadow-md transition-colors hidden">
                        Restore to Active Party
                    </button>
                    <button onclick="window.showPermDeleteConfirm()" class="bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-bold uppercase text-xs shadow-md transition-colors">
                        Permanently Delete
                    </button>
                    <button onclick="document.getElementById('delete-modal').classList.add('hidden')" class="bg-gray-100 hover:bg-gray-200 text-gray-500 py-3 rounded-xl font-bold uppercase text-xs transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
            <div id="delete-stage-confirm" class="hidden">
                <h3 class="text-2xl font-serif text-red-700 font-bold mb-4 uppercase">Are You Sure?</h3>
                <p class="text-gray-500 text-sm mb-8 leading-relaxed">This will erase the character forever. This action CANNOT be undone.</p>
                <div class="flex flex-col gap-3">
                    <button onclick="window.executePermDelete()" class="bg-red-700 hover:bg-red-800 text-white py-3 rounded-xl font-bold uppercase text-xs shadow-md transition-colors">
                        Yes, Delete Forever
                    </button>
                    <button onclick="window.resetDeleteModal()" class="bg-gray-100 hover:bg-gray-200 text-gray-500 py-3 rounded-xl font-bold uppercase text-xs transition-colors">
                        No, Go Back
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCORE GENERATOR MODAL -->
    <div id="score-gen-modal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-[150] hidden">
        <div class="bg-white p-8 rounded-2xl w-full max-w-lg border-4 border-indigo-600 shadow-2xl text-center">
            <h3 class="text-2xl font-serif text-indigo-700 font-bold mb-2 uppercase">Score Generator</h3>
            <p class="text-gray-500 text-xs mb-6">Standard Array or Heroic Roll (1 reroll allowed).</p>
            
            <div id="gen-results-area" class="bg-gray-100 p-6 rounded-xl mb-6 hidden">
                <div id="gen-numbers-display" class="score-line-display"></div>
                <div class="text-[10px] text-gray-400 uppercase font-black tracking-widest mt-2">Available Scores Pool</div>
                <div class="assign-grid" id="assign-grid"></div>
                <button onclick="window.randomizeAssignment()" class="mt-6 w-full py-2 bg-gray-200 text-gray-700 rounded-lg text-[10px] font-black uppercase hover:bg-gray-300 transition-colors">
                    Randomly Assign Numbers
                </button>
            </div>

            <div id="gen-controls" class="grid grid-cols-2 gap-4 mb-6">
                <button id="btn-gen-standard" onclick="window.generateScores('standard')" class="bg-gray-800 text-white py-3 rounded-xl font-bold uppercase text-xs hover:bg-gray-700">Standard Array</button>
                <button id="btn-gen-heroic" onclick="window.generateScores('heroic')" class="bg-indigo-600 text-white py-3 rounded-xl font-bold uppercase text-xs hover:bg-indigo-500">Heroic Roll</button>
            </div>

            <div id="heroic-reroll-area" class="hidden mb-6">
                <button id="btn-reroll" onclick="window.generateScores('heroic', true)" class="w-full bg-amber-500 text-white py-2 rounded-lg font-black uppercase text-[10px] shadow-sm">
                    Use 1x Heroic Reroll
                </button>
            </div>

            <div id="gen-apply-area" class="hidden space-y-4">
                <div class="flex gap-2 border-t pt-4">
                    <button onclick="window.applyScores()" class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold uppercase text-xs shadow-lg hover:bg-green-500">Apply & Finalize</button>
                    <button onclick="document.getElementById('score-gen-modal').classList.add('hidden')" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold uppercase text-xs">Cancel</button>
                </div>
            </div>
            <button id="cancel-gen-btn" onclick="document.getElementById('score-gen-modal').classList.add('hidden')" class="w-full text-gray-400 text-[10px] font-black uppercase mt-4">Maybe Later</button>
        </div>
    </div>

    <!-- CHARACTER SHEET SCREEN -->
    <div id="sheet-screen" class="hidden-view">
        <div id="sheet-container">
            <nav class="sticky top-0 z-[60] bg-gray-900 p-2 shadow-2xl border-b border-gray-800">
                <div class="max-w-6xl mx-auto flex justify-between items-center text-white px-4">
                    <button onclick="window.closeSheet()" class="text-gray-400 hover:text-white font-bold flex items-center gap-2"><span>‚Üê</span> Exit</button>
                    <div class="flex items-center gap-4">
                        <span id="sheet-type-badge" class="bg-amber-600 px-3 py-1 rounded text-[10px] font-black uppercase tracking-widest">PC</span>
                        <div class="flex items-center gap-1">
                            <button onclick="window.saveCurrentCharacter(true)" class="bg-green-700 hover:bg-green-600 px-4 py-1 rounded text-[10px] font-black uppercase tracking-widest">SYNC</button>
                            <button id="delete-char-btn" onclick="window.triggerDeleteModal()" class="bg-red-900 hover:bg-red-700 text-white px-3 py-1 rounded text-[10px] font-black uppercase tracking-widest hidden">Manage</button>
                        </div>
                    </div>
                </div>
            </nav>

            <div class="max-w-6xl mx-auto p-4 md:p-8">
                
                <!-- DM OVERSIGHT PANEL -->
                <div id="dm-oversight-panel" class="dm-panel hidden-view">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                        <div class="flex-grow w-full">
                            <h4 class="text-xs font-black uppercase text-amber-500 mb-2">DM Whisper</h4>
                            <div class="flex gap-2">
                                <input type="text" id="dm-whisper-input" class="bg-black/40 border-none rounded p-2 text-white text-sm" placeholder="Secret note for player...">
                                <button onclick="window.sendDmWhisper()" class="bg-purple-600 px-4 py-2 rounded text-xs font-black uppercase">Send</button>
                            </div>
                        </div>
                        <div class="flex flex-col items-center gap-2">
                            <h4 class="text-xs font-black uppercase text-amber-500">Character Status</h4>
                            <div class="flex gap-2">
                                <button onclick="window.updateCharStatus('alive')" class="bg-green-900 text-green-400 px-4 py-2 rounded text-[10px] font-black uppercase border border-green-700">Alive</button>
                                <button onclick="window.updateCharStatus('coma')" class="bg-amber-900 text-amber-400 px-4 py-2 rounded text-[10px] font-black uppercase border border-amber-700">Coma</button>
                                <button onclick="window.updateCharStatus('dead')" class="bg-gray-700 text-gray-300 px-4 py-2 rounded text-[10px] font-black uppercase border border-gray-600">Death</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="pc-sheet-layout">
                    <!-- HEADER -->
                    <header class="sheet-card mb-8">
                        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                            <div class="lg:col-span-4 flex flex-col gap-4">
                                <div>
                                    <input type="text" id="pc-name-field" class="text-3xl font-bold font-serif w-full mb-1" placeholder="Character Name" data-key="name">
                                    <label class="tiny-label">Character Name</label>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><input type="text" data-key="archetype" placeholder="Survivor"><label class="tiny-label">Archetype</label></div>
                                    <div><input type="text" data-key="belief" placeholder="Belief"><label class="tiny-label">Belief</label></div>
                                </div>
                            </div>
                            <div class="lg:col-span-8 grid grid-cols-2 md:grid-cols-3 gap-4">
                                <div><input type="text" data-key="class" placeholder="Fighter"><label class="tiny-label">Class</label></div>
                                <div><input type="number" data-key="level" placeholder="1" onchange="window.updateLevelDependencies(this.value)"><label class="tiny-label">Level</label></div>
                                <div>
                                    <select id="party-select" data-key="partyId" class="cursor-pointer">
                                        <option value="">Unassigned</option>
                                    </select>
                                    <label class="tiny-label">Party</label>
                                </div>
                                <div><input type="text" data-key="race" placeholder="Human"><label class="tiny-label">Race</label></div>
                                <div><input type="text" data-key="background" placeholder="Noble"><label class="tiny-label">Background</label></div>
                                <div><input type="text" data-key="alignment" placeholder="Neutral"><label class="tiny-label">Alignment</label></div>
                            </div>
                        </div>
                    </header>

                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        
                        <!-- LEFT SIDE -->
                        <div class="lg:col-span-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-6">
                                <div class="sheet-card">
                                    <h3 class="flex justify-between items-center">
                                        Abilities & Modifiers
                                        <button id="main-gen-btn" onclick="window.openScoreGenModal()" class="bg-blue-100 text-[8px] px-1.5 rounded text-blue-700 font-black hover:bg-blue-200">GENERATE</button>
                                    </h3>
                                    <div class="grid grid-cols-2 gap-4 mb-4">
                                        <div class="text-center"><input type="number" data-key="profBonus" class="text-xl font-black text-center" value="2" onchange="window.calcMods()"><label class="tiny-label">Proficiency</label></div>
                                        <div class="text-center"><input type="number" data-key="passivePerception" class="text-xl font-black text-center" value="10" onchange="window.calcMods()"><label class="tiny-label">Pass. Perception</label></div>
                                    </div>
                                    <div id="stats-container" class="space-y-3"></div>
                                </div>
                                <div class="sheet-card"><h3>Saves</h3><div id="saves-container" class="space-y-1"></div></div>
                                <div class="sheet-card"><h3>Skills</h3><div id="skills-container" class="space-y-1 max-h-[300px] overflow-y-auto pr-2"></div></div>
                            </div>

                            <div class="space-y-6">
                                <div class="grid grid-cols-3 gap-2">
                                    <div class="vital-container vital-shield"><div class="vital-label">AC</div><input type="number" class="vital-input" data-key="ac" placeholder="10"></div>
                                    <div class="vital-container vital-square-init"><div class="vital-label">INIT</div><input type="number" class="vital-input" data-key="init" placeholder="0"></div>
                                    <div class="vital-container vital-square-speed"><div class="vital-label">Speed</div><input type="text" class="vital-input text-green-600" data-key="speed" placeholder="30FT"></div>
                                </div>

                                <div class="sheet-card text-center py-8">
                                    <div class="flex justify-between px-2 mb-2 text-[10px] font-black uppercase text-gray-400">
                                        <span>MAX HP: <input type="number" class="w-8" data-key="hpMax"></span>
                                        <span>HD: <input type="text" class="w-12 text-right" data-key="hd" placeholder="1 / 1d10"></span>
                                    </div>
                                    <input type="number" class="text-7xl font-black text-center w-full mb-1" data-key="hpCurrent" placeholder="10">
                                    <div class="text-[10px] font-black uppercase mt-4">Health Points</div>
                                    <input type="number" class="text-xl font-bold text-center w-full border-b border-gray-100" data-key="tempHp" placeholder="Temp HP">
                                    <div class="flex gap-2 justify-center mt-6">
                                        <button onclick="window.rest('short')" class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-[10px] font-black uppercase">Short Rest</button>
                                        <button onclick="window.rest('long')" class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-[10px] font-black uppercase">Long Rest</button>
                                    </div>
                                </div>

                                <div class="sheet-card">
                                    <h3>Death & Coma</h3>
                                    <div class="text-center space-y-4">
                                        <div class="uppercase text-[10px] font-black text-gray-400 tracking-widest">Death Saves</div>
                                        <div class="flex flex-col items-center gap-2">
                                            <div class="text-green-700 text-[10px] font-black">SUCCESS</div>
                                            <div class="flex gap-2">
                                                <div onclick="window.toggleDS('succ', 1)" id="ds-succ-1" class="ds-dot"></div>
                                                <div onclick="window.toggleDS('succ', 2)" id="ds-succ-2" class="ds-dot"></div>
                                                <div onclick="window.toggleDS('succ', 3)" id="ds-succ-3" class="ds-dot"></div>
                                            </div>
                                            <div class="text-red-700 text-[10px] font-black mt-2">FAILURE</div>
                                            <div class="flex gap-2">
                                                <div onclick="window.toggleDS('fail', 1)" id="ds-fail-1" class="ds-dot"></div>
                                                <div onclick="window.toggleDS('fail', 2)" id="ds-fail-2" class="ds-dot"></div>
                                                <div onclick="window.toggleDS('fail', 3)" id="ds-fail-3" class="ds-dot"></div>
                                            </div>
                                        </div>
                                        <div class="pt-4 border-t border-gray-100 flex items-center justify-center gap-2">
                                            <input type="checkbox" data-key="comaActive" class="w-4 h-4">
                                            <span class="text-[10px] font-black uppercase text-amber-600">Active Coma</span>
                                        </div>
                                        <div class="flex items-center justify-center gap-1">
                                            <input type="number" class="w-10 text-center text-xl font-black" data-key="comaRounds" value="0">
                                            <span class="text-gray-400 font-black">/ 10</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="sheet-card">
                                    <h3>Stress & Trauma</h3>
                                    <div class="flex justify-around items-center mb-4">
                                        <div class="text-center">
                                            <input type="number" data-key="currentStress" class="text-2xl font-black text-center w-16" value="0">
                                            <label class="tiny-label">Current Stress</label>
                                        </div>
                                        <div class="text-3xl text-gray-200 font-light">/</div>
                                        <div class="text-center">
                                            <input type="number" data-key="stressThreshold" class="text-2xl font-black text-center w-16" value="10">
                                            <label class="tiny-label">Threshold</label>
                                        </div>
                                    </div>
                                    <textarea data-key="trauma" class="text-xs italic font-serif h-12 w-full" placeholder="Scars and traumas..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- RIGHT SIDE -->
                        <div class="lg:col-span-6 space-y-6">
                            <div id="whisper-display-box" class="hidden-view">
                                <div class="sheet-card !bg-purple-50 !border-purple-200">
                                    <h3 class="!text-purple-700 !border-purple-200">DM Whispers</h3>
                                    <div id="whispers-list" class="space-y-3 max-h-[200px] overflow-y-auto pr-2"></div>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="sheet-card h-64 flex flex-col items-center justify-center border-2 border-dashed bg-gray-50 group relative overflow-hidden">
                                    <img id="portrait-preview" class="hidden absolute inset-0 w-full h-full object-cover">
                                    <div id="portrait-placeholder" class="text-center opacity-40">
                                        <span class="text-4xl">üë§</span><br>
                                        <span class="text-[10px] font-black uppercase">Add Portrait</span>
                                    </div>
                                    <input type="file" onchange="window.handleImageUpload(event)" class="absolute inset-0 opacity-0 cursor-pointer">
                                </div>
                                <div class="sheet-card h-64 flex flex-col">
                                    <h3>Roll History</h3>
                                    <div id="dice-log" class="flex-grow overflow-y-auto text-[10px] font-mono p-2 bg-gray-50 rounded">
                                        <div class="text-gray-300 italic text-center py-10">No actions recorded.</div>
                                    </div>
                                </div>
                            </div>

                            <div class="sheet-card">
                                <h3>Equipment & Weapons</h3>
                                <div class="equip-header"><span>Name</span><span>Atk</span><span>Dmg</span><span></span></div>
                                <div id="attacks-list" class="space-y-1 mb-4"></div>
                                <button onclick="window.addAttackItem()" class="w-full py-2 border-2 border-dashed border-gray-200 text-[10px] font-black text-gray-400 uppercase rounded hover:border-amber-400">+ Add Weapon</button>
                                <div class="grid grid-cols-4 gap-2 mt-6">
                                    <div class="text-center"><input type="number" data-key="sc" value="0" class="text-center font-bold"><label class="tiny-label">SC</label></div>
                                    <div class="text-center"><input type="number" data-key="cr" value="0" class="text-center font-bold"><label class="tiny-label">CR</label></div>
                                    <div class="text-center"><input type="number" data-key="byt" value="0" class="text-center font-bold"><label class="tiny-label">BYT</label></div>
                                    <div class="text-center"><input type="number" data-key="vt" value="0" class="text-center font-bold"><label class="tiny-label">VT</label></div>
                                </div>
                                <textarea data-key="equipment" class="mt-6 text-[12px] h-48 p-3 bg-gray-50 rounded font-mono" placeholder="Detailed Inventory list..."></textarea>
                            </div>

                            <div class="sheet-card">
                                <h3>Identity & Features</h3>
                                <div class="space-y-6">
                                    <div>
                                        <div class="text-[9px] font-black text-gray-400 uppercase mb-2">Languages</div>
                                        <div id="languages-list" class="flex flex-wrap gap-2 mb-3"></div>
                                        <div class="flex gap-2">
                                            <input type="text" id="lang-input" class="text-xs border-b px-2 h-8" placeholder="Add Language...">
                                            <button onclick="window.addLanguageItem()" class="bg-gray-200 px-4 rounded text-[9px] font-black h-8">ADD</button>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                                        <div><input type="text" data-key="traits" class="border-b h-8"><label class="tiny-label">Personality Traits</label></div>
                                        <div><input type="text" data-key="ideals" class="border-b h-8"><label class="tiny-label">Ideals</label></div>
                                        <div><input type="text" data-key="bonds" class="border-b h-8"><label class="tiny-label">Bonds</label></div>
                                        <div><input type="text" data-key="flaws" class="border-b h-8"><label class="tiny-label">Flaws</label></div>
                                    </div>
                                    <div>
                                        <div class="text-[9px] font-black text-gray-400 uppercase mb-2">Notes & Features</div>
                                        <textarea data-key="notes" class="text-[12px] h-48 p-3 bg-gray-50 rounded leading-relaxed font-serif" placeholder="Lore..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="mt-8">
                        <div class="sheet-card">
                            <div class="flex justify-between items-center border-b-2 border-gray-100 pb-2 mb-6">
                                <h2 class="font-serif font-bold text-lg uppercase tracking-wider">Character Moves</h2>
                                <div class="flex items-center gap-2">
                                    <label class="text-[10px] font-black uppercase text-gray-400">Viewing:</label>
                                    <select id="moves-selector" onchange="window.renderMovesGrid()" class="text-[10px] font-black uppercase border rounded px-2 py-1 bg-blue-500 text-white border-none cursor-pointer">
                                        <option value="features">Feature Moves</option>
                                        <option value="scriptcasting">Scriptcasting</option>
                                    </select>
                                </div>
                            </div>
                            <div id="features-lvl-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Roller -->
    <div id="quick-roll-bar" class="hidden-view floating-roller">
        <div class="flex items-center justify-between mb-4 border-b pb-2">
            <div class="flex items-center gap-2">
                <input type="number" id="roll-count" value="1" min="1" class="w-8 text-center font-black bg-gray-100 rounded">
                <div class="h-4 w-px bg-gray-200 mx-1"></div>
                <button onclick="window.setRollMode('normal')" class="mode-btn roll-mode active" id="mode-norm">Norm</button>
                <button onclick="window.setRollMode('adv')" class="mode-btn roll-mode" id="mode-adv">Adv</button>
                <button onclick="window.setRollMode('dis')" class="mode-btn roll-mode" id="mode-dis">Dis</button>
            </div>
        </div>
        <div class="grid grid-cols-4 gap-2">
            <button onclick="window.rollDice(4)" class="dice-grid-btn dice-orange">d4</button>
            <button onclick="window.rollDice(6)" class="dice-grid-btn dice-green">d6</button>
            <button onclick="window.rollDice(8)" class="dice-grid-btn dice-blue">d8</button>
            <button onclick="window.rollDice(10)" class="dice-grid-btn dice-purple">d10</button>
            <button onclick="window.rollDice(12)" class="dice-grid-btn dice-purple">d12</button>
            <button onclick="window.rollDice(20)" class="dice-grid-btn dice-red">d20</button>
            <button onclick="window.rollDice(100)" class="dice-grid-btn dice-dark">d100</button>
        </div>
    </div>

    <!-- Roll Result Overlay -->
    <div id="dice-result-overlay" class="fixed inset-0 bg-black/90 flex items-center justify-center z-[200] hidden" onclick="this.classList.add('hidden')">
        <div class="text-center text-white p-12">
            <div id="roll-label" class="text-amber-500 font-serif text-2xl mb-2 uppercase tracking-widest">ROLL</div>
            <div id="roll-total" class="text-9xl font-black mb-4">20</div>
            <div id="roll-breakdown" class="text-gray-300 font-mono text-lg bg-black/40 px-6 py-2 rounded-full inline-block"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, deleteDoc, onSnapshot, addDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'aeonfall-manager';
        
        let db, auth, user;
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) { console.warn("Firebase restricted mode active"); }

        let characters = [];
        let parties = [];
        let activeCharId = null;
        let activeRole = 'player';
        let rollMode = 'normal';
        let autoSaveTimer = null;
        let lastGeneratedScores = [];
        let sessionRerollUsed = false;

        const STATS = ['str', 'dex', 'con', 'int', 'wis', 'cha'];
        const SKILLS = [
            {n:'Acrobatics', s:'dex'}, {n:'Animal Handling', s:'wis'}, {n:'Arcana', s:'int'},
            {n:'Athletics', s:'str'}, {n:'Deception', s:'cha'}, {n:'History', s:'int'},
            {n:'Insight', s:'wis'}, {n:'Intimidation', s:'cha'}, {n:'Investigation', s:'int'},
            {n:'Medicine', s:'wis'}, {n:'Nature', s:'int'}, {n:'Perception', s:'wis'},
            {n:'Performance', s:'cha'}, {n:'Persuasion', s:'cha'}, {n:'Religion', s:'int'},
            {n:'Sleight of Hand', s:'dex'}, {n:'Stealth', s:'dex'}, {n:'Survival', s:'wis'}
        ];

        window.showToast = (m) => { const t = document.getElementById('toast'); t.textContent = m; t.style.opacity = 1; setTimeout(() => t.style.opacity = 0, 3000); };
        
        window.setRole = (r) => { 
            if (r === 'dm') { document.getElementById('password-modal').classList.remove('hidden'); }
            else { activeRole = 'player'; updateRoleUI(); }
        };

        window.verifyDmPassword = () => {
            const pwInput = document.getElementById('dm-password');
            if (pwInput && pwInput.value === 'Rew4994') {
                activeRole = 'dm';
                document.getElementById('password-modal').classList.add('hidden');
                updateRoleUI();
                window.showToast("DM Access Granted");
            } else {
                window.showToast("Access Denied");
            }
        };

        function updateRoleUI() {
            const isDM = activeRole === 'dm';
            const pb = document.getElementById('role-player-btn'), dbBtn = document.getElementById('role-dm-btn');
            if (pb) pb.className = !isDM ? 'px-6 py-3 rounded-lg text-sm font-bold bg-amber-600 text-white shadow-lg' : 'px-6 py-3 text-gray-500';
            if (dbBtn) dbBtn.className = isDM ? 'px-6 py-3 rounded-lg text-sm font-bold bg-amber-600 text-white shadow-lg' : 'px-6 py-3 text-gray-500';
            document.getElementById('dm-oversight-panel')?.classList.toggle('hidden-view', !isDM);
            renderDashboard();
            if (activeCharId) syncSheetData();
        }

        window.setView = (v) => {
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            const nBtn = document.getElementById(`nav-${v}`); if (nBtn) nBtn.classList.add('active');
            ['party','npcs','beasts','graveyard'].forEach(view => {
                const el = document.getElementById(`${view}-view-container`);
                if (el) el.classList.toggle('hidden-view', view !== v);
            });
            document.getElementById('view-title').textContent = v === 'party' ? 'The Party' : (v === 'npcs' ? 'NPCs' : (v === 'beasts' ? 'Bestiary' : 'Graveyard'));
            renderDashboard();
        };

        // --- CHARACTER MANAGEMENT ---
        window.triggerDeleteModal = () => {
            const char = characters.find(c => c.id === activeCharId);
            if (!char) return;
            window.resetDeleteModal();
            const isArchived = !!char.isDeleted;
            document.getElementById('archive-btn').classList.toggle('hidden', isArchived);
            document.getElementById('restore-btn').classList.toggle('hidden', !isArchived);
            document.getElementById('delete-modal-desc').textContent = isArchived 
                ? "This record is archived. Restore it to active play or erase it permanently."
                : "Archive this character to the Graveyard or erase them permanently.";
            document.getElementById('delete-modal').classList.remove('hidden');
        };

        window.showPermDeleteConfirm = () => {
            document.getElementById('delete-stage-1').classList.add('hidden');
            document.getElementById('delete-stage-confirm').classList.remove('hidden');
        };

        window.resetDeleteModal = () => {
            document.getElementById('delete-stage-1').classList.remove('hidden');
            document.getElementById('delete-stage-confirm').classList.add('hidden');
        };

        window.archiveCharacter = async () => {
            if (!activeCharId || !db) return;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'characters', activeCharId), { isDeleted: true, status: 'dead' });
            document.getElementById('delete-modal').classList.add('hidden');
            window.closeSheet();
            window.showToast("Archived to Graveyard");
        };

        window.restoreCharacter = async () => {
            if (!activeCharId || !db) return;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'characters', activeCharId), { isDeleted: false, status: 'alive' });
            document.getElementById('delete-modal').classList.add('hidden');
            window.showToast("Character Recovered!");
            syncSheetData();
        };

        window.executePermDelete = async () => {
            if (!activeCharId || !db) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'characters', activeCharId));
                document.getElementById('delete-modal').classList.add('hidden');
                window.closeSheet();
                window.showToast("Record Deleted Forever");
            } catch (err) {
                console.error("Delete failed:", err);
                window.showToast("Error deleting document.");
            }
        };

        window.updateCharStatus = async (status) => {
            if (!activeCharId || !db) return;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'characters', activeCharId), { status });
            window.showToast(`Character set to ${status.toUpperCase()}`);
        };

        window.sendDmWhisper = async () => {
            const input = document.getElementById('dm-whisper-input');
            if (!input.value || !activeCharId || !db) return;
            const char = characters.find(c => c.id === activeCharId);
            const whispers = char.dmWhispers || [];
            whispers.push({ text: input.value, timestamp: Date.now() });
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'characters', activeCharId), { dmWhispers: whispers });
            input.value = '';
            window.showToast("Whisper Sent");
        };

        window.openPartyModal = () => document.getElementById('party-modal').classList.remove('hidden');
        
        window.createParty = async () => {
            if (!db) return;
            const name = document.getElementById('party-name-input').value;
            if (!name) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'parties'), { name, createdAt: Date.now() });
            document.getElementById('party-modal').classList.add('hidden');
            document.getElementById('party-name-input').value = '';
            window.showToast("Party Created!");
        };

        window.openScoreGenModal = () => {
            sessionRerollUsed = false;
            document.getElementById('score-gen-modal').classList.remove('hidden');
            document.getElementById('gen-results-area').classList.add('hidden');
            document.getElementById('gen-apply-area').classList.add('hidden');
            document.getElementById('heroic-reroll-area').classList.add('hidden');
            document.getElementById('gen-controls').classList.remove('hidden');
            document.getElementById('cancel-gen-btn').classList.remove('hidden');
        };

        window.generateScores = (method, isReroll = false) => {
            if (method === 'standard') {
                lastGeneratedScores = [15, 14, 13, 12, 10, 8];
                document.getElementById('heroic-reroll-area').classList.add('hidden');
            } else {
                if (isReroll) sessionRerollUsed = true;
                lastGeneratedScores = [];
                for (let i = 0; i < 6; i++) {
                    const rolls = [Math.floor(Math.random()*6)+1, Math.floor(Math.random()*6)+1, Math.floor(Math.random()*6)+1, Math.floor(Math.random()*6)+1];
                    rolls.sort((a,b)=>b-a);
                    lastGeneratedScores.push(rolls[0]+rolls[1]+rolls[2]);
                }
                lastGeneratedScores.sort((a,b)=>b-a);
                if (!sessionRerollUsed) document.getElementById('heroic-reroll-area').classList.remove('hidden');
                else document.getElementById('heroic-reroll-area').classList.add('hidden');
            }
            document.getElementById('gen-numbers-display').innerHTML = lastGeneratedScores.map(n => `<span class="score-line-val">${n}</span>`).join('');
            document.getElementById('assign-grid').innerHTML = STATS.map(stat => `<div class="assign-row"><span class="assign-label">${stat}</span><select class="assign-select" data-assign-stat="${stat}"><option value="">-</option>${lastGeneratedScores.map((n, i) => `<option value="${i}">${n}</option>`).join('')}</select></div>`).join('');
            document.getElementById('gen-results-area').classList.remove('hidden');
            document.getElementById('gen-apply-area').classList.remove('hidden');
            document.getElementById('gen-controls').classList.add('hidden');
            document.getElementById('cancel-gen-btn').classList.add('hidden');
        };

        window.randomizeAssignment = () => {
            if (!lastGeneratedScores || lastGeneratedScores.length < 6) return;
            const selects = Array.from(document.querySelectorAll('[data-assign-stat]'));
            const poolIndices = [0, 1, 2, 3, 4, 5];
            for (let i = 5; i > 0; i--) { const j = Math.floor(Math.random()*(i+1)); [poolIndices[i], poolIndices[j]] = [poolIndices[j], poolIndices[i]]; }
            selects.forEach((s, i) => s.value = poolIndices[i]);
        };

        window.applyScores = async () => {
            if (!activeCharId || !db) return;
            const selects = Array.from(document.querySelectorAll('[data-assign-stat]'));
            const chosenIndices = selects.map(s => s.value).filter(v => v !== "");
            if (chosenIndices.length < 6) { window.showToast("Assign all 6 scores."); return; }
            if (new Set(chosenIndices).size < 6) { window.showToast("Pool numbers must be unique."); return; }
            const updates = { scoresGenerated: true };
            selects.forEach(s => { const stat = s.dataset.assignStat; updates[stat] = lastGeneratedScores[parseInt(s.value)]; });
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'characters', activeCharId), updates);
            window.calcMods();
            document.getElementById('score-gen-modal').classList.add('hidden');
            window.showToast("Scores Applied");
        };

        window.createChar = async (type) => {
            if (!db) return;
            const ref = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'characters'), {
                type, name: `New ${type}`, ownerId: user?.uid || 'anon', isDeleted: false,
                status: 'alive', hpMax: 10, hpCurrent: 10, level: 1, str: 10, dex: 10, con: 10, int: 10, wis: 10, cha: 10,
                profBonus: 2, passivePerception: 10, stressThreshold: 10, dmWhispers: [], scoresGenerated: false
            });
            window.openSheet(ref.id);
        };

        window.openSheet = (id) => {
            activeCharId = id;
            document.getElementById('dashboard-screen').classList.add('hidden-view');
            document.getElementById('sheet-screen').classList.remove('hidden-view');
            document.getElementById('quick-roll-bar').classList.remove('hidden-view');
            initSheetUI();
            syncSheetData();
        };

        window.closeSheet = () => {
            activeCharId = null;
            document.getElementById('sheet-screen').classList.add('hidden-view');
            document.getElementById('dashboard-screen').classList.remove('hidden-view');
            document.getElementById('quick-roll-bar').classList.add('hidden-view');
        };

        window.updateLevelDependencies = (val) => {
            const lvl = parseInt(val) || 1;
            let bonus = (lvl >= 17) ? 6 : (lvl >= 13) ? 5 : (lvl >= 9) ? 4 : (lvl >= 5) ? 3 : 2;
            const profInput = document.querySelector('[data-key="profBonus"]');
            if (profInput) { profInput.value = bonus; window.calcMods(); }
            window.saveCurrentCharacter();
        };

        window.rest = async (type) => {
            if (!activeCharId || !db) return;
            const char = characters.find(c => c.id === activeCharId);
            if (type === 'long') {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'characters', activeCharId), { 
                    dsSucc: 0, dsFail: 0, hpCurrent: parseInt(char.hpMax) || 10, tempHp: 0 
                });
                window.showToast("Long Rest Complete");
            } else window.showToast("Short Rest Function Ready");
        };

        window.calcMods = () => {
            const prof = parseInt(document.querySelector('[data-key="profBonus"]')?.value) || 2;
            STATS.forEach(s => {
                const val = parseInt(document.querySelector(`[data-key="${s}"]`)?.value) || 10;
                const mod = Math.floor((val - 10) / 2);
                const modEl = document.getElementById(`mod-${s}`);
                if (modEl) modEl.textContent = (mod >= 0 ? '+' : '') + mod;
                const isProf = document.querySelector(`[data-key="save_prof_${s}"]`)?.checked;
                const saveModEl = document.getElementById(`save-mod-${s}`);
                if (saveModEl) saveModEl.textContent = (mod + (isProf ? prof : 0) >= 0 ? '+' : '') + (mod + (isProf ? prof : 0));
            });
            SKILLS.forEach(sk => {
                const mod = Math.floor(((parseInt(document.querySelector(`[data-key="${sk.s}"]`)?.value) || 10) - 10) / 2);
                const isProf = document.querySelector(`[data-key="prof_${sk.n.toLowerCase().replace(/ /g,'_')}"]`)?.checked;
                const skillModEl = document.getElementById(`skill-mod-${sk.n.replace(/ /g,'_')}`);
                if (skillModEl) skillModEl.textContent = (mod + (isProf ? prof : 0) >= 0 ? '+' : '') + (mod + (isProf ? prof : 0));
            });
        };

        window.toggleDS = (type, num) => {
            const char = characters.find(c => c.id === activeCharId);
            if (!char) return;
            const key = type === 'succ' ? 'dsSucc' : 'dsFail';
            const newVal = char[key] === num ? num - 1 : num;
            updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'characters', activeCharId), { [key]: newVal });
        };

        window.setRollMode = (m) => {
            rollMode = m;
            document.querySelectorAll('.roll-mode').forEach(b => b.classList.remove('active'));
            document.getElementById(`mode-${m}`).classList.add('active');
        };

        function executeRoll(label, bonus) {
            const r1 = Math.floor(Math.random() * 20) + 1, r2 = Math.floor(Math.random() * 20) + 1;
            let finalDie = r1, breakdown = `(${r1})`;
            if (rollMode === 'adv') { finalDie = Math.max(r1, r2); breakdown = `Adv: Max(${r1}, ${r2})`; }
            else if (rollMode === 'dis') { finalDie = Math.min(r1, r2); breakdown = `Dis: Min(${r1}, ${r2})`; }
            const total = finalDie + bonus;
            document.getElementById('roll-label').textContent = label;
            document.getElementById('roll-total').textContent = total;
            document.getElementById('roll-breakdown').textContent = `${breakdown} + ${bonus}`;
            document.getElementById('dice-result-overlay').classList.remove('hidden');
            const log = document.getElementById('dice-log');
            const item = document.createElement('div');
            item.className = "flex justify-between border-b border-gray-100 py-1";
            item.innerHTML = `<span>${label}</span><span class="font-bold">${total}</span>`;
            log.prepend(item);
        }

        window.rollStat = (s) => { const mod = parseInt(document.getElementById(`mod-${s}`).textContent) || 0; executeRoll(`${s.toUpperCase()} Check`, mod); };
        window.rollSave = (s) => { const mod = parseInt(document.getElementById(`save-mod-${s}`).textContent) || 0; executeRoll(`${s.toUpperCase()} Save`, mod); };
        window.rollSkill = (name) => { const mod = parseInt(document.getElementById(`skill-mod-${name.replace(/ /g,'_')}`).textContent) || 0; executeRoll(`${name} Check`, mod); };

        window.rollDice = (sides) => {
            const count = parseInt(document.getElementById('roll-count').value) || 1, rolls = [];
            for(let i=0; i<count; i++) rolls.push(Math.floor(Math.random() * sides) + 1);
            const total = rolls.reduce((a, b) => a + b, 0);
            document.getElementById('roll-label').textContent = `${count}d${sides} Roll`;
            document.getElementById('roll-total').textContent = total;
            document.getElementById('roll-breakdown').textContent = rolls.length > 1 ? `(${rolls.join('+')})` : `(${total})`;
            document.getElementById('dice-result-overlay').classList.remove('hidden');
            const log = document.getElementById('dice-log');
            const item = document.createElement('div');
            item.className = "flex justify-between border-b border-gray-100 py-1";
            item.innerHTML = `<span>${count}d${sides}</span><span class="font-bold">${total}</span>`;
            log.prepend(item);
        };

        window.handleImageUpload = (e) => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                document.getElementById('portrait-preview').src = ev.target.result;
                document.getElementById('portrait-preview').classList.remove('hidden');
                document.getElementById('portrait-placeholder').classList.add('hidden');
                window.saveCurrentCharacter();
            };
            reader.readAsDataURL(file);
        };

        window.addAttackItem = () => {
            const cont = document.getElementById('attacks-list'), div = document.createElement('div');
            div.className = "equip-row";
            div.innerHTML = `<input type="text" class="atk-name font-bold flex-1" placeholder="Weapon"><input type="text" class="atk-bonus w-10 text-center" placeholder="+0"><input type="text" class="atk-dmg w-12 text-center" placeholder="1d8"><button onclick="this.parentElement.remove(); window.saveCurrentCharacter();" class="text-red-300">√ó</button>`;
            cont.appendChild(div);
        };

        window.addLanguageItem = () => {
            const inp = document.getElementById('lang-input'); if (!inp.value) return;
            const cont = document.getElementById('languages-list'), tag = document.createElement('div');
            tag.className = "bg-gray-100 px-2 py-0.5 rounded text-[10px] flex items-center gap-1 font-bold";
            tag.innerHTML = `<span>${inp.value}</span><button onclick="this.parentElement.remove(); window.saveCurrentCharacter();" class="text-red-400">√ó</button>`;
            cont.appendChild(tag);
            inp.value = ''; window.saveCurrentCharacter();
        };

        window.saveCurrentCharacter = (manual) => {
            if (!activeCharId || !db) return;
            const data = {};
            document.querySelectorAll('[data-key]').forEach(el => data[el.dataset.key] = el.type === 'checkbox' ? el.checked : el.value);
            data.imageSrc = document.getElementById('portrait-preview').src || "";
            data.languages = Array.from(document.querySelectorAll('#languages-list span')).map(s => s.textContent);
            data.attacks = Array.from(document.querySelectorAll('#attacks-list > div')).map(row => ({
                name: row.querySelector('.atk-name')?.value || "",
                bonus: row.querySelector('.atk-bonus')?.value || "",
                dmg: row.querySelector('.atk-dmg')?.value || ""
            }));
            updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'characters', activeCharId), data);
            if (manual) window.showToast("Synced to Cloud");
            document.getElementById('sync-indicator').style.opacity = 1;
            setTimeout(() => document.getElementById('sync-indicator').style.opacity = 0, 1000);
        };

        function renderDashboard() {
            const partyC = document.getElementById('party-view-container'), npcContainer = document.getElementById('npcs-view-container'), beastContainer = document.getElementById('beasts-view-container'), graveContainer = document.getElementById('graveyard-view-container');
            if (!partyC) return;
            partyC.innerHTML = ''; npcContainer.innerHTML = ''; beastContainer.innerHTML = ''; graveContainer.innerHTML = '';
            const pcs = characters.filter(c => c.type === 'PC' && !c.isDeleted);
            parties.forEach(p => {
                const section = document.createElement('div'); section.className = "space-y-4 bg-gray-900/40 p-6 rounded-2xl border border-gray-800 shadow-xl mb-8";
                section.innerHTML = `<h3 class="text-indigo-400 font-serif font-bold uppercase tracking-widest text-sm border-b border-gray-800 pb-2 mb-4">${p.name}</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="party-grid-${p.id}"></div>`;
                partyC.appendChild(section);
                const grid = section.querySelector(`#party-grid-${p.id}`);
                pcs.filter(c => c.partyId === p.id).forEach(c => grid.appendChild(createCard(c)));
            });
            const unassigned = pcs.filter(c => !c.partyId);
            if (unassigned.length > 0) {
                const section = document.createElement('div'); section.className = "space-y-4";
                section.innerHTML = `<h3 class="text-gray-500 font-serif font-bold uppercase tracking-widest text-sm border-b border-gray-800 pb-2 mb-4">Unassigned Adventurers</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="unassigned-grid"></div>`;
                partyC.appendChild(section);
                const grid = section.querySelector('#unassigned-grid');
                unassigned.forEach(c => grid.appendChild(createCard(c)));
            }
            characters.filter(c => c.type === 'NPC' && !c.isDeleted).forEach(c => npcContainer.appendChild(createCard(c)));
            characters.filter(c => c.type === 'Beast' && !c.isDeleted).forEach(c => beastContainer.appendChild(createCard(c)));
            characters.filter(c => c.isDeleted).forEach(c => graveContainer.appendChild(createCard(c)));
        }

        function createCard(c) {
            const card = document.createElement('div');
            card.className = `bg-gray-800 p-5 rounded-xl card border-l-4 shadow-xl ${c.status === 'dead' ? 'opacity-50' : ''}`;
            card.style.borderColor = (c.status === 'coma') ? '#f59e0b' : (c.status === 'dead') ? '#4b5563' : '#10b981';
            card.onclick = () => window.openSheet(c.id);
            card.innerHTML = `<div class="flex items-center gap-4 mb-4"><div class="w-12 h-12 rounded-lg bg-gray-700 overflow-hidden flex-shrink-0">${c.imageSrc ? `<img src="${c.imageSrc}" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center text-xl">üë§</div>'}</div><div><h5 class="text-amber-500 font-serif font-bold">${c.name || 'Unnamed'}</h5><p class="text-[10px] text-gray-400 uppercase font-black">${c.class || 'Class'} ${c.level || 1}</p></div></div><div class="flex justify-between items-center text-[10px] font-black uppercase text-gray-400"><span>${c.status || 'ACTIVE'}</span><span class="text-green-500">HP ${c.hpCurrent || 0}/${c.hpMax || 0}</span></div>`;
            return card;
        }

        function initSheetUI() {
            const sC = document.getElementById('stats-container'), svC = document.getElementById('saves-container'), skC = document.getElementById('skills-container');
            sC.innerHTML = ''; svC.innerHTML = ''; skC.innerHTML = '';
            STATS.forEach(s => {
                sC.innerHTML += `<div class="flex items-center gap-3"><div class="w-12 h-12 bg-gray-100 rounded-lg flex flex-col items-center justify-center border-2 border-gray-300 font-black rollable" onclick="window.rollStat('${s}')"><span class="text-[8px] uppercase text-gray-400">${s}</span><span id="mod-${s}">+0</span></div><div class="flex-grow flex items-center gap-2"><input type="number" data-key="${s}" class="w-10 text-center font-bold" value="10" onchange="window.calcMods()"><label class="tiny-label flex-grow">Score</label></div></div>`;
                svC.innerHTML += `<div class="flex items-center gap-2 text-[10px] border-b border-gray-50 pb-1"><input type="checkbox" data-key="save_prof_${s}" class="w-3 h-3" onchange="window.calcMods()"><span class="font-bold uppercase text-gray-400">${s}</span><span class="ml-auto font-black rollable" id="save-mod-${s}" onclick="window.rollSave('${s}')">+0</span></div>`;
            });
            SKILLS.forEach(sk => {
                const id = `skill-mod-${sk.n.replace(/ /g,'_')}`;
                skC.innerHTML += `<div class="flex items-center gap-2 text-[10px] border-b border-gray-50 py-1"><input type="checkbox" data-key="prof_${sk.n.toLowerCase().replace(/ /g,'_')}" class="w-3 h-3" onchange="window.calcMods()"><span class="font-bold text-gray-600 uppercase">${sk.n}</span><span class="ml-auto font-black rollable" id="${id}" onclick="window.rollSkill('${sk.n}')">+0</span></div>`;
            });
            window.renderMovesGrid();
        }

        window.renderMovesGrid = () => {
            const type = document.getElementById('moves-selector').value, grid = document.getElementById('features-lvl-grid');
            grid.innerHTML = '';
            let levels = (type === 'features') ? ['Level 1', 'Level 2', 'Level 3', 'Level 4', 'Level 5', 'Level 6', 'Level 7', 'Level 8', 'Level 9'] : ['Tricks (0)', 'Level 1', 'Level 2', 'Level 3', 'Level 4', 'Level 5', 'Level 6', 'Level 7', 'Level 8', 'Level 9'];
            levels.forEach(lvl => { grid.innerHTML += `<div class="lvl-card"><div class="lvl-header">${lvl.toUpperCase()}</div><div class="flex-grow"></div><button class="text-[9px] font-black uppercase text-blue-500 text-center mt-2">+ ADD</button></div>`; });
        };

        async function syncSheetData() {
            const char = characters.find(c => c.id === activeCharId); if (!char) return;
            const partySelect = document.getElementById('party-select'); if (partySelect) { partySelect.innerHTML = '<option value="">Unassigned</option>'; parties.forEach(p => partySelect.innerHTML += `<option value="${p.id}">${p.name}</option>`); }
            document.querySelectorAll('[data-key]').forEach(el => {
                if (el.type === 'checkbox') el.checked = !!char[el.dataset.key];
                else {
                    const dbVal = char[el.dataset.key];
                    if ((el.dataset.key === 'passivePerception' || el.dataset.key === 'stressThreshold') && (dbVal === undefined || dbVal === "")) el.value = 10;
                    else el.value = dbVal || (el.type === 'number' ? 0 : '');
                }
            });

            // Status Styling
            const sheet = document.getElementById('sheet-container');
            sheet.className = char.status === 'coma' ? 'status-coma' : char.status === 'dead' ? 'status-dead' : '';

            // Whisper & Manage Logic
            const isDM = activeRole === 'dm', isOwner = char.ownerId === user?.uid;
            document.getElementById('whisper-display-box')?.classList.toggle('hidden-view', !(isDM || isOwner));
            document.getElementById('delete-char-btn')?.classList.toggle('hidden', !(isDM || isOwner));
            
            const wList = document.getElementById('whispers-list'); if (wList) wList.innerHTML = (char.dmWhispers || []).map(w => `<div class="dm-whisper-box"><span class="whisper-tag">From the Void</span><p class="text-xs font-serif italic">${w.text}</p></div>`).reverse().join('');

            if (document.getElementById('main-gen-btn')) document.getElementById('main-gen-btn').classList.toggle('hidden', !!char.scoresGenerated);
            if (char.imageSrc) { const pr = document.getElementById('portrait-preview'); pr.src = char.imageSrc; pr.classList.remove('hidden'); document.getElementById('portrait-placeholder').classList.add('hidden'); }
            for(let i=1; i<=3; i++) {
                const sEl = document.getElementById(`ds-succ-${i}`), fEl = document.getElementById(`ds-fail-${i}`);
                if (sEl) sEl.className = `ds-dot ${char.dsSucc >= i ? 'checked-succ' : ''}`;
                if (fEl) fEl.className = `ds-dot ${char.dsFail >= i ? 'checked-fail' : ''}`;
            }
            const langC = document.getElementById('languages-list'); if (langC) langC.innerHTML = '';
            (char.languages || []).forEach(l => { const t = document.createElement('div'); t.className = "bg-gray-100 px-2 py-0.5 rounded text-[10px] flex items-center gap-1 font-bold"; t.innerHTML = `<span>${l}</span><button onclick="this.parentElement.remove(); window.saveCurrentCharacter();" class="text-red-400">√ó</button>`; langC.appendChild(t); });
            const atkC = document.getElementById('attacks-list'); if (atkC) atkC.innerHTML = '';
            (char.attacks || []).forEach(atk => { 
                const d = document.createElement('div'); 
                d.className = "equip-row"; 
                d.innerHTML = `<input type="text" class="atk-name font-bold flex-1" value="${atk.name}"><input type="text" class="atk-bonus w-10 text-center" value="${atk.bonus}"><input type="text" class="atk-dmg w-12 text-center" value="${atk.dmg}"><button onclick="this.parentElement.remove(); window.saveCurrentCharacter();" class="text-red-300">√ó</button>`; 
                atkC.appendChild(d); 
            });
            window.calcMods();
        }

        const initAuth = async () => {
            if (!auth) return;
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token); else await signInAnonymously(auth);
            onAuthStateChanged(auth, (u) => {
                user = u;
                if (user && db) {
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'characters'), (snap) => { characters = snap.docs.map(d => ({id: d.id, ...d.data()})); renderDashboard(); if (activeCharId) syncSheetData(); });
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'parties'), (snap) => { parties = snap.docs.map(d => ({id: d.id, ...d.data()})); renderDashboard(); if (activeCharId) syncSheetData(); });
                }
            });
        };

        document.addEventListener('input', (e) => { if (e.target.dataset.key || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') { if (autoSaveTimer) clearTimeout(autoSaveTimer); autoSaveTimer = setTimeout(() => window.saveCurrentCharacter(), 1000); } });
        initAuth();
    </script>
</body>
</html>
