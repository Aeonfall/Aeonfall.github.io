<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aeonfall - Custodian's Public Archive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Roboto+Slab:wght@300;400;700&family=Special+Elite&family=MedievalSharp&family=Homemade+Apple&family=Pirata+One&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Roboto Slab', serif; 
            background-color: #0c0c0c; 
            background-image: url('https://www.transparenttextures.com/patterns/dark-wood.png');
            color: #1a0f0a; 
            min-height: 100vh;
            overflow: hidden; 
        }

        /* GUESTBOOK RECEPTION TERMINAL */
        #access-terminal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 100000;
            display: flex; align-items: center; justify-content: center; padding: 20px;
            transition: opacity 1.2s ease, transform 1.2s ease;
        }
        #access-terminal.unlocked { opacity: 0; pointer-events: none; transform: scale(1.05); }
        
        .guestbook-container {
            width: 100%; max-width: 960px; height: 680px;
            background: #f4edd8; background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            box-shadow: 0 50px 150px rgba(0,0,0,1), inset 0 0 100px rgba(0,0,0,0.1);
            border: 1px solid #dcd1b2; border-radius: 4px; display: flex; position: relative;
            transform-style: preserve-3d;
        }
        .guestbook-spine { width: 50px; background: #3a2220; border-left: 4px solid #251615; box-shadow: inset 8px 0 20px rgba(0,0,0,0.7); }
        .guestbook-page { flex: 1; padding: 70px 60px; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .page-left { border-right: 1px solid rgba(0,0,0,0.15); }

        .book-title { font-family: 'Cinzel', serif; font-weight: 900; color: #7a1d1d; font-size: 26px; text-transform: uppercase; margin-bottom: 5px; text-align: center; letter-spacing: 2px; }
        .book-sub { font-family: 'Special Elite', cursive; color: #5d4037; font-size: 10px; text-align: center; margin-bottom: 40px; text-transform: uppercase; letter-spacing: 3px; opacity: 0.8; }
        
        .ledger-line { width: 100%; border-bottom: 1px solid rgba(0,0,0,0.15); padding: 18px 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .ledger-line:hover { background: rgba(122, 29, 29, 0.08); border-bottom-color: #7a1d1d; padding-left: 20px; }
        .ledger-name { font-family: 'Homemade Apple', cursive; color: #1a0f0a; font-size: 20px; }
        .ledger-status-group { display: flex; align-items: center; gap: 15px; }
        .ledger-status { font-family: 'Special Elite'; font-size: 8px; opacity: 0.5; text-transform: uppercase; font-weight: bold; color: #7a1d1d; }

        .sign-here-input { width: 100%; background: transparent; border: none; border-bottom: 2px solid #7a1d1d; font-family: 'Homemade Apple', cursive; font-size: 32px; padding: 20px 0; color: #1a0f0a; outline: none; text-align: center; transition: 0.3s; }

        /* DRAG AND DROP STYLES */
        .drag-handle { cursor: grab; opacity: 0.3; transition: 0.2s; color: #7a1d1d; }
        .drag-handle:hover { opacity: 1; }
        .section-dragging { opacity: 0.2; transform: scale(0.98); border: 2px dashed #7a1d1d !important; }
        
        /* Drag Indicators */
        .section-drag-over-top { border-top: 5px solid #7a1d1d !important; }
        .section-drag-over-bottom { border-bottom: 5px solid #7a1d1d !important; }
        .section-drag-over-left { border-left: 8px solid #7a1d1d !important; padding-left: 12px !important; }
        .section-drag-over-right { border-right: 8px solid #7a1d1d !important; padding-right: 12px !important; }
        .section-drag-over-center { background: rgba(122, 29, 29, 0.05); border-radius: 4px; }

        /* TOAST SYSTEM */
        .toast { 
            position: fixed; top: 40px; left: 50%; transform: translateX(-50%); 
            background: #1a0f0a; color: #f4edd8; padding: 15px 40px; border-radius: 4px; 
            z-index: 2000000; opacity: 0; transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            font-family: 'Cinzel'; font-size: 13px; font-weight: 700; pointer-events: none;
            border: 2px solid #7a1d1d; box-shadow: 0 20px 60px rgba(0,0,0,0.9);
            letter-spacing: 2px; text-transform: uppercase;
        }

        /* MASTER LAYOUT */
        .parchment-container {
            max-width: 1400px; margin: 20px auto; background: #f4edd8;
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            box-shadow: 0 50px 100px rgba(0,0,0,0.8), inset 0 0 100px rgba(0,0,0,0.1);
            border-radius: 4px; position: relative; display: flex; height: calc(100vh - 40px);
            border: 1px solid #dcd1b2; box-sizing: border-box; overflow: hidden;
        }

        .manual-nav {
            width: 320px; background: rgba(0,0,0,0.06); border-right: 1px solid rgba(122, 29, 29, 0.15);
            padding: 40px 15px; flex-shrink: 0; display: flex; flex-direction: column; height: 100%; overflow-y: auto;
        }
        .shelf-item {
            font-family: 'Cinzel', serif; font-size: 10px; font-weight: 900; text-transform: uppercase; color: #f4edd8;
            padding: 14px 18px; margin-bottom: 10px; cursor: pointer; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            letter-spacing: 1px; border-left: 6px solid transparent; position: relative; box-shadow: 4px 4px 12px rgba(0,0,0,0.3);
        }
        .shelf-item.book { background: #4a2c2a; border-left-color: #7a1d1d; }
        .shelf-item.journal { background: #5d4037; border-left-color: #bba683; }
        .shelf-item.manuscript { background: #dcd1b2; color: #1a0f0a; border-left-color: #7a1d1d; }
        .shelf-item.newspaper { background: #fff; color: #1a0f0a; border-left-color: #000; border-top: 1px solid #ddd; }
        .shelf-item.parchment { background: #e0d1af; color: #5d4037; border-left-color: #8d7a5d; border-radius: 0 20px 20px 0; }
        .shelf-item.textbook { background: #709fbc; border-left-color: #d2ad32; color: #1a0f0a; }
        
        .shelf-item:hover { transform: translateX(10px); filter: brightness(1.2); }
        .shelf-item.active { transform: translateX(15px); box-shadow: -8px 8px 25px rgba(122, 29, 29, 0.5); z-index: 10; }

        .new-badge { position: absolute; top: -5px; right: -5px; background: #7a1d1d; color: white; font-size: 7px; padding: 2px 6px; border-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.4); animation: badgePulse 1.5s infinite; border: 1px solid rgba(255,255,255,0.2); pointer-events: none; }
        .personal-badge { position: absolute; bottom: -5px; right: -5px; background: #1565c0; color: white; font-size: 7px; padding: 2px 6px; border-radius: 2px; box-shadow: 0 2px 5px rgba(122, 29, 29, 0.4); border: 1px solid rgba(255,255,255,0.2); pointer-events: none; text-transform: uppercase; font-weight: 900; }
        @keyframes badgePulse { 0% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 0.8; } }

        .manual-body { flex-grow: 1; padding: 60px 50px 100px 50px; height: 100%; overflow-y: auto; overflow-x: hidden; scroll-behavior: smooth; box-sizing: border-box; position: relative; }
        #manual-sections-container { display: flex; flex-wrap: wrap; align-items: flex-start; width: 100%; gap: 0; }

        /* Pencil Charcoal Formatting */
        .manual-h1, .manual-h2, .manual-h3, .manual-p, .manual-note-box { color: #262626 !important; }
        .dm-editable:focus { outline: none; color: #262626 !important; }

        .manual-h2 { font-family: 'Cinzel', serif; font-weight: 900; font-size: 2.2rem; border-bottom: 4px double #7a1d1d; padding-bottom: 8px; text-transform: uppercase; margin-bottom: 25px; width: 100%; letter-spacing: 2px; }
        .manual-h3 { font-family: 'Cinzel', serif; font-weight: 700; font-size: 1.4rem; border-bottom: 1px solid rgba(93, 64, 55, 0.4); padding-bottom: 4px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; width: 100%; }
        .manual-divider { width: 100%; height: 1px; background: linear-gradient(to right, transparent, rgba(122, 29, 29, 0.4), transparent); margin: 30px 0; flex-shrink: 0; }

        /* BUTTONS & UI */
        .arch-btn { font-size: 10px; font-weight: 700; text-transform: uppercase; padding: 8px 16px; border-radius: 4px; cursor: pointer; border: 1px solid #7a1d1d; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; background: #7a1d1d; color: white; font-family: 'Cinzel', serif; letter-spacing: 1px; }
        .arch-btn:hover { background: #000; border-color: #000; transform: translateY(-1px); }
        .arch-btn-secondary { background: #f4edd8; color: #7a1d1d; border-color: #7a1d1d; }

        .tuner-panel { background: #fff; border: 1px solid #7a1d1d; padding: 10px 15px; border-radius: 4px; margin-bottom: 12px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); width: 100%; box-sizing: border-box; position: relative; z-index: 100; }
        .tuner-group { display: flex; flex-direction: column; gap: 1px; }
        .tuner-label { font-size: 7px; font-weight: 900; text-transform: uppercase; color: #7a1d1d; letter-spacing: 1px; }
        .tuner-slider { width: 80px; accent-color: #7a1d1d; height: 12px; }

        .visibility-tag { font-size: 8px; font-weight: 900; text-transform: uppercase; padding: 2px 6px; border-radius: 2px; margin-left: 10px; vertical-align: middle; }
        .tag-public { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .tag-secret { background: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; }
        .tag-personal { background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; }

        /* STICKY TOOLBAR REDESIGN */
        #dm-global-controls {
            position: sticky; bottom: 20px; left: 0; right: 0;
            background: rgba(244, 237, 216, 0.98); backdrop-filter: blur(8px);
            border: 1px solid #dcd1b2; border-top: 4px double #7a1d1d; 
            border-radius: 8px; padding: 16px;
            z-index: 1000; margin-top: 40px; 
            box-shadow: 0 -15px 40px rgba(0,0,0,0.15), inset 0 0 40px rgba(122, 29, 29, 0.05);
            display: flex; flex-direction: column; gap: 12px;
            width: fit-content; margin-left: auto; margin-right: auto;
            min-width: 600px;
        }

        /* ROLE TOGGLE REFINEMENT */
        .role-pill { background: rgba(0,0,0,0.08); border-radius: 4px; padding: 4px; display: flex; width: 100%; max-width: 220px; margin: 0 auto; border: 1px solid rgba(0,0,0,0.1); }
        .role-tab { flex: 1; padding: 8px; font-family: 'Cinzel', serif; font-size: 9px; font-weight: 700; border-radius: 2px; transition: 0.3s; color: #5d4037; text-transform: uppercase; cursor: pointer; text-align: center; }
        .role-tab.active { background: #7a1d1d !important; color: white !important; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* CINEMATIC TRANSITION */
        #cinematic-overlay {
            position: fixed; inset: 0; background: #000; z-index: 90000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.8s ease;
        }
        #cinematic-overlay.active { opacity: 1; pointer-events: auto; }
        .loading-text { font-family: 'Cinzel', serif; color: #7a1d1d; font-size: 12px; letter-spacing: 6px; text-transform: uppercase; font-weight: 900; animation: pulse 2s infinite; margin-top: 20px; }

        /* DOSSIER MODAL */
        #uid-link-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 95000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-box-dossier { background: #fff; width: 100%; max-width: 500px; border: 4px double #7a1d1d; border-radius: 4px; overflow: hidden; box-shadow: 0 40px 100px rgba(0,0,0,0.7); }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="toast" class="toast">Signature Processed</div>

    <!-- GUESTBOOK ACCESS TERMINAL -->
    <div id="access-terminal">
        <div class="guestbook-container">
            <div class="guestbook-spine"></div>
            
            <div class="guestbook-page page-left" id="terminal-login-view">
                <div class="book-title">Archival Registry</div>
                <div class="book-sub">Citizen Guestbook ‚Ä¢ Sign Ledger to Enter</div>
                
                <input type="text" id="terminal-search" class="terminal-input !bg-transparent !border-b !border-t-0 !border-x-0 !border-black/10 !mb-4 !text-black !p-3 !outline-none !font-serif" placeholder="Find character signature..." oninput="window.filterTerminal(this.value)">
                
                <div id="terminal-results" class="flex-grow overflow-y-auto pr-4">
                    <!-- Citizens populated via JS -->
                </div>

                <div class="mt-4 pt-4 border-t border-black/5 flex flex-wrap justify-center gap-x-6 gap-y-2">
                    <button onclick="window.bypassTerminal()" class="text-[9px] font-black uppercase opacity-40 hover:opacity-100 transition-opacity">Proceed as Guest</button>
                    <button onclick="window.proceedAsRegistered()" class="text-[9px] font-black uppercase opacity-40 hover:opacity-100 transition-opacity">Proceed as Registered</button>
                    <button onclick="window.location.href='lore.html'" class="text-[9px] font-black uppercase opacity-40 hover:opacity-100 transition-opacity text-red-800">I Don't want to sign</button>
                </div>
            </div>

            <div class="guestbook-page" id="terminal-register-view">
                <div class="book-title">Register Identity</div>
                <div class="book-sub">Establishing Cognitive Anchor Point</div>
                
                <div class="flex-grow flex flex-col justify-center gap-8">
                    <p class="font-serif italic text-[12px] text-[#5d4037] text-center px-4 leading-relaxed">
                        "I hereby verify my character's presence and bind my soul to the Aeonfall Archives. Synchronization starts now."
                    </p>
                    
                    <div class="px-6">
                        <label class="text-[8px] uppercase font-black opacity-40 block mb-1">Character Name (Final Signature)</label>
                        <input type="text" id="reg-name-input" class="sign-here-input" placeholder="Inscribe name here...">
                    </div>

                    <div class="flex flex-col gap-4 items-center">
                        <button id="reg-bind-btn" onclick="window.registerCitizen()" class="arch-btn !bg-black !border-black !px-12 !py-4 shadow-xl hover:!bg-[#7a1d1d] active:scale-95 transition-all">Sign the Registry</button>
                        <button onclick="window.toggleTerminalView('login')" class="text-[8px] font-black uppercase opacity-40 hover:opacity-100">Back to Ledger</button>
                    </div>
                </div>

                <div class="text-center opacity-20 font-serif text-[8px] mt-4 uppercase font-black tracking-[3px]">Ver. 8.6 ‚Ä¢ Tactical Reflow Enabled</div>
            </div>
        </div>
    </div>

    <!-- TRANSITION OVERLAY -->
    <div id="cinematic-overlay">
        <div class="loading-text">Synchronizing Cognitive Archival Stack...</div>
    </div>

    <!-- DOSSIER MODAL (DM ONLY) -->
    <div id="uid-link-modal" class="hidden" onclick="this.classList.add('hidden')">
        <div class="modal-box-dossier" onclick="event.stopPropagation()">
            <div class="modal-banner flex justify-between items-center bg-[#1a1a1a] text-white p-4 font-serif uppercase text-xs font-black border-b-2 border-[#7a1d1d]">
                <span>Citizen Access Ledger</span>
                <button onclick="document.getElementById('uid-link-modal').classList.add('hidden')" class="opacity-50 hover:opacity-100">‚úï</button>
            </div>
            <div class="p-8">
                <p class="text-[9px] uppercase font-black opacity-30 mb-4 tracking-widest text-[#7a1d1d]">Associate Citizen Signature to Record</p>
                <input type="text" id="user-search" class="w-full bg-gray-50 border border-gray-200 p-3 mb-4 rounded font-serif text-sm italic" placeholder="Search Character Name or paste UID..." oninput="window.filterDMUsers(this.value)">
                
                <div id="user-results" class="max-h-48 overflow-y-auto border border-gray-100 rounded mb-8 bg-white">
                    <!-- Results populated via JS -->
                </div>

                <div class="pt-6 border-t border-dashed border-gray-300">
                    <p class="text-[8px] uppercase font-black opacity-40 mb-3">Manual Archival Fingerprint Bind</p>
                    <div class="flex gap-2">
                        <input type="text" id="manual-uid-input" class="flex-grow p-2 bg-gray-100 border border-gray-200 rounded font-mono text-[10px]" placeholder="Enter Raw Firebase UID...">
                        <button onclick="window.assignManualUID()" class="bg-[#1a1a1a] text-[#f4edd8] px-4 py-2 text-[8px] font-black uppercase rounded hover:bg-[#7a1d1d] transition-colors shadow-sm">Bind RAW</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DM PASS MODAL -->
    <div id="pass-modal" class="fixed inset-0 bg-black/95 flex items-center justify-center z-[110000] hidden p-4">
        <div class="bg-gray-800 p-10 rounded-2xl w-full max-w-sm border-2 border-[#7a1d1d] text-white text-center shadow-2xl">
            <h3 class="text-xl font-serif text-[#f4edd8] font-bold mb-4 uppercase">Custodian Authorization</h3>
            <input type="password" id="dm-pass" class="w-full bg-gray-900 text-center text-2xl rounded-lg p-3 mb-8 border border-gray-700 text-[#7a1d1d] focus:outline-none">
            <button onclick="window.authDm()" class="w-full bg-[#7a1d1d] hover:bg-black text-white py-4 rounded-xl font-bold uppercase text-xs tracking-widest">Unlock Archives</button>
            <button onclick="document.getElementById('pass-modal').classList.add('hidden')" class="text-[10px] text-gray-500 uppercase font-black mt-6 block w-full text-center">Cancel</button>
        </div>
    </div>

    <div class="parchment-container">
        <!-- SIDEBAR -->
        <div class="manual-nav" onclick="event.stopPropagation()">
            <div class="mb-8 text-center">
                <h1 class="font-serif font-black text-2xl text-[#7a1d1d] uppercase leading-none">Aeonfall</h1>
                <p class="text-[8px] uppercase font-black tracking-widest opacity-50 mt-1">Custodian's Public Archive</p>
                
                <div id="user-display-container" class="mt-6 border-y border-black/5 py-4">
                    <div id="user-identity" class="font-serif text-[10px] font-black uppercase text-[#5d4037]">Securing signature...</div>
                    <div id="user-signout-container" class="mt-2 hidden">
                        <button onclick="window.resetIdentity()" class="text-[9px] font-black uppercase text-[#7a1d1d] hover:underline">Sign Out / Leave Ledger</button>
                    </div>
                    <div id="guest-login-action" class="mt-2 hidden">
                        <button onclick="window.showGuestbook()" class="text-[9px] font-black uppercase text-[#7a1d1d] hover:underline">Sign the Guest Book</button>
                    </div>
                </div>
            </div>

            <div class="role-pill mx-auto mb-6">
                <div id="role-player" onclick="window.setRole('player')" class="role-tab active">Player</div>
                <div id="role-dm" onclick="window.setRole('dm')" class="role-tab">DM</div>
            </div>
            
            <div id="nav-list" class="flex-grow"></div>

            <div class="mt-10 pt-10 border-t border-black/5">
                <div onclick="window.openReturnToLoreSequence()" class="block text-center font-serif uppercase font-black text-[11px] no-underline !text-[#7a1d1d] hover:underline mb-4 cursor-pointer">Return to Lore</div>
                <a href="playershandbook.html" class="block text-center font-serif uppercase font-black text-[11px] no-underline !text-[#7a1d1d] hover:underline">‚Üê Return to Hub</a>
            </div>
        </div>

        <!-- CONTENT AREA -->
        <div class="manual-body" id="content-pane">
            <div id="manual-header"></div>
            <div id="manual-sections-container"></div>

            <!-- DM CATEGORIZED CREATION TOOLBAR (STICKY) -->
            <div id="dm-global-controls" class="hidden">
                <div id="toolbar-main" class="flex flex-wrap justify-center gap-2">
                    <button class="arch-btn" onclick="window.switchToolbar('book')">üìï Book</button>
                    <button class="arch-btn" onclick="window.switchToolbar('journal')">üìí Journal</button>
                    <button class="arch-btn" onclick="window.switchToolbar('textbook')">üìì Text Book</button>
                    <button class="arch-btn" onclick="window.switchToolbar('newspaper')">üì∞ Newspaper</button>
                    <button class="arch-btn" onclick="window.switchToolbar('manuscript')">üìú Manuscript</button>
                    <button class="arch-btn" onclick="window.switchToolbar('parchment')">üìÑ Parchment</button>
                </div>
                <div id="toolbar-sub" class="hidden flex flex-wrap justify-center gap-2 items-center">
                    <button class="arch-btn arch-btn-secondary !text-[8px] !px-4" onclick="window.resetToolbar()">‚Üê Back</button>
                    <div class="h-6 w-[1px] bg-[#7a1d1d]/30 mx-2"></div>
                    <div id="sub-tool-buttons" class="flex flex-wrap gap-2">
                        <!-- Dynamic buttons here -->
                    </div>
                </div>
            </div>

            <div class="page-indicator mt-20 opacity-30 text-center uppercase tracking-widest text-[9px] font-black">End of Archive Record ‚Ä¢ Ver. 8.6.0</div>
        </div>
    </div>

    <!-- AUTH MODALS -->
    <div id="del-modal" class="fixed inset-0 z-[110000] flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/90" onclick="document.getElementById('del-modal').classList.add('hidden')"></div>
        <div class="bg-white p-10 rounded-2xl w-full max-w-sm text-center relative z-10 shadow-2xl text-black">
            <h3 class="text-2xl font-serif font-black text-red-700 uppercase mb-4">Purge Record</h3>
            <p id="del-modal-text" class="text-sm text-gray-500 mb-10 italic">This entry will be permanently expunged.</p>
            <div class="flex flex-col gap-4">
                <button id="confirm-del-btn" class="w-full bg-red-700 text-white py-4 rounded-xl font-black text-xs uppercase shadow-lg">Confirm Purge</button>
                <button onclick="document.getElementById('del-modal').classList.add('hidden')" class="w-full bg-gray-100 text-gray-400 py-3 rounded-xl font-bold uppercase text-[10px]">Decline</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, updateDoc, setDoc, onSnapshot, addDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBLN0KhcnZFKZEYyR0O-Q2mZhKr-iyh7BI", authDomain: "aeonfall-523c1.firebaseapp.com", projectId: "aeonfall-523c1", storageBucket: "aeonfall-523c1.firebasestorage.app", messagingSenderId: "716207733913", appId: "1:716207733913:web:7aac43906a70e2b5f50c08" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'aeonfall-manager-v2';

        let manualSections = [], seenDocs = [], allUsers = [], targetSectionForUID = null;
        let manualHeader = { title: "Archival History", subtitle: "Verifying civilizations past." };
        let activeRole = localStorage.getItem('aeonfall_role') || 'player'; 
        let activeEditId = null, userAuth = null, saveTimer = null, deleteCallback = null;
        let activeAnchorUID = null; 
        let draggedId = null, dropSide = null;

        const categoryTools = {
            'book': [
                { label: 'Volume Heading', type: 'subheading' },
                { label: 'Sub-Heading', type: 'inner-subheading' },
                { label: 'Spacing Line', type: 'divider' },
                { label: 'Text Block', type: 'text' },
                { label: 'Data Table', type: 'table' },
                { label: 'Sage Note', type: 'note' }
            ],
            'journal': [
                { label: 'Journal Heading', type: 'subheading' },
                { label: 'Entry Sub-Heading', type: 'inner-subheading' },
                { label: 'Handwritten Log', type: 'text' },
                { label: 'Personal Note', type: 'note' }
            ],
            'textbook': [
                { label: 'Lesson Volume', type: 'subheading' },
                { label: 'Scholar Teaching', type: 'textbook' },
                { label: 'Subject Divider', type: 'divider' }
            ],
            'newspaper': [
                { label: 'News Heading', type: 'subheading' },
                { label: 'Report Column', type: 'text' },
                { label: 'Classified Ledger', type: 'table' }
            ],
            'manuscript': [
                { label: 'MS Heading', type: 'subheading' },
                { label: 'Codex Subheading', type: 'inner-subheading' },
                { label: 'Codex Text', type: 'text' }
            ],
            'parchment': [
                { label: 'Parchment Heading', type: 'subheading' },
                { label: 'Notice Subheading', type: 'inner-subheading' },
                { label: 'Scroll Text', type: 'text' },
                { label: 'Notice Box', type: 'info' }
            ]
        };

        window.switchToolbar = (cat) => {
            const main = document.getElementById('toolbar-main');
            const sub = document.getElementById('toolbar-sub');
            const container = document.getElementById('sub-tool-buttons');
            main.classList.add('hidden');
            sub.classList.remove('hidden');
            container.innerHTML = categoryTools[cat].map(tool => `
                <button class="arch-btn !bg-black !border-black" onclick="window.addManualSection('${tool.type}', '${cat}')">${tool.label}</button>
            `).join('');
        };

        window.resetToolbar = () => {
            document.getElementById('toolbar-main').classList.remove('hidden');
            document.getElementById('toolbar-sub').classList.add('hidden');
        };

        window.addEventListener('paste', function(e) {
            if (e.target.hasAttribute('contenteditable')) {
                e.preventDefault();
                const text = e.clipboardData.getData('text/plain');
                document.execCommand('insertText', false, text);
            }
        });

        window.showToast = (m) => { 
            const t = document.getElementById('toast'); 
            if(t) { 
                t.textContent = m; t.style.opacity = '1'; t.style.transform = 'translateX(-50%) translateY(20px)';
                setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateX(-50%) translateY(0)'; }, 3000); 
            } 
        };

        window.handleDragStart = function(e, id) { if (activeRole !== 'dm') return; draggedId = id; e.currentTarget.classList.add('section-dragging'); };
        
        window.handleDragOver = function(e) { 
            if (!draggedId) return; 
            e.preventDefault(); 
            const rect = e.currentTarget.getBoundingClientRect(); 
            const relX = e.clientX - rect.left;
            const relY = e.clientY - rect.top;
            const horizThreshold = rect.width * 0.25;
            const vertThreshold = rect.height * 0.25;
            e.currentTarget.classList.remove('section-drag-over-top', 'section-drag-over-bottom', 'section-drag-over-left', 'section-drag-over-right', 'section-drag-over-center');
            if (relY < vertThreshold) { dropSide = 'top'; e.currentTarget.classList.add('section-drag-over-top'); } 
            else if (relY > rect.height - vertThreshold) { dropSide = 'bottom'; e.currentTarget.classList.add('section-drag-over-bottom'); } 
            else if (relX < horizThreshold) { dropSide = 'left'; e.currentTarget.classList.add('section-drag-over-left'); } 
            else if (relX > rect.width - horizThreshold) { dropSide = 'right'; e.currentTarget.classList.add('section-drag-over-right'); } 
            else { dropSide = 'center'; e.currentTarget.classList.add('section-drag-over-center'); }
        };

        window.handleDragLeave = function(e) { e.currentTarget.classList.remove('section-drag-over-top', 'section-drag-over-bottom', 'section-drag-over-left', 'section-drag-over-right', 'section-drag-over-center'); };

        window.handleDrop = async function(e, targetId) { 
            e.preventDefault(); e.currentTarget.classList.remove('section-drag-over-top', 'section-drag-over-bottom', 'section-drag-over-left', 'section-drag-over-right', 'section-drag-over-center'); 
            if (!draggedId || draggedId === targetId) return; 
            const sourceIdx = manualSections.findIndex(s => s.id === draggedId);
            const targetIdxOriginal = manualSections.findIndex(s => s.id === targetId);
            const targetBlock = manualSections[targetIdxOriginal];
            const newSections = [...manualSections];
            const [moved] = newSections.splice(sourceIdx, 1); 
            let insertIdx = newSections.findIndex(s => s.id === targetId);
            const batch = writeBatch(db);
            if (dropSide === 'left' || dropSide === 'right') { batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'librarySections', moved.id), { width: 48 }); batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'librarySections', targetBlock.id), { width: 48 }); if (dropSide === 'right') insertIdx += 1; } 
            else if (dropSide === 'top') {} else if (dropSide === 'bottom') { insertIdx += 1; } 
            else { if (insertIdx > sourceIdx) insertIdx += 0; }
            newSections.splice(insertIdx, 0, moved); 
            newSections.forEach((sec, i) => { batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'librarySections', sec.id), { order: i }); }); 
            await batch.commit(); draggedId = null; 
            window.showToast("Archive Records Reordered");
        };

        window.showGuestbook = () => { const terminal = document.getElementById('access-terminal'); if(terminal) { terminal.classList.remove('unlocked'); window.filterTerminal(''); } };
        window.anchorIdentity = (uid) => {
            activeAnchorUID = uid;
            sessionStorage.setItem('aeonfall_session_anchored', 'true');
            localStorage.setItem('aeonfall_claimed_uid', uid);
            window.showToast("COGNITIVE SIGNATURE ANCHORED");
            document.getElementById('access-terminal')?.classList.add('unlocked');
            window.updateIdentityUI();
            window.renderManual();
            onSnapshot(collection(db, 'artifacts', appId, 'users', uid, 'seenDocuments'), snap => {
                seenDocs = snap.docs.map(d => d.id);
                window.renderManual();
            }, err => {});
        };

        window.claimIdentity = (uid) => window.anchorIdentity(uid);

        window.filterTerminal = (val) => {
            const container = document.getElementById('terminal-results'); if(!container) return;
            const search = val.toLowerCase();
            const filtered = allUsers.filter(u => (u.username || '').toLowerCase().includes(search));
            const isDM = activeRole === 'dm';
            container.innerHTML = filtered.map(u => `
                <div class="ledger-line" onclick="window.claimIdentity('${u.uid}')">
                    <span class="ledger-name text-black">${u.username || 'Unidentified'}</span>
                    <div class="ledger-status-group">
                        <span class="ledger-status">Anchor Signature</span>
                        ${isDM ? `<button onclick="window.triggerPurgeCitizen(event, '${u.uid}')" class="purge-btn">Purge</button>` : ''}
                    </div>
                </div>
            `).join('') || (val ? '<div class="p-8 text-center text-[#7a1d1d] font-bold uppercase text-[10px] opacity-40">Identity Not Found</div>' : '<div class="p-8 text-center opacity-30 text-[9px] uppercase font-black tracking-widest">Sign the Registry to unlock personal dossiers</div>');
        };

        window.triggerPurgeCitizen = (e, uid) => {
            e.stopPropagation();
            window.openDelModal("Expunge signature from registry?", async () => {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid));
                window.showToast("RECORD PURGED");
            });
        };

        window.registerCitizen = async () => {
            const characterName = document.getElementById('reg-name-input')?.value.trim();
            if (!characterName) { window.showToast("Signature Required"); return; }
            const currentUser = auth.currentUser || userAuth;
            if (!currentUser) { window.showToast("Establishing Archival Channel..."); return; }
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid), { username: characterName, registeredAt: Date.now(), role: 'citizen' });
                window.anchorIdentity(currentUser.uid);
                window.showToast("IDENTITY RECORD CREATED");
            } catch (e) { window.showToast("Registration Refused."); }
        };

        window.toggleTerminalView = (view) => {
            const login = document.getElementById('terminal-login-view');
            const reg = document.getElementById('terminal-register-view');
            if (view === 'register') { login?.classList.add('hidden'); reg?.classList.remove('hidden'); }
            else { login?.classList.remove('hidden'); reg?.classList.add('hidden'); }
        };

        window.bypassTerminal = () => { activeAnchorUID = null; document.getElementById('access-terminal')?.classList.add('unlocked'); window.showToast("PROCEEDING AS GUEST"); window.updateIdentityUI(); window.renderManual(); };
        window.proceedAsRegistered = () => { const lastUID = localStorage.getItem('aeonfall_claimed_uid'); if (lastUID) window.anchorIdentity(lastUID); else window.showToast("NO ANCHOR FOUND ON LEDGER"); };
        window.resetIdentity = () => { activeAnchorUID = null; localStorage.removeItem('aeonfall_claimed_uid'); sessionStorage.removeItem('aeonfall_session_anchored'); window.showToast("LEAVING LEDGER..."); setTimeout(() => window.location.reload(), 500); };

        window.updateIdentityUI = () => {
            const isAnchored = sessionStorage.getItem('aeonfall_session_anchored') === 'true';
            const effectiveUID = isAnchored ? activeAnchorUID : null;
            const idChar = allUsers.find(au => au.uid === effectiveUID);
            const identText = document.getElementById('user-identity');
            const guestAction = document.getElementById('guest-login-action');
            const signoutContainer = document.getElementById('user-signout-container');
            if(identText) {
                if(idChar) { identText.innerText = `CITIZEN ANCHORED: ${idChar.username}`; guestAction?.classList.add('hidden'); signoutContainer?.classList.remove('hidden'); } 
                else { identText.innerText = 'UNIDENTIFIED GUEST'; guestAction?.classList.remove('hidden'); signoutContainer?.classList.add('hidden'); }
            }
        };

        window.openDelModal = (text, callback) => { const txt = document.getElementById('del-modal-text'); if (txt) txt.innerText = text; deleteCallback = callback; const m = document.getElementById('del-modal'); if(m) m.classList.remove('hidden'); };
        window.setEditing = (id) => { activeEditId = id; };
        window.clearEditing = () => { activeEditId = null; };
        
        window.setRole = (r) => { 
            if(r === 'dm') {
                document.getElementById('pass-modal')?.classList.remove('hidden'); 
            } else { 
                activeRole = 'player'; 
                localStorage.setItem('aeonfall_role', 'player'); 
                window.updateRoleUI(); 
            } 
        };
        
        window.authDm = () => { 
            if(document.getElementById('dm-pass')?.value === 'Rew4994') { 
                activeRole='dm'; 
                localStorage.setItem('aeonfall_role', 'dm'); 
                document.getElementById('pass-modal')?.classList.add('hidden'); 
                window.updateRoleUI(); 
            } else { 
                window.showToast("Key Mismatch"); 
            } 
        };

        window.updateRoleUI = () => { 
            const isDM = activeRole === 'dm'; 
            document.getElementById('dm-global-controls')?.classList.toggle('hidden', !isDM); 
            document.body.classList.toggle('dm-active-edit', isDM); 
            document.getElementById('role-dm')?.classList.toggle('active', isDM);
            document.getElementById('role-player')?.classList.toggle('active', !isDM);
            window.renderManual(); 
        };

        window.openUserModal = (sectionId) => { targetSectionForUID = sectionId; document.getElementById('uid-link-modal')?.classList.remove('hidden'); const searchInput = document.getElementById('user-search'); if(searchInput) searchInput.value = ''; window.filterDMUsers(''); };
        
        window.filterDMUsers = (val) => {
            const container = document.getElementById('user-results'); if(!container) return;
            const search = val.toLowerCase();
            const filtered = allUsers.filter(u => (u.username || '').toLowerCase().includes(search) || (u.uid || '').toLowerCase().includes(search));
            container.innerHTML = filtered.map(u => `
                <div class="user-result flex justify-between items-center p-4 hover:bg-gray-50 border-b border-gray-100">
                    <div class="cursor-pointer flex-grow" onclick="window.assignUIDToSection('${u.uid}')">
                        <div class="font-bold text-xs text-[#1a1a1a]">${u.username || 'Unidentified'}</div>
                        <div class="font-mono text-[7px] opacity-40">${u.uid}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="window.assignUIDToSection('${u.uid}')" class="bind-tag-btn">Sync</button>
                        <button onclick="window.triggerPurgeCitizen(event, '${u.uid}')" class="purge-btn">Purge</button>
                    </div>
                </div>
            `).join('') || '<div class="p-8 text-center opacity-40 text-[10px]">No Signal Found.</div>';
        };

        window.assignUIDToSection = async (uid) => { 
            if(!targetSectionForUID) return; 
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'librarySections', targetSectionForUID), { 
                sharedWith: [uid],
                visibility: 'personal'
            }); 
            document.getElementById('uid-link-modal')?.classList.add('hidden'); 
            window.showToast("Personal Link Established."); 
        };

        window.unbindUIDFromSection = async (sectionId) => {
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'librarySections', sectionId), { 
                    sharedWith: [],
                    visibility: 'secret'
                });
                window.showToast("LINK EXPUNGED - RECORD IS NOW PRIVATE");
            } catch(e) { window.showToast("Unbind Failed."); }
        };

        window.assignManualUID = async () => { 
            const uidInput = document.getElementById('manual-uid-input'); 
            const uid = uidInput ? uidInput.value.trim() : ''; 
            if(!uid || !targetSectionForUID) return; 
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'librarySections', targetSectionForUID), { 
                sharedWith: [uid],
                visibility: 'personal'
            }); 
            document.getElementById('uid-link-modal')?.classList.add('hidden'); 
            window.showToast("Override Complete"); 
        };
        
        window.markAsSeen = async (id) => { 
            if (!seenDocs.includes(id)) {
                seenDocs.push(id);
                window.renderManual();
            }
            const anchored = sessionStorage.getItem('aeonfall_session_anchored') === 'true'; 
            if(anchored && activeAnchorUID) { 
                await setDoc(doc(db, 'artifacts', appId, 'users', activeAnchorUID, 'seenDocuments', id), { seenAt: Date.now() }); 
            }
            window.scrollToSection(id); 
        };
        
        window.scrollToSection = (id) => { const el = document.getElementById(`section-${id}`); if (el) el.scrollIntoView({ behavior: 'smooth' }); };
        window.openReturnToLoreSequence = function() { const overlay = document.getElementById('cinematic-overlay'); overlay?.classList.add('active'); setTimeout(() => { window.location.href = 'lore.html'; }, 2000); };

        window.dbUpdateSection = (id, field, val) => { if(saveTimer) clearTimeout(saveTimer); saveTimer = setTimeout(async () => { try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'librarySections', id), { [field]: val }); window.showToast("Archive Synchronized"); } catch(e) {} }, 800); };
        window.dbUpdateHeader = (field, val) => { if(saveTimer) clearTimeout(saveTimer); saveTimer = setTimeout(async () => { try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'manualConfig', 'libraryHeader'), { [field]: val }, { merge: true }); window.showToast("Signature Sync Complete"); } catch(e) {} }, 800); };

        window.addManualSection = async (type, docType = 'book') => {
            if(!userAuth) return;
            const data = { title: type === 'subheading' ? `NEW VOLUME` : (type === 'inner-subheading' ? "NEW CHAPTER" : type === 'divider' ? "" : "NEW SEGMENT"), content: type === 'divider' ? "" : "Inscribe teachings here...", type, docType, order: manualSections.length, createdAt: Date.now(), width: 100, fontSize: 14, ySpacing: 0, visibility: 'public', sharedWith: [] };
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'librarySections'), data);
            window.showToast("Archival Entry Added");
        };

        window.triggerDelete = (id) => { window.openDelModal("Expunge record?", async () => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'librarySections', id)); }); };

        window.parseAeonfallContent = function(text, isDM) {
            if (!text) return ''; if (isDM && activeEditId !== null) return text;
            return text.replace(/&&([^&]+)&&/g, (m, c) => { const parts = c.split('|'); return `<span class="term-hover def-term">${parts[0].trim()}<span class="tooltip-content">${parts[1] || 'No technical record.'}</span></span>`; })
                .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\*(?!\*)([^\*]+?)\*(?!\*)/g, '<i>$1</i>').replace(/-(?![ -])(.*?)-(?![ -])/g, '<u>$1</u>');
        };

        window.renderManual = () => {
            const isDM = activeRole === 'dm', effectiveUID = activeAnchorUID || 'guest';
            const navList = document.getElementById('nav-list'), container = document.getElementById('manual-sections-container');
            if(!container) return;

            // --- HEADING INHERITANCE LOGIC ---
            let currentHeadingVisibility = 'public';
            let currentHeadingSharedWith = [];
            let currentHeadingDocType = 'book';

            const processedSections = manualSections.map(s => {
                if (s.type === 'subheading') {
                    currentHeadingVisibility = s.visibility || 'public';
                    currentHeadingSharedWith = s.sharedWith || [];
                    currentHeadingDocType = s.docType || 'book';
                    return { ...s, effectiveVisibility: s.visibility, effectiveSharedWith: s.sharedWith, effectiveDocType: s.docType };
                }
                return { ...s, effectiveVisibility: currentHeadingVisibility, effectiveSharedWith: currentHeadingSharedWith, effectiveDocType: currentHeadingDocType };
            });

            const visibleSections = processedSections.filter(s => 
                isDM || s.effectiveVisibility === 'public' || (s.effectiveVisibility === 'personal' && s.effectiveSharedWith?.includes(effectiveUID))
            );

            const headerEl = document.getElementById('manual-header');
            if (headerEl) headerEl.innerHTML = `<h1 id="manual-main-title" class="manual-h1 dm-editable" contenteditable="${isDM}" onfocus="window.setEditing('manual-main-title')" onblur="window.clearEditing(); window.renderManual()" oninput="window.dbUpdateHeader('title', this.innerText)">${activeEditId === 'manual-main-title' ? manualHeader.title : window.parseAeonfallContent(manualHeader.title, false)}</h1><p id="manual-main-subtitle" class="font-serif italic text-sm mb-10 dm-editable" contenteditable="${isDM}" onfocus="window.setEditing('manual-main-subtitle')" onblur="window.clearEditing(); window.renderManual()" oninput="window.dbUpdateHeader('subtitle', this.innerText)">${activeEditId === 'manual-main-subtitle' ? manualHeader.subtitle : window.parseAeonfallContent(manualHeader.subtitle, false)}</p>`;
            
            if (navList) navList.innerHTML = visibleSections.filter(s => s.type === 'subheading').map(s => {
                const isWithin24Hours = (Date.now() - (s.createdAt || 0)) < 86400000;
                const label = (s.effectiveDocType || 'item').toUpperCase();
                return `<div class="shelf-item ${s.effectiveDocType || 'book'}" onclick="window.markAsSeen('${s.id}')">${isWithin24Hours && !seenDocs.includes(s.id) ? '<span class="new-badge">NEW</span>' : ''}${s.effectiveVisibility === 'personal' ? '<span class="personal-badge">Personal</span>' : ''}<span class="item-label">${label}: </span>${s.title}</div>`;
            }).join('');

            container.innerHTML = visibleSections.map(s => {
                const hId = `head-${s.id}`, cId = `content-${s.id}`, customStyle = `width: calc(${s.width ?? 100}% - 10px); font-size: ${s.fontSize ?? 14}px; margin-top: ${s.ySpacing ?? 0}px; flex-shrink: 0; box-sizing: border-box; padding: 5px;`;
                const isHeading = s.type === 'subheading';
                const sharedUser = allUsers.find(u => u.uid === s.effectiveSharedWith?.[0]);
                
                let html = `<section id="section-${s.id}" class="group relative transition-all doc-${s.effectiveDocType || 'book'} ${isDM ? 'border-l border-transparent hover:border-[#7a1d1d]' : ''}" draggable="${isDM}" ondragstart="window.handleDragStart(event, '${s.id}')" ondragover="window.handleDragOver(event)" ondragleave="window.handleDragLeave(event)" ondrop="window.handleDrop(event, '${s.id}')" style="${customStyle}">
                    ${isDM ? `<div class="tuner-panel">
                        <div class="drag-handle text-lg">‚†ø</div>
                        <div class="tuner-group"><span class="tuner-label">Width</span><input type="range" class="tuner-slider" min="10" max="100" value="${s.width ?? 100}" oninput="window.dbUpdateSection('${s.id}', 'width', parseInt(this.value))"></div>
                        
                        ${isHeading ? `
                        <div class="tuner-group">
                            <span class="tuner-label">Access</span>
                            <select class="tuner-select text-[8px] bg-slate-50 border border-slate-300 rounded" onchange="window.dbUpdateSection('${s.id}', 'visibility', this.value)">
                                <option value="public" ${s.visibility==='public'?'selected':''}>Public</option>
                                <option value="secret" ${s.visibility==='secret'?'selected':''}>Secret</option>
                                <option value="personal" ${s.visibility==='personal'?'selected':''}>Personal Tie</option>
                            </select>
                        </div>
                        <div class="tuner-group">
                            <span class="tuner-label">Sync Citizen</span>
                            <div class="flex gap-1">
                                <button class="link-user-btn !text-[7px] !px-3" onclick="window.openUserModal('${s.id}')">${sharedUser?.username || 'Bind'}</button>
                                ${sharedUser ? `<button class="unbind-user-btn" onclick="window.unbindUIDFromSection('${s.id}')">‚úï</button>` : ''}
                            </div>
                        </div>` : `<div class="tuner-group opacity-30"><span class="tuner-label">Inherited</span><div class="text-[7px] font-black uppercase">${s.effectiveVisibility}</div></div>`}
                        <button onclick="window.triggerDelete('${s.id}')" class="arch-btn !bg-transparent !text-[#7a1d1d] !border-none !p-1 ml-auto">‚úï</button>
                    </div>` : ''}
                    <div class="flex justify-between items-end gap-4 mb-2">
                        ${s.type === 'subheading' ? `<h2 id="${hId}" class="manual-h2 dm-editable flex-grow !m-0" contenteditable="${isDM}" onfocus="window.setEditing('${hId}')" onblur="window.clearEditing(); window.renderManual()" oninput="window.dbUpdateSection('${s.id}', 'title', this.innerText)">${activeEditId === hId ? s.title : window.parseAeonfallContent(s.title, false)}</h2>` : (s.type === 'inner-subheading' ? `<h3 id="${hId}" class="manual-h3 dm-editable flex-grow !m-0" contenteditable="${isDM}" onfocus="window.setEditing('${hId}')" onblur="window.clearEditing(); window.renderManual()" oninput="window.dbUpdateSection('${s.id}', 'title', this.innerText)">${activeEditId === hId ? s.title : window.parseAeonfallContent(s.title, false)}</h3>` : '')}
                        ${isDM ? `<span class="visibility-tag tag-${s.effectiveVisibility || 'public'}">${s.effectiveVisibility || 'public'}</span>` : ''}
                    </div>`;
                
                if(s.type === 'text') html += `<div id="${cId}" class="manual-p dm-editable leading-relaxed" contenteditable="${isDM}" onfocus="window.setEditing('${cId}')" onblur="window.clearEditing(); window.renderManual()" oninput="window.dbUpdateSection('${s.id}', 'content', this.innerHTML)">${activeEditId === cId ? s.content : window.parseAeonfallContent(s.content, false)}</div>`;
                else if(s.type === 'textbook') html += `<div class="manual-textbook-box bg-[#f0f9ff] p-8 border-t-8 border-[#5d4037] rounded shadow-lg relative my-6"><div class="absolute -top-3 left-6 bg-[#5d4037] text-[#f4edd8] px-3 py-1 text-[8px] font-black uppercase tracking-widest">Scholar's Teaching</div><div id="${cId}" class="manual-p dm-editable leading-relaxed text-[#2c1810]" contenteditable="${isDM}" onfocus="window.setEditing('${cId}')" onblur="window.clearEditing(); window.renderManual()" oninput="window.dbUpdateSection('${s.id}', 'content', this.innerHTML)">${activeEditId === cId ? s.content : window.parseAeonfallContent(s.content, false)}</div></div>`;
                else if(s.type === 'note') html += `<div class="manual-note-box bg-slate-50 p-5 border-l-4 border-amber-800 rounded shadow-inner"><div id="${cId}" class="manual-p dm-editable italic" contenteditable="${isDM}" onfocus="window.setEditing('${cId}')" onblur="window.clearEditing(); window.renderManual()" oninput="window.dbUpdateSection('${s.id}', 'content', this.innerHTML)">${activeEditId === cId ? s.content : window.parseAeonfallContent(s.content, false)}</div></div>`;
                else if(s.type === 'divider') html += `<div class="manual-divider"></div>`;
                
                html += `</section>`; return html;
            }).join('');
        };

        const initAuth = async () => { try { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } else { await signInAnonymously(auth); } } catch (e) { await signInAnonymously(auth); } };
        onAuthStateChanged(auth, async (u) => { 
            userAuth = u; 
            if (u) {
                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'manualConfig', 'libraryHeader'), d => { if (d.exists()) { manualHeader = d.data(); window.renderManual(); } });
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'librarySections'), snap => { manualSections = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (a.order ?? 0) - (b.order ?? 0)); window.renderManual(); });
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), snap => { 
                    allUsers = snap.docs.map(d => ({uid: d.id, ...d.data()})); 
                    window.updateIdentityUI();
                    window.filterTerminal('');
                    window.renderManual(); 
                });
                window.updateRoleUI();
            }
        });
        const confirmBtn = document.getElementById('confirm-del-btn'); if(confirmBtn) confirmBtn.onclick = async () => { if (deleteCallback) await deleteCallback(); const elModal = document.getElementById('del-modal'); if(elModal) elModal.classList.add('hidden'); };
        initAuth();
    </script>
</body>
</html>
