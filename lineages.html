<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aeonfall - Lineages & Heritage Archives</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Roboto+Slab:wght@300;400;700&family=Special+Elite&family=MedievalSharp&family=Homemade+Apple&family=Pirata+One&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Roboto Slab', serif; 
            background-color: #0c0c0c; 
            background-image: url('https://www.transparenttextures.com/patterns/dark-wood.png');
            color: #1a0f0a; 
            min-height: 100vh;
            padding: 15px;
            overflow-x: hidden;
        }

        /* THE MASTER PARCHMENT */
        .parchment-container {
            max-width: 1300px;
            margin: 20px auto;
            background: #f4edd8;
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            box-shadow: 0 50px 100px rgba(0,0,0,0.8), inset 0 0 100px rgba(0,0,0,0.1);
            border-radius: 4px;
            position: relative;
            padding: 60px 50px 100px 50px; 
            border: 1px solid #dcd1b2;
            clip-path: polygon(0% 0%, 100% 0%, 100% 2%, 99% 50%, 100% 98%, 98% 100%, 2% 99%, 0% 97%, 1% 50%, 0% 2%);
            perspective: 2000px;
        }

        /* HEADER & BRANDING */
        .brand-title { font-family: 'Cinzel', serif; font-weight: 900; color: #7a1d1d; font-size: 2rem; line-height: 1; }
        .brand-sub { font-family: 'Cinzel', serif; font-size: 8px; color: #5d4037; letter-spacing: 0.2em; text-transform: uppercase; font-weight: bold; }
        
        .role-pill { background: rgba(0,0,0,0.05); border-radius: 99px; padding: 3px; display: flex; gap: 4px; border: 1px solid rgba(0,0,0,0.1); position: relative; z-index: 100; }
        .role-tab { padding: 4px 14px; font-family: 'Cinzel', serif; font-size: 9px; font-weight: 900; border-radius: 99px; transition: 0.3s; color: #5d4037; text-transform: uppercase; cursor: pointer; }
        .role-tab.active { background: #7a1d1d; color: white; box-shadow: 0 4px 10px rgba(122, 29, 29, 0.3); }

        /* DASHBOARD GRID */
        .grid-container { 
            display: grid; 
            grid-template-cols: repeat(auto-fill, minmax(380px, 1fr)); 
            gap: 25px; 
            padding: 25px 0; 
        }

        .race-card {
            background: #fff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
            display: flex;
            flex-direction: column;
            height: 340px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .race-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.2); }
        
        .card-bg-image {
            position: absolute;
            top: 0;
            right: 0;
            width: 55%;
            height: 100%;
            z-index: 1;
        }
        .card-bg-image img, .card-bg-image video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: sepia(0.1) contrast(1.1);
        }

        .card-text-panel {
            position: relative;
            z-index: 2;
            width: 65%;
            height: 100%;
            background: linear-gradient(to right, white 85%, rgba(255,255,255,0));
            padding: 25px;
            display: flex;
            flex-direction: column;
        }

        .card-name { font-family: 'Cinzel', serif; font-size: 24px; font-weight: 900; color: #1a1a1a; margin-bottom: 2px; }
        .card-subtitle { font-family: 'Cinzel', serif; font-size: 10px; font-style: italic; color: #888; margin-bottom: 15px; }
        .card-desc { font-size: 13px; color: #444; line-height: 1.5; margin-bottom: 15px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .card-traits-label { font-family: 'Cinzel', serif; font-size: 11px; font-weight: 900; color: #1a1a1a; margin-bottom: 4px; }
        .card-traits-list { font-size: 12px; color: #555; line-height: 1.4; flex-grow: 1; }

        .view-btn {
            background: #f59e0b;
            color: white;
            font-family: 'Cinzel', serif;
            font-weight: 900;
            font-size: 11px;
            text-transform: uppercase;
            padding: 12px;
            border-radius: 4px;
            text-align: center;
            width: 100%;
            margin-top: auto;
            box-shadow: 0 4px 0 #d97706;
            transition: 0.1s;
            position: relative;
            z-index: 5;
        }
        .view-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #d97706; }
        
        .purge-btn-overlay {
            background: #7a1d1d;
            color: white;
            font-family: 'Cinzel', serif;
            font-weight: 900;
            font-size: 10px;
            text-transform: uppercase;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            width: 100%;
            margin-top: 8px;
            box-shadow: 0 4px 0 #4a0000;
            transition: 0.1s;
            position: relative;
            z-index: 6;
        }
        .purge-btn-overlay:active { transform: translateY(2px); box-shadow: 0 2px 0 #4a0000; }

        /* 3D FLIP CONTAINER - REWORKED FOR DYNAMIC HEIGHT */
        .flip-wrapper {
            position: relative;
            width: 100%;
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
            min-height: 600px;
        }
        .flip-wrapper.flipped { transform: rotateY(180deg); }
        
        .side-front, .side-back { 
            width: 100%; 
            backface-visibility: hidden; 
            -webkit-backface-visibility: hidden; 
        }

        .side-front { position: relative; z-index: 2; }
        .side-back { position: absolute; top: 0; left: 0; transform: rotateY(180deg); z-index: 1; }

        .flipped .side-front { position: absolute; top: 0; left: 0; z-index: 1; pointer-events: none; }
        .flipped .side-back { position: relative; z-index: 2; pointer-events: auto; }

        /* TOOLTIP STYLES */
        .term-hover { position: relative; border-bottom: 1px dotted #7a1d1d; cursor: help; display: inline; }
        .tooltip-content {
            visibility: hidden; width: 220px; background-color: #fdfaf3; color: #2c1810;
            text-align: left; border: 2px solid #7a1d1d; border-radius: 6px; padding: 10px;
            position: absolute; z-index: 1000; bottom: 125%; left: 50%; margin-left: -110px;
            opacity: 0; transition: opacity 0.3s; font-size: 11px; line-height: 1.4;
            font-family: 'Roboto Slab', serif; box-shadow: 0 5px 15px rgba(0,0,0,0.3); pointer-events: none; font-style: normal;
        }
        .term-hover:hover .tooltip-content { visibility: visible; opacity: 1; }
        .def-term { color: #7a1d1d; font-weight: 900; border-bottom: 1px dashed #7a1d1d; }

        /* LEDGERS & TABLES */
        .mech-box { background: rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.1); padding: 25px; margin-top: 25px; border-radius: 4px; }
        .mech-box h4 { font-family: 'Cinzel', serif; font-weight: 900; font-size: 14px; text-transform: uppercase; color: #7a1d1d; border-bottom: 2px solid #7a1d1d; margin-bottom: 15px; padding-bottom: 5px; }

        .prog-table { width: 100%; border-collapse: collapse; font-family: 'Special Elite', cursive; font-size: 13px; margin: 20px 0; overflow-x: auto; display: block; }
        .prog-table th { font-family: 'Cinzel', serif; text-transform: uppercase; font-size: 10px; color: #7a1d1d; border-bottom: 2px solid #7a1d1d; padding: 10px 5px; text-align: left; min-width: 80px; }
        .prog-table td { padding: 8px 5px; border-bottom: 1px solid rgba(0,0,0,0.05); }

        .culture-ledger { display: grid; grid-template-cols: 1.5fr 1fr; gap: 40px; margin-top: 30px; }
        @media (max-width: 768px) { .culture-ledger { grid-template-cols: 1fr; } }

        .ledger-list { list-style: none; padding: 0; }
        .ledger-list li { margin-bottom: 12px; border-bottom: 1px dashed rgba(0,0,0,0.1); padding-bottom: 4px; display: flex; flex-direction: column; }
        .ledger-list b { font-family: 'Cinzel', serif; font-size: 11px; text-transform: uppercase; color: #7a1d1d; letter-spacing: 1px; }
        .ledger-list span { font-family: 'Special Elite', cursive; font-size: 15px; color: #3e2723; }

        .record-header { display: grid; grid-template-cols: 1fr 1.2fr; gap: 60px; margin-bottom: 40px; align-items: start; }
        @media (max-width: 1024px) { .record-header { grid-template-cols: 1fr; gap: 30px; } }

        .record-illustration { position: relative; border: 2px solid #1a0f0a; background: rgba(0,0,0,0.02); padding: 10px; box-shadow: 5px 10px 20px rgba(0,0,0,0.1); cursor: zoom-in; }
        .record-illustration img, .record-illustration video { width: 100%; max-height: 550px; object-fit: contain; filter: sepia(0.2); mix-blend-mode: multiply; }
        
        .sigil-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40%; height: 40%; opacity: 0.04; background: url('https://www.transparenttextures.com/patterns/sacred-geometry.png') no-repeat center; background-size: contain; pointer-events: none; }

        .record-title { font-family: 'Pirata One', cursive; font-size: 4.5rem; color: #1a0f0a; line-height: 0.9; margin-bottom: 5px; text-transform: uppercase; }
        @media (max-width: 640px) { .record-title { font-size: 3rem; } }

        .record-label { font-family: 'Cinzel', serif; font-size: 10px; font-weight: 900; color: #7a1d1d; text-transform: uppercase; letter-spacing: 3px; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 10px; display: inline-block; margin-bottom: 30px; }

        .research-findings { font-family: 'Special Elite', cursive; font-size: 16px; line-height: 1.8; color: #1a0f0a; padding: 30px; border: 1px dashed rgba(0,0,0,0.2); background: rgba(0,0,0,0.02); margin: 40px 0; }
        .heritage-block { margin-bottom: 40px; padding-left: 20px; border-left: 3px solid #7a1d1d; }
        .heritage-block h3 { font-family: 'Cinzel', serif; font-size: 20px; font-weight: 900; color: #7a1d1d; margin-bottom: 12px; }

        .dm-active-edit .dm-editable { background: rgba(122, 29, 29, 0.05); outline: 1px dashed #7a1d1d; border-radius: 4px; padding: 4px; }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #1a0f0a; color: #f4edd8; padding: 12px 32px; border-radius: 4px; z-index: 10000; opacity: 0; transition: 0.3s; font-family: 'Cinzel'; font-size: 12px; }
        
        .hidden { display: none !important; }
        .back-nav { display: inline-flex; align-items: center; gap: 10px; color: #7a1d1d; font-weight: 900; font-size: 10px; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 30px; cursor: pointer; border-bottom: 1px solid transparent; position: relative; z-index: 100; }
        .back-nav:hover { border-bottom-color: #7a1d1d; }

        /* DECORATIONS */
        .ornate-corner { position: absolute; width: 35px; height: 35px; opacity: 0.12; color: #7a1d1d; pointer-events: none; }
        .tl { top: 10px; left: 10px; }
        .br { bottom: 10px; right: 10px; transform: rotate(180deg); }

        .drop-cap { float: left; font-family: 'Pirata One', cursive; font-size: 80px; line-height: 60px; padding-top: 4px; padding-right: 8px; color: #7a1d1d; }
        .arch-btn { font-size: 9px; font-weight: 900; text-transform: uppercase; padding: 4px 10px; border-radius: 2px; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); transition: 0.2s; }
        .arch-btn-add { background: #7a1d1d; color: white; border-color: #7a1d1d; }
        .arch-btn-del { background: rgba(122,29,29,0.1); color: #7a1d1d; }

        .placement-active { cursor: crosshair !important; }

        /* LIGHTBOX STYLING */
        .lightbox-overlay { background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); }
        .lightbox-img { max-width: 90vw; max-height: 80vh; object-fit: contain; border: 4px solid #f4edd8; border-radius: 4px; box-shadow: 0 0 50px rgba(0,0,0,1); }
    </style>
</head>
<body>

    <div id="toast" class="toast">DM Message</div>

    <div class="parchment-container" id="parchment">
        <!-- Decoration -->
        <div class="ornate-corner tl"><svg viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="2"><path d="M10,10 Q30,10 30,40 T60,60 T90,90 M10,10 Q10,30 40,30 T60,60"/></svg></div>
        <div class="ornate-corner br"><svg viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="2"><path d="M10,10 Q30,10 30,40 T60,60 T90,90 M10,10 Q10,30 40,30 T60,60"/></svg></div>

        <!-- HEADER -->
        <header class="flex flex-col md:flex-row justify-between items-center gap-6 relative z-[200] mb-6 pb-6 border-b border-black/10">
            <div class="flex flex-col items-center md:items-start text-center md:text-left">
                <h1 class="brand-title">Aeonfall</h1>
                <p class="brand-sub">Archival Heritage Biometry</p>
            </div>

            <div class="flex items-center gap-8">
                <div class="role-pill">
                    <div id="role-player" onclick="window.setRole('player')" class="role-tab active">Player</div>
                    <div id="role-dm" onclick="window.setRole('dm')" class="role-tab">DM</div>
                </div>
                <a href="playershandbook.html" class="text-[10px] font-black uppercase tracking-widest text-[#7a1d1d] hover:text-black transition-colors relative z-[201]">‚Üê Back to Hub</a>
            </div>
        </header>

        <!-- DASHBOARD VIEW -->
        <div id="view-grid">
            <div class="flex flex-col md:flex-row justify-between items-center md:items-end mb-4 gap-4">
                <div>
                    <h2 class="font-serif text-xl font-black uppercase text-[#1a0f0a]">Biological Stacks</h2>
                    <p class="text-[8px] text-[#5d4037] tracking-[0.3em] uppercase font-bold">Authorized Bio-Data Record</p>
                </div>
                <div class="flex gap-2">
                    <button id="add-record-btn" onclick="window.addRecord()" class="hidden bg-[#7a1d1d] hover:bg-[#1a0f0a] text-[#f4edd8] px-3 py-1.5 rounded-sm font-black text-[7px] uppercase shadow-lg transition-all active:scale-95">+ Add Bio-Record</button>
                    <button id="remove-record-btn" onclick="window.togglePurgeMode()" class="hidden bg-gray-200 border border-black/10 text-gray-600 hover:text-red-700 hover:bg-red-50 px-3 py-1.5 rounded-sm font-black text-[7px] uppercase shadow-lg transition-all active:scale-95">Remove Bio-Record</button>
                </div>
            </div>
            
            <div id="stack-grid" class="grid-container">
                <!-- Record Cards -->
            </div>
        </div>

        <!-- DETAIL VIEW -->
        <div id="view-details" class="hidden">
            <div class="flex justify-between items-start mb-4">
                <div onclick="window.setView('grid')" class="back-nav">‚Üê Return to Bio-Stacks</div>
                <div class="flex gap-2">
                    <button onclick="window.flipPage()" id="btn-flip" class="bg-[#1a0f0a] text-[#f4edd8] px-4 py-2 rounded-sm font-black text-[9px] uppercase hover:bg-black transition-colors shadow-sm">üìú Flip Page</button>
                </div>
            </div>

            <div id="flip-container" class="flip-wrapper">
                <div class="side-front" id="details-front"></div>
                <div class="side-back" id="details-back"></div>
            </div>

            <div id="dm-bottom-controls" class="hidden flex gap-4 mt-12 pt-8 border-t border-black/10">
                <button onclick="window.addSection()" class="bg-[#1a0f0a] text-[#f4edd8] px-6 py-2 rounded-sm font-black uppercase text-[10px] tracking-widest hover:bg-black transition-colors">Append Research Chapter</button>
                <button onclick="window.triggerDel()" class="bg-red-700/10 border border-red-700/30 text-red-700 px-6 py-2 rounded-sm font-black uppercase text-[10px] tracking-widest hover:bg-red-700/20 transition-all">Expunge Bio-Record</button>
            </div>
        </div>
    </div>

    <!-- LIGHTBOX MODAL -->
    <div id="lightbox-modal" class="fixed inset-0 z-[10000] flex flex-col items-center justify-center p-4 hidden">
        <div class="absolute inset-0 lightbox-overlay" onclick="window.closeLightbox()"></div>
        <div id="lightbox-content" class="relative z-10"></div>
        <button onclick="window.closeLightbox()" class="relative z-10 mt-8 bg-[#7a1d1d] text-white px-8 py-3 rounded-full font-black text-[11px] uppercase tracking-widest shadow-2xl border-2 border-white/20 active:scale-95 transition-transform">Close Optical Feed</button>
    </div>

    <!-- Modals -->
    <div id="pass-modal" class="fixed inset-0 bg-black/95 flex items-center justify-center z-[5000] hidden p-4">
        <div class="bg-gray-800 p-10 rounded-2xl w-full max-sm border-2 border-amber-600 text-white text-center shadow-2xl relative">
            <h3 class="text-xl font-serif text-amber-500 font-bold mb-4 uppercase">DM Access</h3>
            <input type="password" id="dm-pass" class="w-full bg-gray-900 text-center text-2xl rounded-lg p-3 mb-8 border border-gray-700 text-amber-500 focus:outline-none focus:border-amber-500">
            <div class="flex flex-col gap-4">
                <button onclick="window.authDm()" class="w-full bg-amber-600 hover:bg-amber-500 text-white py-4 rounded-xl font-bold uppercase text-xs tracking-widest">Authorize Access</button>
                <button onclick="document.getElementById('pass-modal').classList.add('hidden')" class="text-[10px] text-gray-500 uppercase font-black tracking-widest">Cancel</button>
            </div>
        </div>
    </div>

    <div id="del-modal" class="fixed inset-0 z-[6000] flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/90" onclick="document.getElementById('del-modal').classList.add('hidden')"></div>
        <div class="bg-white p-10 rounded-2xl w-full max-w-sm text-center relative z-10 shadow-2xl text-black">
            <h3 class="text-2xl font-serif font-black text-red-700 uppercase mb-4">Purge Bio-Record</h3>
            <p class="text-sm text-gray-500 mb-10 italic">This biological entry will be permanently expunged.</p>
            <div class="flex flex-col gap-4">
                <button id="confirm-del-btn" class="w-full bg-red-700 text-white py-4 rounded-xl font-black text-xs uppercase shadow-lg">Confirm Purge</button>
                <button onclick="document.getElementById('del-modal').classList.add('hidden')" class="w-full bg-gray-100 text-gray-400 py-3 rounded-xl font-bold uppercase text-[10px]">Decline</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, updateDoc, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // APP CONFIG & INITIALIZATION
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBLN0KhcnZFKZEYyR0O-Q2mZhKr-iyh7BI",
            authDomain: "aeonfall-523c1.firebaseapp.com",
            projectId: "aeonfall-523c1",
            storageBucket: "aeonfall-523c1.firebasestorage.app",
            messagingSenderId: "716207733913",
            appId: "1:716207733913:web:7aac43906a70e2b5f50c08"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'aeonfall-manager-v2';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const TOOLTIPS = {
            "Activation Time": "The amount of time required to initialize this script and push it to reality.",
            "Mechanum": "Technomagic Protocol: This script utilizes specialized hardware and digital distortion to warp reality through code.",
            "Concord": "Ritual Protocol: This script can be initialized through ritualistic focus, conserving internal energy reserves.",
            "Dominion": "Governs will and influence, shaping thoughts, emotions, and behavior through directed intent.",
            "Ruin": "Governs raw energy and destruction, unleashing force to damage or overwhelm.",
            "Aegis": "Governs protection, prevention, and resistance, creating wards that block or negate harm."
        };

        let lineages = [];
        let activeRole = 'player', currentView = 'grid', saveTimer = null, targetDelId = null;
        let isFlipped = false, currentUser = null, isPurgeMode = false;
        window.activeRaceId = null; 

        window.showToast = (m) => { const t = document.getElementById('toast'); t.textContent=m; t.style.opacity=1; setTimeout(()=>t.style.opacity=0, 3000); };
        window.setRole = (r) => { if(r === 'dm') document.getElementById('pass-modal').classList.remove('hidden'); else { activeRole = 'player'; isPurgeMode = false; updateRoleUI(); } };
        window.authDm = () => { if(document.getElementById('dm-pass').value === 'Rew4994'){ activeRole='dm'; document.getElementById('pass-modal').classList.add('hidden'); document.getElementById('dm-pass').value = ''; updateRoleUI(); } else { window.showToast("Failed Verification"); } };

        function updateRoleUI() {
            const isDM = activeRole === 'dm';
            document.getElementById('role-player').classList.toggle('active', !isDM);
            document.getElementById('role-dm').classList.toggle('active', isDM);
            document.getElementById('add-record-btn').classList.toggle('hidden', !isDM);
            document.getElementById('remove-record-btn').classList.toggle('hidden', !isDM);
            const bCtrl = document.getElementById('dm-bottom-controls');
            if (bCtrl) bCtrl.classList.toggle('hidden', !isDM);
            if(currentView === 'grid') renderGrid(); else renderDetails();
        }

        window.togglePurgeMode = () => {
            isPurgeMode = !isPurgeMode;
            document.getElementById('remove-record-btn').classList.toggle('bg-red-700', isPurgeMode);
            document.getElementById('remove-record-btn').classList.toggle('text-white', isPurgeMode);
            window.showToast(isPurgeMode ? "Purge Mode Enabled" : "Purge Mode Disabled");
            renderGrid();
        };

        function parseAeonfallContent(text, isDM) {
            if (!text) return '';
            if (isDM) return text; 
            let html = text.replace(/&&([^&]+)&&/g, (match, content) => {
                const parts = content.split('|');
                const term = parts[0].trim();
                const definition = parts.length > 1 ? parts[1].trim() : (TOOLTIPS[term] || "No technical record found.");
                return `<span class="term-hover def-term">${term}<span class="tooltip-content">${definition}</span></span>`;
            });
            html = html.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            html = html.replace(/\*(.*?)\*/g, '<i>$1</i>');
            html = html.replace(/__(.*?)__/g, '<u>$1</u>');
            return html;
        }

        const safeJSONParse = (data, fallback = []) => {
            try {
                if (!data) return fallback;
                if (typeof data === 'object') return data;
                return JSON.parse(data);
            } catch (e) {
                console.warn("JSON Parse Error", e);
                return fallback;
            }
        };

        window.zoomMedia = (url) => {
            if (!url) return;
            const modal = document.getElementById('lightbox-modal');
            const content = document.getElementById('lightbox-content');
            content.innerHTML = url.includes('.mp4') ? 
                `<video src="${url}" autoplay loop muted class="lightbox-img"></video>` : 
                `<img src="${url}" class="lightbox-img">`;
            modal.classList.remove('hidden');
        };

        window.closeLightbox = () => {
            document.getElementById('lightbox-modal').classList.add('hidden');
            document.getElementById('lightbox-content').innerHTML = '';
        };

        window.flipPage = () => {
            isFlipped = !isFlipped;
            document.getElementById('flip-container').classList.toggle('flipped', isFlipped);
            document.getElementById('btn-flip').innerText = isFlipped ? "üìú Flip to Biology" : "üìú Flip to Culture";
        };

        window.setView = (v, id = null) => {
            currentView = v; window.activeRaceId = id;
            document.getElementById('view-grid').classList.toggle('hidden', v !== 'grid');
            document.getElementById('view-details').classList.toggle('hidden', v !== 'details');
            isFlipped = false;
            document.getElementById('flip-container').classList.remove('flipped');
            if(v === 'grid') renderGrid(); else renderDetails();
        };

        window.renderGrid = () => {
            const isDM = activeRole === 'dm';
            const grid = document.getElementById('stack-grid');
            grid.innerHTML = lineages.map(race => `
                <div class="race-card" onclick="!isPurgeMode && window.setView('details', '${race.id}')">
                    <div class="card-bg-image">
                        ${race.gridUrl ? 
                            (race.gridUrl.includes('.mp4') ? `<video src="${race.gridUrl}" autoplay loop muted></video>` : `<img src="${race.gridUrl}">`) 
                            : '<div class="w-full h-full bg-[#e0d5ba] flex items-center justify-center text-[10px] text-gray-500 italic">SCANNING...</div>'}
                    </div>
                    <div class="card-text-panel">
                        <h3 class="card-name">${race.name}</h3>
                        <p class="card-subtitle">Archival Biometry</p>
                        <p class="card-desc">${isDM ? (race.desc || 'No description.') : parseAeonfallContent(race.desc, false)}</p>
                        <div class="card-traits-label">${race.name} Traits</div>
                        <div class="card-traits-list">${isDM ? (race.traits || 'None.') : parseAeonfallContent(race.traits, false)}</div>
                        ${isPurgeMode ? `
                            <button onclick="event.stopPropagation(); window.triggerDel('${race.id}')" class="purge-btn-overlay">Purge Record</button>
                        ` : `
                            <button class="view-btn">Consult Bio-Record</button>
                        `}
                    </div>
                </div>
            `).join('');
            if(lineages.length === 0) grid.innerHTML = `<p class="col-span-full text-center py-20 text-[#5d4037] italic uppercase text-[10px] font-black tracking-widest">Awaiting bio-frequency uplink...</p>`;
        };

        window.renderDetails = () => {
            if (!currentUser) return;
            const isDM = activeRole === 'dm';
            const race = lineages.find(r => r.id === window.activeRaceId);
            if (!race) return;

            // SIDE A: FRONT
            document.getElementById('details-front').innerHTML = `
                <div class="${isDM ? 'dm-active-edit' : ''}">
                    <div class="record-header">
                        <div class="flex flex-col">
                            <h2 class="record-title dm-editable" contenteditable="${isDM}" oninput="window.dbUp('${race.id}', 'name', this.innerText)">${race.name}</h2>
                            <p class="record-label">Genetic Signature Verified ‚Ä¢ Custodian #<span class="dm-editable" contenteditable="${isDM}" oninput="window.dbUp('${race.id}', 'custodianId', this.innerText)">${race.custodianId || '994'}</span></p>
                            <div class="bg-black/5 border-l-4 border-[#7a1d1d] p-6 rounded-sm">
                                <h4 class="font-black uppercase text-[11px] tracking-[0.2em] text-[#7a1d1d] mb-4">Innate Parameters</h4>
                                <div class="dm-editable text-sm italic leading-relaxed text-[#3e2723]" contenteditable="${isDM}" oninput="window.dbUp('${race.id}','traits',this.innerText)">${isDM ? (race.traits || 'Ancestral trait markers...') : parseAeonfallContent(race.traits, false)}</div>
                            </div>
                        </div>
                        <div class="record-illustration" onclick="window.zoomMedia('${race.detailUrl}')">
                            <div class="sigil-overlay"></div>
                            ${race.detailUrl ? (race.detailUrl.includes('.mp4') ? `<video src="${race.detailUrl}" autoplay loop muted></video>` : `<img src="${race.detailUrl}">`) : '<div class="h-96 flex items-center justify-center italic text-[#5d4037]">Visual uplink lost</div>'}
                        </div>
                    </div>
                    ${isDM ? `<div class="bg-black/5 p-4 rounded mb-8 grid grid-cols-2 gap-4"><div><label class="text-[9px] font-black text-amber-900">Grid Visual</label><input type="text" class="w-full p-2 text-[10px]" value="${race.gridUrl||''}" oninput="window.dbUp('${race.id}', 'gridUrl', this.value)"></div><div><label class="text-[9px] font-black text-amber-900">Detail Visual</label><input type="text" class="w-full p-2 text-[10px]" value="${race.detailUrl||''}" oninput="window.dbUp('${race.id}', 'detailUrl', this.value)"></div></div>` : ''}
                    <div class="research-findings dm-editable" contenteditable="${isDM}" oninput="window.dbUp('${race.id}', 'desc', this.innerText)">
                        <span class="drop-cap">${(race.desc||"O").charAt(0)}</span>${isDM ? ((race.desc||"nce, in a world not yet broken...").slice(1)) : parseAeonfallContent((race.desc||"nce, in a world not yet broken...").slice(1), false)}
                    </div>
                    <div id="additional-logs">${(race.intros || []).map((intro, idx) => `<div class="heritage-block relative"><h3 class="dm-editable" contenteditable="${isDM}" oninput="window.dbUpIntro('${race.id}', ${idx}, 'leftTitle', this.innerText)">${intro.leftTitle || 'Research Chapter'}</h3><div class="dm-editable text-[#3e2723] font-serif leading-loose" contenteditable="${isDM}" oninput="window.dbUpIntro('${race.id}', ${idx}, 'leftText', this.innerText)">${isDM ? (intro.leftText || 'Handwritten details...') : parseAeonfallContent(intro.leftText, false)}</div>${isDM ? `<button onclick="window.removeSection('${race.id}', ${idx})" class="absolute top-0 right-0 text-[#7a1d1d] opacity-30 hover:opacity-100 text-[9px] uppercase font-black">Expunge Section</button>` : ''}</div>`).join('')}</div>
                </div>
            `;

            // SIDE B: BACK
            const tables = safeJSONParse(race.mechTables);
            document.getElementById('details-back').innerHTML = `
                <div class="${isDM ? 'dm-active-edit' : ''}">
                    <h2 class="record-title mb-6">Cultural Heritage</h2>
                    <div class="culture-ledger">
                        <ul class="ledger-list">
                            ${['cultureName', 'majorityPop', 'coreValues', 'government', 'belief', 'culturalPractices', 'attitudes'].map(f => {
                                const label = f === 'cultureName' ? "Lineage's Name" : f.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                                return `
                                <li><b>${label}:</b> 
                                <span class="dm-editable" contenteditable="${isDM}" oninput="window.dbUp('${race.id}','${f}',this.innerText)">${isDM ? (race[f] || '...') : parseAeonfallContent(race[f], false)}</span></li>
                                `;
                            }).join('')}
                        </ul>
                        <div class="flex flex-col gap-4">
                            <div class="record-illustration" style="height: 250px;" onclick="window.zoomMedia('${race.backMediaUrl}')">
                                ${race.backMediaUrl ? (race.backMediaUrl.includes('.mp4') ? `<video src="${race.backMediaUrl}" autoplay loop muted class="w-full h-full object-cover"></video>` : `<img src="${race.backMediaUrl}" class="w-full h-full object-cover">`) : '<div class="h-full flex items-center justify-center italic opacity-30">Cultural Visual missing</div>'}
                            </div>
                            ${isDM ? `<input type="text" class="w-full p-2 text-[10px] bg-white/50 border border-black/10" value="${race.backMediaUrl||''}" placeholder="Culture Media Link" oninput="window.dbUp('${race.id}', 'backMediaUrl', this.value)">` : ''}
                        </div>
                    </div>

                    <div class="mech-box mt-10">
                        <div class="flex justify-between items-center border-b-2 border-[#7a1d1d] mb-6 pb-2">
                            <h4 class="m-0 border-0">Mechanical Options & Traits</h4>
                            ${isDM ? `<button onclick="window.addMechTable()" class="arch-btn arch-btn-add">+ Add Table</button>` : ''}
                        </div>
                        <div class="grid grid-cols-1 gap-8">
                            <div>
                                <b class="text-[10px] uppercase text-[#7a1d1d] block mb-2 tracking-widest">Mechanical Traits</b>
                                <div class="dm-editable min-h-[60px] p-4 bg-black/5 rounded italic text-sm" contenteditable="${isDM}" oninput="window.dbUp('${race.id}','mechTraits',this.innerText)">${isDM ? (race.mechTraits || 'Trait data pending...') : parseAeonfallContent(race.mechTraits, false)}</div>
                            </div>
                            <div>
                                <b class="text-[10px] uppercase text-[#7a1d1d] block mb-2 tracking-widest">Rules Description Box</b>
                                <div class="dm-editable min-h-[100px] p-4 bg-black/5 rounded italic text-sm leading-relaxed" contenteditable="${isDM}" oninput="window.dbUp('${race.id}','mechDescription',this.innerText)">${isDM ? (race.mechDescription || 'Mechanical overview...') : parseAeonfallContent(race.mechDescription, false)}</div>
                            </div>
                            <div class="space-y-4">
                                ${['mechBackgrounds', 'mechLanguages', 'mechFeats', 'mechEquipment'].map(f => `
                                    <p><b>‚Ä¢ ${f.replace('mech', '').replace(/([A-Z])/g, ' $1').trim()}:</b> <span class="dm-editable italic text-sm" contenteditable="${isDM}" oninput="window.dbUp('${race.id}','${f}',this.innerText)">${isDM ? (race[f] || '...') : parseAeonfallContent(race[f], false)}</span></p>
                                `).join('')}
                            </div>
                        </div>

                        <div id="mech-tables-root">
                            ${tables.map((table, tIdx) => `
                                <div class="mt-8 relative group">
                                    <div class="flex justify-between items-center mb-2">
                                        <b class="text-[10px] uppercase text-[#7a1d1d] dm-editable" contenteditable="${isDM}" oninput="window.updateMechTableField(${tIdx}, 'title', this.innerText)">${table.title}</b>
                                        ${isDM ? `
                                            <div class="flex gap-1 opacity-20 group-hover:opacity-100 transition-opacity">
                                                <button onclick="window.addTableRow(${tIdx})" class="arch-btn arch-btn-add">+ Row</button>
                                                <button onclick="window.remTableRow(${tIdx})" class="arch-btn arch-btn-del">- Row</button>
                                                <button onclick="window.addTableCol(${tIdx})" class="arch-btn arch-btn-add">+ Col</button>
                                                <button onclick="window.remTableCol(${tIdx})" class="arch-btn arch-btn-del">- Col</button>
                                                <button onclick="window.delMechTable(${tIdx})" class="arch-btn arch-btn-del">Delete</button>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="overflow-x-auto w-full">
                                        <table class="prog-table w-full">
                                            <thead><tr>${table.headers.map((h, hIdx) => `<th contenteditable="${isDM}" oninput="window.updateMechTableField(${tIdx}, 'headers', this.innerText, ${hIdx})">${h}</th>`).join('')}</tr></thead>
                                            <tbody>${table.rows.map((row, rIdx) => `<tr>${row.map((cell, cIdx) => `<td contenteditable="${isDM}" oninput="window.updateMechTableField(${tIdx}, 'rows', this.innerText, rIdx, cIdx)">${isDM ? cell : parseAeonfallContent(cell, false)}</td>`).join('')}</tr>`).join('')}</tbody>
                                        </table>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        };

        window.dbUp = (id, field, val) => {
            if (!currentUser) return;
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(() => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', id), { [field]: val }), 1000);
        };

        window.dbUpIntro = (id, idx, field, val) => {
            if (!currentUser) return;
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(() => {
                const r = lineages.find(x => x.id === id);
                if (r && r.intros) { r.intros[idx][field] = val; updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', id), { intros: r.intros }); }
            }, 1000);
        };

        window.addMechTable = async () => {
            if (!currentUser) return;
            const r = lineages.find(x => x.id === window.activeRaceId);
            const tables = safeJSONParse(r.mechTables);
            tables.push({ title: "NEW TABLE", headers: ["Header 1", "Header 2"], rows: [["...", "..."]] });
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', window.activeRaceId), { mechTables: JSON.stringify(tables) });
        };

        window.updateMechTableField = (tIdx, field, val, rowOrCol = null, colIdx = null) => {
            if (!currentUser) return;
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(async () => {
                const r = lineages.find(x => x.id === window.activeRaceId);
                const tables = safeJSONParse(r.mechTables);
                if (tables[tIdx]) {
                    if (field === 'title') tables[tIdx].title = val;
                    else if (field === 'headers') tables[tIdx].headers[rowOrCol] = val;
                    else if (field === 'rows') tables[tIdx].rows[rowOrCol][colIdx] = val;
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', window.activeRaceId), { mechTables: JSON.stringify(tables) });
                }
            }, 1000);
        };

        window.addTableRow = async (tIdx) => {
            if (!currentUser) return;
            const r = lineages.find(x => x.id === window.activeRaceId);
            const tables = safeJSONParse(r.mechTables);
            if (tables[tIdx]) {
                tables[tIdx].rows.push(new Array(tables[tIdx].headers.length).fill("..."));
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', window.activeRaceId), { mechTables: JSON.stringify(tables) });
            }
        };

        window.remTableRow = async (tIdx) => {
            if (!currentUser) return;
            const r = lineages.find(x => x.id === window.activeRaceId);
            const tables = safeJSONParse(r.mechTables);
            if (tables[tIdx] && tables[tIdx].rows.length > 1) {
                tables[tIdx].rows.pop();
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', window.activeRaceId), { mechTables: JSON.stringify(tables) });
            }
        };

        window.addTableCol = async (tIdx) => {
            if (!currentUser) return;
            const r = lineages.find(x => x.id === window.activeRaceId);
            const tables = safeJSONParse(r.mechTables);
            if (tables[tIdx]) {
                tables[tIdx].headers.push("Header");
                tables[tIdx].rows = tables[tIdx].rows.map(row => [...row, "..."]);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', window.activeRaceId), { mechTables: JSON.stringify(tables) });
            }
        };

        window.remTableCol = async (tIdx) => {
            if (!currentUser) return;
            const r = lineages.find(x => x.id === window.activeRaceId);
            const tables = safeJSONParse(r.mechTables);
            if (tables[tIdx] && tables[tIdx].headers.length > 1) {
                tables[tIdx].headers.pop();
                tables[tIdx].rows = tables[tIdx].rows.map(row => row.slice(0, -1));
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', window.activeRaceId), { mechTables: JSON.stringify(tables) });
            }
        };

        window.delMechTable = async (tIdx) => {
            if (!currentUser) return;
            const r = lineages.find(x => x.id === window.activeRaceId);
            const tables = safeJSONParse(r.mechTables);
            tables.splice(tIdx, 1);
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', window.activeRaceId), { mechTables: JSON.stringify(tables) });
        };

        window.addRecord = async () => {
            if (!currentUser) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'handbookLineages'), { 
                name: "NEW SUBJECT", gridUrl: "", detailUrl: "", backMediaUrl: "", custodianId: "994", speed: "30", size: "M", languages: "Com", 
                desc: "Discovery log pending field observation...", traits: "Standard ancestral signatures...", intros: [],
                cultureName: "", majorityPop: "", coreValues: "", government: "", belief: "", culturalPractices: "", attitudes: "",
                mechTraits: "", mechDescription: "", mechBackgrounds: "", mechLanguages: "", mechFeats: "", mechEquipment: "", mechTables: "[]",
                createdAt: Date.now(), order: Date.now() 
            });
            window.showToast("Bio-Record Initialized");
        };

        window.addSection = async () => {
            if (!currentUser) return;
            const r = lineages.find(x => x.id === window.activeRaceId);
            if (!r) return;
            const intros = r.intros || [];
            intros.push({ leftTitle: "Research Findings", leftText: "Technical observations..." });
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', r.id), { intros: intros });
            window.showToast("Chapter Appended");
        };

        window.removeSection = async (id, idx) => {
            if (!currentUser) return;
            const r = lineages.find(x => x.id === id);
            r.intros.splice(idx, 1);
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', id), { intros: r.intros });
            window.showToast("Section Expunged");
        };

        window.triggerDel = (id = null) => { 
            targetDelId = id || window.activeRaceId; 
            document.getElementById('del-modal').classList.remove('hidden'); 
        };
        document.getElementById('confirm-del-btn').onclick = async () => {
            if (!targetDelId || !currentUser) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', targetDelId));
            document.getElementById('del-modal').classList.add('hidden'); 
            window.setView('grid');
            window.showToast("Record Purged");
        };

        // FIREBASE AUTH & SYNC
        const init = async () => {
            const initAuth = async () => {
                // RULE 3 - Auth Before Queries
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (e) {
                    await signInAnonymously(auth);
                }
            };
            
            await initAuth();

            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    // RULE 1 - Use strict collection paths
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'handbookLineages'), (snap) => {
                        lineages = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (a.order ?? a.createdAt) - (b.order ?? b.createdAt));
                        if(currentView === 'grid') renderGrid(); else renderDetails();
                    }, (err) => {
                        console.error("Snapshot synchronization error:", err);
                    });
                }
                updateRoleUI();
            });
        };
        init();
    </script>
</body>
</html>
