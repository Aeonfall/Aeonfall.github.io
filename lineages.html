<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aeonfall - Handmade Journal of Lineages</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Roboto+Slab:wght@300;400;700&family=Special+Elite&family=MedievalSharp&family=Homemade+Apple&family=Pirata+One&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Roboto Slab', serif; 
            background-color: #dcc89f; 
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            color: #2c1810; 
            min-height: 100vh;
            padding: 15px;
            overflow-x: hidden;
        }

        /* THE LEATHER-BOUND JOURNAL CONTAINER */
        .journal-cover {
            max-width: 1350px;
            margin: 20px auto;
            background: #8d6e63; 
            background-image: url('https://www.transparenttextures.com/patterns/dark-leather.png');
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 40px 80px rgba(62, 39, 35, 0.4);
            position: relative;
            border: 1px solid #5d4037;
        }

        .journal-cover::after {
            content: '';
            position: absolute;
            inset: 8px;
            border: 1.5px dashed rgba(255,255,255,0.12);
            pointer-events: none;
            border-radius: 6px;
        }

        .parchment-container {
            background: #f4edd8; 
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            min-height: 800px;
            padding: 70px 60px 100px 90px; 
            position: relative;
            box-shadow: inset 0 0 100px rgba(141, 110, 99, 0.1);
            border-left: 18px solid #5d4037; 
            clip-path: polygon(0.3% 0.3%, 99.7% 0%, 100% 2%, 99.4% 50%, 100% 98%, 98.7% 100%, 1.3% 99.4%, 0% 97%, 0.6% 50%, 0% 2%);
        }

        /* HEADER & BRANDING */
        .brand-title { font-family: 'Pirata One', cursive; font-weight: 400; color: #3e2723; font-size: 3.2rem; line-height: 1; margin-bottom: 5px; }
        .brand-sub { font-family: 'Cinzel', serif; font-size: 9px; color: #8d6e63; letter-spacing: 0.5em; text-transform: uppercase; font-weight: bold; }
        
        .role-pill { background: rgba(93, 64, 55, 0.08); border-radius: 99px; padding: 3px; display: flex; border: 1px solid #d7ccc8; }
        .role-tab { padding: 4px 18px; font-family: 'Cinzel', serif; font-size: 10px; font-weight: 900; border-radius: 99px; transition: 0.3s; color: #5d4037; text-transform: uppercase; cursor: pointer; }
        .role-tab.active { background: #5d4037; color: #fdfaf3; box-shadow: 0 4px 10px rgba(0,0,0,0.15); }

        .grid-container { display: grid; grid-template-cols: repeat(auto-fill, minmax(400px, 1fr)); gap: 35px; padding: 25px 0; }

        .race-card {
            background: #fdfaf3;
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            box-shadow: 4px 6px 15px rgba(0,0,0,0.08);
            position: relative;
            display: flex;
            flex-direction: column;
            height: 410px;
            overflow: hidden;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s ease;
            cursor: pointer;
            border: 1px solid #e0d7c6;
        }
        .race-card:hover { transform: rotate(0.5deg) translateY(-8px); box-shadow: 12px 20px 40px rgba(93, 64, 55, 0.15); }
        
        .card-bg-image { position: absolute; top: 0; right: 0; width: 50%; height: 100%; z-index: 1; filter: sepia(0.3) contrast(1.1); }
        .card-bg-image::after { content: ''; position: absolute; inset: 0; background: linear-gradient(to right, #fdfaf3 10%, transparent 80%); z-index: 2; }
        .card-bg-image img, .card-bg-image video { width: 100%; height: 100%; object-fit: cover; }

        .card-text-panel { position: relative; z-index: 3; width: 68%; height: 100%; padding: 35px; display: flex; flex-direction: column; background: linear-gradient(to right, #fdfaf3 90%, transparent); }

        .card-name { font-family: 'MedievalSharp', cursive; font-size: 28px; color: #2c1810; margin-bottom: 2px; }
        .card-subtitle { font-family: 'Homemade Apple', cursive; font-size: 10px; color: #8d6e63; margin-bottom: 20px; }
        .card-desc { font-family: 'Special Elite', cursive; font-size: 12px; color: #5d4037; line-height: 1.6; margin-bottom: 15px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        
        .view-btn {
            background: #5d4037; color: #fdfaf3; font-family: 'Cinzel', serif; font-weight: 900; font-size: 10px; text-transform: uppercase;
            padding: 13px; border-radius: 4px; text-align: center; width: 100%; margin-top: auto; letter-spacing: 2px; border: 1px solid rgba(255,255,255,0.05);
        }

        .reorder-controls {
            position: absolute; left: 0; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 3px; z-index: 20; background: #3e2723; padding: 6px 3px; border-radius: 0 4px 4px 0;
        }
        .reorder-btn { width: 30px; height: 34px; color: #dcc89f; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .reorder-btn:hover:not(:disabled) { color: #b8860b; transform: scale(1.1); }
        .reorder-btn:disabled { opacity: 0.1; cursor: not-allowed; }

        /* MANUSCRIPT BOXES */
        .discovery-log-box {
            font-family: 'Special Elite', cursive; font-size: 16px; line-height: 1.8; color: #3e2723; 
            padding: 45px; 
            border: 1.5px solid #c5b3a3; background: #faf5eb; margin: 40px 0; position: relative;
            box-shadow: 10px 10px 0 rgba(141, 110, 99, 0.05);
        }

        .finding-stamp { margin-bottom: 50px; padding-left: 30px; border-left: 3px solid #b8860b; background: rgba(184, 134, 11, 0.01); padding-top: 20px; padding-bottom: 20px; }
        .finding-header { 
            font-family: 'Special Elite', cursive; font-size: 14px; font-weight: 900; color: #fdfaf3; 
            background: #3e2723 !important; 
            display: inline-block; padding: 6px 20px; margin-bottom: 18px; text-transform: uppercase; letter-spacing: 2px; border-radius: 2px; box-shadow: 3px 3px 0 #b8860b; 
        }

        /* TABLES */
        .prog-table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0;
            font-family: 'Special Elite', cursive; 
            font-size: 13px; 
            margin: 25px 0; 
            background: #ffffff; 
            border: 2px solid #c5b3a3; 
            box-shadow: 8px 8px 25px rgba(62, 39, 35, 0.15); 
            border-radius: 2px;
            overflow: hidden;
        }
        .prog-table th { 
            font-family: 'Cinzel', serif; 
            text-transform: uppercase; 
            font-size: 10px; 
            color: #3e2723; 
            background: rgba(141, 110, 99, 0.12); 
            border-bottom: 2px solid #3e2723; 
            border-right: 1px solid #c5b3a3;
            padding: 12px 10px; 
            text-align: left; 
            min-width: 110px; 
            font-weight: 900; 
        }
        .prog-table td { padding: 10px; border-bottom: 1px solid #efebe9; border-right: 1px solid #efebe9; color: #5d4037; }
        .prog-table tr:nth-child(even) td { background-color: rgba(141, 110, 99, 0.04); }
        .prog-table th:last-child, .prog-table td:last-child { border-right: none; }
        .prog-table tr:last-child td { border-bottom: none; }

        .ledger-list { list-style: none; padding: 0; }
        .ledger-list li { margin-bottom: 15px; border-bottom: 1px dashed #d7ccc8; padding-bottom: 8px; display: flex; flex-direction: column; }
        .ledger-list b { font-family: 'Cinzel', serif; font-size: 11px; text-transform: uppercase; color: #3e2723; letter-spacing: 2px; font-weight: 900; }
        .ledger-list span { font-family: 'Special Elite', cursive; font-size: 15px; color: #5d4037; margin-top: 4px; }

        .flip-wrapper { position: relative; width: 100%; transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; min-height: 800px; }
        .flip-wrapper.flipped { transform: rotateY(180deg); }
        .side-front, .side-back { 
            width: 100%; 
            backface-visibility: hidden; 
            -webkit-backface-visibility: hidden; 
        }
        .side-front { position: relative; z-index: 2; opacity: 1; transition: opacity 0.4s; }
        .side-back { position: absolute; top: 0; left: 0; transform: rotateY(180deg); z-index: 1; opacity: 0; transition: opacity 0.4s; }
        .flipped .side-front { position: absolute; opacity: 0; pointer-events: none; visibility: hidden; }
        .flipped .side-back { position: relative; opacity: 1; pointer-events: auto; visibility: visible; }

        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #3e2723; color: #fdfaf3; padding: 14px 36px; border-radius: 4px; z-index: 10000; opacity: 0; transition: 0.3s; font-family: 'Cinzel'; font-size: 13px; font-weight: 900; border: 1px solid #b8860b; box-shadow: 0 10px 30px rgba(0,0,0,0.3); pointer-events: none; }
        .dm-active-edit .dm-editable { background: rgba(93, 64, 55, 0.05); outline: 1px dashed #8d6e63; border-radius: 4px; padding: 2px; }
        .hidden { display: none !important; }
        .drop-cap { float: left; font-family: 'Pirata One', cursive; font-size: 80px; line-height: 60px; padding-top: 4px; padding-right: 12px; color: #3e2723; }
    </style>
</head>
<body>

    <div id="toast" class="toast">Archival Message</div>

    <div class="journal-cover">
        <div class="parchment-container" id="parchment">
            <header class="flex flex-col md:flex-row justify-between items-center gap-6 relative z-[200] mb-8 pb-8 border-b border-brown-200/20">
                <div class="flex flex-col items-center md:items-start text-center md:text-left">
                    <h1 class="brand-title">Aeonfall</h1>
                    <p class="brand-sub">Hand-Inscribed Journal of Lineages</p>
                </div>
                <div class="flex items-center gap-10">
                    <div class="role-pill">
                        <div id="role-player" onclick="window.setRole('player')" class="role-tab active">Player</div>
                        <div id="role-dm" onclick="window.setRole('dm')" class="role-tab">DM</div>
                    </div>
                    <a href="playershandbook.html" class="text-[11px] font-black uppercase tracking-[0.3em] text-[#3e2723] hover:text-[#b8860b] transition-colors relative z-[201]">‚Üê Close Journal</a>
                </div>
            </header>

            <div id="view-grid">
                <div class="flex flex-col md:flex-row justify-between items-center md:items-end mb-10 gap-4">
                    <div>
                        <h2 class="font-serif text-2xl font-black uppercase text-[#3e2723] tracking-tight">Biological Stacks</h2>
                        <p class="font-serif italic text-xs text-[#8d6e63]">Hand-Inscribed dossiers of the known world ‚Ä¢ v6.1</p>
                    </div>
                    <div class="flex gap-3">
                        <button id="add-record-btn" onclick="window.addRecord()" class="hidden bg-[#5d4037] hover:bg-[#3e2723] text-[#fdfaf3] px-5 py-2.5 rounded-sm font-black text-[10px] uppercase shadow-xl transition-all active:scale-95">+ Ink New Entry</button>
                        <button id="remove-record-btn" onclick="window.togglePurgeMode()" class="hidden bg-[#d7ccc8] border border-brown-200 text-[#5d4037] hover:bg-[#bcaaa4] px-5 py-2.5 rounded-sm font-black text-[10px] uppercase shadow-md transition-all active:scale-95">Purge Records</button>
                    </div>
                </div>
                <div id="stack-grid" class="grid-container"></div>
            </div>

            <div id="view-details" class="hidden">
                <div class="flex justify-between items-start mb-10">
                    <div onclick="window.setView('grid')" class="back-nav">‚Üê Close Log</div>
                    <button onclick="window.flipPage()" id="btn-flip" class="bg-[#8d6e63] text-[#fdfaf3] px-6 py-3 rounded-sm font-black text-[10px] uppercase hover:bg-[#5d4037] transition-all shadow-lg border border-white/5">üìú Turn Page</button>
                </div>
                <div id="flip-container" class="flip-wrapper">
                    <div class="side-front" id="details-front"></div>
                    <div class="side-back" id="details-back"></div>
                </div>
                <div id="dm-bottom-controls" class="hidden flex gap-4 mt-16 pt-10 border-t border-brown-200/20">
                    <button onclick="window.addSection()" class="bg-[#8d6e63] text-[#fdfaf3] px-8 py-3 rounded-sm font-black uppercase text-[11px] tracking-widest hover:bg-[#5d4037] transition-all">Append Research Note</button>
                    <button onclick="window.triggerDel()" class="bg-red-900/10 border border-red-900/30 text-red-900 px-8 py-3 rounded-sm font-black uppercase text-[11px] tracking-widest hover:bg-red-900/20 transition-all">Expunge Bio-Record</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FIREBASE MODULES -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, updateDoc, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBLN0KhcnZFKZEYyR0O-Q2mZhKr-iyh7BI",
            authDomain: "aeonfall-523c1.firebaseapp.com",
            projectId: "aeonfall-523c1",
            storageBucket: "aeonfall-523c1.firebasestorage.app",
            messagingSenderId: "716207733913",
            appId: "1:716207733913:web:7aac43906a70e2b5f50c08"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'aeonfall-manager-v2';

        let lineages = [];
        let activeRole = 'player', currentView = 'grid', activeRaceId = null, isFlipped = false, currentUser = null;
        let saveTimer = null;
        let targetDelId = null;
        window.isPurgeMode = false;

        window.showToast = (m) => { const t = document.getElementById('toast'); if(t){t.textContent=m; t.style.opacity=1; setTimeout(()=>t.style.opacity=0, 2000);}};
        
        window.setRole = (r) => { 
            if(r === 'dm') { document.getElementById('pass-modal')?.classList.remove('hidden'); }
            else { activeRole = 'player'; window.isPurgeMode = false; updateRoleUI(); } 
        };

        window.authDm = () => { 
            const passInput = document.getElementById('dm-pass');
            if(passInput.value.trim() === 'Rew4994'){ 
                activeRole='dm'; document.getElementById('pass-modal')?.classList.add('hidden'); 
                passInput.value = ''; updateRoleUI(); window.showToast("Clearance Granted");
            } else { window.showToast("Denied"); } 
        };

        function updateRoleUI() {
            const isDM = activeRole === 'dm';
            document.getElementById('role-player')?.classList.toggle('active', !isDM);
            document.getElementById('role-dm')?.classList.toggle('active', isDM);
            document.getElementById('add-record-btn')?.classList.toggle('hidden', !isDM);
            document.getElementById('remove-record-btn')?.classList.toggle('hidden', !isDM);
            document.getElementById('dm-bottom-controls')?.classList.toggle('hidden', !isDM);
            document.body.classList.toggle('dm-active-edit', isDM);
            if(currentView === 'grid') renderGrid(); else renderDetails();
        }

        window.togglePurgeMode = () => {
            window.isPurgeMode = !window.isPurgeMode;
            document.getElementById('remove-record-btn')?.classList.toggle('bg-red-900', window.isPurgeMode);
            document.getElementById('remove-record-btn')?.classList.toggle('text-white', window.isPurgeMode);
            renderGrid();
        };

        const safeJSONParse = (data, fallback = []) => {
            try { if (!data) return fallback; if (typeof data === 'object') return data; return JSON.parse(data);
            } catch (e) { return fallback; }
        };

        window.parseAeonfallContent = (text, isDM) => {
            if (!text) return '';
            let html = text.replace(/&&([^&]+)&&/g, (match, content) => {
                const parts = content.split('|');
                const term = parts[0].trim();
                const definition = parts.length > 1 ? parts[1].trim() : "Technical record missing.";
                return `<span class="term-hover">${term}<span class="tooltip-content">${definition}</span></span>`;
            });
            html = html.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            html = html.replace(/\*(.*?)\*/g, '<i>$1</i>');
            html = html.replace(/__(.*?)__/g, '<u>$1</u>');
            return html;
        };

        window.flipPage = () => {
            isFlipped = !isFlipped;
            document.getElementById('flip-container').classList.toggle('flipped', isFlipped);
            document.getElementById('btn-flip').innerText = isFlipped ? "üìú Return to Bio-Notes" : "üìú Cultural Heritage";
        };

        window.setView = (v, id = null) => {
            currentView = v; activeRaceId = id; isFlipped = false;
            document.getElementById('view-grid').classList.toggle('hidden', v !== 'grid');
            document.getElementById('view-details').classList.toggle('hidden', v !== 'details');
            document.getElementById('flip-container')?.classList.remove('flipped');
            if(v === 'grid') renderGrid(); else renderDetails();
        };

        window.renderGrid = () => {
            const isDM = activeRole === 'dm';
            const grid = document.getElementById('stack-grid');
            grid.innerHTML = lineages.map((race, idx) => `
                <div class="race-card ${window.isPurgeMode ? 'purge-mode-active' : ''}" onclick="!window.isPurgeMode && window.setView('details', '${race.id}')">
                    <div class="card-bg-image">
                        ${race.gridUrl ? (race.gridUrl.includes('.mp4') ? `<video src="${race.gridUrl}" autoplay loop muted></video>` : `<img src="${race.gridUrl}">`) : '<div class="w-full h-full bg-[#d7ccc8] flex items-center justify-center italic text-xs">LOG EMPTY</div>'}
                    </div>
                    <div class="card-text-panel">
                        <h3 class="card-name">${race.name}</h3>
                        <p class="card-subtitle">Journal Dossier</p>
                        <p class="card-desc">${isDM ? (race.desc || '...') : window.parseAeonfallContent(race.desc, false)}</p>
                        <div class="card-traits-label">${race.name} Indicators</div>
                        <div class="card-traits-list">${isDM ? (race.traits || '...') : window.parseAeonfallContent(race.traits, false)}</div>
                        ${isDM ? `<div class="reorder-controls"><button onclick="event.stopPropagation(); window.moveRecord('${race.id}', -1)" class="reorder-btn">‚Üë</button><button onclick="event.stopPropagation(); window.moveRecord('${race.id}', 1)" class="reorder-btn">‚Üì</button></div>` : ''}
                        ${window.isPurgeMode ? `<button onclick="event.stopPropagation(); window.triggerDel('${race.id}')" class="purge-btn-overlay">Purge Entry</button>` : `<button class="view-btn">Inspect Log</button>`}
                    </div>
                </div>
            `).join('');
        };

        window.renderDetails = () => {
            const race = lineages.find(r => r.id === activeRaceId);
            if (!race) return;
            const isDM = activeRole === 'dm';
            const tables = safeJSONParse(race.mechTables);

            document.getElementById('details-front').innerHTML = `
                <div class="record-header">
                    <div class="flex flex-col">
                        <h2 class="card-name text-6xl dm-editable" contenteditable="${isDM}" oninput="window.dbUp('${race.id}', 'name', this.innerText)">${race.name}</h2>
                        <p class="stat-line border-b border-brown-200/20 pb-2 mb-6 uppercase text-[10px] font-black">Verified Signature ‚Ä¢ ID #<span class="dm-editable" contenteditable="${isDM}" oninput="window.dbUp('${race.id}', 'custodianId', this.innerText)">${race.custodianId || '994'}</span></p>
                        <div class="bg-brown-50/50 border-l-4 border-[#3e2723] p-6 rounded-sm">
                            <h4 class="font-black uppercase text-[11px] tracking-[0.2em] text-[#3e2723] mb-4">Innate Parameters</h4>
                            <div class="dm-editable text-sm italic leading-relaxed text-[#5d4037]" contenteditable="${isDM}" oninput="window.dbUp('${race.id}','traits',this.innerText)">${isDM ? (race.traits || '...') : window.parseAeonfallContent(race.traits, false)}</div>
                        </div>
                    </div>
                    <div class="record-illustration">
                        ${race.detailUrl ? (race.detailUrl.includes('.mp4') ? `<video src="${race.detailUrl}" autoplay loop muted></video>` : `<img src="${race.detailUrl}">`) : '<div class="h-64 flex items-center justify-center italic text-[#a1887f]">No visualization</div>'}
                    </div>
                </div>
                ${isDM ? `<div class="bg-brown-100/20 p-4 rounded mb-8 grid grid-cols-2 gap-4"><div><label class="text-[9px] font-black text-[#5d4037] uppercase">Grid Profile</label><input type="text" class="w-full p-2 text-[11px] bg-white border border-brown-200 mt-1" value="${race.gridUrl||''}" oninput="window.dbUp('${race.id}', 'gridUrl', this.value)"></div><div><label class="text-[9px] font-black text-[#5d4037] uppercase">Detail View</label><input type="text" class="w-full p-2 text-[11px] bg-white border border-brown-200 mt-1" value="${race.detailUrl||''}" oninput="window.dbUp('${race.id}', 'detailUrl', this.value)"></div></div>` : ''}
                <div class="discovery-log-box dm-editable" contenteditable="${isDM}" oninput="window.dbUp('${race.id}', 'desc', this.innerText)">
                    <span class="drop-cap">${(race.desc||"O").charAt(0)}</span>${isDM ? (race.desc || '...').slice(1) : window.parseAeonfallContent(race.desc, false).slice(1)}
                </div>
                <div id="additional-logs">${(race.intros || []).map((intro, idx) => `
                    <div class="finding-stamp relative">
                        <h3 class="finding-header dm-editable" contenteditable="${isDM}" oninput="window.updateIntroField(${idx}, 'leftTitle', this.innerText)">${intro.leftTitle || 'STAMP'}</h3>
                        <div class="dm-editable text-[#5d4037] font-serif leading-loose" contenteditable="${isDM}" oninput="window.updateIntroField(${idx}, 'leftText', this.innerText)">${isDM ? (intro.leftText || '...') : window.parseAeonfallContent(intro.leftText, false)}</div>
                        ${isDM ? `<button onclick="window.removeSection(${idx})" class="absolute top-0 right-0 text-red-900 opacity-30 hover:opacity-100 text-[9px] uppercase font-black">Shred</button>` : ''}
                    </div>`).join('')}
                </div>
            `;

            document.getElementById('details-back').innerHTML = `
                <h2 class="record-title-culture">Archival Heritage</h2>
                <div class="culture-ledger">
                    <ul class="ledger-list">
                        ${[
                            { f: 'cultureName', l: 'Archival Identity' },
                            { f: 'majorityPop', l: 'Majority Pop' },
                            { f: 'coreValues', l: 'Core Values' },
                            { f: 'government', l: 'Government' },
                            { f: 'belief', l: 'Belief' },
                            { f: 'culturalPractices', l: 'Cultural Practices' },
                            { f: 'attitudes', l: 'Attitudes' }
                        ].map(item => `<li><b>${item.l}:</b> <span class="dm-editable" contenteditable="${isDM}" oninput="window.dbUp('${race.id}','${item.f}',this.innerText)">${isDM ? (race[item.f] || '...') : window.parseAeonfallContent(race[item.f], false)}</span></li>`).join('')}
                    </ul>
                    <div class="record-illustration" style="height: 300px;">
                        ${race.backMediaUrl ? (race.backMediaUrl.includes('.mp4') ? `<video src="${race.backMediaUrl}" autoplay loop muted class="w-full h-full object-cover"></video>` : `<img src="${race.backMediaUrl}" class="w-full h-full object-cover">`) : '<div class="h-full flex items-center justify-center italic opacity-30">Heritage visual lost</div>'}
                    </div>
                </div>
                ${isDM ? `<input type="text" class="w-full p-2 text-[10px] bg-white border border-brown-200 mt-2" value="${race.backMediaUrl||''}" placeholder="Heritage Vis Link" oninput="window.dbUp('${race.id}', 'backMediaUrl', this.value)">` : ''}

                <div class="mech-box mt-12 bg-[#8d6e63]/10 border-2 border-[#8d6e63]/20 p-10 rounded-sm">
                    <div class="flex justify-between items-center border-b-2 border-[#3e2723] mb-8 pb-3">
                        <h4 class="m-0 border-0 font-black text-[#3e2723] uppercase tracking-widest text-sm">Systemic Readout</h4>
                        ${isDM ? `<button onclick="window.addMechTable()" class="bg-[#3e2723] text-[#fdfaf3] px-4 py-1.5 text-[9px] uppercase font-black rounded-sm">+ Add Ledger</button>` : ''}
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                        <div><b class="text-[10px] uppercase text-[#3e2723] block mb-3 tracking-widest font-black">Innate Capabilities</b><div class="dm-editable min-h-[80px] p-5 bg-white/50 rounded italic text-sm border border-brown-200" contenteditable="${isDM}" oninput="window.dbUp('${race.id}','mechTraits',this.innerText)">${isDM ? (race.mechTraits || '...') : window.parseAeonfallContent(race.mechTraits, false)}</div></div>
                        <div><b class="text-[10px] uppercase text-[#3e2723] block mb-3 tracking-widest font-black">Core Matrix</b><div class="dm-editable min-h-[80px] p-5 bg-white/50 rounded italic text-sm border border-brown-200" contenteditable="${isDM}" oninput="window.dbUp('${race.id}','mechDescription',this.innerText)">${isDM ? (race.mechDescription || '...') : window.parseAeonfallContent(race.mechDescription, false)}</div></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-12">
                        ${[
                            {f:'size',l:'Size'}, {f:'speed',l:'Speed'}, {f:'mechLanguages',l:'Languages'},
                            {f:'mechBackgrounds',l:'Backgrounds'}, {f:'mechFeats',l:'Feats'}, {f:'mechEquipment',l:'Equipment'}
                        ].map(item => `
                            <div class="bg-white/40 p-4 border border-brown-200 rounded">
                                <span class="block text-[10px] uppercase font-black text-[#8d6e63] border-b border-brown-200 mb-2">${item.l}</span>
                                <div class="dm-editable text-sm" contenteditable="${isDM}" oninput="window.dbUp('${race.id}','${item.f}',this.innerText)">${isDM ? (race[item.f] || '...') : window.parseAeonfallContent(race[item.f], false)}</div>
                            </div>
                        `).join('')}
                    </div>

                    <div id="mech-tables-root">
                        ${tables.map((table, tIdx) => `
                            <div class="mt-12 relative group">
                                <div class="flex justify-between items-center mb-4">
                                    <b class="text-[11px] uppercase text-[#3e2723] dm-editable font-black tracking-widest" contenteditable="${isDM}" oninput="window.updateMechTableField(${tIdx}, 'title', this.innerText)">${table.title}</b>
                                    ${isDM ? `
                                        <div class="flex gap-1">
                                            <button onclick="window.addMechTableRow(${tIdx})" class="bg-[#3e2723] text-white px-2 py-0.5 text-[8px] font-black uppercase rounded-sm">+R</button>
                                            <button onclick="window.remMechTableRow(${tIdx})" class="bg-[#3e2723] text-white px-2 py-0.5 text-[8px] font-black uppercase rounded-sm">-R</button>
                                            <button onclick="window.addMechTableCol(${tIdx})" class="bg-[#3e2723] text-white px-2 py-0.5 text-[8px] font-black uppercase rounded-sm">+C</button>
                                            <button onclick="window.remMechTableCol(${tIdx})" class="bg-[#3e2723] text-white px-2 py-0.5 text-[8px] font-black uppercase rounded-sm">-C</button>
                                            <button onclick="window.delMechTable(${tIdx})" class="bg-red-900 text-white px-2 py-0.5 text-[8px] font-black uppercase rounded-sm">Del</button>
                                        </div>
                                    ` : ''}
                                </div>
                                <table class="prog-table w-full">
                                    <thead><tr>${table.headers.map((h, hIdx) => `<th contenteditable="${isDM}" oninput="window.updateMechTableField(${tIdx}, 'headers', this.innerText, ${hIdx})">${h}</th>`).join('')}</tr></thead>
                                    <tbody>${table.rows.map((row, rIdx) => `<tr>${row.map((cell, cIdx) => `<td contenteditable="${isDM}" oninput="window.updateMechTableField(${tIdx}, 'rows', this.innerText, rIdx, cIdx)">${window.parseAeonfallContent(cell, false)}</td>`).join('')}</tr>`).join('')}</tbody>
                                </table>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        };

        window.dbUp = (id, field, val) => {
            if (!currentUser) return;
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(() => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', id), { [field]: val }), 1000);
        };

        window.updateIntroField = (idx, field, val) => {
            if(saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(async () => {
                const race = lineages.find(r => r.id === activeRaceId);
                const intros = race.intros || [];
                intros[idx][field] = val;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', activeRaceId), { intros: intros });
            }, 800);
        };

        window.addMechTable = async () => {
            const race = lineages.find(r => r.id === activeRaceId);
            const tables = safeJSONParse(race.mechTables);
            tables.push({ title: "ARCHIVAL PARAMETERS", headers: ["ID", "Readout"], rows: [["...", "..."]] });
            window.dbUp(activeRaceId, 'mechTables', JSON.stringify(tables));
        };

        window.updateMechTableField = (tIdx, field, val, idx1 = null, idx2 = null) => {
            if(saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(async () => {
                const race = lineages.find(r => r.id === activeRaceId);
                const tables = safeJSONParse(race.mechTables);
                if(field === 'title') tables[tIdx].title = val;
                else if(field === 'headers') tables[tIdx].headers[idx1] = val;
                else if(field === 'rows') tables[tIdx].rows[idx1][idx2] = val;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', activeRaceId), { mechTables: JSON.stringify(tables) });
            }, 800);
        };

        window.addMechTableRow = async (tIdx) => {
            const race = lineages.find(r => r.id === activeRaceId);
            const tables = safeJSONParse(race.mechTables);
            tables[tIdx].rows.push(new Array(tables[tIdx].headers.length).fill("..."));
            window.dbUp(activeRaceId, 'mechTables', JSON.stringify(tables));
        };

        window.remMechTableRow = async (tIdx) => {
            const race = lineages.find(r => r.id === activeRaceId);
            const tables = safeJSONParse(race.mechTables);
            if(tables[tIdx].rows.length > 1) {
                tables[tIdx].rows.pop();
                window.dbUp(activeRaceId, 'mechTables', JSON.stringify(tables));
            }
        };

        window.addMechTableCol = async (tIdx) => {
            const race = lineages.find(r => r.id === activeRaceId);
            const tables = safeJSONParse(race.mechTables);
            tables[tIdx].headers.push("ID");
            tables[tIdx].rows = tables[tIdx].rows.map(r => [...r, "..."]);
            window.dbUp(activeRaceId, 'mechTables', JSON.stringify(tables));
        };

        window.remMechTableCol = async (tIdx) => {
            const race = lineages.find(r => r.id === activeRaceId);
            const tables = safeJSONParse(race.mechTables);
            if(tables[tIdx].headers.length > 1) {
                tables[tIdx].headers.pop();
                tables[tIdx].rows = tables[tIdx].rows.map(r => r.slice(0, -1));
                window.dbUp(activeRaceId, 'mechTables', JSON.stringify(tables));
            }
        };

        window.delMechTable = async (tIdx) => {
            const race = lineages.find(r => r.id === activeRaceId);
            const tables = safeJSONParse(race.mechTables);
            tables.splice(tIdx, 1);
            window.dbUp(activeRaceId, 'mechTables', JSON.stringify(tables));
        };

        window.moveRecord = async (id, direction) => {
            if (!currentUser) return;
            const index = lineages.findIndex(r => r.id === id);
            const targetIndex = index + direction;
            if (targetIndex < 0 || targetIndex >= lineages.length) return;
            const cur = lineages[index]; const tar = lineages[targetIndex];
            const curO = cur.order ?? (cur.createdAt || Date.now());
            const tarO = tar.order ?? (tar.createdAt || Date.now());
            try {
                await Promise.all([
                    updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', cur.id), { order: tarO }),
                    updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', tar.id), { order: curO })
                ]);
            } catch (err) { window.showToast("Uplink Failed"); }
        };

        window.addRecord = async () => {
            if (!currentUser) return;
            const maxOrder = lineages.length > 0 ? Math.max(...lineages.map(l => l.order || l.createdAt || 0)) : Date.now();
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'handbookLineages'), { 
                name: "NEW SUBJECT", custodianId: "994", speed: "30", size: "M", desc: "Log pending...", traits: "Markers pending...", intros: [],
                cultureName: "", majorityPop: "", coreValues: "", government: "", belief: "", culturalPractices: "", attitudes: "",
                mechTraits: "", mechDescription: "", mechBackgrounds: "", mechLanguages: "", mechFeats: "", mechEquipment: "", mechTables: "[]",
                createdAt: Date.now(), order: maxOrder + 1000 
            });
            window.showToast("Archive Initialized");
        };

        window.addSection = async () => {
            if (!currentUser) return;
            const race = lineages.find(r => r.id === activeRaceId);
            const intros = race.intros || [];
            intros.push({ leftTitle: "LOG ENTRY", leftText: "Data recorded..." });
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', activeRaceId), { intros: intros });
            window.showToast("Log Appended");
        };

        window.removeSection = async (idx) => {
            if (!currentUser) return;
            const race = lineages.find(r => r.id === activeRaceId);
            const intros = race.intros || [];
            intros.splice(idx, 1);
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', activeRaceId), { intros: intros });
            window.showToast("Redacted");
        };

        window.triggerDel = (id = null) => { targetDelId = id || activeRaceId; document.getElementById('del-modal')?.classList.remove('hidden'); };
        document.getElementById('confirm-del-btn').onclick = async () => {
            if (!targetDelId || !currentUser) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', targetDelId));
            document.getElementById('del-modal')?.classList.add('hidden'); window.setView('grid'); window.showToast("Purged");
        };

        window.zoomMedia = (url) => { if (!url) return; window.open(url, '_blank'); };

        const init = async () => {
            const initAuth = async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else { await signInAnonymously(auth); }
                } catch (e) { await signInAnonymously(auth); }
            };
            await initAuth();
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'handbookLineages'), (snap) => {
                        lineages = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (a.order ?? a.createdAt) - (b.order ?? b.createdAt));
                        if(currentView === 'grid') renderGrid(); else renderDetails();
                    }, (err) => {
                        console.error("Archive failure:", err);
                        window.showToast("Archival Stream Error");
                    });
                }
                updateRoleUI();
            });
        };
        init();
    </script>

    <div id="pass-modal" class="fixed inset-0 bg-black/95 flex items-center justify-center z-[5000] hidden p-4">
        <div class="bg-[#2c1810] p-12 rounded-2xl w-full max-w-sm border-2 border-[#d4a373] text-[#fdfaf3] text-center shadow-2xl relative">
            <h3 class="text-2xl font-serif text-[#d4a373] font-bold mb-6 uppercase">Master Key</h3>
            <input type="password" id="dm-pass" onkeydown="if(event.key==='Enter') window.authDm()" class="w-full bg-[#1a0f0a] text-center text-3xl rounded-lg p-4 mb-8 border border-[#5d4037] text-[#d4a373] focus:outline-none" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <button onclick="window.authDm()" class="w-full bg-[#5d4037] hover:bg-[#8d6e63] text-white py-5 rounded-xl font-black uppercase text-sm tracking-widest transition-all mb-4">Authorize</button>
            <button onclick="document.getElementById('pass-modal').classList.add('hidden')" class="text-[11px] text-[#8d6e63] uppercase font-black tracking-widest">Cancel</button>
        </div>
    </div>

    <div id="del-modal" class="fixed inset-0 z-[6000] flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/90" onclick="document.getElementById('del-modal').classList.add('hidden')"></div>
        <div class="bg-[#fdfaf3] p-12 rounded-2xl w-full max-w-sm text-center relative z-10 shadow-2xl border-4 border-red-900/20">
            <h3 class="text-3xl font-serif font-black text-red-900 uppercase mb-4">Purge Record</h3>
            <p class="text-sm text-[#5d4037] mb-10 italic">This subject will be permanently shredded.</p>
            <button id="confirm-del-btn" class="w-full bg-red-900 text-white py-5 rounded-xl font-black text-xs uppercase shadow-lg mb-4">Confirm Shred</button>
            <button onclick="document.getElementById('del-modal').classList.add('hidden')" class="w-full bg-white/50 text-[#8d6e63] py-3 rounded-xl font-bold uppercase text-[10px]">Abort</button>
        </div>
    </div>
</body>
</html>
