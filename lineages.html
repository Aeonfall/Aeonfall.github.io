<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aeonfall - Lineages & Heritage Archives</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Roboto+Slab:wght@300;400;700&family=Special+Elite&family=MedievalSharp&family=Homemade+Apple&family=Pirata+One&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Roboto Slab', serif; 
            background-color: #0c0c0c; 
            background-image: url('https://www.transparenttextures.com/patterns/dark-wood.png');
            color: #1a0f0a; 
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* THE MASTER PARCHMENT */
        .parchment-container {
            max-width: 1300px;
            margin: 10px auto;
            background: #f4edd8;
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            box-shadow: 0 50px 100px rgba(0,0,0,0.8), inset 0 0 100px rgba(0,0,0,0.1);
            border-radius: 4px;
            position: relative;
            padding: clamp(40px, 6vw, 60px) clamp(15px, 5vw, 50px);
            border: 1px solid #dcd1b2;
            clip-path: polygon(0% 0%, 100% 0%, 100% 1%, 99% 50%, 100% 99%, 99% 100%, 1% 99%, 0% 98%, 1% 50%, 0% 1%);
            perspective: 2000px;
        }

        /* HEADER & BRANDING */
        .brand-title { font-family: 'Cinzel', serif; font-weight: 900; color: #7a1d1d; font-size: clamp(1.5rem, 4vw, 2.2rem); line-height: 1; }
        .brand-sub { font-family: 'Cinzel', serif; font-size: 8px; color: #5d4037; letter-spacing: 0.15em; text-transform: uppercase; font-weight: bold; }
        
        .role-pill { background: rgba(0,0,0,0.05); border-radius: 99px; padding: 3px; display: flex; gap: 4px; border: 1px solid rgba(0,0,0,0.1); position: relative; z-index: 100; }
        .role-tab { padding: 4px 12px; font-family: 'Cinzel', serif; font-size: 8px; font-weight: 900; border-radius: 99px; transition: 0.3s; color: #5d4037; text-transform: uppercase; cursor: pointer; white-space: nowrap; }
        .role-tab.active { background: #7a1d1d !important; color: white !important; box-shadow: 0 4px 10px rgba(122, 29, 29, 0.3); }

        /* DASHBOARD GRID */
        .grid-container { 
            display: grid; 
            grid-template-cols: repeat(auto-fill, minmax(min(100%, 360px), 1fr)); 
            gap: 20px; 
            padding: 20px 0; 
        }

        .race-card {
            background: #fff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
            display: flex;
            flex-direction: column;
            height: 340px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .race-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.2); }
        
        .card-bg-image { position: absolute; top: 0; right: 0; width: 55%; height: 100%; z-index: 1; }
        .card-bg-image img, .card-bg-image video { width: 100%; height: 100%; object-fit: cover; filter: sepia(0.1) contrast(1.1); }

        .card-text-panel {
            position: relative;
            z-index: 2;
            width: 75%;
            height: 100%;
            background: linear-gradient(to right, white 80%, rgba(255,255,255,0));
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .card-name { font-family: 'Cinzel', serif; font-size: 20px; font-weight: 900; color: #1a1a1a; margin-bottom: 2px; }
        .card-subtitle { font-family: 'Cinzel', serif; font-size: 9px; font-style: italic; color: #888; margin-bottom: 10px; }
        .card-desc { font-size: 11px; color: #444; line-height: 1.4; margin-bottom: 12px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .card-traits-label { font-family: 'Cinzel', serif; font-size: 10px; font-weight: 900; color: #1a1a1a; margin-bottom: 4px; }
        .card-traits-list { font-size: 10px; color: #555; line-height: 1.4; flex-grow: 1; }

        .view-btn {
            background: #f59e0b;
            color: white;
            font-family: 'Cinzel', serif;
            font-weight: 900;
            font-size: 10px;
            text-transform: uppercase;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            width: 100%;
            max-width: 180px;
            margin-top: auto;
            box-shadow: 0 4px 0 #d97706;
            position: relative;
            z-index: 5;
        }

        /* 3D FLIP CONTAINER */
        .flip-wrapper {
            position: relative;
            width: 100%;
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
            min-height: 600px;
        }
        .flip-wrapper.flipped { transform: rotateY(180deg); }
        .side-front, .side-back { width: 100%; backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        .side-back { position: absolute; top: 0; left: 0; transform: rotateY(180deg); }
        .flipped .side-front { visibility: hidden; } 

        /* TITLES & RICH TEXT */
        .record-header { display: grid; grid-template-cols: 1fr; gap: 30px; margin-bottom: 30px; align-items: start; }
        @media (min-width: 1024px) { .record-header { grid-template-cols: 1fr 1.2fr; gap: 60px; } }

        .record-title { font-family: 'Pirata One', cursive; font-size: clamp(2.2rem, 7vw, 4.5rem); color: #1a0f0a; line-height: 0.9; margin-bottom: 5px; text-transform: uppercase; word-wrap: break-word; }
        .record-label { font-family: 'Cinzel', serif; font-size: clamp(8px, 1.8vw, 10px); font-weight: 900; color: #7a1d1d; text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 8px; display: inline-block; margin-bottom: 20px; }

        .culture-ledger { display: grid; grid-template-cols: 1fr; gap: 30px; margin-top: 20px; }
        @media (min-width: 1024px) { .culture-ledger { grid-template-cols: 1.5fr 1fr; gap: 40px; } }

        .research-findings { font-family: 'Special Elite', cursive; font-size: clamp(14px, 2.5vw, 16px); line-height: 1.6; color: #1a0f0a; padding: 20px; border: 1px dashed rgba(0,0,0,0.2); background: rgba(0,0,0,0.02); margin: 30px 0; }
        .drop-cap { float: left; font-family: 'Pirata One', cursive; font-size: clamp(60px, 10vw, 80px); line-height: clamp(50px, 8vw, 60px); padding-top: 4px; padding-right: 8px; color: #7a1d1d; }

        .back-nav { display: inline-flex; align-items: center; gap: 8px; color: #7a1d1d; font-weight: 900; font-size: 9px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; cursor: pointer; position: relative; z-index: 100; }

        .ornate-corner { position: absolute; width: 25px; height: 25px; opacity: 0.12; color: #7a1d1d; pointer-events: none; }
        .tl { top: 10px; left: 10px; }
        .br { bottom: 10px; right: 10px; transform: rotate(180deg); }

        .term-hover { border-bottom: 1px dotted #7a1d1d; color: #7a1d1d; font-weight: 900; cursor: help; position: relative; }
        .tooltip-content {
            visibility: hidden; width: 200px; background-color: #1a0f0a; color: #f4edd8;
            padding: 10px; position: absolute; z-index: 1000; bottom: 125%; left: 50%; transform: translateX(-50%);
            opacity: 0; transition: opacity 0.3s; font-size: 10px; line-height: 1.4; border: 1px solid #7a1d1d;
        }
        .term-hover:hover .tooltip-content { visibility: visible; opacity: 1; }
        
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1a0f0a; color: #f4edd8; padding: 10px 24px; border-radius: 40px; z-index: 10000; font-family: 'Cinzel'; font-size: 10px; opacity: 0; transition: 0.3s; pointer-events: none; border: 1px solid #7a1d1d; }
        
        /* Mobile Specific Overrides - DISABLING FLIP */
        @media (max-width: 640px) {
            .parchment-container { margin: 5px auto; clip-path: none; border-radius: 8px; }
            .side-back { position: relative; transform: none; top: auto; left: auto; box-shadow: none; border-top: 2px dashed #bba683; padding-top: 40px; margin-top: 40px; }
            .flip-wrapper.flipped { transform: none; }
            .flip-wrapper { min-height: auto; }
            #btn-flip { display: none; } 
            .ledger-list li { flex-direction: column; gap: 2px; }
        }
    </style>
</head>
<body>

    <div id="toast" class="toast">DM Message</div>

    <div class="parchment-container" id="parchment">
        <div class="ornate-corner tl"><svg viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="2"><path d="M10,10 Q30,10 30,40 T60,60 T90,90 M10,10 Q10,30 40,30 T60,60"/></svg></div>
        <div class="ornate-corner br"><svg viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="2"><path d="M10,10 Q30,10 30,40 T60,60 T90,90 M10,10 Q10,30 40,30 T60,60"/></svg></div>

        <!-- HEADER -->
        <header class="flex flex-col md:flex-row justify-between items-center gap-4 relative z-[200] mb-6 pb-4 border-b border-black/10">
            <div class="flex flex-col items-center md:items-start text-center md:text-left">
                <h1 class="brand-title">Aeonfall</h1>
                <p class="brand-sub">Heritage Archives</p>
            </div>

            <div class="flex flex-wrap justify-center items-center gap-4 md:gap-8">
                <div class="role-pill">
                    <div id="role-player" onclick="window.setRole('player')" class="role-tab active">Player</div>
                    <div id="role-dm" onclick="window.setRole('dm')" class="role-tab">DM</div>
                </div>
                <a href="playershandbook.html" class="text-[9px] font-black uppercase tracking-widest text-[#7a1d1d] hover:text-black transition-colors">‚Üê Hub</a>
            </div>
        </header>

        <!-- DASHBOARD VIEW -->
        <div id="view-grid">
            <div class="flex flex-col sm:flex-row justify-between items-center sm:items-end mb-4 gap-4">
                <div class="text-center sm:text-left">
                    <h2 class="font-serif text-lg md:text-xl font-black uppercase text-[#1a0f0a]">Biological Stacks</h2>
                    <p class="text-[7px] md:text-[8px] text-[#5d4037] tracking-[0.2em] uppercase font-bold">Bio-Data Records</p>
                </div>
                <button id="add-record-btn" onclick="window.addRecord()" class="hidden bg-[#7a1d1d] text-[#f4edd8] px-3 py-1.5 rounded-sm font-black text-[7px] uppercase shadow-lg">+ Add Record</button>
            </div>
            
            <div id="stack-grid" class="grid-container"></div>
        </div>

        <!-- DETAIL VIEW -->
        <div id="view-details" class="hidden">
            <div class="flex flex-col sm:flex-row justify-between items-start mb-6 gap-4">
                <div onclick="window.setView('grid')" class="back-nav">‚Üê Return to Stacks</div>
                <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                    <button onclick="window.flipPage()" id="btn-flip" class="flex-grow sm:flex-grow-0 bg-[#1a0f0a] text-[#f4edd8] px-4 py-2 rounded-sm font-black text-[8px] uppercase">üìú Flip Page</button>
                    <div id="dm-controls" class="hidden flex gap-2 w-full sm:w-auto">
                        <button onclick="window.enterPinMode()" id="btn-pin-note" class="flex-grow sm:flex-grow-0 bg-amber-600 text-white px-4 py-2 rounded-sm font-black text-[8px] uppercase">üìå Pin Note</button>
                    </div>
                </div>
            </div>

            <div id="flip-container" class="flip-wrapper">
                <div class="side-front" id="details-front"></div>
                <div class="side-back" id="details-back"></div>
            </div>

            <div id="dm-bottom-controls" class="hidden flex flex-col sm:flex-row gap-3 mt-10 pt-6 border-t border-black/10">
                <button onclick="window.addSection()" class="bg-[#1a0f0a] text-[#f4edd8] px-4 py-2 rounded-sm font-black uppercase text-[9px] tracking-wider">Append Chapter</button>
                <button onclick="window.triggerDel()" class="bg-red-700/10 border border-red-700/30 text-red-700 px-4 py-2 rounded-sm font-black uppercase text-[9px] tracking-wider">Expunge Record</button>
            </div>
        </div>
    </div>

    <!-- MODALS (Lightbox, Password, etc.) same as original -->
    <div id="lightbox-modal" class="fixed inset-0 z-[10000] flex flex-col items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/90" onclick="window.closeLightbox()"></div>
        <div id="lightbox-content" class="relative z-10 w-full flex justify-center"></div>
        <button onclick="window.closeLightbox()" class="relative z-10 mt-6 bg-[#7a1d1d] text-white px-6 py-2 rounded-full font-black text-[10px] uppercase tracking-widest shadow-2xl">Close</button>
    </div>

    <div id="pass-modal" class="fixed inset-0 bg-black/95 flex items-center justify-center z-[5000] hidden p-4">
        <div class="bg-gray-800 p-8 rounded-2xl w-full max-w-xs border-2 border-amber-600 text-white text-center shadow-2xl">
            <h3 class="text-lg font-serif text-amber-500 font-bold mb-4 uppercase">Authorize</h3>
            <input type="password" id="dm-pass" class="w-full bg-gray-900 text-center text-xl rounded-lg p-3 mb-6 border border-gray-700 outline-none">
            <button onclick="window.authDm()" class="w-full bg-amber-600 text-white py-3 rounded-xl font-bold uppercase text-[10px]">Verify</button>
            <button onclick="document.getElementById('pass-modal').classList.add('hidden')" class="text-[9px] text-gray-500 uppercase font-black mt-4 block">Cancel</button>
        </div>
    </div>

    <div id="del-modal" class="fixed inset-0 z-[6000] flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/90" onclick="document.getElementById('del-modal').classList.add('hidden')"></div>
        <div class="bg-white p-8 rounded-2xl w-full max-w-xs text-center relative z-10 shadow-2xl">
            <h3 class="text-xl font-serif font-black text-red-700 uppercase mb-4">Expunge?</h3>
            <button id="confirm-del-btn" class="w-full bg-red-700 text-white py-3 rounded-xl font-black text-[10px] uppercase shadow-lg mb-2">Confirm</button>
            <button onclick="document.getElementById('del-modal').classList.add('hidden')" class="w-full bg-gray-100 text-gray-400 py-2 rounded-xl font-bold uppercase text-[9px]">Back</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, updateDoc, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBLN0KhcnZFKZEYyR0O-Q2mZhKr-iyh7BI", authDomain: "aeonfall-523c1.firebaseapp.com", projectId: "aeonfall-523c1", storageBucket: "aeonfall-523c1.firebasestorage.app", messagingSenderId: "716207733913", appId: "1:716207733913:web:7aac43906a70e2b5f50c08" };
        const appId = 'aeonfall-manager-v2';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let lineages = [];
        let activeRole = 'player', currentView = 'grid', isFlipped = false, activeRaceId = null, saveTimer = null;

        window.showToast = (m) => { const t = document.getElementById('toast'); if(t) { t.textContent=m; t.style.opacity=1; setTimeout(()=>t.style.opacity=0, 3000); } };
        window.setRole = (r) => { if(r === 'dm') document.getElementById('pass-modal').classList.remove('hidden'); else { activeRole = 'player'; updateRoleUI(); } };
        window.authDm = () => { if(document.getElementById('dm-pass').value === 'Rew4994'){ activeRole='dm'; document.getElementById('pass-modal').classList.add('hidden'); updateRoleUI(); } else { window.showToast("Authority Refused"); } };

        function updateRoleUI() {
            const isDM = activeRole === 'dm';
            document.getElementById('role-player').classList.toggle('active', !isDM);
            document.getElementById('role-dm').classList.toggle('active', isDM);
            document.getElementById('add-record-btn').classList.toggle('hidden', !isDM);
            const ctrl = document.getElementById('dm-controls'); if (ctrl) ctrl.classList.toggle('hidden', !isDM);
            const bCtrl = document.getElementById('dm-bottom-controls'); if (bCtrl) bCtrl.classList.toggle('hidden', !isDM);
            if(currentView === 'grid') renderGrid(); else renderDetails();
        }

        window.zoomMedia = (url) => { if (!url) return; const modal = document.getElementById('lightbox-modal'); const content = document.getElementById('lightbox-content'); content.innerHTML = url.includes('.mp4') ? `<video src="${url}" autoplay loop muted class="max-h-[80vh]"></video>` : `<img src="${url}" class="max-h-[80vh]">`; modal.classList.remove('hidden'); };
        window.closeLightbox = () => { document.getElementById('lightbox-modal').classList.add('hidden'); };

        window.flipPage = () => { isFlipped = !isFlipped; document.getElementById('flip-container').classList.toggle('flipped', isFlipped); document.getElementById('btn-flip').innerText = isFlipped ? "üìú Biology" : "üìú Culture"; };

        window.setView = (v, id = null) => { currentView = v; activeRaceId = id; isFlipped = false; document.getElementById('view-grid').classList.toggle('hidden', v !== 'grid'); document.getElementById('view-details').classList.toggle('hidden', v !== 'details'); if(v === 'grid') renderGrid(); else renderDetails(); };

        function parseAeonfallContent(text, isDM) {
            if (!text) return ''; if (isDM) return text; 
            let html = text.replace(/&&([^&]+)&&/g, (match, content) => { const parts = content.split('|'); return `<span class="term-hover def-term">${parts[0].trim()}</span>`; });
            html = html.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            html = html.replace(/\*(.*?)\*/g, '<i>$1</i>');
            return html;
        }

        window.renderGrid = () => {
            const isDM = activeRole === 'dm';
            const grid = document.getElementById('stack-grid');
            grid.innerHTML = lineages.map(race => `
                <div class="race-card" onclick="window.setView('details', '${race.id}')">
                    <div class="card-bg-image">${race.gridUrl ? (race.gridUrl.includes('.mp4') ? `<video src="${race.gridUrl}" autoplay loop muted></video>` : `<img src="${race.gridUrl}">`) : '<div class="w-full h-full bg-[#e0d5ba] flex items-center justify-center text-[10px] text-gray-500 italic">SCANNING...</div>'}</div>
                    <div class="card-text-panel">
                        <h3 class="card-name">${race.name}</h3>
                        <p class="card-desc">${isDM ? (race.desc || '...') : parseAeonfallContent(race.desc, false)}</p>
                        <div class="card-traits-list truncate text-[10px]">${race.traits || 'None.'}</div>
                        <button class="view-btn">Consult Record</button>
                    </div>
                </div>
            `).join('');
        };

        window.renderDetails = () => {
            const isDM = activeRole === 'dm';
            const race = lineages.find(r => r.id === activeRaceId);
            if (!race) return;

            document.getElementById('details-front').innerHTML = `
                <h2 class="record-title dm-editable" contenteditable="${isDM}" onblur="window.dbUp('${race.id}', 'name', this.innerText)">${race.name}</h2>
                <div class="record-label">Genetic Signature Verified</div>
                <div class="record-header">
                    <div>
                        <div class="innate-param-header">Innate Parameters</div>
                        <div class="dm-editable italic text-sm p-4 bg-black/5" contenteditable="${isDM}" onblur="window.dbUp('${race.id}','traits',this.innerText)">${isDM ? race.traits : parseAeonfallContent(race.traits, false)}</div>
                    </div>
                    <div class="record-illustration h-64" onclick="window.zoomMedia('${race.detailUrl}')">${race.detailUrl ? (race.detailUrl.includes('.mp4') ? `<video src="${race.detailUrl}" autoplay loop muted class="w-full h-full object-cover"></video>` : `<img src="${race.detailUrl}" class="w-full h-full object-cover">`) : '<div class="h-full bg-black/10 flex items-center justify-center italic">Uplink Lost</div>'}</div>
                </div>
                <div class="research-findings dm-editable" contenteditable="${isDM}" onblur="window.dbUp('${race.id}', 'desc', this.innerText)"><span class="drop-cap">${(race.desc||"O").charAt(0)}</span>${isDM ? ((race.desc||"nce...").slice(1)) : parseAeonfallContent((race.desc||"nce...").slice(1), false)}</div>
            `;

            document.getElementById('details-back').innerHTML = `
                <h2 class="record-title mb-6">Cultural Heritage</h2>
                <div class="culture-ledger">
                    <ul class="ledger-list">${['cultureName', 'coreValues', 'government', 'belief', 'culturalPractices'].map(f => `<li><b>${f.toUpperCase()}:</b> <span class="dm-editable" contenteditable="${isDM}" onblur="window.dbUp('${race.id}','${f}',this.innerText)">${race[f] || '...'}</span></li>`).join('')}</ul>
                    <div class="record-illustration h-48" onclick="window.zoomMedia('${race.backMediaUrl}')">${race.backMediaUrl ? (race.backMediaUrl.includes('.mp4') ? `<video src="${race.backMediaUrl}" autoplay loop muted class="w-full h-full object-cover"></video>` : `<img src="${race.backMediaUrl}" class="w-full h-full object-cover">`) : ''}</div>
                </div>
                <div class="mech-box mt-8">
                    <h4 class="mb-4 text-[#7a1d1d]">Mechanical Traits</h4>
                    <div class="dm-editable italic text-sm" contenteditable="${isDM}" onblur="window.dbUp('${race.id}','mechTraits',this.innerText)">${race.mechTraits || 'Trait data...'}</div>
                </div>
            `;
        };

        window.dbUp = (id, field, val) => { if (saveTimer) clearTimeout(saveTimer); saveTimer = setTimeout(() => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', id), { [field]: val }), 1000); };
        window.addRecord = async () => { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'handbookLineages'), { name: "NEW SUBJECT", createdAt: Date.now() }); };
        window.triggerDel = () => { document.getElementById('del-modal').classList.remove('hidden'); };
        document.getElementById('confirm-del-btn').onclick = async () => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', activeRaceId)); window.setView('grid'); document.getElementById('del-modal').classList.add('hidden'); };

        const init = async () => {
            await signInAnonymously(auth);
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'handbookLineages'), (snap) => {
                lineages = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (a.order ?? a.createdAt) - (b.order ?? b.createdAt));
                if(currentView === 'grid') renderGrid(); else renderDetails();
            });
            updateRoleUI();
        };
        init();
    </script>
</body>
</html>
