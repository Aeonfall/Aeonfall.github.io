<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aeonfall - Lineages & Heritage Archives</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Roboto+Slab:wght@300;400;700&family=Special+Elite&family=MedievalSharp&family=Homemade+Apple&family=Pirata+One&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Roboto Slab', serif; 
            background-color: #0c0c0c; 
            background-image: url('https://www.transparenttextures.com/patterns/dark-wood.png');
            color: #1a0f0a; 
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* THE MASTER PARCHMENT - RESPONSIVE PADDING & CLIP */
        .parchment-container {
            max-width: 1300px;
            margin: 10px auto;
            background: #f4edd8;
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            box-shadow: 0 50px 100px rgba(0,0,0,0.8), inset 0 0 100px rgba(0,0,0,0.1);
            border-radius: 4px;
            position: relative;
            padding: clamp(40px, 6vw, 60px) clamp(15px, 5vw, 50px);
            border: 1px solid #dcd1b2;
            /* Adaptive clip-path: simplified for mobile */
            clip-path: polygon(0% 0%, 100% 0%, 100% 1%, 99% 50%, 100% 99%, 99% 100%, 1% 99%, 0% 98%, 1% 50%, 0% 1%);
            perspective: 2000px;
        }

        /* HEADER & BRANDING */
        .brand-title { font-family: 'Cinzel', serif; font-weight: 900; color: #7a1d1d; font-size: clamp(1.5rem, 4vw, 2.2rem); line-height: 1; }
        .brand-sub { font-family: 'Cinzel', serif; font-size: 8px; color: #5d4037; letter-spacing: 0.15em; text-transform: uppercase; font-weight: bold; }
        
        .role-pill { background: rgba(0,0,0,0.05); border-radius: 99px; padding: 3px; display: flex; gap: 4px; border: 1px solid rgba(0,0,0,0.1); position: relative; z-index: 100; }
        .role-tab { padding: 4px 12px; font-family: 'Cinzel', serif; font-size: 8px; font-weight: 900; border-radius: 99px; transition: 0.3s; color: #5d4037; text-transform: uppercase; cursor: pointer; white-space: nowrap; }
        .role-tab.active { background: #7a1d1d; color: white; box-shadow: 0 4px 10px rgba(122, 29, 29, 0.3); }

        /* DASHBOARD GRID */
        .grid-container { 
            display: grid; 
            grid-template-cols: repeat(auto-fill, minmax(min(100%, 360px), 1fr)); 
            gap: 20px; 
            padding: 20px 0; 
        }

        .race-card {
            background: #fff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
            display: flex;
            flex-direction: column;
            height: 340px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .race-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.2); }
        
        .card-bg-image { position: absolute; top: 0; right: 0; width: 55%; height: 100%; z-index: 1; }
        .card-bg-image img, .card-bg-image video { width: 100%; height: 100%; object-fit: cover; filter: sepia(0.1) contrast(1.1); }

        .card-text-panel {
            position: relative;
            z-index: 2;
            width: 75%;
            height: 100%;
            background: linear-gradient(to right, white 80%, rgba(255,255,255,0));
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .card-name { font-family: 'Cinzel', serif; font-size: 20px; font-weight: 900; color: #1a1a1a; margin-bottom: 2px; }
        .card-subtitle { font-family: 'Cinzel', serif; font-size: 9px; font-style: italic; color: #888; margin-bottom: 10px; }
        .card-desc { font-size: 11px; color: #444; line-height: 1.4; margin-bottom: 12px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .card-traits-label { font-family: 'Cinzel', serif; font-size: 10px; font-weight: 900; color: #1a1a1a; margin-bottom: 4px; }
        .card-traits-list { font-size: 10px; color: #555; line-height: 1.4; flex-grow: 1; }

        .view-btn {
            background: #f59e0b;
            color: white;
            font-family: 'Cinzel', serif;
            font-weight: 900;
            font-size: 10px;
            text-transform: uppercase;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            width: 100%;
            max-width: 180px;
            margin-top: auto;
            box-shadow: 0 4px 0 #d97706;
            position: relative;
            z-index: 5;
        }

        /* 3D FLIP CONTAINER */
        .flip-wrapper {
            position: relative;
            width: 100%;
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
            min-height: 600px;
        }
        .flip-wrapper.flipped { transform: rotateY(180deg); }
        .side-front, .side-back { width: 100%; backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        .side-back { position: absolute; top: 0; left: 0; transform: rotateY(180deg); }
        .flipped .side-front { visibility: hidden; } 

        /* DM STICKY NOTE - RESPONSIVE */
        .dm-sticky-note {
            position: absolute; width: 180px; min-height: 120px; background: #fff;
            padding: 20px 15px; box-shadow: 5px 10px 30px rgba(0,0,0,0.25); z-index: 500; font-family: 'Homemade Apple', cursive; font-size: 12px;
            color: #2c1810; transform: rotate(2deg); cursor: grab; user-select: none;
        }
        @media (max-width: 1024px) { .dm-sticky-note { position: relative !important; left: 0 !important; top: 0 !important; width: 100%; margin-bottom: 20px; transform: none; } }

        /* TABLES & LEDGERS */
        .mech-box { background: rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.1); padding: 15px; margin-top: 20px; border-radius: 4px; }
        .prog-table { width: 100%; border-collapse: collapse; font-family: 'Special Elite', cursive; font-size: 12px; margin: 15px 0; }
        .prog-table th { font-family: 'Cinzel', serif; font-size: 9px; color: #7a1d1d; border-bottom: 2px solid #7a1d1d; padding: 8px 4px; text-align: left; }
        .prog-table td { padding: 6px 4px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        
        .culture-ledger { display: grid; grid-template-cols: 1fr; gap: 30px; margin-top: 20px; }
        @media (min-width: 1024px) { .culture-ledger { grid-template-cols: 1.5fr 1fr; gap: 40px; } }

        .record-header { display: grid; grid-template-cols: 1fr; gap: 30px; margin-bottom: 30px; align-items: start; }
        @media (min-width: 1024px) { .record-header { grid-template-cols: 1fr 1.2fr; gap: 60px; } }

        .record-title { font-family: 'Pirata One', cursive; font-size: clamp(2.2rem, 7vw, 4.5rem); color: #1a0f0a; line-height: 0.9; margin-bottom: 5px; text-transform: uppercase; word-wrap: break-word; }
        .record-label { font-family: 'Cinzel', serif; font-size: clamp(8px, 1.8vw, 10px); font-weight: 900; color: #7a1d1d; text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 8px; display: inline-block; margin-bottom: 20px; }

        .research-findings { font-family: 'Special Elite', cursive; font-size: clamp(14px, 2.5vw, 16px); line-height: 1.6; color: #1a0f0a; padding: 20px; border: 1px dashed rgba(0,0,0,0.2); background: rgba(0,0,0,0.02); margin: 30px 0; }
        .drop-cap { float: left; font-family: 'Pirata One', cursive; font-size: clamp(60px, 10vw, 80px); line-height: clamp(50px, 8vw, 60px); padding-top: 4px; padding-right: 8px; color: #7a1d1d; }

        .back-nav { display: inline-flex; align-items: center; gap: 8px; color: #7a1d1d; font-weight: 900; font-size: 9px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; cursor: pointer; position: relative; z-index: 100; }

        .ornate-corner { position: absolute; width: 25px; height: 25px; opacity: 0.12; color: #7a1d1d; pointer-events: none; }
        .tl { top: 10px; left: 10px; }
        .br { bottom: 10px; right: 10px; transform: rotate(180deg); }

        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1a0f0a; color: #f4edd8; padding: 10px 24px; border-radius: 40px; z-index: 10000; font-family: 'Cinzel'; font-size: 10px; font-weight: 900; border: 1px solid #7a1d1d; pointer-events: none; opacity: 0; transition: 0.3s; }

        .term-hover { position: relative; border-bottom: 1px dotted #7a1d1d; cursor: help; display: inline; }
        .tooltip-content {
            visibility: hidden; width: 200px; background-color: #fdfaf3; color: #2c1810;
            text-align: left; border: 2px solid #7a1d1d; border-radius: 6px; padding: 8px;
            position: absolute; z-index: 1000; bottom: 125%; left: 50%; transform: translateX(-50%);
            opacity: 0; transition: opacity 0.3s; font-size: 11px; line-height: 1.4;
            font-family: 'Roboto Slab', serif; box-shadow: 0 5px 15px rgba(0,0,0,0.3); pointer-events: none; font-style: normal;
        }
        .term-hover:hover .tooltip-content { visibility: visible; opacity: 1; }
        
        /* Mobile Overrides */
        @media (max-width: 640px) {
            .parchment-container { margin: 5px auto; clip-path: none; border-radius: 8px; }
            .side-back { position: relative; transform: none; top: auto; left: auto; }
            .flip-wrapper.flipped { transform: none; }
            #btn-flip { display: none; } 
            .ledger-list li { flex-direction: column; gap: 2px; }
        }
    </style>
</head>
<body>

    <div id="toast" class="toast">DM Message</div>

    <div class="parchment-container" id="parchment">
        <div class="ornate-corner tl"><svg viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="2"><path d="M10,10 Q30,10 30,40 T60,60 T90,90 M10,10 Q10,30 40,30 T60,60"/></svg></div>
        <div class="ornate-corner br"><svg viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="2"><path d="M10,10 Q30,10 30,40 T60,60 T90,90 M10,10 Q10,30 40,30 T60,60"/></svg></div>

        <!-- HEADER -->
        <header class="flex flex-col md:flex-row justify-between items-center gap-4 relative z-[200] mb-6 pb-4 border-b border-black/10">
            <div class="flex flex-col items-center md:items-start text-center md:text-left">
                <h1 class="brand-title">Aeonfall</h1>
                <p class="brand-sub">Heritage Archives</p>
            </div>

            <div class="flex flex-wrap justify-center items-center gap-4 md:gap-8">
                <div class="role-pill">
                    <div id="role-player" onclick="window.setRole('player')" class="role-tab active">Player</div>
                    <div id="role-dm" onclick="window.setRole('dm')" class="role-tab">DM</div>
                </div>
                <a href="playershandbook.html" class="text-[9px] font-black uppercase tracking-widest text-[#7a1d1d] hover:text-black transition-colors">‚Üê Hub</a>
            </div>
        </header>

        <!-- DASHBOARD VIEW -->
        <div id="view-grid">
            <div class="flex flex-col sm:flex-row justify-between items-center sm:items-end mb-4 gap-4">
                <div class="text-center sm:text-left">
                    <h2 class="font-serif text-lg md:text-xl font-black uppercase text-[#1a0f0a]">Biological Stacks</h2>
                    <p class="text-[7px] md:text-[8px] text-[#5d4037] tracking-[0.2em] uppercase font-bold">Bio-Data Records</p>
                </div>
                <button id="add-record-btn" onclick="window.addRecord()" class="hidden bg-[#7a1d1d] text-[#f4edd8] px-3 py-1.5 rounded-sm font-black text-[7px] uppercase shadow-lg">+ Add Record</button>
            </div>
            
            <div id="stack-grid" class="grid-container"></div>
        </div>

        <!-- DETAIL VIEW -->
        <div id="view-details" class="hidden">
            <div class="flex flex-col sm:flex-row justify-between items-start mb-6 gap-4">
                <div onclick="window.setView('grid')" class="back-nav">‚Üê Return to Stacks</div>
                <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                    <button onclick="window.flipPage()" id="btn-flip" class="flex-grow sm:flex-grow-0 bg-[#1a0f0a] text-[#f4edd8] px-4 py-2 rounded-sm font-black text-[8px] uppercase">üìú Flip Page</button>
                    <div id="dm-controls" class="hidden flex gap-2 w-full sm:w-auto">
                        <button onclick="window.enterPinMode()" id="btn-pin-note" class="flex-grow sm:flex-grow-0 bg-amber-600 text-white px-4 py-2 rounded-sm font-black text-[8px] uppercase">üìå Pin Note</button>
                    </div>
                </div>
            </div>

            <div id="flip-container" class="flip-wrapper">
                <div class="side-front" id="details-front"></div>
                <div class="side-back" id="details-back"></div>
            </div>

            <div id="dm-bottom-controls" class="hidden flex flex-col sm:flex-row gap-3 mt-10 pt-6 border-t border-black/10">
                <button onclick="window.addSection()" class="bg-[#1a0f0a] text-[#f4edd8] px-4 py-2 rounded-sm font-black uppercase text-[9px] tracking-wider">Append Chapter</button>
                <button onclick="window.triggerDel()" class="bg-red-700/10 border border-red-700/30 text-red-700 px-4 py-2 rounded-sm font-black uppercase text-[9px] tracking-wider">Expunge Record</button>
            </div>
        </div>
    </div>

    <!-- LIGHTBOX MODAL -->
    <div id="lightbox-modal" class="fixed inset-0 z-[10000] flex flex-col items-center justify-center p-4 hidden">
        <div class="absolute inset-0 lightbox-overlay" onclick="window.closeLightbox()"></div>
        <div id="lightbox-content" class="relative z-10 w-full flex justify-center"></div>
        <button onclick="window.closeLightbox()" class="relative z-10 mt-6 bg-[#7a1d1d] text-white px-6 py-2 rounded-full font-black text-[10px] uppercase tracking-widest shadow-2xl border-2 border-white/20">Close Optical Feed</button>
    </div>

    <!-- Modals -->
    <div id="pass-modal" class="fixed inset-0 bg-black/95 flex items-center justify-center z-[5000] hidden p-4">
        <div class="bg-gray-800 p-8 rounded-2xl w-full max-w-xs border-2 border-amber-600 text-white text-center shadow-2xl">
            <h3 class="text-lg font-serif text-amber-500 font-bold mb-4 uppercase">DM Access</h3>
            <input type="password" id="dm-pass" class="w-full bg-gray-900 text-center text-xl rounded-lg p-3 mb-6 border border-gray-700 text-amber-500 outline-none">
            <div class="flex flex-col gap-3">
                <button onclick="window.authDm()" class="w-full bg-amber-600 text-white py-3 rounded-xl font-bold uppercase text-[10px]">Authorize</button>
                <button onclick="document.getElementById('pass-modal').classList.add('hidden')" class="text-[9px] text-gray-500 uppercase font-black">Cancel</button>
            </div>
        </div>
    </div>

    <div id="del-modal" class="fixed inset-0 z-[6000] flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/90" onclick="document.getElementById('del-modal').classList.add('hidden')"></div>
        <div class="bg-white p-8 rounded-2xl w-full max-w-xs text-center relative z-10 shadow-2xl">
            <h3 class="text-xl font-serif font-black text-red-700 uppercase mb-4">Purge Record</h3>
            <div class="flex flex-col gap-3">
                <button id="confirm-del-btn" class="w-full bg-red-700 text-white py-3 rounded-xl font-black text-[10px] uppercase">Confirm Purge</button>
                <button onclick="document.getElementById('del-modal').classList.add('hidden')" class="w-full bg-gray-100 text-gray-400 py-2 rounded-xl font-bold uppercase text-[9px]">Cancel</button>
            </div>
        </div>
    </div>

    <div id="note-del-modal" class="fixed inset-0 z-[7000] flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/90" onclick="document.getElementById('note-del-modal').classList.add('hidden')"></div>
        <div class="bg-white p-8 rounded-2xl w-full max-w-xs text-center relative z-10 shadow-2xl">
            <h3 class="text-xl font-serif font-black text-amber-900 uppercase mb-4">Shred Note</h3>
            <div class="flex flex-col gap-2">
                <button onclick="window.confirmRemoveNote()" class="w-full bg-red-700 text-white py-3 rounded-xl font-black text-[10px] uppercase">Shred</button>
                <button onclick="document.getElementById('note-del-modal').classList.add('hidden')" class="w-full bg-gray-100 text-gray-400 py-2 rounded-xl font-bold uppercase text-[9px]">Keep</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, updateDoc, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBLN0KhcnZFKZEYyR0O-Q2mZhKr-iyh7BI", authDomain: "aeonfall-523c1.firebaseapp.com", projectId: "aeonfall-523c1", storageBucket: "aeonfall-523c1.firebasestorage.app", messagingSenderId: "716207733913", appId: "1:716207733913:web:7aac43906a70e2b5f50c08" };
        const appId = 'aeonfall-manager-v2';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const TOOLTIPS = {
            "Activation Time": "The amount of time required to initialize this script and push it to reality.",
            "Mechanum": "Technomagic Protocol: This script utilizes specialized hardware and digital distortion to warp reality through code.",
            "Concord": "Ritual Protocol: This script can be initialized through ritualistic focus, conserving internal energy reserves.",
            "Dominion": "Governs will and influence, shaping thoughts, emotions, and behavior through directed intent.",
            "Ruin": "Governs raw energy and destruction, unleashing force to damage or overwhelm.",
            "Aegis": "Governs protection, prevention, and resistance, creating wards that block or negate harm."
        };

        let lineages = [];
        let activeRole = 'player', currentView = 'grid', saveTimer = null, targetDelId = null;
        let pinMode = false, isFlipped = false;
        window.activeRaceId = null; 

        window.showToast = (m) => { const t = document.getElementById('toast'); if(t) { t.textContent=m; t.style.opacity=1; setTimeout(()=>t.style.opacity=0, 3000); } };
        window.setRole = (r) => { if(r === 'dm') document.getElementById('pass-modal').classList.remove('hidden'); else { activeRole = 'player'; updateRoleUI(); } };
        window.authDm = () => { if(document.getElementById('dm-pass').value === 'Rew4994'){ activeRole='dm'; document.getElementById('pass-modal').classList.add('hidden'); document.getElementById('dm-pass').value = ''; updateRoleUI(); } else { window.showToast("Failed Verification"); } };

        function updateRoleUI() {
            const isDM = activeRole === 'dm';
            document.getElementById('role-player').classList.toggle('active', !isDM);
            document.getElementById('role-dm').classList.toggle('active', isDM);
            document.getElementById('add-record-btn').classList.toggle('hidden', !isDM);
            const ctrl = document.getElementById('dm-controls'); if (ctrl) ctrl.classList.toggle('hidden', !isDM);
            const bCtrl = document.getElementById('dm-bottom-controls'); if (bCtrl) bCtrl.classList.toggle('hidden', !isDM);
            if(currentView === 'grid') renderGrid(); else renderDetails();
        }

        function parseAeonfallContent(text, isDM) {
            if (!text) return '';
            if (isDM) return text; 
            let html = text.replace(/&&([^&]+)&&/g, (match, content) => {
                const parts = content.split('|');
                const term = parts[0].trim();
                const definition = parts.length > 1 ? parts[1].trim() : (TOOLTIPS[term] || "No technical record found.");
                return `<span class="term-hover def-term">${term}<span class="tooltip-content">${definition}</span></span>`;
            });
            html = html.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            html = html.replace(/\*(.*?)\*/g, '<i>$1</i>');
            html = html.replace(/__(.*?)__/g, '<u>$1</u>');
            return html;
        }

        window.zoomMedia = (url) => {
            if (!url) return;
            const modal = document.getElementById('lightbox-modal');
            const content = document.getElementById('lightbox-content');
            content.innerHTML = url.includes('.mp4') ? `<video src="${url}" autoplay loop muted class="lightbox-img"></video>` : `<img src="${url}" class="lightbox-img">`;
            modal.classList.remove('hidden');
        };

        window.closeLightbox = () => { document.getElementById('lightbox-modal').classList.add('hidden'); };

        window.flipPage = () => {
            isFlipped = !isFlipped;
            document.getElementById('flip-container').classList.toggle('flipped', isFlipped);
            document.getElementById('btn-flip').innerText = isFlipped ? "üìú Flip to Biology" : "üìú Flip to Culture";
        };

        window.setView = (v, id = null) => {
            currentView = v; window.activeRaceId = id;
            document.getElementById('view-grid').classList.toggle('hidden', v !== 'grid');
            document.getElementById('view-details').classList.toggle('hidden', v !== 'details');
            pinMode = false; isFlipped = false;
            document.getElementById('flip-container')?.classList.remove('flipped');
            if(v === 'grid') renderGrid(); else renderDetails();
        };

        window.renderGrid = () => {
            const isDM = activeRole === 'dm';
            const grid = document.getElementById('stack-grid');
            grid.innerHTML = lineages.map(race => `
                <div class="race-card" onclick="window.setView('details', '${race.id}')">
                    <div class="card-bg-image">${race.gridUrl ? (race.gridUrl.includes('.mp4') ? `<video src="${race.gridUrl}" autoplay loop muted></video>` : `<img src="${race.gridUrl}">`) : '<div class="w-full h-full bg-[#e0d5ba] flex items-center justify-center text-[10px] text-gray-500 italic">SCANNING...</div>'}</div>
                    <div class="card-text-panel">
                        <h3 class="card-name">${race.name}</h3>
                        <p class="card-subtitle">Archival Biometry</p>
                        <p class="card-desc">${isDM ? (race.desc || 'No description.') : parseAeonfallContent(race.desc, false)}</p>
                        <div class="card-traits-label">${race.name} Traits</div>
                        <div class="card-traits-list truncate">${isDM ? (race.traits || 'None.') : parseAeonfallContent(race.traits, false)}</div>
                        <button class="view-btn">Consult Bio-Record</button>
                    </div>
                </div>
            `).join('');
            if(!lineages.length) grid.innerHTML = `<p class="col-span-full text-center py-20 text-[#5d4037] italic uppercase text-[10px] font-black tracking-widest">Awaiting uplink...</p>`;
        };

        window.renderDetails = () => {
            const isDM = activeRole === 'dm';
            const race = lineages.find(r => r.id === window.activeRaceId);
            if (!race) return;

            document.getElementById('details-front').innerHTML = `
                <div class="${isDM ? 'dm-active-edit' : ''}">
                    ${(isDM && race.showNote) ? `<div id="sticky-note" class="dm-sticky-note" style="left: ${race.noteX || 0}px; top: ${race.noteY || 0}px;" onmousedown="window.initNoteDrag(event)"><span class="btn-trash-note" onclick="window.removeNote(event)">‚úï</span><div class="dm-editable" contenteditable="true" oninput="window.dbUp('${race.id}', 'dmNotes', this.innerText)">${race.dmNotes || 'Note...'}</div></div>` : ''}
                    <div class="record-header">
                        <div class="flex flex-col">
                            <h2 class="record-title dm-editable" contenteditable="${isDM}" oninput="window.dbUp('${race.id}', 'name', this.innerText)">${race.name}</h2>
                            <p class="record-label">Genetic Signature ‚Ä¢ #<span class="dm-editable" contenteditable="${isDM}" oninput="window.dbUp('${race.id}', 'custodianId', this.innerText)">${race.custodianId || '994'}</span></p>
                            <div class="bg-black/5 border-l-4 border-[#7a1d1d] p-4 md:p-6 rounded-sm">
                                <h4 class="font-black uppercase text-[10px] tracking-widest text-[#7a1d1d] mb-4">Innate Parameters</h4>
                                <div class="dm-editable text-sm italic leading-relaxed" contenteditable="${isDM}" oninput="window.dbUp('${race.id}','traits',this.innerText)">${isDM ? (race.traits || 'Ancestral traits...') : parseAeonfallContent(race.traits, false)}</div>
                            </div>
                        </div>
                        <div class="record-illustration" onclick="window.zoomMedia('${race.detailUrl}')">${race.detailUrl ? (race.detailUrl.includes('.mp4') ? `<video src="${race.detailUrl}" autoplay loop muted></video>` : `<img src="${race.detailUrl}">`) : '<div class="h-64 flex items-center justify-center italic text-[#5d4037]">Visual lost</div>'}</div>
                    </div>
                    ${isDM ? `<div class="bg-black/5 p-4 rounded mb-8 grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label class="text-[9px] font-black text-amber-900">Grid Media</label><input type="text" class="w-full p-2 text-[10px]" value="${race.gridUrl||''}" oninput="window.dbUp('${race.id}', 'gridUrl', this.value)"></div><div><label class="text-[9px] font-black text-amber-900">Detail Media</label><input type="text" class="w-full p-2 text-[10px]" value="${race.detailUrl||''}" oninput="window.dbUp('${race.id}', 'detailUrl', this.value)"></div></div>` : ''}
                    <div class="research-findings dm-editable" contenteditable="${isDM}" oninput="window.dbUp('${race.id}', 'desc', this.innerText)"><span class="drop-cap">${(race.desc||"O").charAt(0)}</span>${isDM ? ((race.desc||"nce...").slice(1)) : parseAeonfallContent((race.desc||"nce...").slice(1), false)}</div>
                    <div id="additional-logs">${(race.intros || []).map((intro, idx) => `<div class="heritage-block relative"><h3 class="dm-editable" contenteditable="${isDM}" oninput="window.dbUpIntro('${race.id}', ${idx}, 'leftTitle', this.innerText)">${intro.leftTitle || 'Chapter'}</h3><div class="dm-editable font-serif leading-loose" contenteditable="${isDM}" oninput="window.dbUpIntro('${race.id}', ${idx}, 'leftText', this.innerText)">${isDM ? (intro.leftText || 'Details...') : parseAeonfallContent(intro.leftText, false)}</div>${isDM ? `<button onclick="window.removeSection('${race.id}', ${idx})" class="absolute top-0 right-0 text-red-800 text-[8px] uppercase font-black">Expunge</button>` : ''}</div>`).join('')}</div>
                </div>
            `;

            const tables = race.mechTables ? JSON.parse(race.mechTables) : [];
            document.getElementById('details-back').innerHTML = `
                <div class="${isDM ? 'dm-active-edit' : ''}">
                    <h2 class="record-title mb-6">Cultural Heritage</h2>
                    <div class="culture-ledger">
                        <ul class="ledger-list">${['cultureName', 'majorityPop', 'coreValues', 'government', 'belief', 'culturalPractices', 'attitudes'].map(f => `<li><b>${f.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}:</b> <span class="dm-editable" contenteditable="${isDM}" oninput="window.dbUp('${race.id}','${f}',this.innerText)">${isDM ? (race[f] || '...') : parseAeonfallContent(race[f], false)}</span></li>`).join('')}</ul>
                        <div class="record-illustration h-64" onclick="window.zoomMedia('${race.backMediaUrl}')">${race.backMediaUrl ? (race.backMediaUrl.includes('.mp4') ? `<video src="${race.backMediaUrl}" autoplay loop muted class="w-full h-full object-cover"></video>` : `<img src="${race.backMediaUrl}" class="w-full h-full object-cover">`) : '<div class="h-full flex items-center justify-center italic opacity-30">Visual lost</div>'}</div>
                    </div>
                    ${isDM ? `<input type="text" class="w-full p-2 text-[10px] bg-white/50 border mt-4" value="${race.backMediaUrl||''}" placeholder="Culture Media Link" oninput="window.dbUp('${race.id}', 'backMediaUrl', this.value)">` : ''}
                    <div class="mech-box mt-8">
                        <div class="flex flex-wrap justify-between items-center border-b-2 border-[#7a1d1d] mb-6 pb-2 gap-2"><h4 class="m-0 border-0">Mechanical Traits</h4>${isDM ? `<button onclick="window.addMechTable()" class="arch-btn arch-btn-add">+ Add Table</button>` : ''}</div>
                        <div class="grid grid-cols-1 gap-6">
                            <div><b class="text-[9px] uppercase text-[#7a1d1d] block mb-2 tracking-widest">Mechanical Traits</b><div class="dm-editable min-h-[40px] p-4 bg-black/5 italic text-sm" contenteditable="${isDM}" oninput="window.dbUp('${race.id}','mechTraits',this.innerText)">${isDM ? (race.mechTraits || '...') : parseAeonfallContent(race.mechTraits, false)}</div></div>
                            <div><b class="text-[9px] uppercase text-[#7a1d1d] block mb-2 tracking-widest">Rules Box</b><div class="dm-editable min-h-[40px] p-4 bg-black/5 italic text-sm" contenteditable="${isDM}" oninput="window.dbUp('${race.id}','mechDescription',this.innerText)">${isDM ? (race.mechDescription || '...') : parseAeonfallContent(race.mechDescription, false)}</div></div>
                            <div class="space-y-4">${['mechBackgrounds', 'mechLanguages', 'mechFeats', 'mechEquipment'].map(f => `<p><b>‚Ä¢ ${f.replace('mech', '').replace(/([A-Z])/g, ' $1').trim()}:</b> <span class="dm-editable italic text-sm" contenteditable="${isDM}" oninput="window.dbUp('${race.id}','${f}',this.innerText)">${isDM ? (race[f] || '...') : parseAeonfallContent(race[f], false)}</span></p>`).join('')}</div>
                        </div>
                        <div id="mech-tables-root">${tables.map((table, tIdx) => `<div class="mt-8 overflow-x-auto"><div class="flex justify-between items-center mb-2"><b class="text-[10px] uppercase text-[#7a1d1d] dm-editable" contenteditable="${isDM}" oninput="window.updateMechTableField(${tIdx}, 'title', this.innerText)">${table.title}</b>${isDM ? `<div class="flex gap-1"><button onclick="window.addTableRow(${tIdx})" class="arch-btn">+R</button><button onclick="window.addTableCol(${tIdx})" class="arch-btn">+C</button><button onclick="window.delMechTable(${tIdx})" class="arch-btn arch-btn-del">X</button></div>` : ''}</div><table class="prog-table"><thead><tr>${table.headers.map((h, hIdx) => `<th contenteditable="${isDM}" oninput="window.updateMechTableField(${tIdx}, 'headers', this.innerText, hIdx)">${h}</th>`).join('')}</tr></thead><tbody>${table.rows.map((row, rIdx) => `<tr>${row.map((cell, cIdx) => `<td contenteditable="${isDM}" oninput="window.updateMechTableField(${tIdx}, 'rows', this.innerText, rIdx, cIdx)">${isDM ? cell : parseAeonfallContent(cell, false)}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`).join('')}</div>
                    </div>
                </div>
            `;
        };

        window.enterPinMode = () => { pinMode = true; document.getElementById('parchment').classList.add('placement-active'); window.showToast("Click parchment to place note"); const placeClick = (e) => { if (!pinMode) return; const rect = document.getElementById('parchment').getBoundingClientRect(); window.placeNote(e.clientX - rect.left, e.clientY - rect.top); document.getElementById('parchment').removeEventListener('click', placeClick); }; document.getElementById('parchment').addEventListener('click', placeClick); };
        window.placeNote = async (x, y) => { pinMode = false; document.getElementById('parchment').classList.remove('placement-active'); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', window.activeRaceId), { showNote: true, noteX: x, noteY: y }); window.showToast("Note Pinned"); };
        let noteDrag = null;
        window.initNoteDrag = (e) => { if (activeRole !== 'dm' || e.target.classList.contains('btn-trash-note') || e.target.contentEditable === 'true') return; const note = e.currentTarget; const rect = note.getBoundingClientRect(); noteDrag = { el: note, offsetX: e.clientX - rect.left, offsetY: e.clientY - rect.top }; document.addEventListener('mousemove', window.handleNoteDrag); document.addEventListener('mouseup', window.stopNoteDrag); };
        window.handleNoteDrag = (e) => { if (!noteDrag) return; const container = document.getElementById('parchment').getBoundingClientRect(); let x = Math.max(0, Math.min(e.clientX - container.left - noteDrag.offsetX, container.width - 200)); let y = Math.max(0, Math.min(e.clientY - container.top - noteDrag.offsetY, container.height - 120)); noteDrag.el.style.left = `${x}px`; noteDrag.el.style.top = `${y}px`; };
        window.stopNoteDrag = async () => { if (!noteDrag) return; const x = parseInt(noteDrag.el.style.left), y = parseInt(noteDrag.el.style.top); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', window.activeRaceId), { noteX: x, noteY: y }); noteDrag = null; document.removeEventListener('mousemove', window.handleNoteDrag); document.removeEventListener('mouseup', window.stopNoteDrag); };
        window.removeNote = (e) => { e.stopPropagation(); document.getElementById('note-del-modal').classList.remove('hidden'); };
        window.confirmRemoveNote = async () => { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', window.activeRaceId), { showNote: false, dmNotes: "" }); document.getElementById('note-del-modal').classList.add('hidden'); window.showToast("Note Shredded"); };

        window.dbUp = (id, field, val) => { if (saveTimer) clearTimeout(saveTimer); saveTimer = setTimeout(() => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', id), { [field]: val }), 1000); };
        window.dbUpIntro = (id, idx, field, val) => { if (saveTimer) clearTimeout(saveTimer); saveTimer = setTimeout(() => { const r = lineages.find(x => x.id === id); if (r && r.intros) { r.intros[idx][field] = val; updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', id), { intros: r.intros }); } }, 1000); };

        window.addMechTable = async () => { const r = lineages.find(x => x.id === window.activeRaceId); const t = r.mechTables ? JSON.parse(r.mechTables) : []; t.push({ title: "NEW TABLE", headers: ["Col 1", "Col 2"], rows: [["...", "..."]] }); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', window.activeRaceId), { mechTables: JSON.stringify(t) }); };
        window.updateMechTableField = (tIdx, field, val, rOrC = null, cIdx = null) => { if (saveTimer) clearTimeout(saveTimer); saveTimer = setTimeout(async () => { const r = lineages.find(x => x.id === window.activeRaceId); const t = JSON.parse(r.mechTables); if (field === 'title') t[tIdx].title = val; else if (field === 'headers') t[tIdx].headers[rOrC] = val; else if (field === 'rows') t[tIdx].rows[rOrC][cIdx] = val; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', window.activeRaceId), { mechTables: JSON.stringify(t) }); }, 1000); };
        window.addTableRow = async (tIdx) => { const r = lineages.find(x => x.id === window.activeRaceId); const t = JSON.parse(r.mechTables); t[tIdx].rows.push(new Array(t[tIdx].headers.length).fill("...")); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', window.activeRaceId), { mechTables: JSON.stringify(t) }); };
        window.addTableCol = async (tIdx) => { const r = lineages.find(x => x.id === window.activeRaceId); const t = JSON.parse(r.mechTables); t[tIdx].headers.push("Col"); t[tIdx].rows = t[tIdx].rows.map(row => [...row, "..."]); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', window.activeRaceId), { mechTables: JSON.stringify(t) }); };
        window.delMechTable = async (tIdx) => { const r = lineages.find(x => x.id === window.activeRaceId); const t = JSON.parse(r.mechTables); t.splice(tIdx, 1); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', window.activeRaceId), { mechTables: JSON.stringify(t) }); };

        window.addRecord = async () => { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'handbookLineages'), { name: "NEW SUBJECT", gridUrl: "", detailUrl: "", backMediaUrl: "", custodianId: "994", desc: "ince...", traits: "traits...", intros: [], mechTables: "[]", createdAt: Date.now(), order: Date.now() }); };
        window.addSection = async () => { const r = lineages.find(x => x.id === window.activeRaceId); if (!r) return; const i = r.intros || []; i.push({ leftTitle: "Chapter", leftText: "Details..." }); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', r.id), { intros: i }); };
        window.removeSection = async (id, idx) => { const r = lineages.find(x => x.id === id); r.intros.splice(idx, 1); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', id), { intros: r.intros }); };
        window.triggerDel = (id = null) => { targetDelId = id || window.activeRaceId; document.getElementById('del-modal').classList.remove('hidden'); };
        document.getElementById('confirm-del-btn').onclick = async () => { if (!targetDelId) return; await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookLineages', targetDelId)); document.getElementById('del-modal').classList.add('hidden'); window.setView('grid'); };

        const init = async () => {
            await signInAnonymously(auth);
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'handbookLineages'), (snap) => {
                lineages = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (a.order ?? a.createdAt) - (b.order ?? b.createdAt));
                if(currentView === 'grid') renderGrid(); else renderDetails();
            });
            updateRoleUI();
        };
        init();
    </script>
</body>
</html>
