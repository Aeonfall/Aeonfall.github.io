<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aeonfall - Vocations & Class Registry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Roboto+Slab:wght@300;400;700&family=Special+Elite&family=MedievalSharp&family=Homemade+Apple&family=Pirata+One&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Roboto Slab', serif; 
            background-color: #0c0c0c; 
            background-image: url('https://www.transparenttextures.com/patterns/dark-wood.png');
            color: #1a0f0a; 
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* THE MASTER PARCHMENT */
        .parchment-container {
            max-width: 1300px;
            margin: 10px auto;
            background: #f4edd8;
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            box-shadow: 0 50px 100px rgba(0,0,0,0.8), inset 0 0 100px rgba(0,0,0,0.1);
            border-radius: 4px;
            position: relative;
            padding: clamp(40px, 6vw, 60px) clamp(15px, 5vw, 50px);
            border: 1px solid #dcd1b2;
            clip-path: polygon(0% 0%, 100% 0%, 100% 1%, 99% 50%, 100% 99%, 99% 100%, 1% 99%, 0% 98%, 1% 50%, 0% 1%);
            perspective: 3500px;
        }

        /* HEADER & BRANDING */
        .brand-title { font-family: 'Cinzel', serif; font-weight: 900; color: #7a1d1d; font-size: clamp(1.5rem, 4vw, 2.2rem); line-height: 1; }
        .brand-sub { font-family: 'Cinzel', serif; font-size: 8px; color: #5d4037; letter-spacing: 0.15em; text-transform: uppercase; font-weight: bold; }
        
        .role-pill { background: rgba(0,0,0,0.05); border-radius: 99px; padding: 3px; display: flex; gap: 4px; border: 1px solid rgba(0,0,0,0.1); position: relative; z-index: 100; }
        .role-tab { padding: 4px 14px; font-family: 'Cinzel', serif; font-size: 9px; font-weight: 900; border-radius: 99px; transition: 0.3s; color: #5d4037; text-transform: uppercase; cursor: pointer; white-space: nowrap; }
        .role-tab.active { background: #7a1d1d !important; color: white !important; box-shadow: 0 4px 10px rgba(122, 29, 29, 0.3); }

        /* DASHBOARD GRID */
        .grid-container { 
            display: grid; 
            grid-template-cols: repeat(auto-fill, minmax(min(100%, 380px), 1fr)); 
            gap: 20px; 
            padding: 20px 0; 
        }

        .vocation-card {
            background: #fff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
            display: flex;
            height: 420px;
            overflow: hidden;
            transition: transform 0.3s ease;
            border: 1px solid rgba(0,0,0,0.05);
            cursor: pointer;
        }
        .vocation-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.2); }
        .card-art { position: absolute; top: 0; right: 0; width: 60%; height: 100%; z-index: 1; background-size: cover; background-position: center top; }
        
        .card-info-panel { 
            position: relative; 
            z-index: 2; 
            width: 85%; 
            height: 100%; 
            background: linear-gradient(to right, white 75%, rgba(255,255,255,0)); 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
        }
        @media (min-width: 768px) { .card-info-panel { width: 65%; padding: 30px; } }

        .card-header-row { display: flex; align-items: center; margin-bottom: 8px; }
        .card-icon-box { width: 40px; height: 40px; background: #f8f4eb; border: 1px solid #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 12px; flex-shrink: 0; }
        .card-name { font-family: 'Cinzel', serif; font-size: clamp(1.2rem, 3vw, 1.8rem); font-weight: 900; color: #1a1a1a; line-height: 1; }
        .card-tagline { font-family: 'Roboto Slab', serif; font-size: 13px; font-style: italic; color: #333; font-weight: 600; margin-bottom: 10px; }
        .card-desc { font-size: 12px; color: #555; line-height: 1.4; margin-bottom: 15px; flex-grow: 1; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; }

        /* SEQUENTIAL DOSSIER */
        .dossier-stack {
            position: relative;
            width: 100%;
            min-height: 800px;
            transform-style: preserve-3d;
            background: #ede4cc;
            border-radius: 4px;
        }

        .dossier-leaf {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            transform-style: preserve-3d;
            transition: transform 1.2s cubic-bezier(0.645, 0.045, 0.355, 1);
            transform-origin: left center;
        }

        .leaf-side {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            background: #f4edd8; 
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            border-radius: 2px;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.05);
            overflow-y: auto;
            padding: clamp(20px, 5vw, 50px);
        }

        .leaf-front { z-index: 2; }
        .leaf-back { 
            z-index: 1; 
            transform: rotateY(180deg); 
            background: #ede4cc; 
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        #leaf-0 { z-index: 400; }
        #leaf-1 { z-index: 300; }
        #leaf-2 { z-index: 200; }
        #leaf-3 { z-index: 100; }

        .dossier-leaf.flipped { transform: rotateY(-180deg); z-index: 500 !important; }

        /* TITLES & RICH TEXT */
        .dossier-subject-title { font-family: 'Pirata One', cursive; font-size: clamp(3rem, 10vw, 6rem); color: #1a0f0a; line-height: 0.8; margin-bottom: 5px; text-transform: uppercase; word-wrap: break-word; }
        .dossier-subtitle { font-family: 'Cinzel', serif; font-size: clamp(8px, 2vw, 11px); font-weight: 900; color: #7a1d1d; letter-spacing: 2px; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 8px; display: inline-block; margin-bottom: 20px; }
        
        .visual-box { width: 100%; height: clamp(250px, 40vh, 450px); border: 2px solid #1a0f0a; margin: 20px 0; background: rgba(0,0,0,0.02); background-size: cover; background-position: center; }
        .drop-cap { float: left; font-family: 'Pirata One', cursive; font-size: clamp(60px, 12vw, 80px); line-height: clamp(50px, 10vw, 60px); padding-top: 4px; padding-right: 8px; color: #7a1d1d; }

        .record-header { display: grid; grid-template-cols: 1fr; gap: 30px; margin-bottom: 30px; align-items: start; }
        @media (min-width: 1024px) { .record-header { grid-template-cols: 1fr 1.2fr; gap: 40px; } }

        .archetype-box { margin-top: 30px; background: #fff; border: 2px solid #bba683; padding: clamp(15px, 4vw, 30px); border-radius: 8px; }
        .archetype-title { font-family: 'Pirata One', cursive; font-size: clamp(2.5rem, 8vw, 4rem); color: #7a1d1d; line-height: 0.8; }

        /* TABLES */
        .table-wrap { overflow-x: auto; margin: 15px 0; border: 1px solid #bba683; border-radius: 4px; background: white; }
        .prog-table { width: 100%; min-width: 350px; border-collapse: collapse; font-family: 'Special Elite', cursive; font-size: 12px; }
        .prog-table th { font-family: 'Cinzel', serif; font-size: 9px; color: #7a1d1d; border-bottom: 2px solid #7a1d1d; padding: 8px 4px; text-align: left; }
        .prog-table td { padding: 6px 4px; border-bottom: 1px solid rgba(0,0,0,0.05); }

        .trait-group { margin-bottom: 15px; }
        .trait-label { font-family: 'Cinzel', serif; font-weight: 900; font-size: 10px; color: #7a1d1d; text-transform: uppercase; display: block; }
        .trait-value { font-size: 13px; color: #1a0f0a; }

        /* TOOLTIP */
        .term-hover { border-bottom: 1px dotted #7a1d1d; color: #7a1d1d; font-weight: 900; cursor: help; position: relative; }
        .tooltip-content {
            visibility: hidden; width: 200px; background-color: #1a0f0a; color: #f4edd8;
            padding: 10px; position: absolute; z-index: 9999; bottom: 125%; left: 50%; transform: translateX(-50%);
            opacity: 0; transition: opacity 0.3s; font-size: 10px; line-height: 1.4; border: 1px solid #7a1d1d;
        }
        .term-hover:hover .tooltip-content { visibility: visible; opacity: 1; }

        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #1a0f0a; color: white; padding: 10px 24px; border-radius: 40px; z-index: 10000; font-family: 'Cinzel'; font-size: 10px; opacity: 0; transition: 0.3s; pointer-events: none; }
        
        .hidden { display: none !important; }
        .view-btn { background: #e67e22; color: white; font-family: 'Cinzel', serif; font-weight: 900; font-size: 9px; text-transform: uppercase; padding: 10px; border-radius: 4px; text-align: center; width: 100%; max-width: 180px; margin-top: 15px; box-shadow: 0 4px 0 #d35400; }
        
        /* Mobile Specific Overrides - DISABLING FLIP */
        @media (max-width: 768px) {
            .parchment-container { margin: 5px auto; clip-path: none; border-radius: 8px; }
            .dossier-stack { min-height: auto; height: auto; transform: none !important; }
            .dossier-leaf.flipped { transform: none; position: relative; }
            .dossier-leaf { position: relative; min-height: auto; height: auto; transform: none !important; }
            .leaf-side { position: relative; height: auto; transform: none !important; box-shadow: none; border-bottom: 2px dashed #bba683; padding-bottom: 40px; }
            .leaf-back, #btn-flip, .page-indicator { display: none; }
            
            /* Reading order stacking */
            .dossier-leaf#leaf-0 { z-index: 10; }
            .dossier-leaf#leaf-1 { z-index: 9; }
            .dossier-leaf#leaf-2 { z-index: 8; }
            .dossier-leaf#leaf-3 { z-index: 7; }
        }
    </style>
</head>
<body>

    <div id="toast" class="toast">Data Sync Complete</div>

    <div class="parchment-container" id="parchment">
        <!-- Decoration -->
        <svg class="ornate-corner tl" width="30" height="30" viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="2" style="position:absolute;top:10px;left:10px;opacity:0.1;color:#7a1d1d"><path d="M10,10 C30,10 20,40 50,40 C80,40 70,70 90,90" /></svg>
        <svg class="ornate-corner br" width="30" height="30" viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="2" style="position:absolute;bottom:10px;right:10px;opacity:0.1;color:#7a1d1d;transform:rotate(180deg)"><path d="M10,10 C30,10 20,40 50,40 C80,40 70,70 90,90" /></svg>

        <header class="flex flex-col md:flex-row justify-between items-center gap-4 relative z-[200] mb-8 pb-4 border-b border-black/10">
            <div class="flex flex-col items-center md:items-start text-center md:text-left">
                <h1 class="brand-title">Aeonfall</h1>
                <p class="brand-sub">Class Registry archives</p>
            </div>
            <div class="flex flex-wrap justify-center items-center gap-4 md:gap-8">
                <div class="role-pill">
                    <div id="role-player" onclick="window.setRole('player')" class="role-tab active">Player</div>
                    <div id="role-dm" onclick="window.setRole('dm')" class="role-tab">DM</div>
                </div>
                <a href="playershandbook.html" class="text-[9px] font-black uppercase tracking-widest text-[#7a1d1d] hover:text-black transition-colors relative z-[210]">‚Üê Back to Hub</a>
            </div>
        </header>

        <div id="view-grid">
            <div class="flex flex-col sm:flex-row justify-between items-center sm:items-end mb-4 gap-4">
                <div class="text-center sm:text-left">
                    <h2 class="font-serif text-lg md:text-xl font-black uppercase text-[#1a0f0a]">Authorized Vocations</h2>
                    <p class="text-[7px] md:text-[8px] text-[#5d4037] tracking-[0.2em] uppercase font-bold">Class Database</p>
                </div>
                <button id="add-record-btn" onclick="window.addVocation()" class="hidden bg-[#7a1d1d] text-[#f4edd8] px-3 py-1.5 rounded-sm font-black text-[7px] uppercase shadow-lg">+ Register Vocation</button>
            </div>
            <div id="vocation-grid" class="grid-container"></div>
        </div>

        <div id="view-details" class="hidden">
            <div class="flex flex-col sm:flex-row justify-between items-start mb-6 gap-4 relative z-[3000]">
                <div onclick="window.setView('grid')" class="flex items-center gap-2 text-[#7a1d1d] font-black text-[9px] uppercase cursor-pointer hover:underline tracking-widest">
                    ‚Üê Return to Stacks
                </div>
                <button onclick="window.flipPage()" id="btn-flip" class="w-full sm:w-auto bg-[#1a0f0a] text-[#f4edd8] px-4 py-2 rounded-sm font-black text-[8px] uppercase">üìú Flip Page</button>
            </div>

            <div id="dossier-book" class="dossier-stack">
                <div id="leaf-0" class="dossier-leaf">
                    <div class="leaf-side leaf-front" id="content-intro"></div>
                    <div class="leaf-side leaf-back"><div class="font-serif italic opacity-30 text-center w-full">Vocation Overview Registry</div></div>
                </div>
                <div id="leaf-1" class="dossier-leaf">
                    <div class="leaf-side leaf-front" id="content-features"></div>
                    <div class="leaf-side leaf-back"><div class="font-serif italic opacity-30 text-center w-full">Core Mechanics Database</div></div>
                </div>
                <div id="leaf-2" class="dossier-leaf">
                    <div class="leaf-side leaf-front" id="content-archetypes"></div>
                    <div class="leaf-side leaf-back"><div class="font-serif italic opacity-30 text-center w-full">Evolution & Progression</div></div>
                </div>
                <div id="leaf-3" class="dossier-leaf">
                    <div class="leaf-side leaf-front" id="content-scripts"></div>
                    <div class="leaf-side leaf-back"><div class="font-serif italic opacity-30 text-center w-full">End of Bio-Record</div></div>
                </div>
            </div>

            <div class="page-indicator mt-8 text-center font-black text-[9px] text-[#7a1d1d] opacity-50 uppercase tracking-widest" id="page-num">SEGMENT 01 / 04</div>

            <div id="dm-bottom-controls" class="hidden flex flex-wrap gap-3 mt-10 pt-6 border-t border-black/10">
                <button onclick="window.addLoreBlock()" class="arch-btn arch-btn-add">üìë Chapter</button>
                <button onclick="window.addScriptTier()" class="arch-btn arch-btn-add">üß™ Scripts</button>
                <button onclick="window.triggerDel()" class="arch-btn arch-btn-del">üíÄ Expunge</button>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="pass-modal" class="fixed inset-0 bg-black/95 flex items-center justify-center z-[5000] hidden p-4">
        <div class="bg-gray-800 p-8 rounded-2xl w-full max-w-xs border-2 border-amber-600 text-white text-center shadow-2xl">
            <h3 class="text-lg font-serif text-amber-500 font-bold mb-4 uppercase">Authorize</h3>
            <input type="password" id="dm-pass" class="w-full bg-gray-900 text-center text-xl rounded-lg p-3 mb-6 border border-gray-700 outline-none">
            <button onclick="window.authDm()" class="w-full bg-amber-600 text-white py-3 rounded-xl font-bold uppercase text-[10px]">Verify</button>
            <button onclick="document.getElementById('pass-modal').classList.add('hidden')" class="text-[9px] text-gray-500 uppercase font-black mt-4 block">Cancel</button>
        </div>
    </div>

    <div id="del-modal" class="fixed inset-0 z-[6000] flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/90" onclick="document.getElementById('del-modal').classList.add('hidden')"></div>
        <div class="bg-white p-8 rounded-2xl w-full max-w-xs text-center relative z-10 shadow-2xl">
            <h3 class="text-xl font-serif font-black text-red-700 uppercase mb-4">Confirm Purge</h3>
            <button id="confirm-del-btn" class="w-full bg-red-700 text-white py-3 rounded-xl font-black text-[10px] uppercase shadow-lg mb-2">Expunge</button>
            <button onclick="document.getElementById('del-modal').classList.add('hidden')" class="w-full bg-gray-100 text-gray-400 py-2 rounded-xl font-bold uppercase text-[9px]">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, updateDoc, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBLN0KhcnZFKZEYyR0O-Q2mZhKr-iyh7BI", authDomain: "aeonfall-523c1.firebaseapp.com", projectId: "aeonfall-523c1", storageBucket: "aeonfall-523c1.firebasestorage.app", messagingSenderId: "716207733913", appId: "1:716207733913:web:7aac43906a70e2b5f50c08" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'aeonfall-manager-v2';

        let vocations = [];
        let activeRole = 'player', currentView = 'grid', currentPage = 0, activeVocId = null;
        let userAuth = null, saveTimer = null, deleteCallback = null, activeEditId = null;

        window.setEditing = (id) => { activeEditId = id; };
        window.clearEditing = () => { activeEditId = null; };

        window.parseAeonfallContent = function(text, isDM) {
            if (!text) return '';
            if (isDM && activeEditId !== null) return text; 
            let html = text.replace(/&&([^&]+)&&/g, (match, content) => {
                const parts = content.split('|');
                const term = parts[0].trim();
                const definition = parts.length > 1 ? parts[1].trim() : "No technical record found.";
                return `<span class="term-hover def-term">${term}<span class="tooltip-content">${definition}</span></span>`;
            });
            html = html.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            html = html.replace(/\*(?!\*)([^\*]+?)\*(?!\*)/g, '<i>$1</i>');
            html = html.replace(/__(.*?)__/g, '<u>$1</u>');
            html = html.replace(/\\column/g, '<span class="inline-block w-8">&nbsp;</span>');
            return html;
        };

        window.parseScriptList = function(text, isDM) {
            if (!text) return isDM ? 'Input scripts...' : '';
            if (isDM && activeEditId !== null) return text;
            const lines = text.split('\n').filter(l => l.trim() !== '');
            return `<div class="grid grid-cols-1 sm:grid-cols-2 gap-2">${lines.map(name => `<span class="text-xs font-bold text-[#7a1d1d] underline decoration-dotted cursor-pointer hover:text-amber-600 truncate">${name.trim()}</span>`).join('')}</div>`;
        };

        window.setRole = (r) => { if(r === 'dm') document.getElementById('pass-modal')?.classList.remove('hidden'); else { activeRole = 'player'; localStorage.setItem('aeonfall_role', 'player'); window.updateRoleUI(); } };
        window.authDm = () => { if(document.getElementById('dm-pass').value === 'Rew4994') { activeRole='dm'; localStorage.setItem('aeonfall_role', 'dm'); document.getElementById('pass-modal')?.classList.add('hidden'); document.getElementById('dm-pass').value=''; window.updateRoleUI(); } else { window.showToast("Authority Refused"); } };

        window.updateRoleUI = () => {
            const isDM = activeRole === 'dm';
            document.getElementById('role-player')?.classList.toggle('active', !isDM);
            document.getElementById('role-dm')?.classList.toggle('active', isDM);
            document.getElementById('add-record-btn')?.classList.toggle('hidden', !isDM);
            document.getElementById('dm-bottom-controls')?.classList.toggle('hidden', !isDM);
            document.body.classList.toggle('dm-active-edit', isDM);
            if(currentView === 'grid') window.renderGrid(); else window.renderDetails();
        };

        window.setView = (v, id = null) => {
            currentView = v; activeVocId = id; currentPage = 0;
            document.getElementById('view-grid')?.classList.toggle('hidden', v !== 'grid');
            document.getElementById('view-details')?.classList.toggle('hidden', v !== 'details');
            if(v === 'grid') window.renderGrid(); else window.renderDetails();
            window.scrollTo(0,0);
        };

        window.flipPage = () => {
            currentPage = (currentPage + 1) % 4;
            for(let i=0; i<4; i++) { document.getElementById(`leaf-${i}`)?.classList.toggle('flipped', i < currentPage); }
            document.getElementById('page-num').innerText = `SEGMENT 0${currentPage + 1} / 04`;
            window.scrollTo(0,0);
        };

        window.dbUp = (field, val) => {
            if(!activeVocId || !userAuth) return;
            if(saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(async () => { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookVocations', activeVocId), { [field]: val }); window.showToast("Sync"); }, 1000);
        };

        window.updateLoreField = (idx, field, val) => {
            if(saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(async () => {
                const voc = vocations.find(x => x.id === activeVocId);
                const blocks = JSON.parse(voc.loreBlocks || '[]');
                blocks[idx][field] = val;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookVocations', activeVocId), { loreBlocks: JSON.stringify(blocks) });
            }, 1000);
        };

        window.updateTableField = (tIdx, field, val, aIdx = null, idx1 = null, idx2 = null) => {
            if(saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(async () => {
                const v = vocations.find(x => x.id === activeVocId);
                if(aIdx !== null) {
                    const archs = JSON.parse(v.archetypes || '[]');
                    if(field === 'title') archs[aIdx].tables[tIdx].title = val;
                    else if(field === 'headers') archs[aIdx].tables[tIdx].headers[idx1] = val;
                    else if(field === 'rows') archs[aIdx].tables[tIdx].rows[idx1][idx2] = val;
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookVocations', activeVocId), { archetypes: JSON.stringify(archs) });
                } else {
                    const tbs = JSON.parse(v.tables || '[]');
                    if(field === 'title') tbs[tIdx].title = val;
                    else if(field === 'headers') tbs[tIdx].headers[idx1] = val;
                    else if(field === 'rows') tbs[tIdx].rows[idx1][idx2] = val;
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookVocations', activeVocId), { tables: JSON.stringify(tbs) });
                }
            }, 1000);
        };

        window.renderTableHtml = (table, tIdx, isDM, aIdx = null) => {
            return `<div class="mt-6"><b class="text-[9px] uppercase text-[#7a1d1d] dm-editable" contenteditable="${isDM}" onblur="window.updateTableField(${tIdx}, 'title', this.innerText, ${aIdx})">${table.title}</b><div class="table-wrap"><table class="prog-table"><thead><tr>${table.headers.map((h, hi) => `<th contenteditable="${isDM}" onblur="window.updateTableField(${tIdx}, 'headers', this.innerText, ${aIdx}, ${hi})">${h}</th>`).join('')}</tr></thead><tbody>${table.rows.map((row, ri) => `<tr>${row.map((c, ci) => `<td contenteditable="${isDM}" onblur="window.updateTableField(${tIdx}, 'rows', this.innerText, ${aIdx}, ${ri}, ${ci})">${isDM ? c : window.parseAeonfallContent(c, false)}</td>`).join('')}</tr>`).join('')}</tbody></table></div></div>`;
        };

        window.renderGrid = () => {
            const grid = document.getElementById('vocation-grid');
            if (!grid) return;
            grid.innerHTML = vocations.map(v => `
                <div class="vocation-card" onclick="window.setView('details', '${v.id}')">
                    <div class="card-art" style="background-image: url('${v.artUrl || ''}')"></div>
                    <div class="card-info-panel">
                        <div class="card-header-row"><div class="card-icon-box">${v.icon || 'üõ°Ô∏è'}</div><div><h3 class="card-name">${v.name}</h3><span class="text-[8px] italic text-gray-400">Class Record</span></div></div>
                        <div class="h-[2px] bg-amber-600 mb-4 w-full"></div>
                        <div class="card-tagline">${v.tagline}</div>
                        <p class="card-desc">${v.desc}</p>
                        <div class="text-[10px] space-y-1"><div><b>Primary:</b> ${v.primaryAbility}</div><div><b>Die:</b> ${v.hitDie}</div></div>
                        <div class="view-btn">Consult Record</div>
                    </div>
                </div>
            `).join('');
        };

        window.renderDetails = () => {
            const v = vocations.find(x => x.id === activeVocId); if(!v) return;
            const isDM = activeRole === 'dm';

            document.getElementById('content-intro').innerHTML = `
                <h2 class="dossier-subject-title dm-editable" contenteditable="${isDM}" onblur="window.dbUp('name', this.innerText)">${v.name}</h2>
                <div class="dossier-subtitle">Signature Verified ‚Ä¢ Custodian #<span class="dm-editable" contenteditable="${isDM}" onblur="window.dbUp('custodianId', this.innerText)">${v.custodianId || '994'}</span></div>
                <div class="dm-editable italic text-xs text-[#3e2723] mb-4" contenteditable="${isDM}" onblur="window.dbUp('tagline', this.innerText)">${v.tagline}</div>
                <div class="visual-box" style="background-image: url('${v.detailArtUrl || v.artUrl}')"></div>
                ${isDM ? `<div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-6"><input type="text" class="p-2 border text-[9px]" value="${v.artUrl}" oninput="window.dbUp('artUrl', this.value)" placeholder="Grid Art"><input type="text" class="p-2 border text-[9px]" value="${v.detailArtUrl}" oninput="window.dbUp('detailArtUrl', this.value)" placeholder="Detail Art"></div>` : ''}
                <div class="research-body text-sm leading-relaxed dm-editable" contenteditable="${isDM}" onblur="window.dbUp('intro', this.innerHTML)">${isDM ? v.intro : window.parseAeonfallContent(v.intro, false)}</div>
                <div class="mt-8">${JSON.parse(v.loreBlocks || '[]').map((b, i) => `<div class="mb-6"><div class="flex justify-between items-center"><b class="text-sm font-serif uppercase dm-editable" contenteditable="${isDM}" onblur="window.updateLoreField(${i}, 'title', this.innerText)">${b.title}</b>${isDM ? `<button onclick="window.removeLoreBlock(${i})" class="text-red-700 text-[8px]">EXPUNGE</button>` : ''}</div><div class="research-findings text-sm dm-editable" contenteditable="${isDM}" onblur="window.updateLoreField(${i}, 'text', this.innerHTML)">${isDM ? b.text : window.parseAeonfallContent(b.text, false)}</div></div>`).join('')}</div>
            `;

            document.getElementById('content-features').innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1"><div class="dossier-section-header">Quick Build</div><div class="text-xs leading-relaxed dm-editable" contenteditable="${isDM}" onblur="window.dbUp('quickBuild', this.innerHTML)">${isDM ? v.quickBuild : window.parseAeonfallContent(v.quickBuild, false)}</div>${JSON.parse(v.tables || '[]').map((t, ti) => window.renderTableHtml(t, ti, isDM)).join('')}${isDM ? `<button onclick="window.addTable()" class="arch-btn arch-btn-add mt-4 w-full">+ Global Table</button>` : ''}</div>
                    <div class="lg:col-span-2"><div class="dossier-section-header">Core Traits</div><div class="bg-black/5 p-4 rounded mb-6">${['primaryAbility', 'hitDie', 'saves', 'skills', 'weapons', 'armor', 'equipment'].map(f => `<div class="trait-group"><span class="trait-label">${f.toUpperCase()}</span><div class="trait-value dm-editable" contenteditable="${isDM}" onblur="window.dbUp('${f}', this.innerText)">${v[f] || '...'}</div></div>`).join('')}</div><div class="dossier-section-header">Class Features</div><div class="text-sm dm-editable" contenteditable="${isDM}" onblur="window.dbUp('classFeatures', this.innerHTML)">${isDM ? v.classFeatures : window.parseAeonfallContent(v.classFeatures, false)}</div><div class="mt-6">${JSON.parse(v.featureBlocks || '[]').map((f, i) => `<div class="mb-6"><div class="flex justify-between items-center"><b class="uppercase text-sm dm-editable" contenteditable="${isDM}" onblur="window.updateFeatureField(${i}, 'title', this.innerText)">${f.title}</b>${isDM ? `<button onclick="window.removeFeatureBlock(${i})" class="text-red-700 text-[8px]">EXPUNGE</button>` : ''}</div><div class="text-sm italic mt-2 dm-editable" contenteditable="${isDM}" onblur="window.updateFeatureField(${i}, 'content', this.innerHTML)">${isDM ? f.content : window.parseAeonfallContent(f.content, false)}</div></div>`).join('')}${isDM ? `<button onclick="window.addFeatureBlock()" class="arch-btn arch-btn-add">+ Block</button>` : ''}</div>
                </div>
            `;

            document.getElementById('content-archetypes').innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1">${JSON.parse(v.tables || '[]').map((t, ti) => window.renderTableHtml(t, ti, isDM)).join('')}</div>
                    <div class="lg:col-span-2"><div class="flex justify-between items-center mb-6"><div class="dossier-section-header mb-0">Evolution</div>${isDM ? `<button onclick="window.addArchetype()" class="arch-btn arch-btn-add">+ Archetype</button>` : ''}</div>${JSON.parse(v.archetypes || '[]').map((a, i) => `<div class="archetype-box mb-8"><h3 class="archetype-title dm-editable" contenteditable="${isDM}" onblur="window.updateArchetypeField(${i}, 'name', this.innerText)">${a.name}</h3><div class="text-xs italic mb-4 dm-editable" contenteditable="${isDM}" onblur="window.updateArchetypeField(${i}, 'tagline', this.innerText)">${a.tagline || ''}</div><div class="text-sm dm-editable" contenteditable="${isDM}" onblur="window.updateArchetypeField(${i}, 'desc', this.innerHTML)">${isDM ? a.desc : window.parseAeonfallContent(a.desc, false)}</div>${isDM ? `<div class="flex gap-2 mt-4"><button onclick="window.addArchetypeTable(${i})" class="arch-btn">+ Tbl</button><button onclick="window.removeArchetype(${i})" class="arch-btn arch-btn-del">Delete</button></div>` : ''}${(a.tables || []).map((t, ti) => window.renderTableHtml(t, ti, isDM, i)).join('')}</div>`).join('')}</div>
                </div>
            `;

            document.getElementById('content-scripts').innerHTML = `
                <div class="flex justify-between items-center mb-6"><div class="dossier-section-header mb-0">Authorized Scripts</div>${isDM ? `<button onclick="window.addScriptTier()" class="arch-btn arch-btn-add">+ Tier</button>` : ''}</div>
                ${JSON.parse(v.scriptTiers || '[]').map((t, i) => `<div class="mb-8"><div class="flex justify-between items-center border-b border-black/10 pb-2"><b class="text-lg font-serif dm-editable" contenteditable="${isDM}" onblur="window.updateScriptTierField(${i}, 'title', this.innerText)">${t.title}</b>${isDM ? `<button onclick="window.removeScriptTier(${i})" class="text-red-700 text-[8px]">EXPUNGE</button>` : ''}</div><div class="mt-4 dm-editable" contenteditable="${isDM}" onblur="window.updateScriptTierField(${i}, 'list', this.innerText)">${isDM ? t.list : window.parseScriptList(t.list, false)}</div></div>`).join('')}
            `;
        };

        window.removeLoreBlock = async (idx) => { if(activeVocId) { const voc = vocations.find(x => x.id === activeVocId); const b = JSON.parse(voc.loreBlocks || '[]'); b.splice(idx, 1); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookVocations', activeVocId), { loreBlocks: JSON.stringify(b) }); } };
        window.removeFeatureBlock = async (idx) => { if(activeVocId) { const voc = vocations.find(x => x.id === activeVocId); const b = JSON.parse(voc.featureBlocks || '[]'); b.splice(idx, 1); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookVocations', activeVocId), { featureBlocks: JSON.stringify(b) }); } };
        window.removeArchetype = async (idx) => { if(activeVocId) { const voc = vocations.find(x => x.id === activeVocId); const a = JSON.parse(voc.archetypes || '[]'); a.splice(idx, 1); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookVocations', activeVocId), { archetypes: JSON.stringify(a) }); } };
        window.removeScriptTier = async (idx) => { if(activeVocId) { const voc = vocations.find(x => x.id === activeVocId); const t = JSON.parse(voc.scriptTiers || '[]'); t.splice(idx, 1); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookVocations', activeVocId), { scriptTiers: JSON.stringify(t) }); } };

        window.addVocation = async () => { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'handbookVocations'), { name: "NEW SUBJECT", tagline: "Tagline...", desc: "Description...", artUrl: "", icon: "üõ°Ô∏è", createdAt: Date.now() }); };
        window.addLoreBlock = async () => { if(activeVocId) { const voc = vocations.find(x => x.id === activeVocId); const b = JSON.parse(voc.loreBlocks || '[]'); b.push({title:"Research", text:"..."}); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookVocations', activeVocId), { loreBlocks: JSON.stringify(b) }); } };
        window.addFeatureBlock = async () => { if(activeVocId) { const voc = vocations.find(x => x.id === activeVocId); const b = JSON.parse(voc.featureBlocks || '[]'); b.push({title:"Feature", content:"..."}); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookVocations', activeVocId), { featureBlocks: JSON.stringify(b) }); } };
        window.addArchetype = async () => { if(activeVocId) { const voc = vocations.find(x => x.id === activeVocId); const a = JSON.parse(voc.archetypes || '[]'); a.push({name:"Archetype", tagline:"", desc:"", tables:[]}); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookVocations', activeVocId), { archetypes: JSON.stringify(a) }); } };
        window.addScriptTier = async () => { if(activeVocId) { const voc = vocations.find(x => x.id === activeVocId); const t = JSON.parse(voc.scriptTiers || '[]'); t.push({title:"Tier", list:""}); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookVocations', activeVocId), { scriptTiers: JSON.stringify(t) }); } };
        window.addTable = async () => { if(activeVocId) { const v = vocations.find(x => x.id === activeVocId); const t = JSON.parse(v.tables || '[]'); t.push({title:"Table", headers:["Lvl", "Bon"], rows:[["1", "+2"]]}); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookVocations', activeVocId), { tables: JSON.stringify(t) }); } };
        window.addArchetypeTable = async (aIdx) => { if(activeVocId) { const v = vocations.find(x => x.id === activeVocId); const a = JSON.parse(v.archetypes || '[]'); a[aIdx].tables.push({title:"Sub", headers:["Lvl", "Bon"], rows:[["3", "..."]]}); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookVocations', activeVocId), { archetypes: JSON.stringify(a) }); } };

        window.triggerDel = () => { document.getElementById('del-modal').classList.remove('hidden'); };
        document.getElementById('confirm-del-btn').onclick = async () => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookVocations', activeVocId)); window.setView('grid'); document.getElementById('del-modal').classList.add('hidden'); };

        window.showToast = (m) => { const t = document.getElementById('toast'); if(t) { t.textContent=m; t.style.opacity=1; setTimeout(()=>t.style.opacity=0, 2000); } };

        const start = async () => {
            await signInAnonymously(auth);
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'handbookVocations'), (snap) => {
                vocations = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => a.createdAt - b.createdAt);
                if(currentView === 'grid') renderGrid(); else renderDetails();
            });
            window.updateRoleUI();
        };
        start();
    </script>
</body>
</html>
