<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aeonfall - Handmade Journal of Vocations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Roboto+Slab:wght@300;400;700&family=Special+Elite&family=MedievalSharp&family=Homemade+Apple&family=Pirata+One&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Roboto Slab', serif; 
            background-color: #dcc89f; 
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            color: #2c1810; 
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        /* THE LEATHER-BOUND JOURNAL CONTAINER */
        .journal-cover {
            max-width: 1400px;
            margin: 20px auto;
            background: #8d6e63; 
            background-image: url('https://www.transparenttextures.com/patterns/dark-leather.png');
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 40px 80px rgba(62, 39, 35, 0.5);
            position: relative;
            border: 1px solid #5d4037;
        }

        .journal-cover::after {
            content: '';
            position: absolute;
            inset: 10px;
            border: 1.5px dashed rgba(255,255,255,0.15);
            pointer-events: none;
            border-radius: 6px;
        }

        .parchment-container {
            background: #f4edd8; 
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            min-height: 850px;
            padding: 70px 60px 100px 90px; 
            position: relative;
            box-shadow: inset 0 0 100px rgba(141, 110, 99, 0.15);
            border-left: 22px solid #5d4037; 
            clip-path: polygon(0% 0%, 100% 0.5%, 99.4% 50%, 100% 99.5%, 0% 100%, 0.6% 50%);
        }

        /* HEADER & BRANDING */
        .brand-title { font-family: 'Pirata One', cursive; font-weight: 400; color: #3e2723; font-size: 3.5rem; line-height: 1; margin-bottom: 5px; }
        .brand-sub { font-family: 'Cinzel', serif; font-size: 10px; color: #8d6e63; letter-spacing: 0.5em; text-transform: uppercase; font-weight: bold; }
        
        .role-pill { background: rgba(93, 64, 55, 0.08); border-radius: 99px; padding: 3px; display: flex; border: 1px solid #d7ccc8; }
        .role-tab { padding: 4px 18px; font-family: 'Cinzel', serif; font-size: 10px; font-weight: 900; border-radius: 99px; transition: 0.3s; color: #5d4037; text-transform: uppercase; cursor: pointer; }
        .role-tab.active { background: #5d4037; color: #fdfaf3; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        .grid-container { display: grid; grid-template-cols: repeat(auto-fill, minmax(400px, 1fr)); gap: 35px; padding: 25px 0; }

        .vocation-card {
            background: #fdfaf3;
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            box-shadow: 5px 8px 20px rgba(0,0,0,0.1);
            position: relative;
            display: flex;
            height: 420px;
            overflow: hidden;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s ease;
            cursor: pointer;
            border: 1px solid #e0d7c6;
        }
        .vocation-card:hover { transform: rotate(0.8deg) translateY(-8px); box-shadow: 15px 25px 45px rgba(93, 64, 55, 0.2); }
        
        .card-art { position: absolute; top: 0; right: 0; width: 55%; height: 100%; z-index: 1; filter: sepia(0.3) contrast(1.1); background-size: cover; background-position: center top; }
        .card-art::after { content: ''; position: absolute; inset: 0; background: linear-gradient(to right, #fdfaf3 10%, transparent 80%); z-index: 2; }

        .card-info-panel { position: relative; z-index: 3; width: 68%; height: 100%; padding: 35px; display: flex; flex-direction: column; background: linear-gradient(to right, #fdfaf3 90%, transparent); }

        .card-name { font-family: 'MedievalSharp', cursive; font-size: 30px; color: #2c1810; margin-bottom: 2px; }
        .card-tagline { font-family: 'Homemade Apple', cursive; font-size: 11px; color: #8d6e63; margin-bottom: 20px; }
        .card-desc { font-family: 'Special Elite', cursive; font-size: 12px; color: #5d4037; line-height: 1.6; margin-bottom: 15px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        
        .stat-line { font-size: 11px; margin-bottom: 3px; color: #3e2723; font-family: 'Cinzel', serif; font-weight: 700; text-transform: uppercase; }
        .stat-line b { color: #8d6e63; }

        .view-btn {
            background: #5d4037; color: #fdfaf3; font-family: 'Cinzel', serif; font-weight: 900; font-size: 10px; text-transform: uppercase;
            padding: 14px; border-radius: 4px; text-align: center; width: 100%; margin-top: auto; letter-spacing: 2px; border: 1px solid rgba(255,255,255,0.1);
        }

        .reorder-controls {
            position: absolute; left: 0; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 4px; z-index: 20; background: #3e2723; padding: 8px 4px; border-radius: 0 6px 6px 0; border: 1px solid rgba(255,255,255,0.1);
        }
        .reorder-btn { width: 32px; height: 38px; color: #dcc89f; font-size: 22px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .reorder-btn:hover:not(:disabled) { color: #b8860b; transform: scale(1.1); }
        .reorder-btn:disabled { opacity: 0.1; cursor: not-allowed; }

        /* 3D BOOKBOOK SYSTEM - STABILIZED */
        .dossier-stack { position: relative; width: 100%; min-height: 900px; transform-style: preserve-3d; }
        .dossier-leaf { 
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            transform-style: preserve-3d; 
            transition: transform 1.2s cubic-bezier(0.645, 0.045, 0.355, 1); 
            transform-origin: left center; 
        }
        .leaf-side { 
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            backface-visibility: hidden; 
            -webkit-backface-visibility: hidden; 
            background: #fdfaf3; 
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png'); 
            border-radius: 2px; 
            padding: 40px 60px; 
            box-shadow: inset 0 0 50px rgba(0,0,0,0.05); 
            overflow-y: auto; 
        }
        .leaf-front { z-index: 2; border-right: 1px solid rgba(0,0,0,0.1); opacity: 1; transition: opacity 0.4s; }
        .leaf-back { z-index: 1; transform: rotateY(180deg); background: #faf5eb; border-left: 1px solid rgba(0,0,0,0.1); opacity: 0; transition: opacity 0.4s; }
        
        .dossier-leaf.flipped { transform: rotateY(-180deg); z-index: 500 !important; }
        .dossier-leaf.flipped .leaf-front { opacity: 0; visibility: hidden; }
        .dossier-leaf.flipped .leaf-back { opacity: 1; visibility: visible; }

        /* RICH TEXT BOXES */
        .discovery-log-box {
            font-family: 'Special Elite', cursive; font-size: 16px; line-height: 1.8; color: #3e2723; 
            padding: 65px 45px 45px; /* Increased padding to prevent overlap */
            border: 1.5px solid #c5b3a3; background: #faf5eb; margin: 40px 0; position: relative;
            box-shadow: 10px 10px 0 rgba(141, 110, 99, 0.08);
        }
        .discovery-log-box::before {
            content: "FIELD RESEARCH LOG"; position: absolute; top: -14px; left: 25px; background: #5d4037; color: #fdfaf3;
            font-family: 'Special Elite', cursive; font-size: 11px; padding: 4px 18px; letter-spacing: 2px; border-radius: 2px;
            z-index: 10;
        }

        .finding-stamp { margin-bottom: 50px; padding-left: 30px; border-left: 3px solid #b8860b; background: rgba(184, 134, 11, 0.01); padding-top: 20px; padding-bottom: 20px; }
        .finding-header { 
            font-family: 'Special Elite', cursive; font-size: 14px; font-weight: 900; color: #fdfaf3; 
            background: #3e2723 !important; 
            display: inline-block; padding: 6px 20px; margin-bottom: 18px; text-transform: uppercase; letter-spacing: 2px; border-radius: 2px; box-shadow: 3px 3px 0 #b8860b; 
        }

        .leather-tile {
            background: #5d4037; background-image: url('https://www.transparenttextures.com/patterns/dark-leather.png'); color: #fdfaf3;
            padding: 22px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.05); border-top: 4px solid #b8860b; box-shadow: 0 8px 20px rgba(0,0,0,0.3); margin-bottom: 15px;
        }
        .leather-tile-label { font-family: 'Cinzel', serif; font-size: 10px; color: #b8860b; display: block; margin-bottom: 10px; letter-spacing: 2px; text-transform: uppercase; border-bottom: 1px solid rgba(184, 134, 11, 0.2); padding-bottom: 6px; }
        .leather-tile-value { font-family: 'Special Elite', cursive; font-size: 14px; opacity: 0.95; }

        /* THEMED TABLE STYLES - ALTERNATING ROWS */
        .prog-table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0;
            font-family: 'Special Elite', cursive; 
            font-size: 13px; 
            margin: 25px 0; 
            background: #ffffff; 
            border: 2px solid #c5b3a3; 
            box-shadow: 8px 8px 25px rgba(62, 39, 35, 0.15); 
            border-radius: 2px;
            overflow: hidden;
        }
        .prog-table th { 
            font-family: 'Cinzel', serif; 
            text-transform: uppercase; 
            font-size: 10px; 
            color: #3e2723; 
            background: rgba(141, 110, 99, 0.12); 
            border-bottom: 2px solid #3e2723; 
            border-right: 1px solid #c5b3a3;
            padding: 12px 10px; 
            text-align: left; 
            min-width: 110px; 
            font-weight: 900; 
        }
        .prog-table th:last-child { border-right: none; }
        .prog-table td { 
            padding: 10px; 
            border-bottom: 1px solid #efebe9; 
            border-right: 1px solid #efebe9;
            color: #5d4037;
        }
        .prog-table td:last-child { border-right: none; }
        /* Zebra-Striping */
        .prog-table tr:nth-child(even) td {
            background-color: rgba(141, 110, 99, 0.04);
        }
        .prog-table tr:last-child td { border-bottom: none; }

        /* SCRIPTS LOG BOX (SINGLE CONTENT) */
        .scripts-log-box {
            font-family: 'Special Elite', cursive; font-size: 15px; line-height: 1.8; color: #2c1810; 
            padding: 55px 45px 45px; /* Increased padding */
            border: 2px double #3e2723; background: #fff; margin: 50px 0 30px; position: relative;
            box-shadow: 8px 8px 25px rgba(62, 39, 35, 0.1);
        }

        /* UI ELEMENTS */
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #3e2723; color: #fdfaf3; padding: 14px 36px; border-radius: 4px; z-index: 10000; opacity: 0; transition: 0.3s; font-family: 'Cinzel'; font-size: 13px; font-weight: 900; border: 1px solid #b8860b; box-shadow: 0 10px 30px rgba(0,0,0,0.4); pointer-events: none; }
        .back-nav { font-family: 'Cinzel', serif; font-weight: 900; font-size: 11px; color: #5d4037; cursor: pointer; text-transform: uppercase; letter-spacing: 3px; }
        .back-nav:hover { color: #b8860b; }
        .ornate-corner { position: absolute; width: 22px; height: 22px; opacity: 0.25; color: #5d4037; pointer-events: none; }
        .tl { top: 18px; left: 18px; }
        .br { bottom: 18px; right: 18px; transform: rotate(180deg); }
        .page-indicator { font-family: 'Cinzel', serif; font-size: 11px; font-weight: 900; color: #8d6e63; opacity: 0.6; margin-top: 40px; text-align: center; letter-spacing: 3px; }
        .arch-btn { font-size: 9px; font-weight: 900; text-transform: uppercase; padding: 6px 14px; border-radius: 4px; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); transition: 0.2s; }
        .arch-btn-add { background: #5d4037; color: white; }
        .arch-btn-del { background: rgba(122,29,29,0.1); color: #7a1d1d; border-color: #7a1d1d; }

        .term-hover { position: relative; border-bottom: 1px dotted #8d6e63; color: #5d4037; font-weight: 900; cursor: help; display: inline-block; }
        .tooltip-content { visibility: hidden; width: 240px; background: #3e2723; color: #fdfaf3; border-radius: 4px; padding: 12px; position: absolute; z-index: 9999; bottom: 125%; left: 50%; transform: translateX(-50%); opacity: 0; transition: 0.3s; font-family: 'Roboto Slab', serif; font-size: 11px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); pointer-events: none; border: 1px solid #b8860b; }
        .term-hover:hover .tooltip-content { visibility: visible; opacity: 1; }

        .hidden { display: none !important; }
        .drop-cap { float: left; font-family: 'Pirata One', cursive; font-size: 80px; line-height: 60px; padding-top: 4px; padding-right: 12px; color: #3e2723; }
        .record-title-culture { font-family: 'Cinzel', serif; font-size: 2.6rem; font-weight: 900; color: #3e2723; letter-spacing: 6px; text-transform: uppercase; border-bottom: 4px double #b8860b; display: inline-block; margin-bottom: 35px; }

        .editable-header-stamp { 
            font-family: 'Special Elite', cursive !important; 
            background: #3e2723 !important; 
            color: white !important; 
            padding: 8px 25px !important; 
            box-shadow: 4px 4px 0 #b8860b !important;
            border-radius: 2px !important;
            display: inline-block !important;
            margin-bottom: 25px !important;
            min-width: 200px;
        }

        .purge-mode-active { outline: 4px solid #7a1d1d; background: rgba(122, 29, 29, 0.05); }
        .purge-btn-overlay { background: #7a1d1d; color: white; font-family: 'Cinzel', serif; font-weight: 900; font-size: 10px; text-transform: uppercase; padding: 12px; border-radius: 4px; text-align: center; width: 100%; margin-top: 10px; box-shadow: 0 4px 0 #4a0000; transition: 0.1s; }
        .dm-active-edit .dm-editable { background: rgba(93, 64, 55, 0.05); outline: 1px dashed #8d6e63; border-radius: 4px; padding: 2px; }
    </style>
</head>
<body>

    <div id="toast" class="toast">Archival Record Synchronized</div>

    <div class="journal-cover">
        <div class="parchment-container" id="parchment">
            <div class="ornate-corner tl"><svg viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="2"><path d="M10,10 Q30,10 30,40 T60,60 T90,90 M10,10 Q10,30 40,30 T60,60"/></svg></div>
            <div class="ornate-corner br"><svg viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="2"><path d="M10,10 Q30,10 30,40 T60,60 T90,90 M10,10 Q10,30 40,30 T60,60"/></svg></div>

            <header class="flex flex-col md:flex-row justify-between items-center gap-6 relative z-[200] mb-12 pb-8 border-b border-brown-200/20">
                <div class="flex flex-col items-center md:items-start text-center md:text-left">
                    <h1 class="brand-title">Aeonfall</h1>
                    <p class="brand-sub">Hand-Inscribed Journal of Vocations</p>
                </div>

                <div class="flex items-center gap-10">
                    <div class="role-pill">
                        <div id="role-player" onclick="window.setRole('player')" class="role-tab active">Player</div>
                        <div id="role-dm" onclick="window.setRole('dm')" class="role-tab">DM</div>
                    </div>
                    <a href="playershandbook.html" class="text-[11px] font-black uppercase tracking-[0.3em] text-[#3e2723] hover:text-[#b8860b] transition-colors relative z-[201]">‚Üê Close Journal</a>
                </div>
            </header>

            <!-- DASHBOARD -->
            <div id="view-grid">
                <div class="flex flex-col md:flex-row justify-between items-center md:items-end mb-10 gap-4">
                    <div>
                        <h2 class="font-serif text-2xl font-black uppercase text-[#3e2723] tracking-tight">Vocation Stacks</h2>
                        <p class="font-serif italic text-xs text-[#8d6e63]">Hand-Inscribed dossiers of the known paths ‚Ä¢ v6.3</p>
                    </div>
                    <div class="flex gap-3">
                        <button id="add-record-btn" onclick="window.addVocation()" class="hidden bg-[#5d4037] hover:bg-[#3e2723] text-[#fdfaf3] px-6 py-2.5 rounded-sm font-black text-[10px] uppercase shadow-lg transition-all active:scale-95 border border-white/5">+ Register Vocation</button>
                        <button id="remove-record-btn" onclick="window.togglePurgeMode()" class="hidden bg-[#d7ccc8] border border-brown-200 text-[#3e2723] hover:bg-[#bcaaa4] px-6 py-2.5 rounded-sm font-black text-[10px] uppercase shadow-md transition-all active:scale-95">Purge Records</button>
                    </div>
                </div>
                <div id="vocation-grid" class="grid-container"></div>
            </div>

            <!-- DETAIL VIEW -->
            <div id="view-details" class="hidden">
                <div class="flex justify-between items-start mb-10 relative z-[2000]">
                    <div onclick="window.setView('grid')" class="back-nav">‚Üê Close Vocation Log</div>
                    <button onclick="window.flipPage()" id="btn-flip" class="bg-[#5d4037] text-[#fdfaf3] px-8 py-3 rounded-sm font-black text-[11px] uppercase hover:bg-[#3e2723] transition-all shadow-xl border border-white/5">üìú Turn Page</button>
                </div>

                <div id="dossier-book" class="dossier-stack">
                    <div id="leaf-0" class="dossier-leaf">
                        <div class="leaf-side leaf-front" id="content-intro"></div>
                        <div class="leaf-side leaf-back"><div class="font-serif italic opacity-30 text-center w-full">Vocation Profile Registry</div></div>
                    </div>
                    <div id="leaf-1" class="dossier-leaf">
                        <div class="leaf-side leaf-front" id="content-features"></div>
                        <div class="leaf-side leaf-back"><div class="font-serif italic opacity-30 text-center w-full">Core Capability Database</div></div>
                    </div>
                    <div id="leaf-2" class="dossier-leaf">
                        <div class="leaf-side leaf-front" id="content-archetypes"></div>
                        <div class="leaf-side leaf-back"><div class="font-serif italic opacity-30 text-center w-full">Evolutionary Paths</div></div>
                    </div>
                    <div id="leaf-3" class="dossier-leaf">
                        <div class="leaf-side leaf-front" id="content-scripts"></div>
                        <div class="leaf-side leaf-back"><div class="font-serif italic opacity-30 text-center w-full">Terminal Data Block</div></div>
                    </div>
                </div>

                <div class="page-indicator" id="page-num">SEGMENT 01 / 04</div>

                <div id="dm-bottom-controls" class="hidden flex flex-wrap gap-4 mt-16 pt-10 border-t border-brown-200/20">
                    <button onclick="window.addLoreBlock()" class="arch-btn arch-btn-add">Append Observation</button>
                    <button onclick="window.addFeatureBlock()" class="arch-btn arch-btn-add">Add Feature Module</button>
                    <button onclick="window.addArchetype()" class="arch-btn arch-btn-add">Register Archetype</button>
                    <button onclick="window.addTable()" class="arch-btn arch-btn-add">+ Add Global Table</button>
                    <button onclick="window.addScriptTier()" class="arch-btn arch-btn-add">Add Script Module</button>
                    <button onclick="window.triggerDel()" class="arch-btn arch-btn-del">Purge Dossier</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="lightbox-modal" class="fixed inset-0 z-[10000] flex flex-col items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/95 backdrop-blur-md" onclick="window.closeLightbox()"></div>
        <div id="lightbox-content" class="relative z-10 flex items-center justify-center"></div>
        <button onclick="window.closeLightbox()" class="relative z-10 mt-8 bg-[#3e2723] text-[#fdfaf3] px-12 py-4 rounded-full font-black text-[13px] uppercase tracking-widest shadow-2xl">Close Viewport</button>
    </div>

    <div id="pass-modal" class="fixed inset-0 bg-black/95 flex items-center justify-center z-[5000] hidden p-4">
        <div class="bg-[#2c1810] p-12 rounded-2xl w-full max-w-sm border-2 border-[#d4a373] text-[#fdfaf3] text-center shadow-2xl relative">
            <h3 class="text-2xl font-serif text-[#d4a373] font-bold mb-6 uppercase">Master Key</h3>
            <input type="password" id="dm-pass" onkeydown="if(event.key==='Enter') window.authDm()" class="w-full bg-[#1a0f0a] text-center text-3xl rounded-lg p-4 mb-8 border border-[#5d4037] text-[#d4a373] focus:outline-none" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <button onclick="window.authDm()" class="w-full bg-[#5d4037] hover:bg-[#8d6e63] text-white py-5 rounded-xl font-black uppercase text-sm tracking-widest transition-all mb-4">Authorize</button>
            <button onclick="document.getElementById('pass-modal').classList.add('hidden')" class="text-[11px] text-[#8d6e63] uppercase font-black tracking-widest">Cancel</button>
        </div>
    </div>

    <div id="del-modal" class="fixed inset-0 z-[6000] flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/90" onclick="document.getElementById('del-modal').classList.add('hidden')"></div>
        <div class="bg-[#fdfaf3] p-12 rounded-2xl w-full max-w-sm text-center relative z-10 shadow-2xl border-4 border-red-900/20">
            <h3 class="text-3xl font-serif font-black text-red-900 uppercase mb-4">Purge Record</h3>
            <p class="text-sm text-[#5d4037] mb-10 italic">This journal entry will be permanently shredded.</p>
            <button id="confirm-del-btn" class="w-full bg-red-900 text-white py-5 rounded-xl font-black text-xs uppercase shadow-lg mb-4">Confirm Shred</button>
            <button onclick="document.getElementById('del-modal').classList.add('hidden')" class="w-full bg-white/50 text-[#8d6e63] py-3 rounded-xl font-bold uppercase text-[10px]">Abort</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, updateDoc, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBLN0KhcnZFKZEYyR0O-Q2mZhKr-iyh7BI",
            authDomain: "aeonfall-523c1.firebaseapp.com",
            projectId: "aeonfall-523c1",
            storageBucket: "aeonfall-523c1.firebasestorage.app",
            messagingSenderId: "716207733913",
            appId: "1:716207733913:web:7aac43906a70e2b5f50c08"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'aeonfall-manager-v2';

        let vocations = [];
        let activeRole = 'player', currentView = 'grid', currentPage = 0, activeVocId = null;
        let currentUser = null, saveTimer = null, targetDelId = null;
        window.isPurgeMode = false;

        window.showToast = (m) => { const t = document.getElementById('toast'); if(t){t.textContent=m; t.style.opacity=1; setTimeout(()=>t.style.opacity=0, 2000);}};
        
        window.setRole = (r) => { 
            if(r === 'dm') document.getElementById('pass-modal').classList.remove('hidden'); 
            else { activeRole = 'player'; window.isPurgeMode = false; updateRoleUI(); } 
        };

        window.authDm = () => { 
            const passInput = document.getElementById('dm-pass');
            if(passInput.value.trim() === 'Rew4994'){ 
                activeRole='dm'; document.getElementById('pass-modal')?.classList.add('hidden'); 
                passInput.value = ''; updateRoleUI(); window.showToast("Dossier Decrypted");
            } else { window.showToast("Denied"); } 
        };

        function updateRoleUI() {
            const isDM = activeRole === 'dm';
            document.getElementById('role-player')?.classList.toggle('active', !isDM);
            document.getElementById('role-dm')?.classList.toggle('active', isDM);
            document.getElementById('add-record-btn')?.classList.toggle('hidden', !isDM);
            document.getElementById('remove-record-btn')?.classList.toggle('hidden', !isDM);
            document.getElementById('dm-bottom-controls')?.classList.toggle('hidden', !isDM);
            document.body.classList.toggle('dm-active-edit', isDM);
            if(currentView === 'grid') renderGrid(); else renderDetails();
        }

        window.togglePurgeMode = () => {
            window.isPurgeMode = !window.isPurgeMode;
            document.getElementById('remove-record-btn')?.classList.toggle('bg-red-900', window.isPurgeMode);
            document.getElementById('remove-record-btn')?.classList.toggle('text-white', window.isPurgeMode);
            renderGrid();
        };

        window.parseAeonfallContent = (text, isDM) => {
            if (!text) return '';
            let html = text.replace(/&&([^&]+)&&/g, (match, content) => {
                const parts = content.split('|');
                const term = parts[0].trim();
                const definition = parts.length > 1 ? parts[1].trim() : "Technical data missing.";
                return `<span class="term-hover">${term}<span class="tooltip-content">${definition}</span></span>`;
            });
            html = html.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            html = html.replace(/\*(.*?)\*/g, '<i>$1</i>');
            html = html.replace(/__(.*?)__/g, '<u>$1</u>');
            return html;
        };

        window.renderMedia = (url, cssClass = "") => {
            if (!url) return '';
            return url.includes('.mp4') ? 
                `<video src="${url}" class="${cssClass}" autoplay loop muted></video>` : 
                `<img src="${url}" class="${cssClass}">`;
        };

        window.setView = (v, id = null) => {
            currentView = v; activeVocId = id; currentPage = 0;
            document.getElementById('view-grid').classList.toggle('hidden', v !== 'grid');
            document.getElementById('view-details').classList.toggle('hidden', v !== 'details');
            [0, 1, 2, 3].forEach(i => {
                const leaf = document.getElementById(`leaf-${i}`);
                if(leaf) {
                    leaf.classList.remove('flipped');
                    leaf.style.zIndex = (400 - (i * 100)).toString();
                }
            });
            if(v === 'grid') renderGrid(); else renderDetails();
            window.scrollTo(0,0);
        };

        window.flipPage = () => {
            currentPage = (currentPage + 1) % 4;
            for(let i=0; i<4; i++) {
                const leaf = document.getElementById(`leaf-${i}`);
                if(leaf) {
                    leaf.classList.toggle('flipped', i < currentPage);
                    if (i < currentPage) {
                        leaf.style.zIndex = (100 + (i * 100)).toString();
                    } else {
                        leaf.style.zIndex = (400 - (i * 100)).toString();
                    }
                }
            }
            document.getElementById('page-num').innerText = `SEGMENT 0${currentPage + 1} / 04`;
            const labels = ["üìú Features", "üìú Archetypes", "üìú Scripts", "üìú Profile"];
            document.getElementById('btn-flip').innerText = labels[currentPage];
            window.scrollTo(0,0);
        };

        window.dbUp = (id, field, val) => {
            if(!activeVocId || !currentUser) return;
            if(saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(() => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookVocations', id), { [field]: val }), 1000);
        };

        window.updateCollectionField = (idx, collField, field, val) => {
            if(saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(async () => {
                const v = vocations.find(x => x.id === activeVocId);
                const items = JSON.parse(v[collField] || '[]');
                items[idx][field] = val;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookVocations', activeVocId), { [collField]: JSON.stringify(items) });
            }, 800);
        };

        window.renderTableHtml = (table, tIdx, isDM, aIdx = null) => {
            return `
                <div class="mt-8 mb-4 relative group">
                    <div class="flex justify-between items-center mb-2">
                        <b class="text-[11px] uppercase text-[#3e2723] dm-editable font-black tracking-widest" contenteditable="${isDM}" oninput="window.updateTableField(${tIdx}, 'title', this.innerText, ${aIdx})">${table.title}</b>
                        ${isDM ? `
                            <div class="flex gap-1 opacity-20 group-hover:opacity-100 transition-opacity">
                                <button onclick="window.addTableRow(${tIdx}, ${aIdx})" class="bg-[#3e2723] text-white px-2 py-0.5 text-[8px] font-black uppercase rounded-sm">+R</button>
                                <button onclick="window.remTableRow(${tIdx}, ${aIdx})" class="bg-[#3e2723] text-white px-2 py-0.5 text-[8px] font-black uppercase rounded-sm">-R</button>
                                <button onclick="window.addTableCol(${tIdx}, ${aIdx})" class="bg-[#3e2723] text-white px-2 py-0.5 text-[8px] font-black uppercase rounded-sm">+C</button>
                                <button onclick="window.remTableCol(${tIdx}, ${aIdx})" class="bg-[#3e2723] text-white px-2 py-0.5 text-[8px] font-black uppercase rounded-sm">-C</button>
                                <button onclick="window.delTable(${tIdx}, ${aIdx})" class="bg-red-900 text-white px-2 py-0.5 text-[8px] font-black uppercase rounded-sm">DEL</button>
                            </div>
                        ` : ''}
                    </div>
                    <div class="overflow-x-auto w-full">
                        <table class="prog-table w-full">
                            <thead><tr>${table.headers.map((h, hIdx) => `<th contenteditable="${isDM}" oninput="window.updateTableField(${tIdx}, 'headers', this.innerText, ${aIdx}, ${hIdx})">${h}</th>`).join('')}</tr></thead>
                            <tbody>${table.rows.map((row, rIdx) => `<tr>${row.map((cell, cIdx) => `<td contenteditable="${isDM}" oninput="window.updateTableField(${tIdx}, 'rows', this.innerText, ${aIdx}, ${rIdx}, ${cIdx})">${window.parseAeonfallContent(cell, false)}</td>`).join('')}</tr>`).join('')}</tbody>
                        </table>
                    </div>
                </div>
            `;
        };

        window.renderGrid = () => {
            const isDM = activeRole === 'dm';
            const grid = document.getElementById('vocation-grid');
            if(!grid) return;
            grid.innerHTML = vocations.map((v, idx) => `
                <div class="vocation-card" onclick="!window.isPurgeMode && window.setView('details', '${v.id}')">
                    <div class="card-art">
                        ${window.renderMedia(v.artUrl, "w-full h-full object-cover")}
                    </div>
                    <div class="card-info-panel">
                        <h3 class="card-name">${v.name}</h3>
                        <p class="card-tagline">${v.tagline}</p>
                        <p class="card-desc">${isDM ? (v.desc || '...') : window.parseAeonfallContent(v.desc, false)}</p>
                        <div class="space-y-1">
                            <div class="stat-line"><b>Ability:</b> ${v.primaryAbility}</div>
                            <div class="stat-line"><b>Hit Die:</b> ${v.hitDie}</div>
                        </div>
                        ${isDM ? `<div class="reorder-controls"><button onclick="event.stopPropagation(); window.moveRecord('${v.id}', -1)" class="reorder-btn">‚Üë</button><button onclick="event.stopPropagation(); window.moveRecord('${v.id}', 1)" class="reorder-btn">‚Üì</button></div>` : ''}
                        ${window.isPurgeMode ? `<button onclick="event.stopPropagation(); window.triggerDel('${v.id}')" class="purge-btn-overlay">Purge Entry</button>` : `<button class="view-btn">Inspect Log</button>`}
                    </div>
                </div>
            `).join('');
        };

        window.renderDetails = () => {
            const v = vocations.find(x => x.id === activeVocId);
            if(!v) return;
            const isDM = activeRole === 'dm';

            // Side A: Profile
            const lore = JSON.parse(v.loreBlocks || '[]');
            document.getElementById('content-intro').innerHTML = `
                <h2 class="card-name text-6xl dm-editable" contenteditable="${isDM}" oninput="window.dbUp('${v.id}', 'name', this.innerText)">${v.name}</h2>
                <p class="stat-line border-b border-brown-200/20 pb-2 mb-6 uppercase text-[10px] font-black">Signature Verified ‚Ä¢ ID #<span class="dm-editable" contenteditable="${isDM}" oninput="window.dbUp('${v.id}', 'custodianId', this.innerText)">${v.custodianId || '994'}</span></p>
                <div class="leather-tile"><span class="leather-tile-label">Dossier Summary</span><div class="leather-tile-value dm-editable" contenteditable="${isDM}" oninput="window.dbUp('${v.id}', 'tagline', this.innerText)">${v.tagline}</div></div>
                <div class="record-illustration" onclick="window.zoomMedia('${v.detailArtUrl || v.artUrl}')">
                    <div class="sigil-overlay"></div>
                    ${window.renderMedia(v.detailArtUrl || v.artUrl, "w-full h-auto")}
                </div>
                ${isDM ? `<div class="bg-brown-100/20 p-4 rounded mb-8 grid grid-cols-2 gap-4"><div><label class="text-[9px] font-black text-[#5d4037] uppercase">Grid Profile</label><input type="text" class="w-full p-2 text-[11px] bg-white border border-brown-200 mt-1" value="${v.artUrl||''}" oninput="window.dbUp('${v.id}', 'artUrl', this.value)"></div><div><label class="text-[9px] font-black text-[#5d4037] uppercase">Detail View</label><input type="text" class="w-full p-2 text-[11px] bg-white border border-brown-200 mt-1" value="${v.detailArtUrl||''}" oninput="window.dbUp('${v.id}', 'detailArtUrl', this.value)"></div></div>` : ''}
                <div class="discovery-log-box dm-editable" contenteditable="${isDM}" oninput="window.dbUp('${v.id}', 'intro', this.innerText)">
                    <span class="drop-cap">${(v.intro||"O").charAt(0)}</span>${v.intro ? v.intro.slice(1) : ''}
                </div>
                <div id="additional-lore">
                    ${lore.map((block, idx) => `
                        <div class="finding-stamp relative">
                            <h3 class="finding-header dm-editable" contenteditable="${isDM}" oninput="window.updateCollectionField(${idx}, 'loreBlocks', 'title', this.innerText)">${block.title}</h3>
                            <div class="dm-editable text-[#5d4037] font-serif leading-loose" contenteditable="${isDM}" oninput="window.updateCollectionField(${idx}, 'loreBlocks', 'text', this.innerText)">${window.parseAeonfallContent(block.text, false)}</div>
                            ${isDM ? `<button onclick="window.removeCollectionItem(${idx}, 'loreBlocks')" class="absolute top-0 right-0 text-red-900 opacity-30 hover:opacity-100 text-[9px] uppercase font-black">Shred</button>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;

            // Side B: Capabilities
            const feats = JSON.parse(v.featureBlocks || '[]');
            const tbs = JSON.parse(v.tables || '[]');
            document.getElementById('content-features').innerHTML = `
                <h2 class="record-title-culture dm-editable" contenteditable="${isDM}" oninput="window.dbUp('${v.id}', 'headerCore', this.innerText)">${v.headerCore || 'Core Systemic Readout'}</h2>
                <div class="grid grid-cols-2 gap-4 mt-8 mb-8">
                    ${['hitDie', 'primaryAbility', 'saves', 'armor', 'weapons', 'skills'].map(f => `
                        <div class="leather-tile">
                            <span class="leather-tile-label">${f.replace(/([A-Z])/g, ' $1')}</span>
                            <div class="leather-tile-value dm-editable" contenteditable="${isDM}" oninput="window.dbUp('${v.id}', '${f}', this.innerText)">${v[f] || '...'}</div>
                        </div>
                    `).join('')}
                </div>
                <div class="discovery-log-box mb-12">
                    <b class="text-[10px] uppercase font-black text-[#5d4037] block mb-3 border-b border-brown-200">Quick Build Protocol</b>
                    <div class="dm-editable text-sm leading-relaxed italic" contenteditable="${isDM}" oninput="window.dbUp('${v.id}', 'quickBuild', this.innerText)">
                        ${window.parseAeonfallContent(v.quickBuild, false)}
                    </div>
                </div>
                <div class="bg-brown-50/30 p-8 rounded border border-brown-200 mb-12">
                    <b class="text-[10px] uppercase font-black text-[#3e2723] block mb-3 border-b border-brown-300">Vocation Evolution & Systemic Features</b>
                    <div class="dm-editable text-sm leading-relaxed" contenteditable="${isDM}" oninput="window.dbUp('${v.id}', 'classFeaturesOverview', this.innerText)">
                        ${window.parseAeonfallContent(v.classFeaturesOverview, false)}
                    </div>
                </div>
                <div class="space-y-6">
                    ${tbs.map((t, idx) => window.renderTableHtml(t, idx, isDM)).join('')}
                    ${feats.map((feat, idx) => `
                        <div class="finding-stamp relative">
                            <h3 class="finding-header dm-editable" contenteditable="${isDM}" oninput="window.updateCollectionField(${idx}, 'featureBlocks', 'title', this.innerText)">${feat.title}</h3>
                            <div class="dm-editable text-sm" contenteditable="${isDM}" oninput="window.updateCollectionField(${idx}, 'featureBlocks', 'content', this.innerText)">${window.parseAeonfallContent(feat.content, false)}</div>
                            ${isDM ? `<button onclick="window.removeCollectionItem(${idx}, 'featureBlocks')" class="absolute top-0 right-0 text-red-900 opacity-30 hover:opacity-100 text-[9px] uppercase font-black">Shred</button>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;

            // Side C: Evolution
            const archs = JSON.parse(v.archetypes || '[]');
            document.getElementById('content-archetypes').innerHTML = `
                <h2 class="record-title-culture dm-editable" contenteditable="${isDM}" oninput="window.dbUp('${v.id}', 'headerEvolution', this.innerText)">${v.headerEvolution || 'Evolutionary Paths'}</h2>
                <div class="space-y-12 mt-8">
                    ${archs.map((arch, aIdx) => `
                        <div class="leather-tile relative" style="background-image: none; background: #fff; color: #3e2723; border: 1px solid #d7ccc8;">
                            <span class="leather-tile-label" style="color: #8d6e63;">Archetype Identity</span>
                            <h3 class="card-name text-4xl mb-2 dm-editable" contenteditable="${isDM}" oninput="window.updateCollectionField(${aIdx}, 'archetypes', 'name', this.innerText)">${arch.name}</h3>
                            <div class="dm-editable text-sm opacity-80 mb-6" contenteditable="${isDM}" oninput="window.updateCollectionField(${aIdx}, 'archetypes', 'desc', this.innerText)">${window.parseAeonfallContent(arch.desc, false)}</div>
                            ${(arch.tables || []).map((t, tIdx) => window.renderTableHtml(t, tIdx, isDM, aIdx)).join('')}
                            ${isDM ? `<div class="mt-4 flex gap-2"><button onclick="window.addArchetypeTable(${aIdx})" class="bg-[#3e2723] text-white px-3 py-1 text-[8px] font-black uppercase rounded-sm">+ Add Ledger</button><button onclick="window.removeCollectionItem(${aIdx}, 'archetypes')" class="bg-red-900 text-white px-3 py-1 text-[8px] font-black uppercase rounded-sm">Purge Path</button></div>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;

            // Side D: Scripts
            const scriptTiers = JSON.parse(v.scriptTiers || '[]');
            document.getElementById('content-scripts').innerHTML = `
                <h2 class="editable-header-stamp dm-editable" contenteditable="${isDM}" oninput="window.dbUp('${v.id}', 'headerScripts', this.innerText)">${v.headerScripts || 'Terminal Scripts'}</h2>
                <div class="space-y-14 mt-8">
                    ${scriptTiers.map((tier, idx) => `
                        <div class="scripts-log-box relative">
                            <div class="absolute -top-4 left-6 z-20">
                                <h3 class="finding-header dm-editable" contenteditable="${isDM}" oninput="window.updateCollectionField(${idx}, 'scriptTiers', 'title', this.innerText)">
                                    ${tier.title || 'NEW SCRIPT MODULE'}
                                </h3>
                            </div>
                            <div class="dm-editable text-sm leading-relaxed" contenteditable="${isDM}" oninput="window.updateCollectionField(${idx}, 'scriptTiers', 'list', this.innerText)">
                                ${isDM ? (tier.list || '...') : window.parseAeonfallContent(tier.list, false)}
                            </div>
                            ${isDM ? `
                                <div class="absolute -top-3 right-4 flex gap-2 z-20">
                                    <button onclick="window.removeCollectionItem(${idx}, 'scriptTiers')" class="bg-red-900 text-white px-3 py-1 text-[8px] font-black uppercase rounded-sm">Shred Module</button>
                                </div>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        };

        window.updateTableField = (tIdx, field, val, aIdx = null, idx1 = null, idx2 = null) => {
            if(saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(async () => {
                const v = vocations.find(x => x.id === activeVocId);
                if(aIdx !== null) {
                    const archs = JSON.parse(v.archetypes || '[]');
                    if(field === 'title') archs[aIdx].tables[tIdx].title = val;
                    else if(field === 'headers') archs[aIdx].tables[tIdx].headers[idx1] = val;
                    else if(field === 'rows') archs[aIdx].tables[tIdx].rows[idx1][idx2] = val;
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookVocations', activeVocId), { archetypes: JSON.stringify(archs) });
                } else {
                    const tbs = JSON.parse(v.tables || '[]');
                    if(field === 'title') tbs[tIdx].title = val;
                    else if(field === 'headers') tbs[tIdx].headers[idx1] = val;
                    else if(field === 'rows') tbs[tIdx].rows[idx1][idx2] = val;
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookVocations', activeVocId), { tables: JSON.stringify(tbs) });
                }
            }, 800);
        };

        window.addTable = async () => {
            const v = vocations.find(x => x.id === activeVocId);
            const tbs = JSON.parse(v.tables || '[]');
            tbs.push({ title: "FIELD LEDGER", headers: ["Level", "Features"], rows: [["...", "..."]] });
            window.dbUp(activeVocId, 'tables', JSON.stringify(tbs));
        };

        window.addArchetypeTable = async (aIdx) => {
            const v = vocations.find(x => x.id === activeVocId);
            const archs = JSON.parse(v.archetypes || '[]');
            if(!archs[aIdx].tables) archs[aIdx].tables = [];
            archs[aIdx].tables.push({ title: "PATH LEDGER", headers: ["Level", "Feature"], rows: [["...", "..."]] });
            window.dbUp(activeVocId, 'archetypes', JSON.stringify(archs));
        };

        window.addTableRow = async (tIdx, aIdx = null) => {
            const v = vocations.find(x => x.id === activeVocId);
            if(aIdx !== null) {
                const archs = JSON.parse(v.archetypes || '[]');
                archs[aIdx].tables[tIdx].rows.push(new Array(archs[aIdx].tables[tIdx].headers.length).fill("..."));
                window.dbUp(activeVocId, 'archetypes', JSON.stringify(archs));
            } else {
                const tbs = JSON.parse(v.tables || '[]');
                tbs[tIdx].rows.push(new Array(tbs[tIdx].headers.length).fill("..."));
                window.dbUp(activeVocId, 'tables', JSON.stringify(tbs));
            }
        };

        window.remTableRow = async (tIdx, aIdx = null) => {
            const v = vocations.find(x => x.id === activeVocId);
            if(aIdx !== null) {
                const archs = JSON.parse(v.archetypes || '[]');
                if(archs[aIdx].tables[tIdx].rows.length > 1) {
                    archs[aIdx].tables[tIdx].rows.pop();
                    window.dbUp(activeVocId, 'archetypes', JSON.stringify(archs));
                }
            } else {
                const tbs = JSON.parse(v.tables || '[]');
                if(tbs[tIdx].rows.length > 1) {
                    tbs[tIdx].rows.pop();
                    window.dbUp(activeVocId, 'tables', JSON.stringify(tbs));
                }
            }
        };

        window.addTableCol = async (tIdx, aIdx = null) => {
            const v = vocations.find(x => x.id === activeVocId);
            if(aIdx !== null) {
                const archs = JSON.parse(v.archetypes || '[]');
                archs[aIdx].tables[tIdx].headers.push("ID");
                archs[aIdx].tables[tIdx].rows = archs[aIdx].tables[tIdx].rows.map(r => [...r, "..."]);
                window.dbUp(activeVocId, 'archetypes', JSON.stringify(archs));
            } else {
                const tbs = JSON.parse(v.tables || '[]');
                tbs[tIdx].headers.push("ID");
                tbs[tIdx].rows = tbs[tIdx].rows.map(r => [...r, "..."]);
                window.dbUp(activeVocId, 'tables', JSON.stringify(tbs));
            }
        };

        window.remTableCol = async (tIdx, aIdx = null) => {
            const v = vocations.find(x => x.id === activeVocId);
            if(aIdx !== null) {
                const archs = JSON.parse(v.archetypes || '[]');
                if(archs[aIdx].tables[tIdx].headers.length > 1) {
                    archs[aIdx].tables[tIdx].headers.pop();
                    archs[aIdx].tables[tIdx].rows = archs[aIdx].tables[tIdx].rows.map(r => r.slice(0, -1));
                    window.dbUp(activeVocId, 'archetypes', JSON.stringify(archs));
                }
            } else {
                const tbs = JSON.parse(v.tables || '[]');
                if(tbs[tIdx].headers.length > 1) {
                    tbs[tIdx].headers.pop();
                    tbs[tIdx].rows = tbs[tIdx].rows.map(r => r.slice(0, -1));
                    window.dbUp(activeVocId, 'tables', JSON.stringify(tbs));
                }
            }
        };

        window.delTable = async (tIdx, aIdx = null) => {
            const v = vocations.find(x => x.id === activeVocId);
            if(aIdx !== null) {
                const archs = JSON.parse(v.archetypes || '[]');
                archs[aIdx].tables.splice(tIdx, 1);
                window.dbUp(activeVocId, 'archetypes', JSON.stringify(archs));
            } else {
                const tbs = JSON.parse(v.tables || '[]');
                tbs.splice(tIdx, 1);
                window.dbUp(activeVocId, 'tables', JSON.stringify(tbs));
            }
        };

        window.moveRecord = async (id, direction) => {
            if (!currentUser) return;
            const index = vocations.findIndex(r => r.id === id);
            const targetIndex = index + direction;
            if (targetIndex < 0 || targetIndex >= vocations.length) return;
            const cur = vocations[index]; const tar = vocations[targetIndex];
            const curO = cur.order ?? (cur.createdAt || Date.now());
            const tarO = tar.order ?? (tar.createdAt || Date.now());
            try {
                await Promise.all([
                    updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookVocations', cur.id), { order: tarO }),
                    updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookVocations', tar.id), { order: curO })
                ]);
            } catch (err) { window.showToast("Uplink Failed"); }
        };

        window.addVocation = async () => {
            if (!currentUser) return;
            const maxOrder = vocations.length > 0 ? Math.max(...vocations.map(l => l.order || l.createdAt || 0)) : Date.now();
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'handbookVocations'), { 
                name: "NEW SUBJECT", artUrl: "", detailArtUrl: "", tagline: "Entry Summary", desc: "Short overview...", intro: "Hand-inked details...",
                hitDie: "d8", primaryAbility: "Str", saves: "Str", armor: "None", weapons: "None", skills: "None",
                quickBuild: "Initial setup details...", classFeaturesOverview: "Mechanics summary...",
                headerCore: "Core Systemic Readout", headerEvolution: "Evolutionary Paths", headerScripts: "Terminal Scripts",
                loreBlocks: "[]", featureBlocks: "[]", archetypes: "[]", scriptTiers: "[]", tables: "[]",
                createdAt: Date.now(), order: maxOrder + 1000 
            });
            window.showToast("Archive Initialized");
        };

        window.addLoreBlock = () => {
            const v = vocations.find(x => x.id === activeVocId);
            const items = JSON.parse(v.loreBlocks || '[]');
            items.push({ title: "NEW LOG ENTRY", text: "Recording technical observations..." });
            window.dbUp(activeVocId, 'loreBlocks', JSON.stringify(items));
        };

        window.addFeatureBlock = () => {
            const v = vocations.find(x => x.id === activeVocId);
            const items = JSON.parse(v.featureBlocks || '[]');
            items.push({ title: "CORE CAPABILITY", content: "Mechanism details..." });
            window.dbUp(activeVocId, 'featureBlocks', JSON.stringify(items));
        };

        window.addArchetype = () => {
            const v = vocations.find(x => x.id === activeVocId);
            const items = JSON.parse(v.archetypes || '[]');
            items.push({ name: "NEW PATH", desc: "Evolutionary divergence summary...", tables: [] });
            window.dbUp(activeVocId, 'archetypes', JSON.stringify(items));
        };

        window.addScriptTier = () => {
            const v = vocations.find(x => x.id === activeVocId);
            const items = JSON.parse(v.scriptTiers || '[]');
            items.push({ title: "NEW SCRIPT MODULE", list: "Description of script protocols..." });
            window.dbUp(activeVocId, 'scriptTiers', JSON.stringify(items));
        };

        window.removeCollectionItem = (idx, collField) => {
            const v = vocations.find(x => x.id === activeVocId);
            const items = JSON.parse(v[collField] || '[]');
            items.splice(idx, 1);
            window.dbUp(activeVocId, collField, JSON.stringify(items));
        };

        window.zoomMedia = (url) => {
            if (!url) return;
            const modal = document.getElementById('lightbox-modal');
            const content = document.getElementById('lightbox-content');
            if(!modal || !content) return;
            content.innerHTML = url.includes('.mp4') ? 
                `<video src="${url}" autoplay loop muted class="max-w-full max-h-[85vh] border-8 border-[#3e2723] rounded shadow-2xl"></video>` : 
                `<img src="${url}" class="max-w-full max-h-[85vh] border-8 border-[#3e2723] rounded shadow-2xl">`;
            modal.classList.remove('hidden');
        };

        window.closeLightbox = () => { document.getElementById('lightbox-modal')?.classList.add('hidden'); };

        window.triggerDel = (id = null) => { 
            const tid = id || activeVocId;
            if(tid) { targetDelId = tid; document.getElementById('del-modal')?.classList.remove('hidden'); }
        };
        document.getElementById('confirm-del-btn').onclick = async () => {
            if (!targetDelId || !currentUser) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'handbookVocations', targetDelId));
            document.getElementById('del-modal')?.classList.add('hidden'); window.setView('grid'); window.showToast("Purged");
        };

        const init = async () => {
            const initAuth = async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else { await signInAnonymously(auth); }
                } catch (e) { await signInAnonymously(auth); }
            };
            await initAuth();
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'handbookVocations'), (snap) => {
                        vocations = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (a.order ?? a.createdAt) - (b.order ?? b.createdAt));
                        if(currentView === 'grid') renderGrid(); else renderDetails();
                    });
                }
                updateRoleUI();
            });
        };
        init();
    </script>
</body>
</html>
