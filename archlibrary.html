<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aeonfall - Archivist's Scholar Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Roboto+Slab:wght@300;400;700&family=Special+Elite&family=MedievalSharp&family=Homemade+Apple&family=Pirata+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --arch-burgundy: #741b1b;
            --arch-gold: #c5a059;
            --arch-indigo: #312e81;
            --arch-charcoal: #121417;
            --arch-vellum: #b5a48d; /* Aged burnt parchment base */
            --arch-burnt: rgba(54, 28, 20, 0.4);
            --arch-shadow: 0 15px 40px rgba(0,0,0,0.6);
            --arch-engraved: 1px 1px 0px rgba(255,255,255,0.1), -1px -1px 0px rgba(0,0,0,0.4);
        }

        body { 
            font-family: 'Roboto Slab', serif; 
            background-color: var(--arch-charcoal); 
            background-image: 
                radial-gradient(circle at 50% 0%, rgba(49, 46, 129, 0.15) 0%, transparent 60%),
                url('https://www.transparenttextures.com/patterns/dark-leather.png');
            color: #cbd5e1; 
            min-height: 100vh;
            overflow: hidden; 
        }

        /* ACCESS TERMINAL */
        #access-terminal {
            position: fixed; inset: 0; background: rgba(2, 6, 23, 0.98); z-index: 100000;
            display: flex; align-items: center; justify-content: center; padding: 20px;
            transition: opacity 1.2s ease, transform 1.2s ease;
        }
        #access-terminal.unlocked { opacity: 0; pointer-events: none; transform: scale(1.05); }
        
        .guestbook-container {
            width: 100%; max-width: 960px; height: 680px;
            background: var(--arch-vellum); background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            box-shadow: 0 50px 150px rgba(0,0,0,0.8), 
                        inset 0 0 120px var(--arch-burnt),
                        inset 0 0 40px rgba(0,0,0,0.2);
            border: 2px solid var(--arch-gold); border-radius: 4px; display: flex; position: relative;
            transform-style: preserve-3d;
        }
        .guestbook-spine { 
            width: 65px; background: #231f20; border-left: 5px solid var(--arch-gold); 
            box-shadow: inset 10px 0 30px rgba(0,0,0,0.7);
            display: flex; align-items: center; justify-content: center;
        }
        .rune-mark { font-family: 'Cinzel'; color: var(--arch-gold); writing-mode: vertical-rl; font-size: 14px; letter-spacing: 14px; opacity: 0.7; font-weight: 900; }

        .guestbook-page { flex: 1; padding: 70px 60px; display: flex; flex-direction: column; overflow: hidden; position: relative; color: #1e293b; }
        .page-left { border-right: 1px solid rgba(0, 0, 0, 0.15); background: rgba(0,0,0,0.02); }

        .book-title { font-family: 'Cinzel', serif; font-weight: 900; color: var(--arch-burgundy); font-size: 28px; text-transform: uppercase; margin-bottom: 5px; text-align: center; letter-spacing: 2px; }
        .book-sub { font-family: 'Cinzel', serif; color: var(--arch-indigo); font-size: 9px; text-align: center; margin-bottom: 40px; text-transform: uppercase; font-weight: 900; letter-spacing: 4px; opacity: 0.8; }
        
        .ledger-line { width: 100%; border-bottom: 1px solid rgba(0, 0, 0, 0.12); padding: 18px 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.3s; }
        .ledger-line:hover { background: rgba(49, 46, 129, 0.08); border-bottom-color: var(--arch-gold); padding-left: 25px; }
        .ledger-name { font-family: 'Cinzel', serif; color: #0f172a; font-size: 18px; font-weight: 700; }

        .sign-here-input { width: 100%; background: rgba(255,255,255,0.2); border: 1px solid var(--arch-gold); font-family: 'Homemade Apple', cursive; font-size: 24px; padding: 15px; color: var(--arch-indigo); outline: none; text-align: center; transition: 0.4s; border-radius: 4px; }

        /* TACTICAL SIDEBAR TABS */
        .shelf-item {
            font-family: 'Cinzel', serif; font-size: 10px; font-weight: 900; text-transform: uppercase; color: #1e293b;
            padding: 14px 18px; margin-bottom: 10px; cursor: pointer; transition: 0.3s;
            letter-spacing: 1px; border-left: 4px solid transparent; position: relative; 
            background: rgba(255,255,255,0.2); border: 1px solid rgba(0,0,0,0.1);
            clip-path: polygon(0% 0%, 100% 0%, 98% 100%, 0% 100%);
            overflow: visible; /* Ensure badges can pop out slightly if needed, but inward is safer */
        }
        .shelf-item:hover { transform: translateX(8px); background: rgba(255,255,255,0.4); }
        .shelf-item.active { transform: translateX(12px); color: var(--arch-indigo); background: #fff; border-color: var(--arch-indigo); z-index: 10; }
        
        .shelf-item.book { border-left-color: var(--arch-burgundy); }
        .shelf-item.newspaper { border-left-color: #334155; }
        .shelf-item.manuscript { border-left-color: var(--arch-indigo); }
        .shelf-item.parchment { border-left-color: var(--arch-gold); }
        .shelf-item.textbook { border-left-color: #be123c; }

        .item-label { display: block; font-family: 'Cinzel'; font-size: 6px; letter-spacing: 1px; opacity: 0.5; margin-bottom: 2px; }
        
        /* NOTIFICATION BADGES FIXED POSITIONING */
        .new-badge { 
            position: absolute; top: 4px; right: 8px; /* Moved inward to avoid clip-path */
            background: var(--arch-burgundy); color: white; font-size: 7px; padding: 2px 6px; 
            border-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 20;
            animation: badgePulse 2s infinite; 
        }
        @keyframes badgePulse { 0%, 100% { transform: scale(1); opacity: 0.9; } 50% { transform: scale(1.1); opacity: 1; } }
        
        .personal-badge { 
            position: absolute; bottom: 4px; right: 8px; /* Moved inward */
            background: var(--arch-indigo); color: white; font-size: 7px; padding: 2px 6px; 
            border-radius: 2px; text-transform: uppercase; font-weight: 900; z-index: 20;
        }

        /* TACTICAL DRAG HANDLES */
        .drag-handle { cursor: grab; opacity: 0.4; transition: 0.2s; color: var(--arch-gold); font-size: 22px; }
        .drag-handle:hover { opacity: 1; color: var(--arch-indigo); filter: drop-shadow(0 0 5px var(--arch-gold)); }
        .section-dragging { opacity: 0.2; transform: scale(0.98); border: 2px dashed var(--arch-gold) !important; }
        
        /* TOAST SYSTEM (FIXED CLIPPING) */
        .toast { 
            position: fixed; top: 40px; left: 50%; transform: translateX(-50%); 
            background: #1e293b; color: var(--arch-gold); padding: 18px 45px; border-radius: 4px; 
            z-index: 2000000; opacity: 0; transition: 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            font-family: 'Cinzel'; font-size: 13px; font-weight: 900; pointer-events: none;
            border: 2px solid var(--arch-gold); box-shadow: var(--arch-shadow);
            letter-spacing: 2px; text-transform: uppercase;
            max-width: 85vw; text-align: center; line-height: 1.4;
        }

        /* MASTER REPOSITORY */
        .parchment-container {
            max-width: 1400px; margin: 20px auto; background: var(--arch-vellum);
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            box-shadow: 0 50px 100px rgba(0,0,0,0.8), inset 0 0 150px var(--arch-burnt);
            border-radius: 4px; position: relative; display: flex; height: calc(100vh - 40px);
            border: 1px solid #475569; box-sizing: border-box; overflow: hidden;
        }

        .manual-nav {
            width: 320px; background: rgba(0,0,0,0.15); border-right: 1px solid rgba(0,0,0,0.2);
            padding: 40px 15px; flex-shrink: 0; display: flex; flex-direction: column; height: 100%; overflow-y: auto;
        }

        .manual-body { flex-grow: 1; padding: 60px 50px; height: 100%; overflow-y: auto; overflow-x: hidden; scroll-behavior: smooth; box-sizing: border-box; }
        
        .manual-h1 { 
            font-family: 'Cinzel', serif; font-weight: 900; font-size: 3.2rem; 
            color: #000; text-shadow: var(--arch-engraved);
            margin-bottom: 20px; width: 100%; letter-spacing: 2px;
        }
        .manual-h2 { font-family: 'Cinzel', serif; font-weight: 900; font-size: 2.2rem; color: #1e1b4b; border-bottom: 4px double var(--arch-gold); padding-bottom: 10px; text-transform: uppercase; margin-bottom: 25px; width: 100%; letter-spacing: 2px; }
        .manual-h3 { font-family: 'Cinzel', serif; font-weight: 700; font-size: 1.4rem; color: var(--arch-burgundy); border-bottom: 1px solid rgba(136, 19, 55, 0.2); padding-bottom: 4px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; width: 100%; }
        
        .manual-divider { width: 100%; height: 2px; background: linear-gradient(to right, transparent, var(--arch-gold), var(--arch-purple), var(--arch-gold), transparent); margin: 35px 0; flex-shrink: 0; opacity: 0.4; filter: blur(0.5px); }

        .arch-btn { font-size: 10px; font-weight: 900; text-transform: uppercase; padding: 12px 20px; border-radius: 4px; cursor: pointer; border: 1px solid var(--arch-gold); transition: 0.3s; display: inline-flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.4); color: var(--arch-indigo); }
        .arch-btn:hover { border-color: var(--arch-indigo); color: #fff; background: var(--arch-indigo); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        .arch-dropdown { position: relative; display: inline-block; }
        .arch-dropdown-content { display: none; position: absolute; bottom: 100%; left: 0; background: #fff; min-width: 210px; box-shadow: var(--arch-shadow); border: 2px solid var(--arch-indigo); border-radius: 4px; margin-bottom: 10px; overflow: hidden; z-index: 5000; }
        .arch-dropdown.active .arch-dropdown-content { display: block; }
        .dropdown-link { padding: 12px 18px; display: block; font-size: 10px; font-weight: 900; text-transform: uppercase; color: #1e293b; border-bottom: 1px solid #f1f5f9; transition: 0.2s; cursor: pointer; }
        .dropdown-link:hover { background: var(--arch-indigo); color: white; padding-left: 22px; }

        /* ROLE PILL */
        .role-pill { background: rgba(0,0,0,0.08); border-radius: 99px; padding: 4px; display: flex; gap: 4px; border: 1px solid rgba(0,0,0,0.1); align-self: center; width: fit-content; margin: 0 auto 20px auto; }
        .role-tab { padding: 8px 24px; font-family: 'Cinzel', serif; font-size: 9px; font-weight: 900; border-radius: 99px; transition: 0.3s; color: #64748b; text-transform: uppercase; cursor: pointer; }
        .role-tab.active { background: var(--arch-indigo); color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

        /* TUNER PANEL */
        .tuner-panel { 
            background: rgba(255, 255, 255, 0.95); border: 1px solid var(--arch-gold); padding: 12px 18px; border-radius: 4px; 
            margin-bottom: 12px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; box-sizing: border-box; position: relative; z-index: 100; 
        }
        .tuner-label { font-size: 7px; font-weight: 900; text-transform: uppercase; color: var(--arch-indigo); letter-spacing: 1px; }

        #cinematic-overlay { position: fixed; inset: 0; background: #000; z-index: 90000; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.8s ease; }
        #cinematic-overlay.active { opacity: 1; pointer-events: auto; }

        .hidden { display: none !important; }
        .purge-btn { background: rgba(116, 27, 27, 0.1); color: var(--arch-burgundy); border: 1px solid var(--arch-burgundy); font-size: 7px; padding: 2px 6px; border-radius: 2px; text-transform: uppercase; font-weight: 900; transition: 0.2s; cursor: pointer; }
        .purge-btn:hover { background: var(--arch-burgundy); color: white; }
    </style>
</head>
<body onclick="window.closeAllDropdowns()">

    <div id="toast" class="toast">Signature Processed</div>

    <div id="access-terminal">
        <div class="guestbook-container">
            <div class="guestbook-spine"><div class="rune-mark">·öõ AEONFALL ·öú</div></div>
            <div class="guestbook-page page-left" id="terminal-login-view">
                <div class="book-title">Library Ledger</div>
                <div class="book-sub">Registry of Scholars ‚Ä¢ Verification Node</div>
                <input type="text" id="terminal-search" class="terminal-input !bg-white/40 !border-b !border-t-0 !border-x-0 !border-slate-400 !mb-4 !text-slate-900 !p-3 !outline-none !font-serif" placeholder="Search Character Ledger..." oninput="window.filterTerminal(this.value)">
                <div id="terminal-results" class="flex-grow overflow-y-auto pr-4"></div>
                <div class="mt-4 pt-4 border-t border-slate-400 flex flex-wrap justify-center gap-x-6 gap-y-2">
                    <button onclick="window.bypassTerminal()" class="text-[9px] font-black uppercase opacity-40 hover:opacity-100">Proceed as Guest</button>
                    <button onclick="window.proceedAsRegistered()" class="text-[9px] font-black uppercase opacity-40 hover:opacity-100">Restore Signature</button>
                    <button onclick="window.location.href='lore.html'" class="text-[9px] font-black uppercase opacity-40 hover:opacity-100 text-red-800">Return to Lore</button>
                </div>
            </div>
            <div class="guestbook-page" id="terminal-register-view">
                <div class="book-title">Register Signature</div>
                <div class="book-sub">Formal Scholar Enrollment</div>
                <div class="flex-grow flex flex-col justify-center gap-8">
                    <p class="font-serif italic text-[12px] text-slate-700 text-center px-4 leading-relaxed">"I formally submit my signature to the Archivist‚Äôs registry, anchoring my presence within the eternal Scholar‚Äôs Library. Initiating archival synchronization."</p>
                    <div class="px-6"><label class="text-[8px] uppercase font-black opacity-40 block mb-1">Character Alias (Permanent Signature)</label><input type="text" id="reg-name-input" class="sign-here-input" placeholder="Inscribe identity here..."></div>
                    <div class="flex flex-col gap-4 items-center">
                        <button id="reg-bind-btn" onclick="window.registerCitizen()" class="arch-btn !bg-[#1e1b4b] !border-[#1e1b4b] !px-12 !py-4 shadow-xl hover:!bg-[#312e81] !text-white active:scale-95 transition-all">Submit Entry</button>
                        <button onclick="window.toggleTerminalView('login')" class="text-[8px] font-black uppercase opacity-40 hover:opacity-100">Back to Ledger</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="cinematic-overlay"><div class="loading-text" style="font-family: 'Cinzel'; color: var(--arch-gold); letter-spacing: 4px; font-weight: 900;">Manifesting Scholar Stacks...</div></div>

    <div id="uid-link-modal" class="hidden" onclick="this.classList.add('hidden')">
        <div class="modal-box-dossier" onclick="event.stopPropagation()">
            <div class="modal-banner flex justify-between items-center p-4"><span>Citizen Attribution Ledger</span><button onclick="document.getElementById('uid-link-modal').classList.add('hidden')" class="opacity-50 hover:opacity-100">‚úï</button></div>
            <div class="p-8">
                <p class="text-[9px] uppercase font-black opacity-40 mb-4 tracking-widest text-[#312e81]">Attribute Research Node to Signature</p>
                <input type="text" id="user-search" class="w-full bg-white/40 border border-slate-400 p-3 mb-4 rounded font-serif text-sm italic text-slate-900" placeholder="Filter registry..." oninput="window.filterDMUsers(this.value)">
                <div id="user-results" class="max-h-64 overflow-y-auto border border-slate-400 rounded mb-8 bg-black/5 p-2"></div>
                <div class="pt-6 border-t border-dashed border-slate-500">
                    <p class="text-[8px] uppercase font-black opacity-40 mb-3">Manual UID Force Bind</p>
                    <div class="flex gap-2"><input type="text" id="manual-uid-input" class="flex-grow p-2 bg-white/40 border border-slate-400 rounded font-mono text-[10px]" placeholder="RAW UID..."><button onclick="window.assignManualUID()" class="bg-[#312e81] text-white px-4 py-2 text-[8px] font-black uppercase rounded shadow-sm">Affix RAW</button></div>
                </div>
            </div>
        </div>
    </div>

    <div id="lightbox-modal" class="lightbox hidden" onclick="this.classList.add('hidden')"><div id="lightbox-content"></div></div>

    <div class="parchment-container">
        <div class="manual-nav" onclick="event.stopPropagation()">
            <div class="mb-8 text-center">
                <h1 class="font-serif font-black text-2xl text-black uppercase leading-none tracking-tighter">Aeonfall</h1>
                <p id="library-subtitle" class="text-[8px] uppercase font-black tracking-widest opacity-100 mt-1 !text-black">Archivist SCHOLAR's library.</p>
                <div id="user-display-container" class="mt-6 border-y border-slate-600/30 py-4">
                    <div id="user-identity" class="font-serif text-[10px] font-black uppercase text-slate-600">Syncing registry...</div>
                    <div id="user-signout-container" class="mt-2 hidden"><button onclick="window.resetIdentity()" class="text-[9px] font-black uppercase text-red-700 hover:underline">Sign Out</button></div>
                    <div id="guest-login-action" class="mt-2 hidden"><button onclick="window.showGuestbook()" class="text-[9px] font-black uppercase text-indigo-700 hover:underline">Identify Signature</button></div>
                </div>
            </div>
            <div class="role-pill mx-auto">
                <div id="role-player-btn" onclick="window.setRole('player')" class="role-tab active">Player</div>
                <div id="role-dm-btn" onclick="window.setRole('dm')" class="role-tab">DM</div>
            </div>
            <div id="nav-list" class="flex-grow mt-6"></div>
            <div class="mt-10 pt-10 border-t border-slate-600/30">
                <div onclick="window.openReturnToLoreSequence()" class="block text-center font-serif uppercase font-black text-[11px] !text-[#9f1239] hover:underline mb-4 cursor-pointer">Return to Lore</div>
                <a href="playershandbook.html" class="block text-center font-serif uppercase font-black text-[11px] !text-[#9f1239] hover:underline">‚Üê System Hub</a>
            </div>
        </div>

        <div class="manual-body" id="content-pane" onclick="window.closeAllDropdowns()">
            <div id="manual-header"></div>
            <div id="manual-sections-container"></div>

            <!-- DM TOOLBAR -->
            <div id="dm-global-controls" class="hidden mt-16 pt-8 border-t border-slate-600/30 flex flex-wrap gap-4" onclick="event.stopPropagation()">
                <div class="arch-dropdown" id="dd-book">
                    <button class="arch-btn" onclick="window.toggleDropdown(event, 'dd-book')">üìï Book</button>
                    <div class="arch-dropdown-content">
                        <div class="dropdown-link" onclick="window.addManualSection('subheading', 'book')">Volume Heading</div>
                        <div class="dropdown-link" onclick="window.addManualSection('inner-subheading', 'book')">Sub-Heading</div>
                        <div class="dropdown-link" onclick="window.addManualSection('divider', 'book')">Spacing Line</div>
                        <div class="dropdown-link" onclick="window.addManualSection('text', 'book')">Text Block</div>
                        <div class="dropdown-link" onclick="window.addManualSection('media', 'book')">Media Block</div>
                        <div class="dropdown-link" onclick="window.addManualSection('table', 'book')">Data Table</div>
                        <div class="dropdown-link" onclick="window.addManualSection('note', 'book')">Sage Note</div>
                    </div>
                </div>
                <div class="arch-dropdown" id="dd-newspaper">
                    <button class="arch-btn" style="background-color: #334155; color: white;" onclick="window.toggleDropdown(event, 'dd-newspaper')">üì∞ Newspaper</button>
                    <div class="arch-dropdown-content">
                        <div class="dropdown-link" onclick="window.addManualSection('subheading', 'newspaper')">Archive Heading</div>
                        <div class="dropdown-link" onclick="window.addManualSection('inner-subheading', 'newspaper')">Section Sub-Heading</div>
                        <div class="dropdown-link" onclick="window.addManualSection('divider', 'newspaper')">Column Divider</div>
                        <div class="dropdown-link" onclick="window.addManualSection('text', 'newspaper')">Report Passage</div>
                        <div class="dropdown-link" onclick="window.addManualSection('media', 'newspaper')">Press Photo</div>
                        <div class="dropdown-link" onclick="window.addManualSection('table', 'newspaper')">Classified Stat</div>
                    </div>
                </div>
                <div class="arch-dropdown" id="dd-manuscript">
                    <button class="arch-btn" style="background-color: var(--arch-indigo); color: white;" onclick="window.toggleDropdown(event, 'dd-manuscript')">üìú Manuscript</button>
                    <div class="arch-dropdown-content">
                        <div class="dropdown-link" onclick="window.addManualSection('subheading', 'manuscript')">MS Heading</div>
                        <div class="dropdown-link" onclick="window.addManualSection('inner-subheading', 'manuscript')">Codex Subheading</div>
                        <div class="dropdown-link" onclick="window.addManualSection('divider', 'manuscript')">Vellum Break</div>
                        <div class="dropdown-link" onclick="window.addManualSection('text', 'manuscript')">Codex Script</div>
                        <div class="dropdown-link" onclick="window.addManualSection('research', 'manuscript')">Elder Research</div>
                    </div>
                </div>
                <div class="arch-dropdown" id="dd-parchment">
                    <button class="arch-btn" style="background-color: var(--arch-gold); color: white;" onclick="window.toggleDropdown(event, 'dd-parchment')">üìÑ Parchment</button>
                    <div class="arch-dropdown-content">
                        <div class="dropdown-link" onclick="window.addManualSection('subheading', 'parchment')">Parchment Heading</div>
                        <div class="dropdown-link" onclick="window.addManualSection('inner-subheading', 'parchment')">Scroll Subheading</div>
                        <div class="dropdown-link" onclick="window.addManualSection('divider', 'parchment')">Fiber Split</div>
                        <div class="dropdown-link" onclick="window.addManualSection('text', 'parchment')">Inscribed Text</div>
                        <div class="dropdown-link" onclick="window.addManualSection('info', 'parchment')">Informational Box</div>
                    </div>
                </div>
                <div class="arch-dropdown" id="dd-textbook">
                    <button class="arch-btn" style="background-color: #be123c; color: white;" onclick="window.toggleDropdown(event, 'dd-textbook')">üìï Text Book</button>
                    <div class="arch-dropdown-content">
                        <div class="dropdown-link" onclick="window.addManualSection('subheading', 'textbook')">Chapter Heading</div>
                        <div class="dropdown-link" onclick="window.addManualSection('inner-subheading', 'textbook')">Topic Sub-Heading</div>
                        <div class="dropdown-link" onclick="window.addManualSection('divider', 'textbook')">Logical Break</div>
                        <div class="dropdown-link" onclick="window.addManualSection('text', 'textbook')">Academic Text</div>
                        <div class="dropdown-link" onclick="window.addManualSection('table', 'textbook')">Data Repository</div>
                    </div>
                </div>
            </div>
            <div class="page-indicator mt-20 opacity-30 text-center uppercase tracking-widest text-[9px] font-black">End of Library Record ‚Ä¢ Ver. 2.9.6</div>
        </div>
    </div>

    <!-- DM AUTH MODALS -->
    <div id="del-modal" class="fixed inset-0 z-[110000] flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/90" onclick="document.getElementById('del-modal').classList.add('hidden')"></div>
        <div class="bg-white p-10 rounded-sm w-full max-w-sm text-center relative z-10 shadow-2xl border border-slate-300">
            <h3 class="text-2xl font-serif font-black uppercase mb-4 text-red-700">Expunge Record?</h3>
            <p id="del-modal-text" class="text-sm text-slate-500 mb-10 italic">This record will be permanently deleted.</p>
            <div class="flex flex-col gap-4">
                <button id="confirm-del-btn" class="w-full bg-red-700 text-white py-4 rounded-sm font-black text-xs uppercase shadow-lg">Confirm Erasure</button>
                <button onclick="document.getElementById('del-modal').classList.add('hidden')" class="w-full bg-slate-100 py-3 text-slate-400 font-bold uppercase text-[10px]">Cancel</button>
            </div>
        </div>
    </div>

    <div id="pass-modal" class="fixed inset-0 bg-slate-950/98 flex items-center justify-center z-[110000] hidden p-4">
        <div class="bg-white p-10 rounded-sm w-full max-sm border-2 border-indigo-900 shadow-2xl text-center">
            <h3 class="text-xl font-serif text-indigo-900 font-bold mb-4 uppercase tracking-[2px]">Scholar Verification</h3>
            <input type="password" id="dm-pass" class="w-full bg-slate-50 text-center text-2xl rounded-lg p-3 mb-8 border border-slate-300 text-indigo-900 focus:outline-none" placeholder="KEY">
            <button onclick="window.authDm()" class="w-full bg-indigo-900 hover:bg-indigo-800 text-white py-4 rounded-sm font-bold uppercase text-xs">Verify Access</button>
            <button onclick="document.getElementById('pass-modal').classList.add('hidden')" class="text-[10px] text-slate-400 uppercase font-black mt-6 block w-full text-center">Abort</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, updateDoc, setDoc, onSnapshot, addDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBLN0KhcnZFKZEYyR0O-Q2mZhKr-iyh7BI", authDomain: "aeonfall-523c1.firebaseapp.com", projectId: "aeonfall-523c1", storageBucket: "aeonfall-523c1.firebasestorage.app", messagingSenderId: "716207733913", appId: "1:716207733913:web:7aac43906a70e2b5f50c08" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'aeonfall-archivist-v1';

        let manualSections = [], seenDocs = [], allUsers = [], targetSectionForUID = null;
        let manualHeader = { title: "Scholar Library", subtitle: "Categorizing civilizations past within the Scholar's Library." };
        let activeRole = localStorage.getItem('aeonfall_role') || 'player'; 
        let activeEditId = null, userAuth = null, saveTimer = null, deleteCallback = null, activeAnchorUID = null, draggedId = null, dropSide = null;

        // --- GLOBAL UI HELPERS ---
        window.showToast = (m) => { 
            const t = document.getElementById('toast'); 
            if(t) { t.textContent = m; t.style.opacity = '1'; setTimeout(() => { t.style.opacity = '0'; }, 6000); } 
        };
        window.toggleDropdown = (e, id) => { e.stopPropagation(); const el = document.getElementById(id); const isActive = el.classList.contains('active'); window.closeAllDropdowns(); if (!isActive) el.classList.add('active'); };
        window.closeAllDropdowns = () => { document.querySelectorAll('.arch-dropdown').forEach(d => d.classList.remove('active')); };
        window.toggleTerminalView = (v) => { const l = document.getElementById('terminal-login-view'), r = document.getElementById('terminal-register-view'); if(v==='register'){l.classList.add('hidden'); r.classList.remove('hidden');}else{l.classList.remove('hidden'); r.classList.add('hidden');} };

        // --- IDENTITY ---
        window.anchorIdentity = (uid) => {
            activeAnchorUID = uid; sessionStorage.setItem('aeonfall_session_anchored', 'true'); localStorage.setItem('aeonfall_claimed_uid', uid);
            document.getElementById('access-terminal')?.classList.add('unlocked');
            window.updateIdentityUI(); window.renderManual();
            
            const unreadCount = manualSections.filter(s => {
                const isWithin24Hrs = (Date.now() - (s.createdAt || 0)) < 86400000;
                const isPersonal = s.visibility === 'personal' && s.sharedWith?.includes(uid);
                return (isWithin24Hrs || isPersonal) && !seenDocs.includes(s.id);
            }).length;
            if(unreadCount > 0) window.showToast(`DISCOVERY: ${unreadCount} NEW RECORDS DETECTED IN THE ARCHIVES`);
            else window.showToast("COGNITIVE SIGNATURE ANCHORED");
        };

        window.filterTerminal = (val) => {
            const container = document.getElementById('terminal-results'); if(!container) return;
            const search = val.toLowerCase();
            const filtered = allUsers.filter(u => (u.username || '').toLowerCase().includes(search));
            container.innerHTML = filtered.map(u => `<div class="ledger-line" onclick="window.anchorIdentity('${u.uid}')"><span class="ledger-name text-slate-900">${u.username || 'Unidentified'}</span><div class="ledger-status-group"><span class="ledger-status">Anchor</span>${activeRole==='dm' ? `<button onclick="window.triggerPurgeCitizen(event, '${u.uid}')" class="purge-btn">Purge</button>` : ''}</div></div>`).join('') || '<div class="p-8 text-center opacity-30">Search Registry</div>';
        };

        window.registerCitizen = async () => {
            const characterName = document.getElementById('reg-name-input')?.value.trim();
            if (!characterName) { window.showToast("Signature Required"); return; }
            const currentUser = auth.currentUser || userAuth;
            try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid), { username: characterName, registeredAt: Date.now(), role: 'citizen' }); window.anchorIdentity(currentUser.uid); } catch (e) { window.showToast("Registry Refused."); }
        };

        window.proceedAsRegistered = () => { const lastUID = localStorage.getItem('aeonfall_claimed_uid'); if (lastUID) window.anchorIdentity(lastUID); else window.showToast("NO ANCHOR FOUND"); };
        window.bypassTerminal = () => { activeAnchorUID = null; document.getElementById('access-terminal')?.classList.add('unlocked'); window.showToast("GUEST ACCESS GRANTED"); window.updateIdentityUI(); window.renderManual(); };

        window.updateIdentityUI = () => {
            const idChar = allUsers.find(au => au.uid === activeAnchorUID);
            const identText = document.getElementById('user-identity');
            const guestAction = document.getElementById('guest-login-action');
            const signoutContainer = document.getElementById('user-signout-container');
            if(identText) {
                if(idChar) { identText.innerText = `CITIZEN SIGNED: ${idChar.username}`; guestAction?.classList.add('hidden'); signoutContainer?.classList.remove('hidden'); } 
                else { identText.innerText = 'UNIDENTIFIED GUEST'; guestAction?.classList.remove('hidden'); signoutContainer?.classList.add('hidden'); }
            }
        };

        // --- ROLE MANAGEMENT ---
        window.setRole = (r) => { if(r === 'dm') document.getElementById('pass-modal')?.classList.remove('hidden'); else { activeRole = 'player'; localStorage.setItem('aeonfall_role', 'player'); window.updateRoleUI(); } };
        window.authDm = () => { if(document.getElementById('dm-pass')?.value === 'Rew4994') { activeRole='dm'; localStorage.setItem('aeonfall_role', 'dm'); document.getElementById('pass-modal')?.classList.add('hidden'); window.updateRoleUI(); } else { window.showToast("Access Denied"); } };
        window.updateRoleUI = () => { 
            const isDM = activeRole === 'dm'; 
            document.getElementById('role-player-btn')?.classList.toggle('active', !isDM);
            document.getElementById('role-dm-btn')?.classList.toggle('active', isDM);
            document.getElementById('dm-global-controls')?.classList.toggle('hidden', !isDM);
            document.body.classList.toggle('dm-active-edit', isDM); window.renderManual(); 
        };

        // --- DRAG AND DROP ---
        window.handleDragStart = function(e, id) { if (activeRole !== 'dm') return; draggedId = id; e.currentTarget.classList.add('section-dragging'); };
        window.handleDragOver = function(e) { if (!draggedId) return; e.preventDefault(); const rect = e.currentTarget.getBoundingClientRect(); const relX = e.clientX - rect.left; const threshold = rect.width * 0.3; e.currentTarget.classList.remove('section-drag-over-before', 'section-drag-over-after', 'section-drag-over-center'); if (relX < threshold) { dropSide = 'left'; e.currentTarget.classList.add('section-drag-over-before'); } else if (relX > rect.width - threshold) { dropSide = 'right'; e.currentTarget.classList.add('section-drag-over-after'); } else { dropSide = 'center'; e.currentTarget.classList.add('section-drag-over-center'); } };
        window.handleDragLeave = function(e) { e.currentTarget.classList.remove('section-drag-over-before', 'section-drag-over-after', 'section-drag-over-center'); };
        window.handleDrop = async function(e, targetId) { e.preventDefault(); e.currentTarget.classList.remove('section-drag-over-before', 'section-drag-over-after', 'section-drag-over-center'); if (!draggedId || draggedId === targetId) return; const sourceIdx = manualSections.findIndex(s => s.id === draggedId); const targetIdxOriginal = manualSections.findIndex(s => s.id === targetId); const targetBlock = manualSections[targetIdxOriginal]; const newSections = [...manualSections]; const [moved] = newSections.splice(sourceIdx, 1); let insertIdx = newSections.findIndex(s => s.id === targetId); const batch = writeBatch(db); if (dropSide === 'left' || dropSide === 'right') { batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'librarySections', moved.id), { width: 48 }); batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'librarySections', targetBlock.id), { width: 48 }); if (dropSide === 'right') insertIdx += 1; } else { if (insertIdx > sourceIdx) insertIdx += 1; } newSections.splice(insertIdx, 0, moved); newSections.forEach((sec, i) => { batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'librarySections', sec.id), { order: i }); }); await batch.commit(); draggedId = null; };

        // --- DATABASE OPS ---
        window.dbUpdateSection = (id, field, val) => { if(saveTimer) clearTimeout(saveTimer); saveTimer = setTimeout(async () => { try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'librarySections', id), { [field]: val }); window.showToast("Record Synchronized"); } catch(e) {} }, 800); };
        window.dbUpdateHeader = (field, val) => { if(saveTimer) clearTimeout(saveTimer); saveTimer = setTimeout(async () => { try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'manualConfig', 'libraryHeader'), { [field]: val }, { merge: true }); } catch(e) {} }, 800); };
        window.addManualSection = async (type, docType = 'book') => {
            if(!userAuth) return;
            const data = { title: type==='subheading'?'NEW VOLUME':(type==='inner-subheading'?'NEW CHAPTER':type==='divider'?'':'NEW RESEARCH FRAGMENT'), content: type==='divider'?'':'Details...', type, docType, order: manualSections.length, createdAt: Date.now(), width: 100, fontSize: 14, ySpacing: 0, visibility: 'public', sharedWith: [] };
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'librarySections'), data);
            window.closeAllDropdowns();
        };
        window.triggerPurgeCitizen = (e, uid) => { e.stopPropagation(); window.openDelModal("Expunge signature from the registry?", async () => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid)); window.showToast("RECORD PURGED"); }); };
        window.assignUIDToSection = async (uid) => { if(!targetSectionForUID) return; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'librarySections', targetSectionForUID), { sharedWith: [uid] }); document.getElementById('uid-link-modal')?.classList.add('hidden'); window.showToast("Attributed Signature."); };
        window.assignManualUID = async () => { const uid = document.getElementById('manual-uid-input')?.value.trim(); if(!uid || !targetSectionForUID) return; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'librarySections', targetSectionForUID), { sharedWith: [uid] }); document.getElementById('uid-link-modal')?.classList.add('hidden'); window.showToast("Override Complete"); };
        window.openReturnToLoreSequence = () => { document.getElementById('cinematic-overlay').classList.add('active'); setTimeout(() => { window.location.href = 'lore.html'; }, 2000); };
        window.openUserModal = (id) => { targetSectionForUID = id; document.getElementById('uid-link-modal').classList.remove('hidden'); window.filterDMUsers(''); };
        window.filterDMUsers = (v) => { const search = v.toLowerCase(); const filtered = allUsers.filter(u => (u.username || '').toLowerCase().includes(search) || (u.uid || '').toLowerCase().includes(search)); document.getElementById('user-results').innerHTML = filtered.map(u => `<div class="user-result flex justify-between items-center"><div class="flex-grow"><b>${u.username || 'Unidentified'}</b><div class="text-[8px] opacity-40 uppercase">${u.uid}</div></div><button onclick="window.assignUIDToSection('${u.uid}')" class="bind-tag-btn">Sync</button></div>`).join(''); };
        window.setEditing = (id) => { activeEditId = id; };
        window.clearEditing = () => { activeEditId = null; };
        window.triggerDelete = (id) => { deleteCallback = async () => await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'librarySections', id)); document.getElementById('del-modal').classList.remove('hidden'); };
        
        window.markAsSeen = async (id) => { 
            const el = document.getElementById(`section-${id}`); if(el) el.scrollIntoView({ behavior: 'smooth' }); 
            if(activeAnchorUID) await setDoc(doc(db, 'artifacts', appId, 'users', activeAnchorUID, 'seenDocuments', id), { seenAt: Date.now() });
        };

        window.renderManual = () => {
            const isDM = activeRole === 'dm', anchored = sessionStorage.getItem('aeonfall_session_anchored') === 'true';
            const effectiveUID = anchored ? activeAnchorUID : 'guest';
            const container = document.getElementById('manual-sections-container'); if(!container) return;
            const visibleSections = manualSections.filter(s => isDM || s.visibility === 'public' || (s.visibility === 'personal' && s.sharedWith?.includes(effectiveUID)));
            
            document.getElementById('nav-list').innerHTML = visibleSections.filter(s => s.type === 'subheading').map(s => {
                const isNew = (Date.now() - (s.createdAt || 0)) < 86400000 && !seenDocs.includes(s.id);
                const icons = { 'book': 'üìï', 'newspaper': 'üì∞', 'manuscript': 'üìú', 'parchment': 'üìÑ', 'textbook': 'üìï' };
                const label = { 'book': 'Codex', 'newspaper': 'Press', 'manuscript': 'Scroll', 'parchment': 'Notice', 'textbook': 'Study' };
                return `<div class="shelf-item ${s.docType || 'book'}" onclick="window.markAsSeen('${s.id}')">${isNew ? '<span class="new-badge">NEW</span>' : ''}${s.visibility === 'personal' ? '<span class="personal-badge">Tie</span>' : ''}<span class="item-label">${icons[s.docType] || 'üìï'} ${label[s.docType] || 'Volume'}</span>${s.title}</div>`;
            }).join('');

            const headerEl = document.getElementById('manual-header');
            if (headerEl) headerEl.innerHTML = `<h1 id="manual-main-title" class="manual-h1 dm-editable" contenteditable="${isDM}" onfocus="window.setEditing('manual-main-title')" onblur="window.clearEditing(); window.renderManual()" oninput="window.dbUpdateHeader('title', this.innerText)">${manualHeader.title}</h1><p id="manual-main-subtitle" class="font-serif italic text-sm text-slate-700 mb-10 dm-editable" contenteditable="${isDM}" onfocus="window.setEditing('manual-main-subtitle')" onblur="window.clearEditing(); window.renderManual()" oninput="window.dbUpdateHeader('subtitle', this.innerText)">${manualHeader.subtitle}</p>`;
            
            container.innerHTML = visibleSections.map(s => {
                const customStyle = `width: calc(${s.width ?? 100}% - 10px); font-size: ${s.fontSize ?? 14}px; margin-top: ${s.ySpacing ?? 0}px; flex-shrink: 0; box-sizing: border-box; padding: 10px;`;
                let html = `<section id="section-${s.id}" class="group relative transition-all doc-${s.docType || 'book'}" draggable="${isDM}" ondragstart="window.handleDragStart(event, '${s.id}')" ondragover="window.handleDragOver(event)" ondragleave="window.handleDragLeave(event)" ondrop="window.handleDrop(event, '${s.id}')" style="${customStyle}">
                    ${isDM ? `<div class="tuner-panel"><div class="drag-handle">‚†ø</div><div class="tuner-group"><span class="tuner-label">Width</span><input type="range" class="tuner-slider" min="10" max="100" value="${s.width ?? 100}" oninput="window.dbUpdateSection('${s.id}', 'width', parseInt(this.value))"></div><div class="tuner-group"><span class="tuner-label">Access</span><select class="tuner-select text-[8px] bg-white border border-slate-300 rounded" onchange="window.dbUpdateSection('${s.id}', 'visibility', this.value)"><option value="public" ${s.visibility==='public'?'selected':''}>Public</option><option value="secret" ${s.visibility==='secret'?'selected':''}>Secret</option><option value="personal" ${s.visibility==='personal'?'selected':''}>Personal Tie</option></select></div>${s.visibility === 'personal' ? `<div class="tuner-group"><span class="tuner-label">Binding</span><button class="link-user-btn !text-[7px] !px-3" onclick="window.openUserModal('${s.id}')">${allUsers.find(u => u.uid === s.sharedWith?.[0])?.username || 'Attribute'}</button></div>` : ''}<button onclick="window.triggerDelete('${s.id}')" class="arch-btn arch-btn-del !rounded-md ml-auto">‚úï</button></div>` : ''}
                    <div class="flex justify-between items-end gap-4 mb-2">
                        ${s.type === 'subheading' ? `<h2 id="head-${s.id}" class="manual-h2 dm-editable flex-grow !m-0" contenteditable="${isDM}" onfocus="window.setEditing('head-${s.id}')" onblur="window.clearEditing(); window.renderManual()" oninput="window.dbUpdateSection('${s.id}', 'title', this.innerText)">${s.title}</h2>` : (s.type === 'inner-subheading' ? `<h3 id="head-${s.id}" class="manual-h3 dm-editable flex-grow !m-0" contenteditable="${isDM}" onfocus="window.setEditing('head-${s.id}')" onblur="window.clearEditing(); window.renderManual()" oninput="window.dbUpdateSection('${s.id}', 'title', this.innerText)">${s.title}</h3>` : '')}
                        ${isDM ? `<span class="visibility-tag tag-${s.visibility || 'public'}">${s.visibility || 'public'}</span>` : ''}
                    </div>`;
                if(s.type === 'text') html += `<div id="content-${s.id}" class="manual-p dm-editable leading-relaxed" contenteditable="${isDM}" onfocus="window.setEditing('content-${s.id}')" onblur="window.clearEditing(); window.renderManual()" oninput="window.dbUpdateSection('${s.id}', 'content', this.innerHTML)">${s.content}</div>`;
                else if(s.type === 'note') html += `<div class="manual-note-box bg-white/40 p-5 border-l-4 border-indigo-900 rounded-sm shadow-inner"><div id="content-${s.id}" class="manual-p dm-editable italic" contenteditable="${isDM}" onfocus="window.setEditing('content-${s.id}')" onblur="window.clearEditing(); window.renderManual()" oninput="window.dbUpdateSection('${s.id}', 'content', this.innerHTML)">${s.content}</div></div>`;
                else if(s.type === 'divider') html += `<div class="manual-divider"></div>`;
                html += `</section>`; return html;
            }).join('');
        };

        window.triggerDelete = (id) => { window.openDelModal("Purge archival entry?", async () => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'librarySections', id)); }); };
        window.resetIdentity = () => { activeAnchorUID = null; localStorage.removeItem('aeonfall_claimed_uid'); sessionStorage.removeItem('aeonfall_session_anchored'); window.showToast("SIGNING OUT..."); setTimeout(() => window.location.reload(), 500); };
        window.openReturnToLoreSequence = function() { document.getElementById('cinematic-overlay').classList.add('active'); setTimeout(() => { window.location.href = 'lore.html'; }, 2000); };

        const initAuth = async () => { try { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } else { await signInAnonymously(auth); } } catch (e) { await signInAnonymously(auth); } };
        onAuthStateChanged(auth, async (u) => { 
            userAuth = u; if (u) {
                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'manualConfig', 'libraryHeader'), d => { if (d.exists()) { manualHeader = d.data(); window.renderManual(); } });
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'librarySections'), snap => { manualSections = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (a.order ?? 0) - (b.order ?? 0)); window.renderManual(); });
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), snap => { allUsers = snap.docs.map(d => ({uid: d.id, ...d.data()})); window.updateIdentityUI(); window.filterTerminal(''); window.renderManual(); });
                
                const anchoredUID = localStorage.getItem('aeonfall_claimed_uid');
                if(anchoredUID) {
                    onSnapshot(collection(db, 'artifacts', appId, 'users', anchoredUID, 'seenDocuments'), snap => { seenDocs = snap.docs.map(d => d.id); window.renderManual(); });
                }
                window.updateRoleUI();
            }
        });
        document.getElementById('confirm-del-btn').onclick = async () => { if (deleteCallback) await deleteCallback(); document.getElementById('del-modal').classList.add('hidden'); };
        initAuth();
    </script>
</body>
</html>
